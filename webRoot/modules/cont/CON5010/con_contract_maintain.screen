<?xml version="1.0" encoding="UTF-8"?>
<!--
    $Author:Spencer 3893
    $Date: 2015-03-17 上午10:48:06  
    $Revision: 1.0  
    $Purpose:我发起的合同 
-->
<a:screen xmlns:a="http://www.aurora-framework.org/application" trace="true">
    <a:init-procedure>
        <a:model-query fetchAll="true" model="cont.CON5010.con_contract_headers_init" rootPath="con5010_contract_header_init_source"/>
        <a:model-query defaultWhereClause="t1.partner_type_code=&apos;PARTNER02&apos; and t1.ENABLED_FLAG=&apos;Y&apos;" fetchAll="true" model="cont.CON2020.con_contract_partner_types_cmb" rootPath="con5010_contract_partner_type2"/>
        <a:model-query defaultWhereClause="t1.partner_type_code=&apos;PARTNER01&apos; and t1.ENABLED_FLAG=&apos;Y&apos;" fetchAll="true" model="cont.CON2020.con_contract_partner_types_cmb" rootPath="con5010_contract_partner_type1"/>
        <a:model-query defaultWhereClause="flex_value_set_code = &apos;CONTRACT_TYPE&apos;" fetchAll="true" model="public.fnd_flex_value_v_lov" rootPath="contract_types"/>
        <a:model-query defaultWhereClause="flex_value_set_code = &apos;CONTRACT_STATUS&apos;" fetchAll="true" model="public.fnd_flex_value_v_lov" rootPath="contract_status"/>
        <a:model-query defaultWhereClause="flex_value_set_code = &apos;CONTRACT_PROPERTY&apos;" fetchAll="true" model="public.fnd_flex_value_v_lov" rootPath="contract_propertys"/>
        <a:model-query defaultWhereClause="flex_value_set_code = &apos;CONTRACT_RECEIPT_PAYMENT&apos;" fetchAll="true" model="public.fnd_flex_value_v_lov" rootPath="contract_receipt_payments"/>
        <a:model-query defaultWhereClause="cbi.config_classify_code = &apos;CONTRACT&apos; AND cbi.config_item_code = &apos;CONTRACT_05&apos;" fetchAll="true" model="public.get_fnd_config_center_bg_item_value" rootPath="bg_item_contract_05"/>
    </a:init-procedure>
    <a:view>
        <a:link id="con5010_attachment_file_upload_link" url="${/request/@context_path}/uploadFile.screen"/>
        <a:link id="con5010_attachment_file_show_upload_link" url="${/request/@context_path}/check_uploadFile.screen"/>
        <a:link id="con5010_attachment_file_download_link" url="${/request/@context_path}/atm_download.svc"/>
        <a:link id="con5010_check_attachment_upload_link" model="cont.CON5010.con_contract_check_atm_upload" modelaction="query"/>
        <a:link id="con5010_update_file_path_link" model="cont.CON5010.con_contract_atm_file_path" modelaction="execute"/>
        <a:link id="con5010_update_file_id_link" model="cont.CON5010.con_contract_atm_file_id" modelaction="execute"/>
        <a:link id="con5010_delete_atm_link" url="${/request/@context_path}/modules/cont/CON5010/con_contract_atm_delete.svc"/>
        <a:link id="con5010_delete_partner_link" url="${/request/@context_path}/modules/cont/CON5010/con_contract_partner_delete.svc"/>
        <a:link id="con5010_delete_object_link" url="${/request/@context_path}/modules/cont/CON5010/con_contract_object_delete.svc"/>
        <a:link id="con5010_delete_stage_link" url="${/request/@context_path}/modules/cont/CON5010/con_contract_stage_delete.svc"/>
        <a:link id="con5010_delete_link" url="${/request/@context_path}/modules/cont/CON5010/con_contract_delete.svc"/>
        <a:link id="con5010_publish_con_link" model="cont.CON5010.con_contract_headers_publish" modelaction="execute"/>
        <a:link id="con5010_publish_return_link" model="cont.CON5010.con_contract_headers_publish" modelaction="update"/>
        <a:link id="con5010_contract_generate_maintain_link" url="${/request/@context_path}/modules/cont/CON5010/con_contract_generate_maintain.screen"/>
        <a:link id="con5010_generate_maintain_load_data_link" model="cont.CON5010.con_generate_load_data" modelaction="execute"/>
        <a:link id="con5010_contract_detail_terminal_link" url="${/request/@context_path}/modules/cont/CON5010/con_contract_detail_terminal.screen"/>
        <a:link id="con5010_contract_histories_link" url="${/request/@context_path}/modules/cont/public/con_contract_histories_query.screen"/>
        <a:link id="con5010_save_link" model="cont.CON2030.fnd_atm_lines" modelaction="execute"/>
        <script><![CDATA[
            //是否启用在线签章标志
            g_sign_online_flag = '${/model/bg_item_contract_05/record/@bg_config_item_value}';
            
            var headFields = ['contract_number', 'status_desc', 'contract_type_name', 'direction_name', 'company_short_name', 'contract_object_name'];
            
            var contract_header_id_bak = '${/parameter/@contract_header_id}';
            
            function con5010_back() {
                $('con5010_contract_result_ds').query();
                $('con5010_contract_maintain_window').close();
            }
            
            
            
            function onCon5010UploadOrDownloadFun(value, record, name) {
                var atm_line_id = record.get('atm_line_id');
                if (!record.isNew && atm_line_id != undefined) {
                    return '<a href="javascript:con5010_uploadordownload_file(\'' + atm_line_id + '\')">${l:CON_CONTRACT_ATM_LINES.UPLOAD/DOWNLOAD}</a>';
                }
            }
            
            function con5010_uploadordownload_file(id) {
                // Aurora.Masker.mask(Ext.getBody(), '${l:LOADING}');
                var url;
                Aurora.showConfirm('${l:PROMPT}', '${l:SRM_ATM_UNIQ}', function(cmp) {
                    url = $('con5010_attachment_file_upload_link').getUrl() + "?table_name=CON_CONTRACT_ATM_LINES&header_id=" + id;
                    new Aurora.Window({
                        url: url,
                        title: '${l:CON_CONTRACT_ATM_LINES.UPLOAD/DOWNLOAD}',
                        id: 'con5010_uploadordownload_window',
                        width: 850,
                        height: 500
                    }).on('beforeclose', function() {
                        Aurora.request({
                            url: $('con5010_update_file_id_link').getUrl(),
                            para: {
                                contract_header_id: contract_header_id_bak || $('con5010_contract_header_ds').getAt(0).get('contract_header_id'),
                                atm_line_id: id
                            },
                            success: function(args) {
                                if (args.result.error_code == '-1') {
                                    Aurora.showWarningMessage('${l:PROMPT}', '${l:CON_CONTRACT_HEADERS.ATM_ONLY_ONE}');
                                } else {
                                    $('con5010_contract_atm_lines_ds').setQueryParameter('contract_header_id', contract_header_id_bak);
                                    $('con5010_contract_atm_lines_ds').query();
                                }
                            },
                            scope: this
                        });
                    });
                }, null, null, 85);
                // }
                // },
                // scope: this
                // });
            }
            
            function con5010_con_headers_ds_update(ds, record, name, value, oldvalue) {
                var contract_type = record.get('contract_type_code');
                var partner_record;
                if (name == "contract_type_code") {
                    if (value == 'UNIVERSAL_CON') {
                        //合同类型从附件合同修改成普通合同
                        if (oldvalue == 'ATM_CON') {
                            con5010_con_headers_ds_rules(record, value);
                            Ext.get('con5010_accordion_dim').show();
                            $('con5010_accordion_dim').selectAccordionIndex(0);
                        } else {
                            con5010_con_headers_ds_rules(record, value);
                            $('con5010_accordion_dim').selectAccordionIndex(0);
                            Ext.get('con5010_upload_atm').hide();
                        }
                        //合同用途
                        if (record.get('direction_id')) {
                            record.set('clause_template_id', '');
                            record.set('clause_template_name', '');
                            record.getMeta().getField('clause_template_name').setRequired(true);
                            record.getMeta().getField('clause_template_name').setReadOnly(false);
                            record.getField('clause_template_name').setLovPara('templet_usage', record.get('direction_id'));
            
                            //业务信息
                            $('con5010_contract_get_business_lines_ds').setQueryParameter('direction_id', record.get('direction_id'));
                            $('con5010_contract_get_business_lines_ds').query();
            
                            //附件
                            $('con5010_contract_get_atm_lines_ds').setQueryParameter('direction_id', record.get('direction_id'));
                            $('con5010_contract_get_atm_lines_ds').query();
                        }
                        //公司
                        if (record.get('company_id')) {
                            record.getMeta().getField('contract_object_name').setRequired(true);
                            record.getMeta().getField('contract_object_name').setReadOnly(false);
                            partner_record = $('con5010_contract_partner_lines_ds').create();
                            partner_record.set('partner_type_id', '${/model/con5010_contract_partner_type1/record/@partner_type_id}');
                            partner_record.set('partner_type_name', '${/model/con5010_contract_partner_type1/record/@partner_type_name}');
                            partner_record.set('partner_type_code', '${/model/con5010_contract_partner_type1/record/@partner_type_code}');
                            partner_record.set('partner_category', 'COMPANY');
                            partner_record.set('representative', record.get('legal_rep_name'));
                            partner_record.set('partner_desc', record.get('business_represent_name'));
                            partner_record.set('address', record.get('business_address'));
                            partner_record.set('tel_phone', record.get('business_represent_phone'));
                            partner_record.set('note', record.get('business_represent_mail'));
                        }
                        //合同对象
                        if (record.get('contract_object_id')) {
                            partner_record = $('con5010_contract_partner_lines_ds').create();
                            partner_record.set('partner_type_id', '${/model/con5010_contract_partner_type2/record/@partner_type_id}');
                            partner_record.set('partner_type_name', '${/model/con5010_contract_partner_type2/record/@partner_type_name}');
                            partner_record.set('partner_type_code', '${/model/con5010_contract_partner_type2/record/@partner_type_code}');
                            partner_record.set('partner_category', 'VENDER');
                            partner_record.set('representative', record.get('legal_rep_name'));
                            partner_record.set('partner_desc', record.get('business_represent_name'));
                            partner_record.set('address', record.get('business_address'));
                            partner_record.set('tel_phone', record.get('business_represent_phone'));
                            partner_record.set('note', record.get('business_represent_mail'));
                        }
                    } else if (value == 'ATM_CON') {
                        if (oldvalue == 'UNIVERSAL_CON') {
                            var pds = $('con5010_contract_partner_lines_ds');
                            var precords = pds.getAll();
                            if (precords.length >= 1) {
                                for (var j = 0;j < precords.length;j++) {
                                    if (precords[j].isNew) {
                                        pds.remove(precords);
                                    }
                                }
                            }
            
                            con5010_con_headers_ds_rules(record, value);
                            $('con5010_accordion_dim').selectAccordionIndex(0);
                        } else {
                            //新建合同第一次直接选附件合同
                            con5010_con_headers_ds_rules(record, value);
                        }
                        Ext.get('con5010_upload_atm').show();
                        diaplayBtn('con5010_accordion_dim');
                    }
                } else if (name == "direction_id") {
            
                    if (contract_type == 'UNIVERSAL_CON') {
                        record.set('clause_template_id', '');
                        record.set('clause_template_name', '');
                        record.getMeta().getField('clause_template_name').setRequired(true);
                        record.getMeta().getField('clause_template_name').setReadOnly(false);
                        record.getField('clause_template_name').setLovPara('templet_usage', record.get('direction_id'));
            
                        //业务信息
                        $('con5010_contract_get_business_lines_ds').setQueryParameter('direction_id', record.get('direction_id'));
                        $('con5010_contract_get_business_lines_ds').query();
            
                        //附件
                        $('con5010_contract_get_atm_lines_ds').setQueryParameter('direction_id', record.get('direction_id'));
                        $('con5010_contract_get_atm_lines_ds').query();
                    }
                } else if (name == "company_id") {
                    if (contract_type == 'UNIVERSAL_CON') {
                        record.getMeta().getField('contract_object_name').setRequired(true);
                        record.getMeta().getField('contract_object_name').setReadOnly(false);
                        partner_record = $('con5010_contract_partner_lines_ds').create();
                        partner_record.set('partner_type_id', '${/model/con5010_contract_partner_type1/record/@partner_type_id}');
                        partner_record.set('partner_type_name', '${/model/con5010_contract_partner_type1/record/@partner_type_name}');
                        partner_record.set('partner_type_code', '${/model/con5010_contract_partner_type1/record/@partner_type_code}');
                        partner_record.set('partner_category', 'COMPANY');
                        partner_record.set('partner', record.get('company_id'));
                        partner_record.set('representative', record.get('legal_rep_name'));
                        partner_record.set('partner_desc', record.get('business_represent_name'));
                        partner_record.set('address', record.get('business_address'));
                        partner_record.set('tel_phone', record.get('business_represent_phone'));
                        partner_record.set('note', record.get('business_represent_mail'));
                    }
                    var company_id = record.get('company_id');
                    record.getField('contract_object_name').setLovPara('company_id', company_id);
                    record.set('contract_object_name', null);
                    record.set('contract_object_id', null);
                    record.set('contract_object_code', null);
                } else if (name == "contract_object_id") {
                    if (contract_type == 'UNIVERSAL_CON') {
                        if (oldvalue != undefined || oldvalue != null) {
                            partner_record = $('con5010_contract_partner_lines_ds').findById(1);
                            $('con5010_contract_partner_lines_ds').remove(partner_record);
                            partner_record = $('con5010_contract_partner_lines_ds').create();
                            partner_record.set('partner_type_id', '${/model/con5010_contract_partner_type2/record/@partner_type_id}');
                            partner_record.set('partner_type_name', '${/model/con5010_contract_partner_type2/record/@partner_type_name}');
                            partner_record.set('partner_type_code', '${/model/con5010_contract_partner_type2/record/@partner_type_code}');
                            partner_record.set('partner_category', 'VENDER');
                            partner_record.set('partner', record.get('contract_object_id'));
                            partner_record.set('representative', record.get('legal_rep_name'));
                            partner_record.set('partner_desc', record.get('business_represent_name'));
                            partner_record.set('address', record.get('business_address'));
                            partner_record.set('tel_phone', record.get('business_represent_phone'));
                            partner_record.set('note', record.get('business_represent_mail'));
                        } else {
                            partner_record = $('con5010_contract_partner_lines_ds').create();
                            partner_record.set('partner_type_id', '${/model/con5010_contract_partner_type2/record/@partner_type_id}');
                            partner_record.set('partner_type_name', '${/model/con5010_contract_partner_type2/record/@partner_type_name}');
                            partner_record.set('partner_type_code', '${/model/con5010_contract_partner_type2/record/@partner_type_code}');
                            partner_record.set('partner_category', 'VENDER');
                            partner_record.set('partner', record.get('contract_object_id'));
                            partner_record.set('representative', record.get('legal_rep_name'));
                            partner_record.set('partner_desc', record.get('business_represent_name'));
                            partner_record.set('address', record.get('business_address'));
                            partner_record.set('tel_phone', record.get('business_represent_phone'));
                            partner_record.set('note', record.get('business_represent_mail'));
                        }
            
                    }
                } else if (name == "amount") {
                    var tax_flag = record.get('tax_flag');
                    var amount = record.get('amount');
                    if (tax_flag == 'Y') {
                        //var tax_type_rate = (record.get('tax_type_rate') == 0) ? 1 : record.get('tax_type_rate');
                        var tax_type_rate = record.get('tax_type_rate');
                        if (!isNaN(tax_type_rate)) {
                            var tax_amount = (amount * tax_type_rate) / 100;
                            record.set('tax_amount', tax_amount);
                            // var not_include_amount = amount - tax_amount;
                            // record.set('not_include_amount', not_include_amount);
                        }
                    } else if (tax_flag == 'N') {
                        // record.set('not_include_amount', amount);
                    }
                } else if (name == "tax_type_rate") {
                    amount = record.get('amount');
                    tax_type_rate = record.get('tax_type_rate');
                    if (!isNaN(tax_type_rate)) {
                        tax_amount = (amount * tax_type_rate) / 100;
                        record.set('tax_amount', tax_amount);
                        // not_include_amount = amount - tax_amount;
                        // record.set('not_include_amount', not_include_amount);
                    }
                } else if (name == "tax_flag") {
                    if (record.get('tax_flag') == 'Y') {
                        // record.getMeta().getField('tax_type_desc').setRequired(true);
                        record.getMeta().getField('tax_type_desc').setReadOnly(false);
                        // record.getMeta().getField('tax_amount').setRequired(true);
                        record.getMeta().getField('tax_amount').setReadOnly(false);
                    } else if (record.get('tax_flag') == 'N') {
                        record.set('tax_type_id', '');
                        record.set('tax_type_rate', '');
                        record.set('tax_type_desc', '');
                        record.getMeta().getField('tax_type_desc').setRequired(false);
                        record.getMeta().getField('tax_type_desc').setReadOnly(true);
                        // record.set('tax_amount', '');
                        // record.getMeta().getField('tax_amount').setRequired(false);
                        // record.getMeta().getField('tax_amount').setReadOnly(true);
                    }
                } else if (name == 'tax_amount') {
                    record.set('not_include_amount', record.get('amount') - record.get('tax_amount'));
                	// 	} else if (name == 'clause_template_id') {
                    // $('con_contract_atm_files_ds').setQueryParameter('source_table_name', 'CONT_ATM_UPLOAD');
                    // $('con_contract_atm_files_ds').setQueryParameter('source_pk_value', record.get('clause_template_id'));
                    // if (record.get('contract_header_id') != undefined) {
                    // $('con_contract_atm_files_ds').setQueryParameter('contract_header_id', record.get('contract_header_id'));
                    // } else {
                    // $('con_contract_atm_files_ds').setQueryParameter('contract_header_id', '0');
                    // }
                    // $('con_contract_atm_files_ds').query();
                } else if (name == 'long_term_flag') {
                    if (value == 'Y') {
                        record.getMeta().getField('end_date').setRequired(false);
                        record.getMeta().getField('end_date').setReadOnly(true);
                    } else {
                        record.getMeta().getField('end_date').setRequired(true);
                        record.getMeta().getField('end_date').setReadOnly(false);
                    }
                }else if(name == 'batch_create_ckb'){
                    if(value == 'Y'){
                        $('add_btn').show();
                        $('del_btn').show();
                        record.getMeta().getField('clause_template_name').setRequired(false);
                        record.getMeta().getField('clause_template_name').setReadOnly(true);
                    }else{
                        $('add_btn').hide();
                        $('del_btn').hide();
                        record.getMeta().getField('clause_template_name').setRequired(true);
                        record.getMeta().getField('clause_template_name').setReadOnly(false);
                    }
                }
                
            }
            
            function con5010_con_headers_ds_rules(record, contract_type) {
                if (contract_type == 'UNIVERSAL_CON') {
            
                    record.getMeta().getField('currency_name').setRequired(true);
                    record.getMeta().getField('currency_name').setReadOnly(false);
            
                    record.getMeta().getField('receipt_payment_desc').setRequired(true);
                    record.getMeta().getField('receipt_payment_desc').setReadOnly(false);
            
                    record.getMeta().getField('payment_method_desc').setRequired(true);
                    record.getMeta().getField('payment_method_desc').setReadOnly(false);
            
                    // record.getMeta().getField('tax_flag_desc').setRequired(true);
                    // record.getMeta().getField('tax_flag_desc').setReadOnly(false);
            
                    record.getMeta().getField('amount').setRequired(true);
                    record.getMeta().getField('amount').setReadOnly(false);
                } else if (contract_type == 'ATM_CON') {
            
                    record.set('language', '');
                    record.set('clause_template_id', '');
                    record.set('clause_template_name', '');
                    record.getMeta().getField('clause_template_name').setRequired(false);
                    record.getMeta().getField('clause_template_name').setReadOnly(true);
            
                    record.set('currency_code', '');
                    record.set('currency_name', '');
                    record.getMeta().getField('currency_name').setRequired(false);
                    record.getMeta().getField('currency_name').setReadOnly(true);
            
                    record.set('receipt_payment', '');
                    record.set('receipt_payment_desc', '');
                    record.getMeta().getField('receipt_payment_desc').setRequired(false);
                    record.getMeta().getField('receipt_payment_desc').setReadOnly(true);
            
                    record.set('payment_method', '');
                    record.set('payment_method_desc', '');
                    record.getMeta().getField('payment_method_desc').setRequired(false);
                    record.getMeta().getField('payment_method_desc').setReadOnly(true);
            
                    record.set('tax_flag', '');
                    // record.set('tax_flag_desc', '');
                    // record.getMeta().getField('tax_flag_desc').setRequired(false);
                    // record.getMeta().getField('tax_flag_desc').setReadOnly(true);
            
                    record.set('tax_type_id', '');
                    record.set('tax_type_rate', '');
                    record.set('tax_type_desc', '');
                    record.getMeta().getField('tax_type_desc').setRequired(false);
                    record.getMeta().getField('tax_type_desc').setReadOnly(true);
            
                    // record.set('not_include_amount', '');
                    // record.getMeta().getField('not_include_amount').setRequired(false);
                    // record.getMeta().getField('not_include_amount').setReadOnly(true);
            
                    // record.set('tax_amount', '');
                    // record.getMeta().getField('tax_amount').setRequired(false);
                    // record.getMeta().getField('tax_amount').setReadOnly(true);
            
                    record.set('amount', '');
                    record.getMeta().getField('amount').setRequired(false);
                    record.getMeta().getField('amount').setReadOnly(true);
            
                    var bds = $('con5010_contract_business_lines_ds');
                    var brecords = bds.getAll();
                    if (brecords.length >= 1) {
                        for (var i = 0;i < brecords.length;i++) {
                            if (brecords[i].isNew) {
                                bds.remove(brecords);
                            }
                        }
                    }
            
                    var ads = $('con5010_contract_atm_lines_ds');
                    var arecords = ads.getAll();
                    if (arecords.length >= 1) {
                        for (var j = 0;j < arecords.length;j++) {
                            if (arecords[j].isNew) {
                                ads.remove(arecords);
                            }
                        }
                    }
            
                    var pds = $('con5010_contract_partner_lines_ds');
                    var precords = pds.getAll();
                    if (precords.length >= 1) {
                        for (var k = 0;k < precords.length;k++) {
                            if (precords[k].isNew) {
                                ads.remove(precords);
                            }
                        }
                    }
            
                }
            }
            
            function con5010ValueFun(record, name) {
                if (name == 'contract_business_line_value') {
                    var editor = record.get('custom_field_editor');
                    if (editor == 'CHAR') {
                        return 'con5010_business_lines_tf';
                    } else if (editor == 'NUMBER') {
                        return 'con5010_business_lines_nf';
                    } else if (editor == 'DATE') {
                        return 'con5010_business_lines_dp';
                    } else if (editor == 'TIME') {
                        return 'con5010_business_lines_dtp';
                    }
                }
            }
            
            function onBusinessRendererFun(value, record, name) {
                if (name == 'contract_business_line_value') {
                    var editor = record.get('custom_field_editor');
                    var contract_business_line_id = record.get('contract_business_line_id');
                    if (editor == 'DATE') {
                        return Aurora.formatDate(value);
                    } else if (editor == 'TIME') {
                        return Aurora.formatDateTime(value);
                    } else if (editor == 'IMG') {
                        if (!record.isNew && contract_business_line_id != undefined) {
                            return '<a href="javascript:con5010_business_uploadordownload_file(\'' + contract_business_line_id + '\')">${l:CON_CONTRACT_ATM_LINES.UPLOAD/DOWNLOAD}</a>';
                        }
                    }
                }
                return value;
            }
            
            function con5010_business_uploadordownload_file(id) {
                var url;
                Aurora.showConfirm('${l:PROMPT}', '${l:SRM_ATM_UNIQ}', function(cmp) {
                    url = $('con5010_attachment_file_upload_link').getUrl() + "?table_name=CON_CONTRACT_BUSINESS_LINES&header_id=" + id;
                    new Aurora.Window({
                        url: url,
                        title: '${l:CON_CONTRACT_ATM_LINES.UPLOAD/DOWNLOAD}',
                        id: 'con5010_uploadordownload_window',
                        width: 850,
                        height: 500
                    }).on('beforeclose', function() {
                        Aurora.request({
                            url: $('con5010_update_file_path_link').getUrl(),
                            para: {
                                contract_header_id: contract_header_id_bak || $('con5010_contract_header_ds').getAt(0).get('contract_header_id'),
                                contract_business_line_id: id
                            },
                            success: function(args) {
                                if (args.result.error_code == '-1') {
                                    Aurora.showWarningMessage('${l:PROMPT}', '${l:CON_CONTRACT_HEADERS.ATM_ONLY_ONE}');
                                } else {
                                    $('con5010_contract_business_lines_ds').setQueryParameter('contract_header_id', contract_header_id_bak);
                                    $('con5010_contract_business_lines_ds').query();
                                }
                            },
                            scope: this
                        });
                    });
                }, null, null, 85);
            }
            
            function con5010_save_fun() {
                if (!$('con5010_contract_header_ds').validate()) {
                    return;
                }
                if (contract_header_id_bak) {
                    Aurora.showConfirm('${l:PROMPT}', '${l:CON5010.OVERRIDE_CONFIRM}', function(cmp) {
                        $('con5010_contract_header_ds').submit();
                    });
                } else {
                    $('con5010_contract_header_ds').submit();
                }
            }
            
            function con5010PartnerLoadFun(ds) {
                var records = $('con5010_contract_partner_lines_ds').getAll();
                for (var i = 0;i < records.length;i++) {
            
                    if (records[i].get('partner_code')) {
                        records[i].getMeta().getField('partner_desc').setReadOnly(true);
                    }
                }
            }
            
            function con5010PartnerAddFun(dataSet, record, index) {
                record.data['line_num'] = 10 * (index + 1);
            }
            
            function con5010PartnerUpdateFun(dataSet, record, name, value, oldvalue) {
                if (name == 'partner_code') {
                    if (oldvalue != undefined || oldvalue != null) {
                        if (value == '') {
                            record.getMeta().getField('partner_desc').setReadOnly(false);
                        }
                    } else {
                        record.getMeta().getField('partner_desc').setReadOnly(true);
                    }
                }
            
            }
            
            function con5010ObjectAddFun(dataSet, record, index) {
                record.data['line_num'] = 10 * (index + 1);
                record.data['currency_name'] = $('con5010_contract_header_ds').getAt(0).get('currency_name');
                record.data['currency_code'] = $('con5010_contract_header_ds').getAt(0).get('currency_code');
            }
            
            function con5010ObjectUpdateFun(dataSet, record, name, value, oldvalue) {
                if (name == 'contract_object_line_code') {
                    if (oldvalue != undefined || oldvalue != null) {
                        if (value == '') {
                            record.getMeta().getField('contract_object_line_name').setReadOnly(false);
                        }
                    } else {
                        record.getMeta().getField('contract_object_line_name').setReadOnly(true);
                    }
                }
            
                if (name == 'price' || name == 'primary_quantity') {
                    var primary_quantity = (record.get('primary_quantity') == null) ? 1 : record.get('primary_quantity');
                    var price = record.get('price');
                    var amount = primary_quantity * price;
                    record.set('amount', amount);
                }
            }
            
            function con5010BusinessAddFun(dataSet, record, index) {
                record.data['line_num'] = 10 * (index + 1);
            }
            
            function con5010StageAddFun(dataSet, record, index) {
                record.data['line_num'] = 10 * (index + 1);
                record.data['currency_name'] = $('con5010_contract_header_ds').getAt(0).get('currency_name');
                record.data['currency_code'] = $('con5010_contract_header_ds').getAt(0).get('currency_code');
            }
            
            function con5010_dateValidator(record, name, value) {
                var start_date;
                var end_date;
                if (name == 'end_date') {
                    start_date = Aurora.formatDate(record.get('start_date'));
                    end_date = Aurora.formatDate(record.get('end_date'));
                    if (value != undefined) {
                        if (end_date < start_date) {
                            return '${l:CON_CONTRACT_HEADERS.END_DATE_START_DATE}';
            
                        } else {
                            return true;
                        }
                    } else {
                        return true;
                    }
                }
            }
            
            function onCon5010PartnerCellClickFun(grid, row, name, record) {
                if (name == "partner_code") {
                    record.set('partner_category', 'VENDER');
                    record.getField('partner_code').setLovPara('company_id', $('con5010_contract_header_ds').getAt(0).get('company_id'));
                }
            }
            
            function onCon5010AtmCellClickFun(grid, row, name, record) {
                if (name == "atm_type_name") {
                    record.getField('atm_type_name').setLovPara('direction_id', $('con5010_contract_header_ds').getAt(0).get('direction_id'));
                }
            }
            
            function con5010_success_dispatch(ds, res) {
                //debugger;
                // // Aurora.showMessage('${l:PROMPT}', '${l:PROMPT.OPERATION_SUCCESS}');
                // // lock_current_window();
                // var rec = ds.getCurrentRecord();
                // var head_id = contract_header_id_bak == '' ? res.result.record.contract_header_id : contract_header_id_bak;
                // var templt_id = rec.data.clause_template_id;
                // Ext.get('con5010_published').show();
                // // Ext.get('con5010_download').show();
                // Ext.get('con5010_delete').show();
                // Ext.get('con5010_histories').show();
                // // Ext.get('con5010_edit').show();
            
                // var contract_type_code = rec.get('contract_type_code');
                // if (contract_type_code == 'UNIVERSAL_CON') {
                // diaplayBtn('con5010_upload_atm');
                // } else if (contract_type_code == 'ATM_CON') {
                // Ext.get('con5010_upload_atm').show();
                // }
                // $('con5010_contract_header_ds').setQueryParameter('contract_header_id', head_id);
                // $('con5010_contract_header_ds').query();
                // $('con5010_contract_partner_lines_ds').setQueryParameter('contract_header_id', head_id);
                // $('con5010_contract_partner_lines_ds').query();
                // $('con5010_contract_atm_lines_ds').setQueryParameter('contract_header_id', head_id);
                // $('con5010_contract_atm_lines_ds').query();
                // $('con5010_contract_object_lines_ds').setQueryParameter('contract_header_id', head_id);
                // $('con5010_contract_object_lines_ds').query();
                // $('con5010_contract_business_lines_ds').setQueryParameter('contract_header_id', head_id);
                // $('con5010_contract_business_lines_ds').query();
                // $('con5010_contract_stage_lines_ds').setQueryParameter('contract_header_id', head_id);
                // $('con5010_contract_stage_lines_ds').query();
                // contract_header_id_bak = head_id;
            
                // //保存成功后生成合同
                // var templt_name = 'con_contract.xml';
                // var templet_id = rec.get('clause_template_id');
                // var url = $('con5010_contract_update_print_link').getUrl() + '?templt_name=' + templt_name + '&contract_header_id=' + contract_header_id_bak + '&templet_id=' + templet_id;
                // var form = document.createElement("form");
                // form.target = "word_export_window";
                // form.method = "post";
                // form.action = url;
                // var iframe = Ext.get('word_export_window') || new Ext.Template('<iframe id ="word_export_window" name="word_export_window" style="position:absolute;left:-10000px;top:-10000px;width:1px;height:1px;display:none"></iframe>').insertFirst(document.body, {}, true);
                // document.body.appendChild(form);
                // form.submit();
                // Ext.fly(form).remove();
                // Aurora.request({
                // url: $('con5010_save_link').getUrl() + '?contract_header_id=' + contract_header_id_bak + '&clause_template_id=' + templt_id,
                // success: function() {
                // Aurora.Masker.unmask($('con5010_contract_maintain_window').wrap);
                // $('con_contract_atm_files_ds').query();
                // },
                // error: function() {
                // Aurora.Masker.unmask($('con5010_contract_maintain_window').wrap);
                // },
                // failure: function() {
                // Aurora.Masker.unmask($('con5010_contract_maintain_window').wrap);
                // },
                // scope: this
                // });
            
                // Aurora.showMessage('${l:PROMPT}', '${l:PROMPT.OPERATION_SUCCESS}');
                // // unlock_current_window();
            
                var rec = ds.getCurrentRecord();
                var head_id = contract_header_id_bak == '' ? res.result.record.contract_header_id : contract_header_id_bak;
                contract_header_id_bak = head_id;
                Ext.get('con5010_published').show();
                // Ext.get('con5010_download').show();
                Ext.get('con5010_delete').show();
                Ext.get('con5010_histories').show();
                Ext.get('con5010_edit').show();
                // Ext.get('con5010_recipient_atm_view').show();
            
                var contract_type_code = rec.get('contract_type_code');
                // if (contract_type_code != 'ATM_CON') {
                    // //保存成功后生成合同
                    // lock_current_window();
                    // Aurora.request({
                        // url: $('con5010_contract_update_print_link').getUrl(),
                        // para: {
                            // 'contract_header_id': head_id,
                            // 'templet_id': rec.get('clause_template_id')
                        // },
                        // success: function(args) {
                            // unlock_current_window();
                        // },
                        // failure: function(args) {
                            // console.log('failure');
                            // unlock_current_window();
                        // },
                        // error: function(args) {
                            // console.log('error');
                            // unlock_current_window();
                        // },
                        // scope: this
                    // });
                // } else if (contract_type_code == 'ATM_CON') {
                    // Ext.get('con5010_upload_atm').show();
                // }
                $('con5010_contract_header_ds').setQueryParameter('contract_header_id', head_id);
                $('con5010_contract_header_ds').query();
                $('con5010_contract_partner_lines_ds').setQueryParameter('contract_header_id', head_id);
                $('con5010_contract_partner_lines_ds').query();
                $('con5010_contract_atm_lines_ds').setQueryParameter('contract_header_id', head_id);
                $('con5010_contract_atm_lines_ds').query();
                $('con5010_contract_object_lines_ds').setQueryParameter('contract_header_id', head_id);
                $('con5010_contract_object_lines_ds').query();
                $('con5010_contract_business_lines_ds').setQueryParameter('contract_header_id', head_id);
                $('con5010_contract_business_lines_ds').query();
                $('con5010_contract_stage_lines_ds').setQueryParameter('contract_header_id', head_id);
                $('con5010_contract_stage_lines_ds').query();
                // $('con5010_payment_header_ds').setQueryParameter('contract_header_id', head_id);
                // $('con5010_payment_header_ds').query();
                // $('con5010_payment_lines_ds').setQueryParameter('contract_header_id', head_id);
                // $('con5010_payment_lines_ds').query();
                // $('con5010_con_retention_ds').setQueryParameter('contract_header_id', head_id);
                // $('con5010_con_retention_ds').query();
            
            
                Aurora.showMessage('${l:PROMPT}', '${l:PROMPT.OPERATION_SUCCESS}');
            }
            
            function con5010_con_headers_ds_query(ds) {
                //debugger;
                var record = $('con5010_contract_header_ds').getAt(0);
                var status = record.get('status');
                if (record.get('contract_number')) {
                    var headMeta = record.getMeta();
            
                    for (var i = 0;i < headFields.length;i++) {
                        headMeta.getField(headFields[i]).setReadOnly(true);
                    }
                }
                if (record.get('contract_type_code') == 'UNIVERSAL_CON') {
                    if (status == 'NEW' || status == 'REFUSED') {
                        record.getMeta().getField('clause_template_name').setRequired(true);
                        record.getMeta().getField('clause_template_name').setReadOnly(false);
                    }
                    record.getField('clause_template_name').setLovPara('templet_id', record.get('clause_template_id'));
            
                    record.getMeta().getField('currency_name').setRequired(true);
                    record.getMeta().getField('currency_name').setReadOnly(false);
            
                    record.getMeta().getField('receipt_payment_desc').setRequired(true);
                    record.getMeta().getField('receipt_payment_desc').setReadOnly(false);
            
                    record.getMeta().getField('payment_method_desc').setRequired(true);
                    record.getMeta().getField('payment_method_desc').setReadOnly(false);
            
                    // record.getMeta().getField('tax_flag_desc').setRequired(true);
                    // record.getMeta().getField('tax_flag_desc').setReadOnly(false);
            
                    record.getMeta().getField('amount').setRequired(true);
                    record.getMeta().getField('amount').setReadOnly(false);
            
                    if (record.get('tax_flag') == 'Y') {
                        record.getMeta().getField('tax_type_desc').setRequired(true);
                        record.getMeta().getField('tax_type_desc').setReadOnly(false);
                        // record.getMeta().getField('tax_amount').setRequired(true);
                        // record.getMeta().getField('tax_amount').setReadOnly(false);
                    } else if (record.get('tax_flag') == 'N') {
                        record.set('tax_type_id', '');
                        record.set('tax_type_rate', '');
                        record.set('tax_type_desc', '');
                        record.getMeta().getField('tax_type_desc').setRequired(false);
                        record.getMeta().getField('tax_type_desc').setReadOnly(true);
                        // record.set('tax_amount', '');
                        // record.getMeta().getField('tax_amount').setRequired(false);
                        // record.getMeta().getField('tax_amount').setReadOnly(true);
                    }
            
                } else if (record.get('contract_type_code') == 'ATM_CON') {
                    record.set('currency_code', '');
                    record.set('currency_name', '');
                    record.getMeta().getField('currency_name').setRequired(false);
                    record.getMeta().getField('currency_name').setReadOnly(true);
            
                    record.set('receipt_payment', '');
                    record.set('receipt_payment_desc', '');
                    record.getMeta().getField('receipt_payment_desc').setRequired(false);
                    record.getMeta().getField('receipt_payment_desc').setReadOnly(true);
            
                    record.set('payment_method', '');
                    record.set('payment_method_desc', '');
                    record.getMeta().getField('payment_method_desc').setRequired(false);
                    record.getMeta().getField('payment_method_desc').setReadOnly(true);
            
                    record.set('tax_flag', '');
                    // record.set('tax_flag_desc', '');
                    // record.getMeta().getField('tax_flag_desc').setRequired(false);
                    // record.getMeta().getField('tax_flag_desc').setReadOnly(true);
            
                    record.set('tax_type_id', '');
                    record.set('tax_type_rate', '');
                    record.set('tax_type_desc', '');
                    record.getMeta().getField('tax_type_desc').setRequired(false);
                    record.getMeta().getField('tax_type_desc').setReadOnly(true);
            
                    // record.set('not_include_amount', '');
                    // record.getMeta().getField('not_include_amount').setRequired(false);
                    // record.getMeta().getField('not_include_amount').setReadOnly(true);
            
                    record.getMeta().getField('amount').setRequired(false);
                    record.getMeta().getField('amount').setReadOnly(true);
            
                    record.set('tax_amount', '');
                    record.getMeta().getField('tax_amount').setRequired(false);
                    record.getMeta().getField('tax_amount').setReadOnly(true);
            
            
                }
            
                if (record.get('long_term_flag') == 'Y') {
                    record.getMeta().getField('start_date').setRequired(false);
                    record.getMeta().getField('start_date').setReadOnly(true);
                    record.getMeta().getField('end_date').setRequired(false);
                    record.getMeta().getField('end_date').setReadOnly(true);
                }
                
                record.set('contract_property_code', 'OUTSIDE_CON');
                record.set('contract_property_name', '外部合同');
                record.set('contract_type_code', 'UNIVERSAL_CON');
                record.set('contract_type_name', '普通合同');
            }
            
            function con5010ConGetAtmLinesFun(ds) {
                $('con5010_contract_atm_lines_ds').removeAll();
            
                var r = ds.getAll();
                for (var t = 0;t < r.length;t++) {
                    record = $('con5010_contract_atm_lines_ds').create();
                    record.set('atm_type_id', r[t].get('atm_type_id'));
                    record.set('atm_type_name', r[t].get('atm_type_name'));
                    record.set('required_flag', r[t].get('required_flag'));
                }
            }
            
            function con5010ConGetBusinessLinesFun(ds) {
                $('con5010_contract_business_lines_ds').removeAll();
            
                var r = ds.getAll();
                for (var t = 0;t < r.length;t++) {
                    record = $('con5010_contract_business_lines_ds').create();
                    if (r[t].get('custom_field_editor') == 'IMG' || r[t].get('contract_type') == 'ATM_CON' || r[t].get('vendor_flag') == 'Y') {
                        record.getMeta().getField('contract_business_line_value').setRequired(false);
                    } else {
                        record.getMeta().getField('contract_business_line_value').setRequired(true);
                    }
                    //record.set('line_num', r[t].get('line_num'));
                    record.set('custom_field_id', r[t].get('custom_field_id'));
                    record.set('contract_business_line_code', r[t].get('contract_business_line_code'));
                    record.set('contract_business_line_name', r[t].get('contract_business_line_name'));
                    record.set('custom_field_editor', r[t].get('custom_field_editor'));
                    record.set('note', r[t].get('note'));
                    record.set('vendor_flag', r[t].get('vendor_flag'));
                }
            }
            
            function con5010DeleteAtm() {
                var ds = $('con5010_contract_atm_lines_ds');
                var rs = $('con5010_contract_atm_lines_ds').getSelected();
                if (rs.length < 1) {
                    Aurora.showMessage('${l:PROMPT}', '${l:CHOOSE_ONE_RECORD}');
                }
                for (var i = 0;i < rs.length;i++) {
                    if (rs[i].isNew) {
                        ds.remove(rs);
                    }
                }
                var param = $('con5010_contract_atm_lines_ds').getJsonData(true);
                Aurora.request({
                    url: $('con5010_delete_atm_link').getUrl(),
                    para: param,
                    success: function(args) {
                        $('con5010_contract_atm_lines_ds').setQueryParameter('contract_header_id', contract_header_id_bak);
                        $('con5010_contract_atm_lines_ds').query();
                    },
                    scope: this
                });
            }
            
            function con5010DeletePartner() {
                var ds = $('con5010_contract_partner_lines_ds');
                var rs = $('con5010_contract_partner_lines_ds').getSelected();
                if (rs.length < 1) {
                    Aurora.showMessage('${l:PROMPT}', '${l:CHOOSE_ONE_RECORD}');
                }
                for (var i = 0;i < rs.length;i++) {
                    if (rs[i].isNew) {
                        ds.remove(rs);
                    }
                }
                var param = $('con5010_contract_partner_lines_ds').getJsonData(true);
                Aurora.request({
                    url: $('con5010_delete_partner_link').getUrl(),
                    para: param,
                    success: function(args) {
                        //$('con5010_contract_partner_lines_ds').setQueryParameter('contract_header_id', contract_header_id_bak);
                        //$('con5010_contract_partner_lines_ds').query();
                    },
                    scope: this
                });
            }
            
            function con5010DeleteObject() {
                var ds = $('con5010_contract_object_lines_ds');
                var rs = $('con5010_contract_object_lines_ds').getSelected();
                if (rs.length < 1) {
                    Aurora.showMessage('${l:PROMPT}', '${l:CHOOSE_ONE_RECORD}');
                }
                for (var i = 0;i < rs.length;i++) {
                    if (rs[i].isNew) {
                        ds.remove(rs);
                    }
                }
                var param = $('con5010_contract_object_lines_ds').getJsonData(true);
                Aurora.request({
                    url: $('con5010_delete_object_link').getUrl(),
                    para: param,
                    success: function(args) {
                        $('con5010_contract_object_lines_ds').setQueryParameter('contract_header_id', contract_header_id_bak);
                        $('con5010_contract_object_lines_ds').query();
                    },
                    scope: this
                });
            }
            
            function con5010DeleteStage() {
                var ds = $('con5010_contract_stage_lines_ds');
                var rs = $('con5010_contract_stage_lines_ds').getSelected();
                if (rs.length < 1) {
                    Aurora.showMessage('${l:PROMPT}', '${l:CHOOSE_ONE_RECORD}');
                }
                for (var i = 0;i < rs.length;i++) {
                    if (rs[i].isNew) {
                        ds.remove(rs);
                    }
                }
                var param = $('con5010_contract_stage_lines_ds').getJsonData(true);
                Aurora.request({
                    url: $('con5010_delete_stage_link').getUrl(),
                    para: param,
                    success: function(args) {
                        $('con5010_contract_stage_lines_ds').setQueryParameter('contract_header_id', contract_header_id_bak);
                        $('con5010_contract_stage_lines_ds').query();
                    },
                    scope: this
                });
            }
            
            function con5010_del_fun() {
                Aurora.showConfirm('${l:PROMPT}', '${l:CON_CONTRACT_HEADERS.DELETE_CONTRACT}', function(cmp) {
                    if (contract_header_id_bak != '') {
                        Aurora.request({
                            url: $('con5010_delete_link').getUrl(),
                            para: {
                                contract_header_id: contract_header_id_bak
                            },
                            success: function() {
                                con5010_back();
                            },
                            scope: this
                        });
                    }
            
                }, null, null, 85);
            }
            
            //上传合同
            
            function con5010_upload_fun() {
                var url = $('con5010_attachment_file_upload_link').getUrl() + "?table_name=CON_CONTRACT_HEADERS&header_id=" + contract_header_id_bak;
                new Aurora.Window({
                    url: url,
                    title: '${l:CON_CONTRACT_ATM_LINES.UPLOAD/DOWNLOAD}',
                    id: 'con5010_header_uploadordownload_window',
                    width: 850,
                    height: 500
                });
            }
            //退回合同
            
            
            function con5010_return_fun() {
                Aurora.showConfirm('${l:PROMPT}', '是否确认退回？', function(cmp) {
                    Aurora.request({
                        url: $('con5010_publish_return_link').getUrl(),
                        para: {
                            contract_header_id: contract_header_id_bak
                        },
                        success: function() {
                            con5010_back();
                        },
                        scope: this
                    });
                }, null, null, 85);
            }
            //发布合同
            //2017年11月9日 10:25:21
            //MODIFY:提交
            
            function con5010_published_fun() {
                if ($('con5010_contract_header_ds').isModified()) {
                    Aurora.showInfoMessage('${l:PROMPT}', '${l:PROMPT.SAVE_SUBMIT}', null, 250, 100);
                    return;
                }
                Aurora.showConfirm('${l:PROMPT}', '${l:DOCUMNET_SUBMIT_CONFIRM}', function(cmp) {
                    Aurora.request({
                        url: $('con5010_publish_con_link').getUrl(),
                        para: {
                            contract_header_id: contract_header_id_bak
                        },
                        success: function() {
                            con5010_back();
                        },
                        scope: this
                    });
                }, null, null, 85);
            }
            
            //终止合同
            
            function con5010_terminal_fun() {
                Aurora.showConfirm('${l:PROMPT}', '${l:CON_CONTRACT_HEADERS.TERMINAL_CONTRACT}', function(cmp) {
                    new Aurora.Window({
                        id: 'con5010_contract_terminal_window2',
                        url: $('con5010_contract_detail_terminal_link').getUrl(),
                        params: null,
                        title: '',
                        height: 150,
                        width: 456
                    });
                }, null, null, 85);
            }
            
            //生成合同文本
            
            function con5010_generte_fun() {
                //Aurora.showConfirm('${l:PROMPT}', '${l:CON_CONTRACT_HEADERS.GENERTE_CONTRACT}', function(cmp) {
                if (contract_header_id_bak != '') {
            
                    Aurora.request({
                        url: $('con5010_generate_maintain_load_data_link').getUrl(),
                        para: {
                            contract_header_id: contract_header_id_bak,
                            templet_id: $('con5010_contract_header_ds').getAt(0).get('clause_template_id')
                        },
                        success: function() {
                            //初始数据成功后打开生成文本页面
                            new Aurora.Window({
                                url: $('con5010_contract_generate_maintain_link').getUrl() + '?contract_header_id=' + contract_header_id_bak + '&templet_id=' + $('con5010_contract_header_ds').getAt(0).get('clause_template_id') + '&language=' + $('con5010_contract_header_ds').getAt(0).get('language') + '&clause_usage=' + $('con5010_contract_header_ds').getAt(0).get('DIRECTION_ID'),
                                title: '${l:CON_CONTRACT_HEADERS.GENERTE_CONTRACT_TEXT}',
                                id: 'con5010_generate_maintain_window',
                                // width: 850,
                                // height: 500
                                fullScreen: true
                            });
                        },
                        scope: this
                    });
                }
            
                //}, null, null, 85);
            }
            //编辑合同按钮
            
            function con5010_edit_fun() {
                var head_record = $('con5010_contract_header_ds').getCurrentRecord();
                if (head_record.get('status') == 'CONFIRMED') {
                    Aurora.showMessage('${l:PROMPT}', '${l:CON5010.EDIT_STATUS_ERROR}');
                    return;
                }
                var table_name;
                if (head_record.get('contract_type_code') == 'UNIVERSAL_CON' || head_record.get('contract_type_code') == 'CHANGES_CON') {
                    table_name = 'CON_CONTRACT_DOC';
                } else if (head_record.get('contract_type_code') == 'ATM_CON') {
                    table_name = 'CON_CONTRACT_HEADERS';
                }
                var editor_url;
                //兼容IE10
                if (!window.location.origin) {
                    window.location.origin = window.location.protocol + "//" + window.location.hostname + (window.location.port ? ':' + window.location.port : '');
                }
                var file_url = window.location.origin + $('con5010_office_fileurl_link').getUrl();
                var upload_url = window.location.origin + $('con5010_office_uploadurl_link').getUrl();
                lock_current_window();
                Aurora.request({
                    url: $('con5010_contract_get_editurl_link').getUrl(),
                    para: {
                        'document_id': contract_header_id_bak,
                        'table_name': table_name,
                        'edit_code': 'TEST_OFFICE_EDITOR_FULL',
                        'file_url': file_url,
                        'upload_url': upload_url,
                        'custom_para': '&fileType=contract'
                    },
                    success: function(args) {
                        unlock_current_window();
                        editor_url = args.result.edit_url;
                        con5010_contract_query();
                        con5010_edit_contract_online(editor_url);
                    },
                    failure: function() {
                        unlock_current_window();
                        con5010_contract_query();
                    },
                    error: function() {
                        unlock_current_window();
                        con5010_contract_query();
                    },
                    scope: this
                });
            }
            
            //操作记录按钮
            
            function con5010_histories_fun() {
                new Aurora.Window({
                    id: 'con_contract_histories_window',
                    url: $('con5010_contract_histories_link').getUrl() + '?contract_header_id=' + contract_header_id_bak,
                    params: null,
                    title: '',
                    height: 460,
                    width: 730
                });
            }
            
            function con5010_company_commit(lov, r1, r2) {
                r1.getMeta().getField('contract_object_name').setReadOnly(false);
                r1.getMeta().getField('contract_object_name').setRequired(true);
            }
            
            //合同下载
            
            function con5010_download_fun() {
                var records = $('con5010_contract_header_ds').getAll();
                if (records.length != 1) {
                    Aurora.showMessage('${l:PROMPT}', '${l:SELECT_RECORD}');
                    return;
                }
                var contract_header_id = records[0].get('contract_header_id');
                var download_url;
                lock_current_window();
                //请求下载地址
                Aurora.request({
                    url: $('con5010_contract_download_link').getUrl() + '/query',
                    para: {
                        'contract_header_id': contract_header_id
                    },
                    success: function(args) {
                        if (!args.result.record.download_url) {
                            Aurora.showMessage('${l:PROMPT}', '${l:CON5010.NO_DOC}');
                            unlock_current_window();
                        } else {
                            download_url = args.result.record.download_url;
                            unlock_current_window();
                            window.open(download_url, '_self');
                        }
                    },
                    error: function() {
                        unlock_current_window();
                        con5010_contract_query();
                    },
                    scope: this
                });
            }
            
            //采购方在线签章
            
            function con5010SignOnline() {
                var rs = $('con5010_contract_header_ds').getCurrentRecord();
                if (rs.get('status') != 'CONFIRMED') {
                    Aurora.showMessage('${l:PROMPT}', '${l:CON5010.SIGN_STATUS_ERROR}');
                    return;
                }
                var param = rs.data;
                Aurora.showConfirm('${l:PROMPT}', '${l:CON5020.CONFIRM_SIGN}', function(cmp) {
                    lock_current_window();
                    Aurora.request({
                        url: $('con5010_con_sign_link').getUrl(),
                        para: param,
                        success: function(res) {
                            if (!res.result.attribute10) {
                                Aurora.showMessage('${l:PROMPT}', '${l:CON5010.NO_DOC}');
                            } else {
                                // con5020_sign_contract_online(res.result.attribute10);
                                window.open(res.result.attribute10, param);
                                unlock_current_window();
                            }
                        },
                        error: function() {
                            unlock_current_window();
                            con5010_contract_query();
                        },
                        scope: this
                    });
                }, null, null, 85);
            }
            
            //合同直接确认
            
            function con5010Effect() {
                Aurora.showConfirm('${l:PROMPT}', '${l:CON5020.CONFIRM_SIGN}', function(cmp) {
                    if (contract_header_id_bak != '') {
                        Aurora.request({
                            url: $('con5010_effect_contract_link').getUrl() + '/execute',
                            para: {
                                contract_header_id: contract_header_id_bak
                            },
                            success: function() {
                                con5010_back();
                            },
                            scope: this
                        });
                    }
                }, null, null, 85);
            }
            
            //合同签署
            
            function con5010_sign_fun() {
                if ('Y' == g_sign_online_flag) {
                    //通过在线签章确认
                    con5010SignOnline();
                } else {
                    //直接确认
                    con5010Effect();
                }
            }
            
            function kw1010_upload_render(value, record, name) {
                var atm_line_id = record.get('atm_line_id');
                var atm_id = record.get('atm_id');
                var atm_counts = record.get('atm_counts');
                var vendor_atm_counts = record.get('vendor_atm_counts');
                if (name == "attachment") {
                    return '<a href="javascript:qms8010_upload_file_readonly(' + atm_line_id + ')">附件查看</a>';
                }
            
                if (name == "vendor_attachment") {
                    return '<a href="javascript:qms8010_vendor_file_readonly(' + atm_id + ')">附件查看</a>';
                }
            
                if (name == "atm_flag") {
                    if (atm_counts > 0) {
                        return '<div style="margin-top:3px;margin-left:auto;margin-right:auto;vertical-align:middle;height:20px;line-height:20px;"><img src="${/request/@context_path}/images/paperclip.png"/></div>';
                    } else {
                        return '';
                    }
                }
                if (name == "vendor_atm_flag") {
                    if (vendor_atm_counts > 0) {
                        return '<div style="margin-top:3px;margin-left:auto;margin-right:auto;vertical-align:middle;height:20px;line-height:20px;"><img src="${/request/@context_path}/images/paperclip.png"/></div>';
                    } else {
                        return '';
                    }
                }
            }
            
            function qms8010_upload_file_readonly(id) {
                var url = "${/request/@context_path}/uploadFileView.screen?table_name=CONT_ATM_UPLOAD&header_id=" + id;
                new Aurora.Window({
                    url: url,
                    title: '附件查看',
                    id: 'qms8010_entrustment_edit_atm_window',
                    width: 850,
                    height: 500
                });
            } //附件查看
            
            function qms8010_vendor_file_readonly(id) {
                var url = "${/request/@context_path}/uploadFileView.screen?table_name=CONT_VENDOR_ATM_UPLOAD&header_id=" + id;
                new Aurora.Window({
                    url: url,
                    title: '附件查看',
                    id: 'qms8010_entrustment_edit_atm_window',
                    width: 850,
                    height: 500
                });
            } //附件查看
        ]]></script>
        <a:dataSets>
            <a:dataSet id="con5010_contract_types_ds">
                <a:datas dataSource="/model/contract_types"/>
            </a:dataSet>
            <a:dataSet id="con5010_contract_propertys_ds">
                <a:datas dataSource="/model/contract_propertys"/>
            </a:dataSet>
            <a:dataSet id="con5010_contract_status_ds">
                <a:datas dataSource="/model/contract_status"/>
            </a:dataSet>
            <a:dataSet id="con5010_contract_receipt_payments_ds">
                <a:datas dataSource="/model/contract_receipt_payments"/>
            </a:dataSet>
            <a:dataSet id="con5010_tax_flag_ds" lookupCode="YES_NO"/>
            <a:dataSet id="con5010_contract_partner_types_ds" loadData="true" model="cont.CON2020.con_contract_partner_types_cmb"/>
            <a:dataSet id="con5010_contract_payment_methods_ds" loadData="true" model="cont.CON5010.con_contract_csh_payment_methods_cmb"/>
            <a:dataSet id="con5010_contract_get_atm_lines_ds" model="cont.CON5010.con_contract_get_atm_lines">
                <a:events>
                    <a:event name="load" handler="con5010ConGetAtmLinesFun"/>
                </a:events>
            </a:dataSet>
            <a:dataSet id="con5010_contract_get_business_lines_ds" model="cont.CON5010.con_contract_get_business_lines">
                <a:events>
                    <a:event name="load" handler="con5010ConGetBusinessLinesFun"/>
                </a:events>
            </a:dataSet>
            <a:dataSet id="con5010_contract_header_ds" autoCount="false" fetchAll="true" model="cont.CON5010.con_contract_headers_query" selectable="true" submitUrl="${/request/@context_path}/modules/cont/CON5010/con_contract_update.svc">
                <a:datas dataSource="/model/con5010_contract_header_init_source"/>
                <a:fields>
                    <a:field name="batch_create_ckb" checkedValue="Y" defaultValue="N" uncheckedValue="N"/>
                    <a:field name="contract_header_id"/>
                    <a:field name="contract_number" readOnly="true"/>
                    <a:field name="contract_desc" required="true"/>
                    <a:field name="status"/>
                    <a:field name="status_desc" readOnly="true"/>
                    <a:field name="contract_type_code"/>
                    <a:field name="contract_type_name" displayField="flex_desc" options="con5010_contract_types_ds" returnField="contract_type_code" valueField="flex_value"/>
                    <a:field name="contract_property_code"/>
                    <a:field name="contract_property_name" displayField="flex_desc" options="con5010_contract_propertys_ds" readOnly="true" returnField="contract_property_code" valueField="flex_value"/>
                    <a:field name="direction_name" lovGridHeight="320" lovHeight="450" lovService="cont.CON2010.con_contract_direction_lov" lovWidth="520" title="CON201.CON_BASIC_CLAUSE.CLAUSE_USAGE_NAME">
                        <a:mapping>
                            <a:map from="direction_name" to="direction_name"/>
                            <a:map from="direction_id" to="direction_id"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="direction_id" defaultValue="1"/>
                    <a:field name="clause_template_id"/>
                    <a:field name="clause_template_name" lovGridHeight="320" lovHeight="450" lovService="cont.CON5010.con_contract_header_clause_template_lov" lovWidth="500" required="true" title="CON202.CON_CLAUSE_TEMPLET.DESCRIPTION">
                        <a:mapping>
                            <a:map from="description" to="clause_template_name"/>
                            <a:map from="language" to="language"/>
                            <a:map from="templet_id" to="clause_template_id"/>
                            <a:map from="templet_code" to="templet_code"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="company_short_name" autoComplete="true" lovGridHeight="320" lovHeight="450" lovService="cont.CON201.fnd_assign_company_lov" lovWidth="500" required="true" title="CON_CONTRACT_HEADERS.COMPANY_SHORT_NAME">
                        <a:mapping>
                            <a:map from="legal_rep_name" to="legal_rep_name"/>
                            <a:map from="business_represent_name" to="business_represent_name"/>
                            <a:map from="business_represent_phone" to="business_represent_phone"/>
                            <a:map from="business_represent_mail" to="business_represent_mail"/>
                            <a:map from="business_address" to="business_address"/>
                            <a:map from="company_code" to="company_code"/>
                            <a:map from="company_desc" to="company_short_name"/>
                            <a:map from="company_id" to="company_id"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="company_id"/>
                    <!-- <a:field name="contract_object_name" autoComplete="true" lovGridHeight="320" lovHeight="530" lovUrl="${/request/@context_path}/modules/cont/CON5010/con_contract_object_select.screen" lovWidth="1000" readOnly="true" title="CON_CONTRACT_HEADERS.CONTRACT_OBJECT_NAME">
                         <a:mapping>
                            <a:map from="company_code" to="contract_object_code"/>
                            <a:map from="company_short_name" to="contract_object_name"/>
                            <a:map from="company_id" to="contract_object_id"/>
                        </a:mapping> -->
                    <a:field name="contract_object_name" autoComplete="true" lovGridHeight="320" lovHeight="450" lovService="cont.CON5010.con_contract_coop_vendor_lov" lovWidth="500" readOnly="true" title="CON_CONTRACT_HEADERS.CONTRACT_OBJECT_NAME">
                        <a:mapping>
                            <a:map from="legal_rep_name" to="legal_rep_name"/>
                            <a:map from="business_represent_name" to="business_represent_name"/>
                            <a:map from="business_represent_phone" to="business_represent_phone"/>
                            <a:map from="business_represent_mail" to="business_represent_mail"/>
                            <a:map from="business_address" to="business_address"/>
                            <a:map from="company_code" to="contract_object_code"/>
                            <a:map from="company_short_name" to="contract_object_name"/>
                            <a:map from="company_id" to="contract_object_id"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="contract_object_id"/>
                    <!-- <a:field name="start_date" required="true" validator="con5010_dateValidator"/> -->
                    <a:field name="start_date" required="true"/>
                    <a:field name="end_date" required="true" validator="con5010_dateValidator"/>
                    <a:field name="project_code"/>
                    <a:field name="master_contract_header_id"/>
                    <a:field name="master_contract_number" lovGridHeight="320" lovHeight="450" lovService="cont.CON5010.con_contract_header_lov" lovWidth="500" title="CON_CONTRACT_HEADERS.MASTER_CONTRACT_NUMBER">
                        <a:mapping>
                            <a:map from="contract_number" to="master_contract_number"/>
                            <a:map from="contract_header_id" to="master_contract_header_id"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="archive_code"/>
                    <a:field name="contract_date"/>
                    <a:field name="effective_date"/>
                    <a:field name="created_by"/>
                    <a:field name="created_by_name" readOnly="true"/>
                    <a:field name="creation_date" readOnly="true"/>
                    <a:field name="currency_code"/>
                    <a:field name="currency_name" lovGridHeight="320" lovHeight="450" lovService="cont.CON5010.con_contract_gld_currency_bg_lov" lovWidth="500" title="CURRENCY_SELECTION">
                        <a:mapping>
                            <a:map from="currency_name" to="currency_name"/>
                            <a:map from="currency_code" to="currency_code"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="receipt_payment"/>
                    <a:field name="receipt_payment_desc" displayField="flex_desc" options="con5010_contract_receipt_payments_ds" returnField="receipt_payment" valueField="flex_value"/>
                    <a:field name="payment_method"/>
                    <a:field name="payment_method_desc" displayField="description" options="con5010_contract_payment_methods_ds" returnField="payment_method" valueField="payment_method_id"/>
                    <a:field name="tax_flag"/>
                    <a:field name="tax_flag_desc" displayField="code_value_name" options="con5010_tax_flag_ds" returnField="tax_flag" valueField="code_value"/>
                    <a:field name="tax_type_id"/>
                    <a:field name="tax_type_rate"/>
                    <a:field name="tax_type_desc" lovGridHeight="320" lovHeight="450" lovService="cont.CON5010.con_contract_tax_type_lov" lovWidth="500" title="CON_CONTRACT_HEADERS.TAX_TYPE_ID">
                        <a:mapping>
                            <a:map from="tax_type_name" to="tax_type_desc"/>
                            <a:map from="tax_type_codes_bg_id" to="tax_type_id"/>
                            <a:map from="tax_type_rate" to="tax_type_rate"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="tax_amount"/>
                    <a:field name="amount"/>
                    <a:field name="not_include_amount" readOnly="true"/>
                    <a:field name="note"/>
                    <a:field name="long_term_flag" checkedValue="Y" defaultValue="N" uncheckedValue="N"/>
                </a:fields>
                <a:events>
                    <a:event name="update" handler="con5010_con_headers_ds_update"/>
                    <a:event name="load" handler="con5010_con_headers_ds_query"/>
                    <a:event name="submitsuccess" handler="con5010_success_dispatch"/>
                </a:events>
            </a:dataSet>
            <a:dataSet id="con5010_contract_partner_lines_ds" autoQuery="true" bindName="partner_lines" bindTarget="con5010_contract_header_ds" fetchAll="true" model="cont.CON5010.con_contract_partner_lines_query" queryUrl="${/request/@context_path}/autocrud/cont.CON5010.con_contract_partner_lines_query/query?contract_header_id=${/parameter/@contract_header_id}" selectable="true">
                <a:fields>
                    <a:field name="line_num"/>
                    <a:field name="contract_partner_line_id"/>
                    <a:field name="partner_type_id"/>
                    <a:field name="partner_type_code" readOnly="true"/>
                    <a:field name="partner_type_name" displayField="partner_type_name" options="con5010_contract_partner_types_ds" required="true" returnField="partner_type_id" valueField="partner_type_id">
                        <a:mapping>
                            <a:map from="partner_type_code" to="partner_type_code"/>
                            <a:map from="partner_type_name" to="partner_type_name"/>
                            <a:map from="partner_type_id" to="partner_type_id"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="partner_category"/>
                    <a:field name="partner"/>
                    <a:field name="partner_code" lovGridHeight="320" lovHeight="450" lovService="cont.CON5010.con_contract_coop_vendor_lov" lovWidth="500" title="CON_CONTRACT_PARTNER_LINES.PARTNER_CODE">
                        <a:mapping>
                            <a:map from="company_code" to="partner_code"/>
                            <a:map from="company_short_name" to="partner_desc"/>
                            <a:map from="company_id" to="partner"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="partner_desc"/>
                    <a:field name="percentage"/>
                    <a:field name="address"/>
                    <!-- <a:field name="representative" required="true"/> -->
                    <!-- <a:field name="representative" lovGridHeight="320" lovHeight="450" lovWidth="500" title="CON_CONTRACT_PARTNER_LINES.REPRESENTATIVE">
                        <a:mapping>
                            <a:map from="contact_name" to="representative"/>
                            <a:map from="address" to="address"/>
                            <a:map from="mobile_phone" to="tel_phone"/>
                            <a:map from="tax_id_number" to="tax_id_number"/>
                        </a:mapping>
                    </a:field> -->
                    <a:field name="tel_phone"/>
                    <a:field name="bank_branch_code"/>
                    <a:field name="bank_account_name"/>
                    <a:field name="bank_account_code"/>
                    <a:field name="tax_id_number"/>
                    <a:field name="note"/>
                </a:fields>
                <a:events>
                    <a:event name="add" handler="con5010PartnerAddFun"/>
                    <a:event name="load" handler="con5010PartnerLoadFun"/>
                    <a:event name="update" handler="con5010PartnerUpdateFun"/>
                </a:events>
            </a:dataSet>
            <a:dataSet id="con5010_contract_atm_lines_ds" autoQuery="true" bindName="atm_lines" bindTarget="con5010_contract_header_ds" fetchAll="true" model="cont.CON5010.con_contract_atm_lines_query" queryUrl="${/request/@context_path}/autocrud/cont.CON5010.con_contract_atm_lines_query/query?table_name=CON_CONTRACT_ATM_LINES&amp;contract_header_id=${/parameter/@contract_header_id}" selectable="true">
                <a:fields>
                    <a:field name="atm_line_id"/>
                    <a:field name="atm_type_id"/>
                    <a:field name="atm_type_name" lovGridHeight="320" lovHeight="450" lovService="cont.CON2010.con_contract_attachment_types_lov" lovWidth="500" title="CON_CONTRACT_ATM_LINES.ATM_TYPE_NAME">
                        <a:mapping>
                            <a:map from="atm_type_name" to="atm_type_name"/>
                            <a:map from="atm_type_id" to="atm_type_id"/>
                            <a:map from="required_flag" to="required_flag"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="required_flag" checkedValue="Y" readOnly="true" uncheckedValue="N"/>
                    <a:field name="atm_multi_id"/>
                    <a:field name="file_name"/>
                    <a:field name="file_size"/>
                    <a:field name="upload_date"/>
                    <a:field name="upload_user"/>
                </a:fields>
            </a:dataSet>
            <a:dataSet id="con5010_contract_object_lines_ds" autoQuery="true" bindName="object_lines" bindTarget="con5010_contract_header_ds" model="cont.CON5010.con_contract_object_lines_query" queryUrl="${/request/@context_path}/autocrud/cont.CON5010.con_contract_object_lines_query/query?contract_header_id=${/parameter/@contract_header_id}" selectable="true">
                <a:fields>
                    <a:field name="contract_object_line_id"/>
                    <a:field name="line_num"/>
                    <a:field name="contract_object_line_code" lovGridHeight="320" lovHeight="500" lovService="cont.mtl_system_items_lov" lovWidth="510" title="PUR_ADJ_VENDER_LIST.ITEM">
                        <a:mapping>
                            <a:map from="item_name" to="contract_object_line_name"/>
                            <a:map from="display_item_code" to="contract_object_line_code"/>
                            <a:map from="item_id" to="item_id"/>
                            <a:map from="uom_id" to="uom_id"/>
                            <a:map from="uom_desc" to="uom_name"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="contract_object_line_name"/>
                    <a:field name="model_number" required="true"/>
                    <a:field name="uom_id"/>
                    <a:field name="uom_name" lovGridHeight="320" lovHeight="500" lovService="cont.fnd_uom_codes_lov" lovWidth="510" required="true" title="FND_UOM_CODES.UOM_CODE_QUERY">
                        <a:mapping>
                            <a:map from="uom_desc" to="uom_name"/>
                            <a:map from="uom_id" to="uom_id"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="primary_quantity" required="true"/>
                    <a:field name="price" required="true"/>
                    <a:field name="currency_code"/>
                    <a:field name="currency_name" lovGridHeight="320" lovHeight="450" lovService="cont.CON5010.con_contract_gld_currency_bg_lov" lovWidth="500" required="true" title="CURRENCY_SELECTION">
                        <a:mapping>
                            <a:map from="currency_name" to="currency_name"/>
                            <a:map from="currency_code" to="currency_code"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="amount" readOnly="true" required="true"/>
                    <a:field name="schedule_date"/>
                    <a:field name="tax_flag"/>
                    <a:field name="tax_type_id"/>
                    <a:field name="tax_amount"/>
                    <a:field name="not_include_amount"/>
                    <a:field name="note"/>
                </a:fields>
                <a:events>
                    <a:event name="add" handler="con5010ObjectAddFun"/>
                    <a:event name="update" handler="con5010ObjectUpdateFun"/>
                </a:events>
            </a:dataSet>
            <a:dataSet id="con5010_contract_business_lines_ds" autoQuery="true" bindName="business_lines" bindTarget="con5010_contract_header_ds" model="cont.CON5010.con_contract_business_lines_query" queryUrl="${/request/@context_path}/autocrud/cont.CON5010.con_contract_business_lines_query/query?contract_header_id=${/parameter/@contract_header_id}">
                <a:fields>
                    <a:field name="contract_business_line_id"/>
                    <a:field name="line_num"/>
                    <a:field name="custom_field_id"/>
                    <a:field name="contract_business_line_code"/>
                    <a:field name="contract_business_line_name"/>
                    <a:field name="custom_field_editor"/>
                    <a:field name="contract_business_line_value"/>
                    <a:field name="note"/>
                </a:fields>
                <a:events>
                    <a:event name="add" handler="con5010BusinessAddFun"/>
                </a:events>
            </a:dataSet>
            <a:dataSet id="con5010_contract_stage_lines_ds" autoQuery="true" bindName="stage_lines" bindTarget="con5010_contract_header_ds" model="cont.CON5010.con_contract_stage_lines_query" queryUrl="${/request/@context_path}/autocrud/cont.CON5010.con_contract_stage_lines_query/query?contract_header_id=${/parameter/@contract_header_id}" selectable="true">
                <a:fields>
                    <a:field name="contract_stage_line_id"/>
                    <a:field name="line_num"/>
                    <a:field name="contract_stage_line_code"/>
                    <a:field name="contract_stage_line_name"/>
                    <a:field name="milestone_date"/>
                    <a:field name="currency_code"/>
                    <a:field name="currency_name" lovGridHeight="320" lovHeight="450" lovService="cont.CON5010.con_contract_gld_currency_bg_lov" lovWidth="500" title="CURRENCY_SELECTION">
                        <a:mapping>
                            <a:map from="currency_name" to="currency_name"/>
                            <a:map from="currency_code" to="currency_code"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="contract_stage_amount"/>
                    <a:field name="note"/>
                </a:fields>
                <a:events>
                    <a:event name="add" handler="con5010StageAddFun"/>
                </a:events>
            </a:dataSet>
            <!--     <a:dataSet id="con_contract_atm_files_ds" autoQuery="true" model="cont.CON5020.fnd_atm_lines" queryUrl="${/request/@context_path}/autocrud/cont.CON5020.fnd_atm_lines/query?source_table_name=CONT_ATM_UPLOAD&amp;source_pk_value=${/parameter/@templet_id}" selectable="true">
                <a:fields>
                    <a:field name="atm_line_id"/>
                    <a:field name="line_number"/>
                    <a:field name="atm_desc" required="true"/>
                    <a:field name="source_table_name" defaultValue="CONT_ATM_UPLOAD"/>
                    <a:field name="source_pk_value" defaultValue="${/parameter/@templet_id}"/>
                    <a:field name="check_flag" checkedValue="Y" defaultValue="N" uncheckedValue="N"/>
                    <a:field name="contract_header_id"/>
                </a:fields>
            </a:dataSet> -->
            <a:dataSet id="con5010_contract_batch_lines_ds" bindName="batch_tepl" bindTarget="con5010_contract_header_ds" selectable="true">
                <a:fields>
                    <a:field name="batch_tepl_code" lovGridHeight="320" lovHeight="450" lovService="cont.CON5010.con_contract_header_clause_template_lov" lovWidth="500" required="true" title="CON202.CON_CLAUSE_TEMPLET.DESCRIPTION">
                        <a:mapping>
                            <a:map from="description" to="batch_tepl_name"/>
                            <a:map from="templet_code" to="batch_tepl_code"/>
                            <a:map from="templet_id" to="clause_template_id"/>
                        </a:mapping>
                    </a:field>
                </a:fields>
            </a:dataSet>
        </a:dataSets>
        <a:defaultScreen>
            <a:screenTopToolbar>
                <a:gridButton id="con5010_save" click="con5010_save_fun" text="HLS.SAVE" width="100"/>
                <!-- <a:gridButton id="con5010_terminal" click="con5010_terminal_fun" text="CON5010.TERMINAL" width="100"/> -->
                <a:gridButton id="con5010_return" click="con5010_return_fun" text="退回" width="100"/>
                <a:gridButton id="con5010_edit" click="con5010_edit_fun" text="CON5010.EDIT_DOC" width="100"/>
                <a:gridButton id="con5010_published" click="con5010_published_fun" text="发布" width="100"/>
                <a:gridButton id="con5010_sign" click="con5010_sign_fun" text="CON5020.SIGN" width="100"/>
                <!-- <a:gridButton id="con5010_download" click="con5010_download_fun" text="CON5010.DOWNLOAD_DOC" width="100"/> -->
                <a:gridButton id="con5010_histories" click="con5010_histories_fun" text="CON_CONTRACT_HEADERS.HISTORIES" width="100"/>
                <a:gridButton id="con5010_generate" click="con5010_generte_fun" text="CON5010.GENERATE_CON" width="100"/>
                <a:gridButton id="con5010_delete" click="con5010_del_fun" text="CON5010.DEL" width="100"/>
                <a:gridButton id="con5010_upload_atm" click="con5010_upload_fun" text="PROMPT.UPLOAD_ATTACHMENT" width="100"/>
                <a:gridButton click="con5010_back" text="HAP_BACK" width="100"/>
            </a:screenTopToolbar>
            <a:fieldSet showBorder="true" title="CON5010.BASIC_INFORMATION">
                <a:hBox labelWidth="120">
                    <a:textField name="contract_number" bindTarget="con5010_contract_header_ds" prompt="CON_CONTRACT_HEADERS.CONTRACT_NUMBER"/>
                    <a:textField name="contract_desc" bindTarget="con5010_contract_header_ds" prompt="项目名称"/>
                    <a:textField name="status_desc" bindTarget="con5010_contract_header_ds" prompt="CON_CONTRACT_HEADERS.STATUS"/>
                </a:hBox>
                <a:hBox labelWidth="120">
                    <!--<a:comboBox name="contract_type_name" bindTarget="con5010_contract_header_ds" prompt="CON_CONTRACT_HEADERS.CONTRACT_TYPE_NAME"/>-->
                    <a:comboBox name="contract_property_name" bindTarget="con5010_contract_header_ds" prompt="CON_CONTRACT_HEADERS.CONTRACT_PROPERTY_NAME"/>
                    <a:lov name="direction_name" bindTarget="con5010_contract_header_ds" prompt="CON_CONTRACT_HEADERS.DIRECTION_NAME"/>
                    <a:lov name="clause_template_name" bindTarget="con5010_contract_header_ds" prompt="CON_CONTRACT_HEADERS.CLAUSE_TEMPLATE_NAME"/>
                    <a:checkBox name="batch_create_ckb" bindTarget="con5010_contract_header_ds" prompt="是否批量创建合同"/>
                </a:hBox>
                <a:hBox labelWidth="120">
                    <a:datePicker name="start_date" bindTarget="con5010_contract_header_ds" prompt="工程开工日期"/>
                    <a:datePicker name="end_date" bindTarget="con5010_contract_header_ds" prompt="工程完工日期/设备到厂日期/费用申请单物品到厂日期"/>
                    <a:checkBox name="long_term_flag" bindTarget="con5010_contract_header_ds" prompt="长期有效"/>
                </a:hBox>
                <a:hBox labelWidth="120">
                    <a:lov name="company_short_name" bindTarget="con5010_contract_header_ds" prompt="CON_CONTRACT_HEADERS.COMPANY_SHORT_NAME">
                        <a:events>
                            <a:event name="commit" handler="con5010_company_commit"/>
                        </a:events>
                    </a:lov>
                    <a:lov name="contract_object_name" bindTarget="con5010_contract_header_ds" prompt="合同相对方"/>
                    <a:lov name="currency_name" bindTarget="con5010_contract_header_ds" prompt="CON_CONTRACT_HEADERS.CURRENCY_CODE"/>
                    <!--<a:textField name="archive_code" bindTarget="con5010_contract_header_ds" prompt="CON_CONTRACT_HEADERS.ARCHIVE_CODE"/>-->
                </a:hBox>
                <a:hBox labelWidth="120">
                    <a:lov name="tax_type_desc" bindTarget="con5010_contract_header_ds" prompt="CON_CONTRACT_HEADERS.TAX_TYPE_ID"/>
                    <a:currencyField name="amount" bindTarget="con5010_contract_header_ds" prompt="CON_CONTRACT_HEADERS.AMOUNT"/>
                    <a:comboBox name="receipt_payment_desc" bindTarget="con5010_contract_header_ds" prompt="付款条件"/>
                    <a:comboBox name="payment_method_desc" bindTarget="con5010_contract_header_ds" prompt="CON_CONTRACT_HEADERS.PAYMENT_METHOD"/>
                    <!--<a:textField name="project_code" bindTarget="con5010_contract_header_ds" prompt="CON_CONTRACT_HEADERS.PROJECT_CODE" width="428"/>-->
                    <!--<a:lov name="master_contract_number" bindTarget="con5010_contract_header_ds" prompt="CON_CONTRACT_HEADERS.MASTER_CONTRACT_NUMBER"/>-->
                </a:hBox>
                <a:hBox labelWidth="120">
                    <a:textField name="created_by_name" bindTarget="con5010_contract_header_ds" prompt="CON_CONTRACT_HEADERS.CREATED_BY_NAME"/>
                    <a:datePicker name="creation_date" bindTarget="con5010_contract_header_ds" prompt="CON_CONTRACT_HEADERS.CREATION_DATE"/>
                    <a:datePicker name="contract_date" bindTarget="con5010_contract_header_ds" prompt="CON_CONTRACT_HEADERS.CONTRACT_DATE"/>
                </a:hBox>
                <a:hBox labelWidth="120">
                    <a:textArea name="note" bindTarget="con5010_contract_header_ds" height="40" prompt="CON_CONTRACT_HEADERS.NOTE" width="978"/>
                </a:hBox>
            </a:fieldSet>
            <!-- <a:tabPanel height="300" marginWidth="130">
                <a:tabs>
                    <a:tab prompt="合同协议" width="100">
                        <a:grid id="con_contract_atm_files_grid" bindTarget="con_contract_atm_files_ds" height="260" marginWidth="150" navBar="true">
                            <a:columns>
                                <a:column name="atm_desc" prompt="FND_ATM_LINES.ATM_DESC"/>
                                <a:column name="upload_user_desc" prompt="上传人"/>
                                <a:column name="upload_date" prompt="上传时间"/>
                                <a:column name="attachment" align="center" prompt="PROMPT.UPLOAD_DOWNLOAD" renderer="kw1010_upload_render" width="100"/>
                                <a:column name="atm_flag" align="center" renderer="kw1010_upload_render" width="20"/>
                                <a:column name="check_flag" align="center" prompt="是否签署同意" width="60"/>
                                <a:column name="vendor_attachment" align="center" prompt="供应商附件（含电子签章）" renderer="kw1010_upload_render" width="100"/>
                                <a:column name="vendor_atm_flag" align="center" renderer="kw1010_upload_render" width="20"/>
                            </a:columns>
                        </a:grid>
                    </a:tab>
                </a:tabs>
            </a:tabPanel> -->
            <a:accordionPanel id="con5010_accordion_dim" marginWidth="25" showIcon="true" singleMode="false">
                <a:accordions>
                    <a:accordion id="con5010_sub_accordion" prompt="CON5010.CONTRACT_DETAILS" selected="false">
                        <a:tabPanel height="240" marginWidth="30">
                            <a:tabs>
                                <!--
                                <a:tab prompt="CON5010.CONTRACT_EXPENSE" width="100">
                                    <a:hBox labelWidth="120">
                                        
                                        
                                    </a:hBox>
                                    <a:hBox labelWidth="120">
                                        <a:comboBox name="tax_flag_desc" bindTarget="con5010_contract_header_ds" prompt="CON_CONTRACT_HEADERS.TAX_FLAG"/>
                                        
                                    </a:hBox>
                                    <a:hBox labelWidth="120">
                                        <a:currencyField name="not_include_amount" bindTarget="con5010_contract_header_ds" prompt="CON_CONTRACT_HEADERS.NOT_INCLUDE_AMOUNT"/>
                                        <a:currencyField name="tax_amount" bindTarget="con5010_contract_header_ds" prompt="CON_CONTRACT_HEADERS.TAX_AMOUNT"/>
                                    </a:hBox>
                                </a:tab>  added wangchenglong 2019-08-20-->
                                <a:tab prompt="合同主体" width="100">
                                    <a:grid id="con5010_contract_partner_lines_grid" bindTarget="con5010_contract_partner_lines_ds" height="200" marginWidth="45">
                                        <a:toolBar>
                                            <a:button text="HAP_NEW" type="add"/>
                                            <a:button click="con5010DeletePartner" text="HAP_DELETE"/>
                                            <a:button text="HAP_CLEAR" type="clear"/>
                                            <!--  <a:button type="save"/> -->
                                        </a:toolBar>
                                        <a:columns>
                                            <a:column name="line_num" align="left" prompt="CON_CONTRACT_PARTNER_LINES.LINE_NUM" width="20"/>
                                            <a:column name="partner_type_name" editor="con5010_partners_lines_cmb" prompt="合同主体名称" width="80"/>
                                            <!--  <a:column name="partner_type_code" editor="con5010_partners_lines_tf" prompt="CON_CONTRACT_PARTNER_TYPES.PARTNER_TYPE_CODE" width="80"/>
                                            <a:column name="partner_code" editor="con5010_partners_lines_lov" prompt="CON_CONTRACT_PARTNER_LINES.PARTNER_CODE" width="60"/> 
                                            <a:column name="percentage" editor="con5010_partners_lines_pf" prompt="CON_CONTRACT_PARTNER_LINES.PERCENTAGE" width="40"/> -->
                                            <a:column name="representative" editor="con5010_partners_lines_tf" prompt="CON_CONTRACT_PARTNER_LINES.REPRESENTATIVE" width="60"/>
                                            <a:column name="address" editor="con5010_partners_lines_tf" prompt="地址" width="90"/>
                                            <a:column name="partner_desc" editor="con5010_partners_lines_tf" prompt="联系人" width="100"/>
                                            <a:column name="tel_phone" editor="con5010_partners_lines_tf" prompt="CON_CONTRACT_PARTNER_LINES.TEL_PHONE" width="60"/>
                                            <a:column name="note" editor="con5010_partners_lines_tf" prompt="E-mail" width="80"/>
                                            <a:column name="bank_account_name" editor="con5010_partners_lines_tf" prompt="开户名" width="80"/>
                                            <a:column name="bank_branch_code" editor="con5010_partners_lines_tf" prompt="开户行" width="60"/>
                                            <a:column name="bank_account_code" editor="con5010_partners_lines_tf" prompt="CON_CONTRACT_PARTNER_LINES.BANK_ACCOUNT_CODE" width="80"/>
                                        </a:columns>
                                        <a:editors>
                                            <a:comboBox id="con5010_partners_lines_cmb"/>
                                            <a:numberField id="con5010_partners_lines_nf1" allowDecimals="false" allowNegative="false"/>
                                            <a:numberField id="con5010_partners_lines_nf" allowDecimals="true" allowNegative="false" decimalPrecision="3"/>
                                            <a:textField id="con5010_partners_lines_tf"/>
                                            <a:lov id="con5010_partners_lines_lov"/>
                                            <a:percentField id="con5010_partners_lines_pf" allowDecimals="true" allowNegative="false" decimalPrecision="3"/>
                                        </a:editors>
                                        <a:events>
                                            <a:event name="cellclick" handler="onCon5010PartnerCellClickFun"/>
                                        </a:events>
                                    </a:grid>
                                </a:tab>
                                <a:tab prompt="CON5010.CONTRACT_ATMS" width="100">
                                    <a:grid id="con5010_contract_atm_lines_grid" bindTarget="con5010_contract_atm_lines_ds" height="200" marginWidth="45">
                                        <a:toolBar>
                                            <a:button text="HAP_NEW" type="add"/>
                                            <a:button click="con5010DeleteAtm" text="HAP_DELETE"/>
                                            <a:button text="HAP_CLEAR" type="clear"/>
                                        </a:toolBar>
                                        <a:columns>
                                            <a:column name="atm_type_name" editor="con5010_atm_lines_lv" prompt="CON_CONTRACT_ATM_LINES.ATM_TYPE_NAME" width="100"/>
                                            <a:column name="required_flag" editor="con5010_atm_lines_ck" prompt="CON_CONTRACT_ATTACHMENT_TYPES.REQUIRED_FLAG" sortable="true" width="60"/>
                                            <a:column name="file_name" align="left" prompt="CON_CONTRACT_ATM_LINES.FILE_NAME" sortable="true" width="250"/>
                                            <a:column name="file_size" align="center" prompt="CON_CONTRACT_ATM_LINES.FILE_SIZE" sortable="true" width="100"/>
                                            <a:column name="upload_user" align="center" prompt="CON_CONTRACT_ATM_LINES.UPLOAD_USER" sortable="true" width="50"/>
                                            <a:column name="upload_date" align="center" prompt="CON_CONTRACT_ATM_LINES.UPLOAD_DATE" renderer="Aurora.formatDate" sortable="true" width="80"/>
                                            <a:column align="center" prompt="CON_CONTRACT_ATM_LINES.UPLOAD/DOWNLOAD" renderer="onCon5010UploadOrDownloadFun"/>
                                        </a:columns>
                                        <a:editors>
                                            <a:lov id="con5010_atm_lines_lv"/>
                                            <a:checkBox id="con5010_atm_lines_ck"/>
                                        </a:editors>
                                        <a:events>
                                            <a:event name="cellclick" handler="onCon5010AtmCellClickFun"/>
                                        </a:events>
                                    </a:grid>
                                </a:tab>
                                <a:tab prompt="批量创建新合同" width="100">
                                    <a:grid bindTarget="con5010_contract_batch_lines_ds" height="200" marginWidth="45">
                                        <a:toolBar>
                                            <a:button id="add_btn" hidden="true" type="add"/>
                                            <a:button id="del_btn" hidden="true" type="delete"/>
                                        </a:toolBar>
                                        <a:columns>
                                            <a:column name="batch_tepl_code" editor="batch_contract_lov" prompt="模板编码"/>
                                            <a:column name="batch_tepl_name" prompt="模板名称"/>
                                        </a:columns>
                                        <a:editors>
                                            <a:lov id="batch_contract_lov"/>
                                        </a:editors>
                                    </a:grid>
                                </a:tab>
                            </a:tabs>
                        </a:tabPanel>
                        <a:tabPanel marginHeight="240" marginWidth="30">
                            <a:tabs>
                                <a:tab prompt="CON5010.CONTRACT_OBJECTS" width="100">
                                    <a:grid id="con5010_contract_object_lines_grid" bindTarget="con5010_contract_object_lines_ds" marginHeight="300" marginWidth="45" navBar="true">
                                        <a:toolBar>
                                            <a:button text="HAP_NEW" type="add"/>
                                            <a:button click="con5010DeleteObject" text="HAP_DELETE"/>
                                            <a:button text="HAP_CLEAR" type="clear"/>
                                        </a:toolBar>
                                        <a:columns>
                                            <a:column name="line_num" align="left" prompt="CON_CONTRACT_OBJECT_LINES.LINE_NUM" width="20"/>
                                            <a:column name="contract_object_line_name" align="left" editor="con5010_object_lines_tf" prompt="设备名称" width="100"/>
                                            <a:column name="model_number" align="left" editor="con5010_object_lines_tf" prompt="规格型号" width="50"/>
                                            <a:column name="contract_object_line_code" align="left" editor="con5010_object_lines_lov" prompt="品牌" width="60"/>
                                            <a:column name="note" align="left" editor="con5010_object_lines_tf" prompt="产地" width="120"/>
                                            <a:column name="primary_quantity" align="right" editor="con5010_object_lines_nf" prompt="CON_CONTRACT_OBJECT_LINES.PRIMARY_QUANTITY" width="40"/>
                                            <a:column name="uom_name" align="left" editor="con5010_object_lines_lov" prompt="CON_CONTRACT_OBJECT_LINES.UOM_ID" width="60"/>
                                            <a:column name="price" align="right" editor="con5010_object_lines_cf" prompt="CON_CONTRACT_OBJECT_LINES.PRICE" width="40"/>
                                            <a:column name="amount" align="right" editor="con5010_object_lines_cf" prompt="总价" renderer="Aurora.formatMoney" width="60"/>
                                            <!-- <a:column name="schedule_date" align="left" editor="con5010_object_lines_dp" prompt="CON_CONTRACT_OBJECT_LINES.SCHEDULE_DATE" renderer="Aurora.formatDate" width="80"/>-->
                                            <a:column name="currency_name" align="left" editor="con5010_object_lines_lov" prompt="CON_CONTRACT_OBJECT_LINES.CURRENCY_CODE" width="40"/>
                                        </a:columns>
                                        <a:editors>
                                            <a:textField id="con5010_object_lines_tf"/>
                                            <a:lov id="con5010_object_lines_lov"/>
                                            <a:comboBox id="con5010_object_lines_cmb"/>
                                            <a:numberField id="con5010_object_lines_nf" allowDecimals="false" allowNegative="false"/>
                                            <a:currencyField id="con5010_object_lines_cf"/>
                                            <a:datePicker id="con5010_object_lines_dp"/>
                                        </a:editors>
                                    </a:grid>
                                </a:tab>
                                <a:tab prompt="CON5010.CONTRACT_BUSINESS_INFO" width="100">
                                    <a:grid id="con5010_contract_business_lines_grid" bindTarget="con5010_contract_business_lines_ds" marginHeight="295" marginWidth="45" navBar="true">
                                        <a:columns>
                                            <a:column name="line_num" align="left" prompt="CON_CONTRACT_BUSINESS_LINES.LINE_NUM" width="20"/>
                                            <a:column name="contract_business_line_code" align="left" prompt="CON_CONTRACT_BUSINESS_LINES.CONTRACT_BUSINESS_LINE_CODE" width="60"/>
                                            <a:column name="contract_business_line_name" align="left" prompt="CON_CONTRACT_BUSINESS_LINES.CONTRACT_BUSINESS_LINE_NAME" width="100"/>
                                            <a:column name="contract_business_line_value" align="left" editorFunction="con5010ValueFun" prompt="CON_CONTRACT_BUSINESS_LINES.CONTRACT_BUSINESS_LINE_VALUE" renderer="onBusinessRendererFun" width="100"/>
                                            <a:column name="note" align="left" editor="con5010_business_lines_tf" prompt="CON_CONTRACT_BUSINESS_LINES.NOTE" width="120"/>
                                        </a:columns>
                                        <a:editors>
                                            <a:textField id="con5010_business_lines_tf"/>
                                            <a:numberField id="con5010_business_lines_nf1" allowDecimals="false" allowNegative="false"/>
                                            <a:numberField id="con5010_business_lines_nf" allowDecimals="true" allowFormat="true" allowNegative="true" decimalPrecision="8"/>
                                            <a:datePicker id="con5010_business_lines_dp"/>
                                            <a:dateTimePicker id="con5010_business_lines_dtp"/>
                                        </a:editors>
                                    </a:grid>
                                </a:tab>
                                <a:tab prompt="CON5010.CONTRACT_STAGES" width="100">
                                    <a:grid id="con5010_contract_stage_lines_grid" bindTarget="con5010_contract_stage_lines_ds" marginHeight="300" marginWidth="45" navBar="true">
                                        <a:toolBar>
                                            <a:button text="HAP_NEW" type="add"/>
                                            <a:button click="con5010DeleteStage" text="HAP_DELETE"/>
                                            <a:button text="HAP_CLEAR" type="clear"/>
                                        </a:toolBar>
                                        <a:columns>
                                            <a:column name="line_num" align="left" prompt="CON_CONTRACT_STAGE_LINES.LINE_NUM" width="20"/>
                                            <a:column name="contract_stage_line_code" align="left" editor="con5010_stage_lines_tf" prompt="CON_CONTRACT_STAGE_LINES.CONTRACT_STAGE_LINE_CODE" width="40"/>
                                            <a:column name="contract_stage_line_name" align="left" editor="con5010_stage_lines_tf" prompt="CON_CONTRACT_STAGE_LINES.CONTRACT_STAGE_LINE_NAME" width="100"/>
                                            <a:column name="milestone_date" align="left" editor="con5010_stage_lines_dp" prompt="CON_CONTRACT_STAGE_LINES.MILESTONE_DATE" renderer="Aurora.formatDate" width="50"/>
                                            <a:column name="currency_name" align="left" editor="con5010_stage_lines_lov" prompt="CON_CONTRACT_OBJECT_LINES.CURRENCY_CODE" width="40"/>
                                            <a:column name="contract_stage_amount" align="right" editor="con5010_stage_lines_cf" prompt="CON_CONTRACT_STAGE_LINES.CONTRACT_STAGE_AMOUNT" width="100"/>
                                            <a:column name="note" align="left" editor="con5010_stage_lines_tf" prompt="CON_CONTRACT_STAGE_LINES.NOTE" width="120"/>
                                        </a:columns>
                                        <a:editors>
                                            <a:textField id="con5010_stage_lines_tf"/>
                                            <a:numberField id="con5010_stage_lines_nf" allowDecimals="false" allowNegative="false"/>
                                            <a:currencyField id="con5010_stage_lines_cf"/>
                                            <a:datePicker id="con5010_stage_lines_dp"/>
                                            <a:lov id="con5010_stage_lines_lov"/>
                                        </a:editors>
                                    </a:grid>
                                </a:tab>
                            </a:tabs>
                        </a:tabPanel>
                    </a:accordion>
                </a:accordions>
            </a:accordionPanel>
            <form name="con5010_downloadform" enctype="multipart/form-data" method="get" style="display:none;"><![CDATA[
            ]]></form>
        </a:defaultScreen>
        <script><![CDATA[
            function diaplayBtn(id) {
                var ui = document.getElementById(id);
                ui.style.display = "none";
            }
            
            function con5010Init() {
                //debugger;
                if (contract_header_id_bak != '') {
                    var record = $('con5010_contract_header_ds').getAt(0);
                    var contract_type_code = record.get('contract_type_code');
                    if (record.get('status') != 'NEW') {
                        diaplayBtn('con5010_delete');
                    }
                    if (record.get('status') != 'REFUSED') {
                        //diaplayBtn('con5010_terminal');
                    }
            
                    if (record.get('status') != 'NEW' && record.get('status') != 'REFUSED') {
                        diaplayBtn('con5010_save');
                        diaplayBtn('con5010_published');
                        // diaplayBtn('con5010_edit');
                        //diaplayBtn('con5010_download');
            
                        record.getMeta().getField('contract_desc').setReadOnly(true);
                        record.getMeta().getField('clause_template_name').setReadOnly(true);
                        record.getMeta().getField('start_date').setReadOnly(true);
                        record.getMeta().getField('end_date').setReadOnly(true);
                        record.getMeta().getField('project_code').setReadOnly(true);
                        record.getMeta().getField('master_contract_number').setReadOnly(true);
                        record.getMeta().getField('archive_code').setReadOnly(true);
                        record.getMeta().getField('contract_date').setReadOnly(true);
                        record.getMeta().getField('note').setReadOnly(true);
                        record.getMeta().getField('long_term_flag').setReadOnly(true);
                    }
                    if (record.get('status') == 'CONFIRMED') {
                        diaplayBtn('con5010_sign');
                    }
            
                    if (contract_type_code == 'UNIVERSAL_CON') {
                        //$('con5010_accordion_dim').selectAccordionIndex(0);
                        diaplayBtn('con5010_upload_atm');
                    } else if (contract_type_code == 'ATM_CON') {
                        // diaplayBtn('con5010_accordion_dim');
                        //diaplayBtn('con5010_download');
                    }
                    if (record.get('status') == 'NEW') {
                        diaplayBtn('con5010_return');
                    }
                } else {
                    diaplayBtn('con5010_published');
                    diaplayBtn('con5010_return');
                    // diaplayBtn('con5010_download');
                    // diaplayBtn('con5010_edit');
                    diaplayBtn('con5010_histories');
                    diaplayBtn('con5010_delete');
                    //diaplayBtn('con5010_terminal');
                    diaplayBtn('con5010_upload_atm');
                    diaplayBtn('con5010_sign');
                }
            
                //debugger;
                // record = $('con5010_contract_header_ds').getCurrentRecord();
                // if (record.get('clause_template_id') != undefined && record.get('clause_template_id') != '') {
                    // $('con_contract_atm_files_ds').setQueryParameter('source_table_name', 'CONT_ATM_UPLOAD');
                    // $('con_contract_atm_files_ds').setQueryParameter('source_pk_value', record.get('clause_template_id'));
                    // if (record.get('contract_header_id') != undefined) {
                        // $('con_contract_atm_files_ds').setQueryParameter('contract_header_id', record.get('contract_header_id'));
                    // }
                    // $('con_contract_atm_files_ds').query();
            
                    // // var atm_record = $('con_contract_atm_files_ds').getAll();
                    // // atm_record.set('contract_header_id',record.get('contract_header_id'));
                // }
            
            }
            con5010Init();
        ]]></script>
    </a:view>
</a:screen>
