<?xml version="1.0" encoding="UTF-8"?>
<!--
    $Author: FelixDru  
    $Date: 2014-07-22 下午03:48:40  
    $Revision: 1.0  
    $Purpose: 采购订单只读查看
-->
<a:screen xmlns:c="aurora.application.action" xmlns:p="uncertain.proc" xmlns:a="http://www.aurora-framework.org/application" trace="true">
    <a:init-procedure>
        <a:model-query fetchAll="true" model="public.currency_list" rootPath="pur5320_currency_source"/>
        <a:model-query defaultWhereClause="cbi.config_classify_code = &apos;PO&apos; AND cbi.config_item_code = &apos;PO_08&apos;" fetchAll="true" model="public.get_fnd_config_center_bg_item_value" rootPath="bg_item_po_08"/>
    </a:init-procedure>
    <a:view>
        <a:link id="pur_purchaseOrderViewRecord_link" url="${/request/@context_path}/modules/pur/public/pur_purchase_order_operate_record.screen"/>
        <a:link id="pur53201_po_save_link" url="${/request/@context_path}/modules/pur/PUR5320/pur_po_manual_save.svc"/>
        <a:link id="pur53201_po_submit_link" url="${/request/@context_path}/modules/pur/PUR5320/pur_po_manual_submit.svc"/>
        <a:link id="pur5320_copyFromOtherPo_link" url="${/request/@context_path}/modules/pur/PUR5320/pur_copy_from_po_query.screen"/>
        <a:link id="pur5320_purchaseOrderDelete_link" model="pur.PUR5320.pur_po_delete" modelaction="execute"/>
        <a:link id="pur5320_pur_po_line_subject_maintain_link" url="${/request/@context_path}/modules/pur/PUR5320/pur_po_line_subject_maintain.screen"/>
        <script><![CDATA[
            var o_pur_header_id;
            //返回按钮定义
            
            function pur_purchaseOrderViewRecordClose_fun() {
                $('pur53201_po_maintain_window').close();
            }
            
            //操作记录
            
            function pur_purchaseOrderViewRecordOpen() {
                new Aurora.Window({
                    id: 'pur_purchase_order_record_window',
                    url: $('pur_purchaseOrderViewRecord_link').getUrl() + '?transaction_object=PUR_HEADERS_ALL' + '&pur_header_id=${/parameter/@pur_header_id}',
                    title: '${l:PUR_HEADERS_ALL.OPERATION_RECORD}',
                    height: 450,
                    width: 700
                });
            }
            
            
            function pur5320_purchaseOrderMoneyRenderFun(value, record, name) {
                return Aurora.formatNumber(value);
            }
            
            
            //Upload Attachment
            
            function pur5320_UploadAttachmentFun() {
                var url = "${/request/@context_path}/uploadFile.screen?table_name=PUR_PO_ATTACHMENT&header_id=${/parameter/@pur_header_id}";
                new Aurora.Window({
                    url: url,
                    title: '${l:ATM.UPLOAD_ATTACHMENT}',
                    id: 'fpur_5320_po_attm_window',
                    width: 610,
                    height: 500
                });
            }
            
            
            function pur5320_purchaseOrderSaveFunction() {
                var header_ds = $('pur5320_purchaseOrderHeader_ds');
                var line_ds = $('pur5320_purchaseOrderViewLineDetail_ds');
                var header_record = header_ds.getCurrentRecord();
            
                if (!header_ds.validate() || !line_ds.validate() || header_ds.getAll().length == 0) {
                    return;
                }
            
                //将行库存组织赋值到头上
                if (line_ds.getAll().length > 0) {
                    var line_record = line_ds.getAll()[0];
                    header_record.set('business_unit_id', line_record.get('business_unit_id'));
                    header_record.set('inv_organization_id', line_record.get('ship_to_organization_id'));
                    header_record.set('inv_organization_name', line_record.get('ship_to_organization_name'));
                }
            
                var data = header_record.data;
                if (Aurora.isEmpty(header_record.get('pur_header_id'))) {
                    data._status = 'insert';
                } else {
                    data._status = 'update';
                }
                data['lines'] = line_ds.getJsonData();
            
                Aurora.Masker.mask($('pur53201_po_maintain_window').wrap, '${l:LOADING}...');
                Aurora.request({
                    url: $('pur53201_po_save_link').getUrl(),
                    para: data,
                    success: function(res) {
                        var pur_header_id;
                        if (!Ext.isEmpty(res.result)) {
                            pur_header_id = res.result.pur_header_id;
                        } else {
                            pur_header_id = '${/parameter/@pur_header_id}';
                        }
                        Aurora.Masker.unmask($('pur53201_po_maintain_window').wrap);
                        $('pur5320_purchaseOrderHeader_ds').setQueryParameter('pur_header_id', pur_header_id);
                        $('pur5320_purchaseOrderHeader_ds').query();
                        $('pur5320_purchaseOrderViewLineDetail_ds').setQueryParameter('pur_header_id', pur_header_id);
                        $('pur5320_purchaseOrderViewLineDetail_ds').query();
                        Aurora.showMessage('${l:PROMPT}', '${l:PROMPT.SAVE_SUCCESS}!');
            
                        $('pur5320_purchaseOrderSubmitBtu').enable();
                        $('pur5320_uploadAttachmentBtu').enable();
            
                    },
                    failure: function() {
                        Aurora.Masker.unmask($('pur53201_po_maintain_window').wrap);
                        return;
                    },
                    error: function() {
                        Aurora.Masker.unmask($('pur53201_po_maintain_window').wrap);
                        return;
                    }
                });
            }
            
            function pur5320_purchaseOrderSubmitFunction() {
                var line_ds = $('pur5320_purchaseOrderViewLineDetail_ds');
            
                if (line_ds.getAll().length == 0) {
                    Aurora.showMessage('${l:PROMPT}', '${l:PROMPT.PLEASE_INPUT_LINE}!');
                    return;
                }
            
                Aurora.showConfirm('${l:PROMPT}', '${l:DOCUMNET_SUBMIT_CONFIRM}？', function() {
                    var header_ds = $('pur5320_purchaseOrderHeader_ds');
                    var line_ds = $('pur5320_purchaseOrderViewLineDetail_ds');
                    var header_record = header_ds.getCurrentRecord();
            
                    if (!header_ds.validate() || !line_ds.validate() || header_ds.getAll().length == 0) {
                        return;
                    }
            
                    //将行库存组织赋值到头上
                    if (line_ds.getAll().length > 0) {
                        var line_record = line_ds.getAll()[0];
                        header_record.set('business_unit_id', line_record.get('business_unit_id'));
                        header_record.set('inv_organization_id', line_record.get('ship_to_organization_id'));
                        header_record.set('inv_organization_name', line_record.get('ship_to_organization_name'));
                    }
            
                    var data = header_ds.getCurrentRecord().data;
                    if (Aurora.isEmpty(header_record.get('pur_header_id'))) {
                        data._status = 'insert';
                    } else {
                        data._status = 'update';
                    }
                    data['lines'] = line_ds.getJsonData();
            
                    Aurora.Masker.mask($('pur53201_po_maintain_window').wrap, '${l:LOADING}...');
                    Aurora.request({
                        url: $('pur53201_po_submit_link').getUrl(),
                        para: data,
                        success: function(res) {
                            Aurora.Masker.unmask($('pur53201_po_maintain_window').wrap);
                            Aurora.showMessage('${l:PROMPT}', '${l:PROMPT.SUBMIT_SUCCESS}', function() {
                                pur_purchaseOrderViewRecordClose_fun();
                            });
                        },
                        failure: function() {
                            Aurora.Masker.unmask($('pur53201_po_maintain_window').wrap);
                            return;
                        },
                        error: function() {
                            Aurora.Masker.unmask($('pur53201_po_maintain_window').wrap);
                            return;
                        }
                    });
                });
            }
            
            
            //Header Load
            
            function pur5320_orderHeader_loadFun(dataSet) {
                if (dataSet.getAll().length > 0) {
                    var record = dataSet.getAt(0);
                    var vendor_id = record.get('vendor_id');
                    record.getField('vendor_site_name').setReadOnly(false);
                    record.getField('vendor_site_name').setLovPara('vendor_id', vendor_id);
                }
            }
            
            //Header Update
            
            function pur5320_orderHeader_updateFun(ds, record, name, value, oldvalue) {
                if (name == 'vendor_id') {
                    if (Ext.isEmpty(value)) {
                        record.getField('vendor_site_name').setReadOnly(true);
                        record.getField('vendor_site_name').setLovPara('vendor_id', -1);
                        record.set('vendor_site_id', '');
                        record.set('vendor_site_name', '');
                    } else {
                        record.getField('vendor_site_name').setReadOnly(false);
                        record.getField('vendor_site_name').setLovPara('vendor_id', value);
                        record.set('vendor_site_id', '');
                        record.set('vendor_site_name', '');
                    }
                } else if (name == 'company_id') {
                    var line_records = $('pur5320_purchaseOrderViewLineDetail_ds').getAll();
                    for (var i = 0;i < line_records.length;i++) {
                        var line_record = line_records[i];
            
                        line_record.set('ship_to_organization_id', '');
                        line_record.set('ship_to_organization_name', '');
                    }
                } else if (name == 'currency_code') {
                    var line_records = $('pur5320_purchaseOrderViewLineDetail_ds').getAll();
                    for (var i = 0;i < line_records.length;i++) {
                        var line_record = line_records[i];
            
                        line_record.set('currency_code', value);
                    }
                }
            }
            
            
            //Line Before Create
            
            function pur5320_orderLine_beforecreateFun() {
                var header_ds = $('pur5320_purchaseOrderHeader_ds');
                if (!header_ds.validate() || header_ds.getAll().length == 0) {
                    Aurora.showMessage('${l:PROMPT}', '${l:PROMPT.PLEASE_INPUT}', function() {});
                    return false;
                }
            
                return true;
            }
            //Line Add
            
            function pur5320_orderLine_addFun(ds, record, index) {
                var currency_code = $('pur5320_purchaseOrderHeader_ds').getAt(0).get('currency_code');
                record.set('currency_code', currency_code);
                if (currency_code == 'CNY') {
                    record.set('rate', 1);
                }
            
                //Add by Hunter.Wang at 2017-05-19
                //新增配置项，判断是否引用物料价格信息记录，来带出单价
                var item_value = '${/model/bg_item_po_08/record/@bg_config_item_value}'; //获取“引用物料价格信息记录”配置项的值
                if (!Aurora.isEmpty(item_value) && item_value == 'Y') {
                    //获取订单头的公司、BU、供应商
                    var company_id = $('pur5320_purchaseOrderHeader_ds').getCurrentRecord().get('company_id'); //公司
                    var business_unit_id = $('pur5320_purchaseOrderHeader_ds').getCurrentRecord().get('business_unit_id'); //BU
                    var coop_company_id = $('pur5320_purchaseOrderHeader_ds').getCurrentRecord().get('vendor_company_id'); //供应商
                    record.getField('item_code').setLovPara('company_id', company_id);
                    record.getField('item_code').setLovPara('business_unit_id', business_unit_id);
                    record.getField('item_code').setLovPara('coop_company_id', coop_company_id);
                }
            }
            
            //Line Update
            
            function pur5320_orderLine_updateFun(ds, record, name, value, oldvalue) {
                if (name == 'quantity' || name == 'unit_price') {
                    var quantity = record.get('quantity');
                    var unit_price = record.get('unit_price');
                    if (!Ext.isEmpty(quantity) && !Ext.isEmpty(unit_price)) {
                        record.set('line_amount', Aurora.formatNumber(quantity * unit_price, 2));
                    } else {
                        record.set('line_amount', '');
                    }
                } else if (name == 'ship_to_organization_id') {
                    record.set('warehouse_name', '');
                    record.set('warehouse_id', '');
                    if (Ext.isEmpty(value)) {
                        record.getField('warehouse_name').setReadOnly(true);
                    } else {
                        record.getField('warehouse_name').setReadOnly(false);
                    }
                } else if (name == 'warehouse_id') {
                    record.set('inv_location_name', '');
                    record.set('inv_location_id', '');
                    if (Ext.isEmpty(value)) {
                        record.getField('inv_location_name').setReadOnly(true);
                    } else {
                        record.getField('inv_location_name').setReadOnly(false);
                    }
                }
            
                if (name == 'unit_price' || name == 'tax_rate' || name == 'original_unit_price' || name == 'rate') {
                    var unit_price = record.get('unit_price');
                    var tax_rate = record.get('tax_rate');
                    var original_unit_price = record.get('original_unit_price');
                    var rate = record.get('rate');
            
                    if (Ext.isEmpty(tax_rate)) {
                        tax_rate = 0;
                    }
            
                    if (Ext.isEmpty(rate)) {
                        rate = 0;
                    }
            
                    if ((!Ext.isEmpty(unit_price) && Ext.isEmpty(original_unit_price) && name != 'original_unit_price') || name == 'unit_price') {
                        record.set('original_unit_price', unit_price * (1 + tax_rate / 100) * rate);
                    } else if ((Ext.isEmpty(unit_price) && !Ext.isEmpty(original_unit_price) && name != 'unit_price') || name == 'original_unit_price') {
                        record.set('unit_price', parseFloat(original_unit_price / ((1 + tax_rate / 100) * rate)).toFixed(8));
                    } else if (Ext.isEmpty(unit_price) && Ext.isEmpty(original_unit_price)) {} else {
                        record.set('original_unit_price', unit_price * (1 + tax_rate / 100) * rate);
                    }
                }
            }
            
            //CellClick
            
            
            function pur5320_purchaseOrderDetail_gridCellClickFun(grid, row, name, record) {
                if (name == 'ship_to_organization_name') {
                    var company_id = $('pur5320_purchaseOrderHeader_ds').getAt(0).get('company_id');
                    if (Ext.isEmpty(company_id)) {
                        Aurora.showMessage('${l:PROMPT}', '${l:CHOOSE_COMPANY_FIRST}');
                        return;
                    }
                    record.getMeta().getField('ship_to_organization_name').setLovPara('company_id', company_id);
                } else if (name == 'warehouse_name') {
                    var ship_to_organization_id = record.get('ship_to_organization_id');
                    record.getMeta().getField('warehouse_name').setLovPara('company_id', ship_to_organization_id);
                } else if (name == 'inv_location_name') {
                    var warehouse_id = record.get('warehouse_id');
                    record.getMeta().getField('inv_location_name').setLovPara('warehouse_id', warehouse_id);
                }
            }
            
            //INIT
            
            
            function pur5320_initFun() {
                if (Ext.isEmpty('${/parameter/@pur_header_id}')) {
                    $('pur5320_purchaseOrderSubmitBtu').disable();
                    $('pur5320_uploadAttachmentBtu').disable();
                    $('pur5320_copyFromOtherPoBtu').enable();
                    $('pur5320_purchaseOrderDeleteBtu').disable();
                }
            }
            
            //Cope From Other PO
            
            function pur5320_copyFromOtherPoFun() {
                o_pur_header_id = '';
                new Aurora.Window({
                    id: 'pur5320_copyFromOtherPo_window',
                    url: $('pur5320_copyFromOtherPo_link').getUrl(),
                    title: '${l:PUR5230_COPY_FROM_OTHERS}',
                    height: 450,
                    width: 700
                }).on('close', function() {
                    $('pur53201_po_maintain_window').load($('pur5320_purchaseOrderViewDetail_link').getUrl() + '?pur_header_id=' + o_pur_header_id);
                });
            }
            
            function pur5320_purchaseOrderDeleteFunction() {
                Aurora.showConfirm('${l:PROMPT}', '${l:PROMPT.CONFIRM_DELETE}?', function() {
                    Aurora.Masker.mask($('pur53201_po_maintain_window').wrap, '${l:LOADING}...');
                    Aurora.request({
                        url: $('pur5320_purchaseOrderDelete_link').getUrl(),
                        para: {
                            pur_header_id: '${/parameter/@pur_header_id}'
                        },
                        success: function() {
                            Aurora.Masker.unmask($('pur53201_po_maintain_window').wrap);
                            Aurora.showMessage('${l:PROMPT}', '${l:PROMPT.DELETED}!', function() {
                                pur_purchaseOrderViewRecordClose_fun();
                            });
                        },
                        failure: function() {
                            Aurora.Masker.unmask($('pur53201_po_maintain_window').wrap);
                            return;
                        },
                        error: function() {
                            Aurora.Masker.unmask($('pur53201_po_maintain_window').wrap);
                            return;
                        }
                    });
                });
            }
            
            function pur5320_purchaseOrderViewDetailLineOtherInfoRenderer(value, record, name) {
                if (name == 'subject_assign') {
                    if (!Aurora.isEmpty(record.get('pur_line_id'))) {
                        return '<a href="javascript:pur5320_purchaseOrderViewDetailLineOtherInfoRendererOpen(' + record.get('pur_line_id') + ')">科目分配</a>';
                    }
                }
            }
            
            function pur5320_purchaseOrderViewDetailLineOtherInfoRendererOpen(id) {
                new Aurora.Window({
                    id: 'pur5320_pur_po_line_subject_maintain_link_window',
                    url: $('pur5320_pur_po_line_subject_maintain_link').getUrl() + '?pur_line_id=' + id,
                    title: '科目分配',
                    height: '300',
                    width: '550'
                });
            }
            
            function pur_purchaseOrderViewDetailOthersGridEditorFunction(record, name){
                if (name == 'category_name') {
                    var item_id = record.get('item_id');
                    if (Aurora.isEmpty(item_id)) {
                        return 'pur5320_purchaseOrderOtherDetail_lov';
                    }
                    return '';
                }
            }
        ]]></script>
        <a:dataSets>
            <a:dataSet id="pur5320_currency_ds" autoCreate="true" loadData="true">
                <a:datas dataSource="/model/pur5320_currency_source"/>
            </a:dataSet>
            <a:dataSet id="pur5320_purchaseOrderHeader_ds" autoCreate="true" autoQuery="true" model="pur.PUR5320.pur_purchase_order_header" queryUrl="${/request/@context_path}/autocrud/pur.PUR5320.pur_purchase_order_header/query?pur_header_id=${/parameter/@pur_header_id}">
                <a:fields>
                    <a:field name="display_po_number"/>
                    <a:field name="display_release_num"/>
                    <a:field name="revision_num"/>
                    <a:field name="company_id"/>
                    <a:field name="company_name" displayField="company_full_name" options="pur5320_userAuthorityCompany_ds" required="true" returnField="company_id" valueField="company_id">
                        <a:mapping>
                            <a:map from="company_code" to="company_code"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="business_unit_name" autoComplete="true" autoCompleteField="business_unit_name" lovHeight="480" lovService="public.fnd_business_unit_lov" lovWidth="550" prompt="FND_BUSINESS_UNITS.BUSINESS_UNIT" title="FND_BUSINESS_UNITS.BUSINESS_UNIT_QUERY">
                        <a:mapping>
                            <a:map from="business_unit_id" to="business_unit_id"/>
                            <a:map from="business_unit_name" to="business_unit_name"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="type_lookup_desc" displayField="description" options="pur5320_order_type_options" required="true" returnField="type_lookup_code" valueField="order_type_code"/>
                    <a:field name="agent_name" autoComplete="true" autoCompleteField="code_name" lovGridHeight="320" lovHeight="480" lovService="public.pur_buyers_lov" lovWidth="500" required="true" title="PUR_HEADERS_ALL.PUR_BUYER">
                        <a:mapping>
                            <a:map from="buyer_id" to="agent_id"/>
                            <a:map from="buyer_code" to="agent_code"/>
                            <a:map from="description" to="agent_name"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="vendor_name" autoComplete="true" autoCompleteField="vendor_code_name" lovGridHeight="330" lovHeight="450" lovService="pur.PUR7010.pur_vendors_by_user_authority_lov" lovWidth="500" required="true" title="PUR_VENDORS.VENDOR">
                        <a:mapping>
                            <a:map from="vendor_id" to="vendor_id"/>
                            <a:map from="vendor_code" to="vendor_code"/>
                            <a:map from="vendor_name" to="vendor_name"/>
                            <a:map from="vendor_company_id" to="vendor_company_id"/>
                            <a:map from="vendor_business_group" to="vendor_business_group"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="vendor_site_name" autoComplete="true" autoCompleteField="vendor_site_name" lovHeight="500" lovService="pur.PUR7010.pur_vendor_sites_lov?vendor_id=-1" lovWidth="550" readOnly="true" required="true" title="PUR_HEADERS_ALL.VENDOR_SITE">
                        <a:mapping>
                            <a:map from="vendor_site_id" to="vendor_site_id"/>
                            <a:map from="vendor_site_code" to="vendor_site_code"/>
                            <a:map from="vendor_site_name" to="vendor_site_name"/>
                            <a:map from="coop_business_unit_id" to="coop_business_unit_id"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="srm_name_desc" displayField="code_value_name" options="pur5320_srm_status_ds" returnField="srm_status" valueField="code_value"/>
                    <a:field name="reply_over_flag_desc" displayField="code_value_name" options="pur5320_yes_no_ds" returnField="reply_over_flag" valueField="code_value"/>
                    <a:field name="erp_status_desc" displayField="code_value_name" options="pur5320_headeErpStatus" returnField="erp_status" valueField="code_value"/>
                    <a:field name="pur_organization_name" autoComplete="true" autoCompleteField="pur_organization_code_name" lovHeight="480" lovService="public.pur_organization_lov" lovWidth="500" prompt="PUR_ORGANIZATIONS.PUR_ORGANIZATION" title="PUR_ORGANIZATIONS.PUR_ORGANIZATION">
                        <a:mapping>
                            <a:map from="pur_organization_id" to="pur_organization_id"/>
                            <a:map from="pur_organization_name" to="pur_organization_name"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="currency_desc"/>
                    <a:field name="currency_code" displayField="currency_code" options="pur5320_currency_ds" required="true" returnField="currency_desc" valueField="currency_name"/>
                    <a:field name="data_source" defaultValue="MANUAL"/>
                    <a:field name="ship_to_location_name" autoComplete="true" autoCompleteField="location_code_desc" lovHeight="480" lovService="public.fnd_locations_lov" lovWidth="500" required="false" title="PUR_REQUISITION_LNS.LOCATION_DESC">
                        <a:mapping>
                            <a:map from="location_id" to="ship_to_location_id"/>
                            <a:map from="location_code" to="ship_to_location_code"/>
                            <a:map from="location_desc" to="ship_to_location_name"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="bill_to_location_name" autoComplete="true" autoCompleteField="location_code" lovHeight="480" lovService="public.fnd_locations_lov" lovWidth="500" required="false" title="PUR_REQUISITION_LNS.LOCATION_DESC">
                        <a:mapping>
                            <a:map from="location_id" to="ship_to_location_id"/>
                            <a:map from="location_code" to="bill_to_location_code"/>
                            <a:map from="location_desc" to="bill_to_location_name"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="payment_terms" autoComplete="true" autoCompleteField="code_name" lovHeight="480" lovService="public.csh_payment_terms_lov" lovWidth="500" title="CSH_PAYMENT_TERMS_VL.PAYMENT_TERM_ID">
                        <a:mapping>
                            <a:map from="payment_term_id" to="payment_term_id"/>
                            <a:map from="payment_term_code" to="payment_term_code"/>
                            <a:map from="payment_term_name" to="payment_terms"/>
                        </a:mapping>
                    </a:field>
                </a:fields>
                <a:events>
                    <a:event name="load" handler="pur5320_orderHeader_loadFun"/>
                    <a:event name="update" handler="pur5320_orderHeader_updateFun"/>
                </a:events>
            </a:dataSet>
            <a:dataSet id="pur5320_purchaseOrderViewLineDetail_ds" autoCount="true" autoQuery="true" fetchAll="true" model="pur.PUR5320.pur_purchase_order_line_detail" queryUrl="${/request/@context_path}/autocrud/pur.PUR5320.pur_purchase_order_line_detail/query?pur_header_id=${/parameter/@pur_header_id}" selectable="true">
                <a:fields>
                    <a:field name="pur_header_id" defaultValue="${/parameter/@pur_header_id}"/>
                    <a:field name="pur_line_location_id"/>
                    <a:field name="item_code" autoComplete="true" autoCompleteField="code_name" lovHeight="480" lovService="pur.PUR5320.mtl_system_item_relations_lov" lovWidth="700" lovautoquery="false" required="false" title="BID_ENTRUSTMENT_LN_ITEMS.ITEM_CODE">
                        <a:mapping>
                            <a:map from="item_id" to="item_id"/>
                            <a:map from="item_code" to="item_code"/>
                            <a:map from="item_name" to="item_description"/>
                            <a:map from="primary_uom_code" to="unit_meas_lookup_code"/>
                            <a:map from="primary_uom_desc" to="unit_meas_lookup_code_desc"/>
                            <a:map from="item_category_id" to="category_id"/>
                            <a:map from="item_category_name" to="category_name"/>
                            <a:map from="item_category_code" to="category_code"/>
                            <a:map from="item_specs" to="item_specs"/>
                            <a:map from="item_model" to="item_model"/>
                            <a:map from="brand" to="brand"/>
                            <a:map from="item_price" to="unit_price"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="category_id" requiredMessage="${l:PUR5130.PLEASE_CHOOSE_MATL_CATEGORY}"/>
                    <a:field name="category_name" autoComplete="true" autoCompleteField="category_code_name" lovHeight="480" lovService="pur.PUR5130.mtl_categories_user_defined_vl" lovWidth="510" lovautoquery="true" title="PUR_REQUISITION_LNS.ITEM_CATEGORY_ID">
                        <a:mapping>
                            <a:map from="category_name" to="category_name"/>
                            <a:map from="category_udf_id" to="category_id"/>
                            <a:map from="category_code" to="category_code"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="unit_meas_lookup_code"/>
                    <a:field name="unit_meas_lookup_code_desc" autoComplete="true" autoCompleteField="code_name" lovGridHeight="350" lovHeight="500" lovService="public.fnd_uom_codes_lov" lovWidth="500" lovautoquery="true" required="true" requiredMessage="${l:PUR5130.PLEASE_CHOOSE_UNIT}" title="FND_UOM_CODES.UOM">
                        <a:mapping>
                            <a:map from="uom_code" to="unit_meas_lookup_code"/>
                            <a:map from="uom_desc" to="unit_meas_lookup_code_desc"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="tax_rate" autoComplete="true" autoCompleteField="tax_type_code" lovGridHeight="350" lovHeight="500" lovService="public.fnd_tax_type_code_lov?business_group=${/session/@business_group}" lovWidth="500" lovautoquery="true" title="PUR_LINES_ALL.TAX_RATE">
                        <a:mapping>
                            <a:map from="tax_type_id" to="tax_code_id"/>
                            <a:map from="tax_type_rate" to="tax_rate"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="ship_to_organization_id"/>
                    <a:field name="ship_to_organization_name" autoComplete="true" autoCompleteField="organization_code_name" lovHeight="500" lovService="public.inv_organizations_lov" lovWidth="650" lovautoquery="true" required="true" title="PUR_HEADERS_ALL.SHIP_TO_ORGANIZATION_ID">
                        <a:mapping>
                            <a:map from="business_unit_id" to="business_unit_id"/>
                            <a:map from="inv_organization_id" to="ship_to_organization_id"/>
                            <a:map from="inv_organization_name" to="ship_to_organization_name"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="warehouse_name" autoComplete="true" autoCompleteField="warehouse_code_name" lovHeight="500" lovService="public.inv_warehouse_lov" lovWidth="500" lovautoquery="true" readOnly="true" title="PUR_LINE_LOCATIONS_ALL.WAREHOUSE_ID">
                        <a:mapping>
                            <a:map from="warehouse_id" to="warehouse_id"/>
                            <a:map from="warehouse_name" to="warehouse_name"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="inv_location_name" autoComplete="true" autoCompleteField="location_code_name" lovHeight="500" lovService="public.inv_location_lov" lovWidth="500" lovautoquery="true" readOnly="true" title="PUR_LINE_LOCATIONS_ALL.INV_LOCATION_ID">
                        <a:mapping>
                            <a:map from="location_id" to="inv_location_id"/>
                            <a:map from="location_name" to="inv_location_name"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="quantity" required="true"/>
                    <a:field name="unit_price" required="true"/>
                    <a:field name="is_returned_flag" defaultValue="N"/>
                    <a:field name="is_returned_flag_desc" displayField="code_value_name" options="pur5320_yes_no_ds" returnField="is_returned_flag" valueField="code_value"/>
                    <a:field name="is_free_flag" defaultValue="N"/>
                    <a:field name="is_free_flag_desc" displayField="code_value_name" options="pur5320_yes_no_ds" returnField="is_free_flag" valueField="code_value"/>
                    <a:field name="is_immed_shipped_flag" defaultValue="N"/>
                    <a:field name="is_immed_shipped_flag_desc" displayField="code_value_name" options="pur5320_yes_no_ds" returnField="is_immed_shipped_flag" valueField="code_value"/>
                </a:fields>
                <a:events>
                    <a:event name="beforecreate" handler="pur5320_orderLine_beforecreateFun"/>
                    <a:event name="add" handler="pur5320_orderLine_addFun"/>
                    <a:event name="update" handler="pur5320_orderLine_updateFun"/>
                </a:events>
            </a:dataSet>
        </a:dataSets>
        <a:screenBody>
            <a:screenTopToolbar>
                <a:toolbarButton click="pur5320_purchaseOrderSaveFunction" text="HAP_SAVE" width="100"/>
                <a:toolbarButton id="pur5320_purchaseOrderSubmitBtu" click="pur5320_purchaseOrderSubmitFunction" text="PROMPT.SUBMIT" width="100"/>
                <a:toolbarButton id="pur5320_uploadAttachmentBtu" click="pur5320_UploadAttachmentFun" text="ATM.UPLOAD_ATTACHMENT" width="100"/>
                <a:toolbarButton id="pur5320_copyFromOtherPoBtu" click="pur5320_copyFromOtherPoFun" disabled="true" text="PUR5230_COPY" width="100"/>
                <a:toolbarButton id="pur5320_purchaseOrderDeleteBtu" click="pur5320_purchaseOrderDeleteFunction" text="PROMPT.DELETE" width="100"/>
                <a:toolbarButton click="pur_purchaseOrderViewRecordOpen" text="PUR_HEADERS_ALL.OPERATION_RECORD" width="100"/>
                <a:toolbarButton click="pur_purchaseOrderViewRecordClose_fun" text="HAP_BACK" width="100"/>
            </a:screenTopToolbar>
            <a:hBox labelWidth="100">
                <a:textField name="display_po_number" bindTarget="pur5320_purchaseOrderHeader_ds" emptyText="PROMPT.NOT_GENERATED" prompt="PUR_HEADERS_ALL.SEGMENT1" readOnly="true"/>
                <a:textField name="display_release_num" bindTarget="pur5320_purchaseOrderHeader_ds" prompt="PUR_HEADERS_ALL.RELEASE_NUM" readOnly="true"/>
                <a:textField name="revision_num" bindTarget="pur5320_purchaseOrderHeader_ds" emptyText="PROMPT.NOT_GENERATED" prompt="PUR_HEADERS_ALL.REVISION_NUM" readOnly="true"/>
                <a:lov name="pur_organization_name" bindTarget="pur5320_purchaseOrderHeader_ds" prompt="PROMPT.PUR_ORGANIZATION"/>
            </a:hBox>
            <a:hBox labelWidth="100">
                <a:lov name="agent_name" bindTarget="pur5320_purchaseOrderHeader_ds" prompt="PUR_HEADERS_ALL.PUR_BUYER"/>
                <a:comboBox name="currency_code" bindTarget="pur5320_purchaseOrderHeader_ds" prompt="PUR_HEADERS_ALL.CURRENCY_CODE"/>
                <a:textField name="sum_amount" bindTarget="pur5320_purchaseOrderHeader_ds" prompt="PUR_HEADERS_ALL.AMOUNT" readOnly="true" renderer="pur5320_purchaseOrderMoneyRenderFun"/>
                <a:textField name="data_source" bindTarget="pur5320_purchaseOrderHeader_ds" prompt="PUR_HEADERS_ALL.DATA_SOURCE" readOnly="true"/>
            </a:hBox>
            <a:hBox labelWidth="100">
                <a:comboBox name="company_name" bindTarget="pur5320_purchaseOrderHeader_ds" prompt="PUR_HEADERS_ALL.COMPANY"/>
                <a:comboBox name="type_lookup_desc" bindTarget="pur5320_purchaseOrderHeader_ds" prompt="PUR_HEADERS_ALL.ORDER_TYPE_ID"/>
                <a:lov name="ship_to_location_name" bindTarget="pur5320_purchaseOrderHeader_ds" prompt="PUR_HEADERS_ALL.SHIP_TO_LOCATION_ID"/>
                <a:lov name="bill_to_location_name" bindTarget="pur5320_purchaseOrderHeader_ds" prompt="PUR_HEADERS_ALL.BILL_TO_LOCATION_ID"/>
            </a:hBox>
            <a:hBox labelWidth="100">
                <a:textField name="creation_date_desc" bindTarget="pur5320_purchaseOrderHeader_ds" prompt="PUR_HEADERS_ALL.CREATION_DATE" readOnly="true"/>
                <a:textField name="release_date_desc" bindTarget="pur5320_purchaseOrderHeader_ds" prompt="PUR_HEADERS_ALL.RELEASE_DATE" readOnly="true"/>
                <a:lov name="vendor_name" bindTarget="pur5320_purchaseOrderHeader_ds" prompt="PUR_HEADERS_ALL.VENDOR_ID"/>
                <a:lov name="vendor_site_name" bindTarget="pur5320_purchaseOrderHeader_ds" prompt="PUR_HEADERS_ALL.VENDOR_SITE" readOnly="true"/>
            </a:hBox>
            <a:hBox labelWidth="100">
                <a:textArea name="comments" bindTarget="pur5320_purchaseOrderHeader_ds" height="30" prompt="PUR_HEADERS_ALL.COMMENTS" width="850"/>
            </a:hBox>
            <a:accordionPanel id="pur5320_purchaseOrderHeader_ds_accordionPanel" singleMode="false" width="963">
                <a:accordions>
                    <a:accordion prompt="PROMPT.OTHER_INFO" selected="false">
                        <a:hBox labelWidth="100">
                            <a:lov name="payment_terms" bindTarget="pur5320_purchaseOrderHeader_ds" prompt="付款条款"/>
                        </a:hBox>
                    </a:accordion>
                </a:accordions>
            </a:accordionPanel>
            <a:tabPanel marginHeight="240" marginWidth="30">
                <a:tabs>
                    <a:tab prompt="PROMPT.BASIC_INFOMATION" width="100">
                        <a:grid id="pur_purchaseOrderDetail_grid" bindTarget="pur5320_purchaseOrderViewLineDetail_ds" marginHeight="300" marginWidth="55" navBar="true">
                            <a:toolBar>
                                <a:button type="add"/>
                                <a:button type="delete"/>
                            </a:toolBar>
                            <a:columns>
                                <a:column name="line_num" align="center" lock="true" prompt="PUR_LINES_ALL.LINE_NUM" sortable="true" width="25"/>
                                <a:column name="shipment_num" align="center" lock="true" prompt="PUR_LINE_LOCATIONS_ALL.SHIPMENT_NUM" sortable="true" width="30"/>
                                <a:column name="item_code" align="center" editor="pur5320_purchaseOrderDetail_lov" lock="true" prompt="MTL_SYSTEM_ITEMS.ITEM_CODE" sortable="true" width="90"/>
                                <a:column name="item_description" align="center" editor="pur5320_purchaseOrderDetail_line_desc_tf" lock="true" prompt="MTL_SYSTEM_ITEMS.ITEM_NAME" width="100"/>
                                <a:column name="ean_code" align="left" editor="pur5320_purchaseOrderDetail_maxTf" lock="true" prompt="PUR_LINES_ALL.EAN_CODE" sortable="true" width="80"/>
                                <a:column name="quantity" align="right" editor="pur5320_purchaseOrderDetail_nf" lock="true" prompt="PUR_LINES_ALL.QUANTITY" sortable="true" width="30"/>
                                <a:column name="unit_meas_lookup_code_desc" align="center" editor="pur5320_purchaseOrderDetail_lov" lock="true" prompt="PUR_LINES_ALL.UNIT_MEAS_LOOKUP_CODE" width="30"/>
                                <a:column name="item_specs" align="left" prompt="MTL_SYSTEM_VENDOR_ITEMS.ITEM_SPECS" width="60"/>
                                <a:column name="item_model" align="left" prompt="MTL_SYSTEM_VENDOR_ITEMS.ITEM_MODEL" width="60"/>
                                <a:column name="manufacturer_name" align="left" prompt="MTL_SYSTEM_VENDOR_ITEMS.MANUFACTURER_NAME" width="100"/>
                                <a:column name="brand" align="left" prompt="MTL_SYSTEM_VENDOR_ITEMS.BRAND" width="100"/>
                                <a:column name="parent_po_num" editor="pur5320_purchaseOrderDetail_maxTf" prompt="PUR7010.ASSOCIATED_PO_NUMBER" width="60"/>
                                <a:column name="unit_price" align="right" editor="pur5320_purchaseOrderDetail_moneyNf" prompt="PUR_LINES_ALL.UNIT_PRICE" renderer="pur5320_purchaseOrderMoneyRenderFun" sortable="true" width="60"/>
                                <a:column name="line_amount" align="right" prompt="PUR_LINES_ALL.LINE_AMOUNT" renderer="pur5320_purchaseOrderMoneyRenderFun" width="40"/>
                                <a:column name="tax_rate" align="left" editor="pur5320_purchaseOrderDetail_lov" prompt="PUR_LINES_ALL.TAX_RATE" renderer="pur5320_purchaseOrderMoneyRenderFun" width="40"/>
                                <a:column name="need_by_date" align="center" editor="pur5320_purchaseOrderDetail_dp" prompt="PUR_LINE_LOCATIONS_ALL.NEED_BY_DATE" renderer="Aurora.formatDate" sortable="true" width="50"/>
                                <a:column name="promised_date" align="center" editor="pur5320_purchaseOrderDetail_dp" prompt="PUR_LINE_LOCATIONS_ALL.PROMISED_DATE" renderer="Aurora.formatDate" sortable="true" width="50"/>
                                <a:column name="request_arrival_date_desc" align="center" editor="pur5320_purchaseOrderDetail_dp" prompt="PUR_LINE_LOCATIONS_ALL.REQUEST_ARRIVAL_DATE" renderer="Aurora.formatDate" sortable="true" width="80"/>
                                <a:column name="consigned_flag" align="center" editor="pur5320_purchaseOrderDetail_cb" prompt="PUR_LINE_LOCATIONS_ALL.CONSIGNED_FLAG" width="50"/>
                                <a:column name="ship_to_organization_name" align="center" editor="pur5320_purchaseOrderDetail_lov" prompt="PUR_HEADERS_ALL.SHIP_TO_ORGANIZATION_ID" width="50"/>
                                <a:column name="warehouse_name" align="center" prompt="PUR_LINE_LOCATIONS_ALL.WAREHOUSE_ID" width="70"/>
                                <a:column name="inv_location_name" align="center" prompt="PUR_LINE_LOCATIONS_ALL.INV_LOCATION_ID" width="70"/>
                                <a:column name="line_desc" editor="pur5320_purchaseOrderDetail_line_desc_tf" prompt="PUR_LINES_ALL.PUR_LINE_DESC" width="140"/>
                            </a:columns>
                            <a:editors>
                                <a:lov id="pur5320_purchaseOrderDetail_lov"/>
                                <a:textField id="pur5320_purchaseOrderDetail_maxTf" maxLength="300"/>
                                <a:numberField id="pur5320_purchaseOrderDetail_nf" allowDecimals="true" allowFormat="true" allowNegative="false" decimalPrecision="2"/>
                                <a:numberField id="pur5320_purchaseOrderDetail_moneyNf" allowDecimals="true" allowFormat="true" allowNegative="false" decimalPrecision="8"/>
                                <a:datePicker id="pur5320_purchaseOrderDetail_dp"/>
                                <a:checkBox id="pur5320_purchaseOrderDetail_cb"/>
                                <a:textField id="pur5320_purchaseOrderDetail_line_desc_tf"/>
                            </a:editors>
                            <a:events>
                                <a:event name="cellClick" handler="pur5320_purchaseOrderDetail_gridCellClickFun"/>
                            </a:events>
                        </a:grid>
                    </a:tab>
                    <a:tab prompt="PROMPT.OTHER_INFO" width="100">
                        <a:grid id="pur_purchaseOrderViewDetail_others_grid" bindTarget="pur5320_purchaseOrderViewLineDetail_ds" marginHeight="300" marginWidth="55" navBar="true">
                            <a:toolBar>
                                <a:button type="add"/>
                                <a:button type="delete"/>
                            </a:toolBar>
                            <a:columns>
                                <a:column name="line_num" align="center" lock="true" prompt="PUR_LINES_ALL.LINE_NUM" sortable="true" width="25"/>
                                <a:column name="shipment_num" align="center" lock="true" prompt="PUR_LINE_LOCATIONS_ALL.SHIPMENT_NUM" sortable="true" width="30"/>
                                <a:column name="item_code" align="center" lock="true" prompt="MTL_SYSTEM_ITEMS.ITEM_CODE" sortable="true" width="90"/>
                                <a:column name="item_description" align="center" lock="true" prompt="MTL_SYSTEM_ITEMS.ITEM_NAME" width="100"/>
                                <a:column name="ean_code" align="left" lock="true" prompt="PUR_LINES_ALL.EAN_CODE" sortable="true" width="80"/>
                                <a:column name="quantity" align="right" lock="true" prompt="PUR_LINES_ALL.QUANTITY" sortable="true" width="30"/>
                                <a:column name="unit_meas_lookup_code_desc" align="center" lock="true" prompt="PUR_LINES_ALL.UNIT_MEAS_LOOKUP_CODE" width="30"/>
                                <a:column name="line_type_name" align="center" editor="pur5320_purchaseOrderOtherDetail_maxTf" prompt="PUR_LINES_ALL.LINE_TYPE_ID" width="80"/>
                                <a:column name="category_name" align="center" editorFunction="pur_purchaseOrderViewDetailOthersGridEditorFunction" prompt="PUR_RFX_LN_ITEMS.ITEM_CATEGORY_ID" width="80"/>
                                <a:column name="currency_code" align="center" prompt="PUR_HEADERS_ALL.CURRENCY_CODE" width="50"/>
                                <a:column name="rate" align="left" prompt="PUR_LINES_ALL.RATE" renderer="pur5320_purchaseOrderMoneyRenderFun" width="50"/>
                                <a:column name="original_unit_price" align="left" editor="pur5320_purchaseOrderOtherDetail_moneyNf" prompt="PUR_LINES_ALL.ORIGINAL_UNIT_PRICE" renderer="pur5320_purchaseOrderMoneyRenderFun" width="50"/>
                                <a:column name="is_returned_flag_desc" align="center" editor="pur5320_purchaseOrderOtherDetail_cbB" prompt="PUR_LINES_ALL.IS_RETURNED_FLAG" width="60"/>
                                <a:column name="is_free_flag_desc" align="center" editor="pur5320_purchaseOrderOtherDetail_cbB" prompt="PUR_LINES_ALL.IS_FREE_FLAG" width="60"/>
                                <a:column name="is_immed_shipped_flag_desc" align="center" editor="pur5320_purchaseOrderOtherDetail_cbB" prompt="PUR_LINES_ALL.IS_IMMED_SHIPPED_FLAG" width="60"/>
                                <a:column name="subject_assign" align="center" prompt="科目分配" renderer="pur5320_purchaseOrderViewDetailLineOtherInfoRenderer" width="60"/>
                                <a:column name="actual_receiver_name" align="center" editor="pur5320_purchaseOrderOtherDetail_maxTf" prompt="PUR_LINES_ALL.ACTUAL_RECEIVER_NAME" width="80"/>
                                <a:column name="ship_to_location_address" align="center" editor="pur5320_purchaseOrderOtherDetail_Tf" prompt="PUR_LINES_ALL.SHIP_TO_LOCATION_ADDRESS" width="80"/>
                                <a:column name="contacts_info" align="center" editor="pur5320_purchaseOrderOtherDetail_Tf" prompt="PUR_LINES_ALL.CONTACTS_INFO" width="80"/>
                                <a:column name="secondary_unit_of_measure" align="center" prompt="PUR_LINES_ALL.SECONDARY_UNIT_OF_MEASURE" width="80"/>
                                <a:column name="secondary_quantity" align="right" prompt="PUR_LINES_ALL.SECONDARY_QUANTITY" width="80"/>
                                <a:column name="vendor_desc" align="center" prompt="PUR_LINE_LOCATIONS_ALL.VENDOR_DESC" width="80"/>
                                <a:column name="c_attribute3" align="left" prompt="PUR_LINE_LOCATIONS_ALL.S_ATTRIBUTE4" width="80"/>
                                <a:column name="user_hold_flag_desc" align="center" prompt="PUR_LINES_ALL.USER_HOLD_FLAG" width="60"/>
                                <a:column name="frozen_flag_desc" align="center" prompt="PUR_LINE_LOCATIONS_ALL.FROZEN_FLAG" width="60"/>
                            </a:columns>
                            <a:editors>
                                <a:textField id="pur5320_purchaseOrderOtherDetail_maxTf" maxLength="300"/>
                                <a:comboBox id="pur5320_purchaseOrderOtherDetail_cbB"/>
                                <a:textField id="pur5320_purchaseOrderOtherDetail_Tf"/>
                                <a:numberField id="pur5320_purchaseOrderOtherDetail_moneyNf" allowDecimals="true" allowFormat="true" allowNegative="false" decimalPrecision="8"/>
                                <a:lov id="pur5320_purchaseOrderOtherDetail_lov"/>
                            </a:editors>
                        </a:grid>
                    </a:tab>
                </a:tabs>
            </a:tabPanel>
        </a:screenBody>
        <script><![CDATA[
        pur5320_initFun();
        ]]></script>
    </a:view>
</a:screen>
