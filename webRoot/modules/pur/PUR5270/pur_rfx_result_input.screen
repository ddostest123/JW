<?xml version="1.0" encoding="UTF-8"?>
<!--
    $Author: IsaacF  
    $Date: 2013-7-3 下午2:29:43  
    $Revision: 1.0  
    $Purpose: 
-->
<a:screen xmlns:a="http://www.aurora-framework.org/application" xmlns:s="aurora.plugin.script">
    <a:init-procedure><![CDATA[
    ]]></a:init-procedure>
    <a:view>
        <a:link id="pur52402_rfx_check_price_submit_link" model="pur.PUR5240.pur_rfx_check_price_submit" modelaction="execute"/>
        <a:link id="pur5240_rfx_feedback_vendor_quote_view_link" url="${/request/@context_path}/modules/pur/public/pur_rfx_feedback_vendor_quote_view.screen"/>
        <a:link id="bid6020_bidding_score_link" url="${/request/@context_path}/modules/bid/BID6020/bid_bidding_score.screen"/>
        <a:link id="pur5220_rfxLadderQuotationView_link" url="${/request/@context_path}/modules/pur/SACPUR5210/pur_rfx_ladder_quotation_view.screen"/>
        <a:link id="pur5220_rfx_assistance_v2_link" url="${/request/@context_path}/modules/pur/PUR5220/pur_rfx_assistance_v2.screen"/>
        <a:link id="pur52402_rfx_item_note_view_link" url="${/request/@context_path}/modules/pur/PUR5240/pur_rfx_item_note_view.screen"/>
        <a:link id="pur5220_rfx_item_history_price_link" url="${/request/@context_path}/modules/pur/public/pur_rfx_item_history_price.screen"/>
        <a:link id="pur5240_pur_rfx_feedback_all_save_link" url="${/request/@context_path}/modules/pur/PUR5270/pur_rfx_feedback_all_save.svc"/>
        <a:link id="pur_rfx_approval_config_confirm_link" url="${/request/@context_path}/modules/pur/PUR5240/pur_rfx_approval_config_confirm.screen"/>
        <style><![CDATA[
             #pur5240_rfx_item_price_contain{
                position:fixed;
                z-index:9;
                /* left: 1400px; */
                top: 0;
                width: 500px;
                height: 0px;
                background:#F7F7F7;
                overflow:auto;
                box-shadow: 0px 0px 10px 4px #ddd;
            }
        ]]></style>
        <script><![CDATA[
            var lineQueryFlag = [];
            
            var confirm_flag = 'N';
            
            //浮点数加法
            
            function pur5240_accAdd(arg1, arg2) {
                var r1, r2, m, c;
                try {
                    r1 = arg1.toString().split(".")[1].length;
                } catch (e) {
                    r1 = 0;
                }
                try {
                    r2 = arg2.toString().split(".")[1].length;
                } catch (e) {
                    r2 = 0;
                }
                c = Math.abs(r1 - r2);
                m = Math.pow(10, Math.max(r1, r2));
                if (c > 0) {
                    var cm = Math.pow(10, c);
                    if (r1 > r2) {
                        arg1 = Number(arg1.toString().replace(".", ""));
                        arg2 = Number(arg2.toString().replace(".", "")) * cm;
                    } else {
                        arg1 = Number(arg1.toString().replace(".", "")) * cm;
                        arg2 = Number(arg2.toString().replace(".", ""));
                    }
                } else {
                    arg1 = Number(arg1.toString().replace(".", ""));
                    arg2 = Number(arg2.toString().replace(".", ""));
                }
                return (arg1 + arg2) / m;
            }
            
            //浮点数除法 。
            
            function pur5240_accDiv(arg1, arg2) {
                var t1 = 0,
                    t2 = 0,
                    r1, r2;
                try {
                    t1 = arg1.toString().split(".")[1].length;
                } catch (e) {}
                try {
                    t2 = arg2.toString().split(".")[1].length;
                } catch (e) {}
                r1 = Number(arg1.toString().replace(".", ""));
                r2 = Number(arg2.toString().replace(".", ""));
                return (r1 / r2) * Math.pow(10, t2 - t1);
            }
            
            //浮点数乘法
            
            function pur5240_accMul(arg1, arg2) {
                var m = 0,
                    s1 = arg1.toString(),
                    s2 = arg2.toString();
                try {
                    m += s1.split(".")[1].length;
                } catch (e) {}
                try {
                    m += s2.split(".")[1].length;
                } catch (e) {}
                return Number(s1.replace(".", "")) * Number(s2.replace(".", "")) / Math.pow(10, m);
            }
            
            function pur52402_rfx_feedback_submit() {
               debugger;
                var ds = $('pur52402_rfx_feedback_all_ds');
                var hd_ds = $('pur52402_rfx_headers_ds');
                var record = hd_ds.getCurrentRecord();
                if (!ds.validate()) {
                    return;
                }
                if (ds.isModified()) {
                    Aurora.showMessage('${l:PROMPT}', '${l:PUR5240.UNSAVED_FOR_SUBMIT}');
                    return;
                }
            
                var rfx_header_id = ${/parameter/@rfx_header_id};
                var total_costs = record.get('total_costs');
                var cost_comments = record.get('cost_comments');
                var data = {};
                data.rfx_header_id = rfx_header_id;
                data.total_costs = total_costs;
                data.cost_comments = cost_comments;
            
                var approval_config_enable = record.get('approval_config_enable');
                if (approval_config_enable != 0) {
                    Aurora.Masker.mask($('pur5270_rfx_input_window').wrap, '${l:LOADING}');
                    new Aurora.Window({
                        id: 'pur_rfx_approval_config_confirm',
                        title: '审批配置录入',
                        url: $('pur_rfx_approval_config_confirm_link').getUrl() + '?rfx_header_id=' + rfx_header_id,
                        width: 450,
                        height: 350
                    }).on('beforeclose', function() {
                        Aurora.Masker.unmask($('pur5270_rfx_input_window').wrap);
                        if (confirm_flag == 'Y') {
                            Aurora.Masker.mask($('pur5270_rfx_input_window').wrap, '${l:LOADING}');
                            Aurora.request({
                                url: $('pur52402_rfx_check_price_submit_link').getUrl(),
                                para: data,
                                success: function(result) {
                                    Aurora.Masker.unmask($('pur5270_rfx_input_window').wrap);
                                    Aurora.showMessage('${l:PROMPT}', '${l:PUR5220.SUBMIT_SUCCESSFULLY}');
                                    window.setTimeout("pur52402_rfx_feedback_return()", 1000);
                                },
                                failure: function() {
                                    Aurora.Masker.unmask($('pur5270_rfx_input_window').wrap);
                                    return;
                                },
                                error: function() {
                                    Aurora.Masker.unmask($('pur5270_rfx_input_window').wrap);
                                    return;
                                }
                            });
            
                            // });
                        }
                    });
            
            
                } else {
                    Aurora.showConfirm('${l:PROMPT}', '${l:PUR5240.PRICE_CHECKED_SUBMIT_CONFIRM}', function() {
                        Aurora.Masker.mask($('pur5270_rfx_input_window').wrap, '${l:LOADING}');
                        Aurora.request({
                            url: $('pur52402_rfx_check_price_submit_link').getUrl(),
                            para: data,
                            // para: {
                            // rfx_header_id: ${/parameter/@rfx_header_id},
                            // total_costs: ${@total_costs},
                            // cost_comments: ${@cost_comments}
                            // },
                            success: function(result) {
                                Aurora.Masker.unmask($('pur5270_rfx_input_window').wrap);
                                Aurora.showMessage('${l:PROMPT}', '${l:PUR5220.SUBMIT_SUCCESSFULLY}');
                                window.setTimeout("pur52402_rfx_feedback_return()", 1000);
                            },
                            failure: function() {
                                Aurora.Masker.unmask($('pur5270_rfx_input_window').wrap);
                                return;
                            },
                            error: function() {
                                Aurora.Masker.unmask($('pur5270_rfx_input_window').wrap);
                                return;
                            }
                        });
            
                    });
                }
            }
            
            
            function pur52402_rfx_feedback_return() {
                $('pur5270_rfx_input_window').close();
            }
            
            
            function formatNumber2(value, decimalprecision) {
                if (Ext.isEmpty(value)) return '';
            
                value = String(value).replace(/,/g, '');
                if (isNaN(value)) return '';
                if (decimalprecision || decimalprecision === 0)
            
            
                var point_value = value.split('.');
                var in_length = (point_value.length == 2) ? '.' + point_value[1] : '';
            
            
                if (in_length.length - 1 < decimalprecision) {
            
                    decimalprecision = in_length.length - 1
                };
                if (in_length.length == 0) {
                    decimalprecision = 0;
                }
            
                value = Number(value).toFixed(decimalprecision);
            
                var ps = value.split('.');
                var sub = (ps.length == 2) ? '.' + ps[1] : '';
            
            
                var whole = ps[0];
                var r = /(\d+)(\d{3})/;
                while (r.test(whole)) {
                    whole = whole.replace(r, '$1' + ',' + '$2');
                }
            
                Math.round()
                v = whole + sub;
                return v;
            }
            
            function pur52402_formatNumber_render(value, record, name) {
                var lowest_flag = record.get('lowest_flag');
                if (lowest_flag == 'Y') {
            
                    return '<font color="red">' + formatNumber2(value, 8) + '</font>';
                } else {
                    return formatNumber2(value, 8);
                }
            
            
            }
            
            function pur52402_rfx_operation_record_fun() {
                new Aurora.Window({
                    url: '${/request/@context_path}/modules/pur/public/pur_rfx_operation_records.screen?rfx_header_id=${/parameter/@rfx_header_id}',
                    title: '${l:PROMPT.OPERATION_RECORD}',
                    id: 'pur_publicRfxOperationRecord_window',
                    width: 500,
                    height: 350
                });
            }
            
            function pur5240_rfxFeedbackVendorQuote_renderFun(value, record, name) {
                var quote_header_id = record.get('quote_header_id');
                var abandoned_flag = record.get('abandoned_flag');
                var source_from = record.get('source_from');
                if (record.get('source_from_code') == "OFFLINE" && !Ext.isEmpty(quote_header_id) && record.get('feedback_line_id')) {
                    return '<a href="javascript:sacpur52105_rfxFeedbackVendorQuote_openEditFun(' + record.get('feedback_line_id') + ',' + quote_header_id + ')">${l:PUR_RFX_QUOTE_TITLE}</a>';
                }
            
                if (abandoned_flag == 'N' && !Ext.isEmpty(quote_header_id)) {
                    return '<a href="javascript:pur5240_rfxFeedbackVendorQuote_openViewFun(' + record.get('feedback_line_id') + ')">${l:PUR_RFX_QUOTE_TITLE}</a>';
                }
                return ''
            }
            
            function sacpur52105_rfxFeedbackVendorQuote_openEditFun(feedback_line_id, quote_header_id) {
                new Aurora.Window({
                    url: $('sacpur52105_rfx_feedback_vendor_quote_edit_link').getUrl() + '?feedback_line_id=' + feedback_line_id + '&quote_header_id=' + quote_header_id,
                    title: '${l:PUR_RFX_QUOTE_TITLE}',
                    id: 'sacpur5210_rfx_feedback_vendor_quote_edit_window',
                    width: 900,
                    height: 430
                });
            }
            
            function pur5240_rfxFeedbackVendorQuote_openViewFun(feedback_line_id) {
                new Aurora.Window({
                    url: $('pur5240_rfx_feedback_vendor_quote_view_link').getUrl() + '?feedback_line_id=' + feedback_line_id,
                    title: '${l:PUR_RFX_QUOTE_TITLE}',
                    id: 'pur_public_rfx_feedback_vendor_quote_view_window',
                    width: 900,
                    height: 450
                });
            }
            
            function pur52402_rfxCheckPriceVendorsDetailGridEditorFunction(record, name) {
                if (name == "allotted_quantity") {
                    if (record.get('suggested_flag') == "Y") {
                        record.getMeta().getField('allotted_quantity').setRequired(true);
                        return 'pur52402_vendors_suggested_note_nf';
            
                    } else if (record.get('suggested_flag') == "N") {
                        record.getMeta().getField('allotted_quantity').setRequired(false);
                        return '';
                    }
                }
                if (name == "price_batch_quantity") {
                    if (record.get('suggested_flag') == "Y") {
                        return 'pur52402_vendors_suggested_note_nf';
            
                    } else if (record.get('suggested_flag') == "N") {
                        return '';
                    }
                }
            }
            
            
            function pur52402_rfxCheckPriceVendorsDetailGridEditorFunction2(record, name) {
                if (name == "allotted_quantity") {
                    if (record.get('suggested_flag') == "Y") {
                        record.getMeta().getField('allotted_quantity').setRequired(true);
                        return 'pur52402_vendors_suggested_note_nf2';
            
                    } else if (record.get('suggested_flag') == "N") {
                        record.getMeta().getField('allotted_quantity').setRequired(false);
                        return '';
                    }
                }
                if (name == "price_batch_quantity") {
                    if (record.get('suggested_flag') == "Y") {
                        return 'pur52402_vendors_suggested_note_nf2';
            
                    } else if (record.get('suggested_flag') == "N") {
                        return '';
                    }
                }
                if (name == "line_num") {
                    if (record.get('source_from') == "手工录入") {
                        return 'pur5270_lov';
            
                    } else {
                        return '';
                    }
                }
                if (name == "vendor_code") {
                    if (record.get('source_from') == "手工录入") {
                        return 'pur5270_lov';
            
                    } else {
                        return '';
                    }
                }
            
                if (name == "erp_vendor_code") {
                    if (record.get('source_from') == "手工录入") {
                        return 'pur5270_lov';
            
                    } else {
                        return '';
                    }
                }
                if (name == "vendor_desc") {
                    if (record.get('source_from') == "手工录入") {
                        return 'pur52402_vendors_suggested_note_tf2';
            
                    } else {
                        return '';
                    }
                }
                if (name == "valid_fb_retail_price") {
                    if (record.get('source_from') == "手工录入") {
                        return 'pur52402_valid_fb_retail_price_nb';
            
                    } else {
                        return '';
                    }
                }
            
                if (name == "feedback_expiry_date_from") {
                    if (record.get('source_from') == "手工录入") {
                        return 'pur52402_datePicker';
            
                    } else {
                        return '';
                    }
                }
            
                if (name == "feedback_expiry_date_to") {
                    if (record.get('source_from') == "手工录入") {
                        return 'pur52402_datePicker';
            
                    } else {
                        return '';
                    }
                }
            
                if (name == "promised_date") {
                    if (record.get('source_from') == "手工录入") {
                        return 'pur52402_datePicker';
            
                    } else {
                        return '';
                    }
                }
            
                if (name == "delivery_cycle") {
                    if (record.get('source_from') == "手工录入") {
                        return 'pur52402_valid_fb_delivery_cycle_nb2';
            
                    } else {
                        return '';
                    }
                }
                if (name == "valid_fb_reason") {
                    if (record.get('source_from') == "手工录入") {
                        return 'pur52402_vendors_suggested_note_tf2';
            
                    } else {
                        return '';
                    }
                }
                if (name == "valid_fb_wholesale_price") {
                    if (record.get('source_from') == "手工录入") {
                        return 'pur52402_suggested_operation_desc_nb2';
            
                    } else {
                        return '';
                    }
                }
            
                if (name == "min_purchase") {
                    if (record.get('source_from') == "手工录入") {
                        return 'pur52402_suggested_operation_desc_nb2';
            
                    } else {
                        return '';
                    }
                }
                if (name == "min_package") {
                    if (record.get('source_from') == "手工录入") {
                        return 'pur52402_suggested_operation_desc_nb2';
            
                    } else {
                        return '';
                    }
                }
            
            
            }
            
            
            function pur52402_rfx_assistance_v2() {
                //校验数据
                // var i_records = $('pur52402_rfx_ln_items_ds').getAll();
                // var v_records = $('pur52402_rfx_ln_vendors_ds').getAll();
                // if (i_records.length == 0 || v_records.length == 0) {
                // Aurora.showMessage('提示', '物料或供应商为空');
                // return;
                // }
                //打开窗口
                new Aurora.Window({
                    url: $('pur5220_rfx_assistance_v2_link').getUrl() + '?rfx_header_id=' + '${/parameter/@rfx_header_id}',
                    id: 'pur5220_rfx_assistance_window',
                    width: 850,
                    height: 480
                });
            }
            
            function bid6020BiddingDocmDetailRender(value, record, name) {
                if ('${/parameter/@status}' != 'SCORED') {
                    return '-';
                }
                return '<a href="javascript:bid6020BiddingScoreDetail(' + record.get('rfx_header_id') + "," + record.get('feedback_header_id') + ');">' + value + '</a>';
            }
            
            function bid6020BiddingScoreDetail(entrustment_header_id, bid_header_id) {
                new Aurora.Window({
                    id: 'bid6020_bidding_score_window',
                    title: '专家评分',
                    url: $('bid6020_bidding_score_link').getUrl() + '?entrustment_header_id=-' + entrustment_header_id + '&bid_header_id=-' + bid_header_id + '&round=${/parameter/@round}&version=${/parameter/@version}',
                    width: '800',
                    height: '400'
                });
            }
            
            function pur52202_rfxLadderQuotationRenderViewFun(value, record, name) {
                if (name == 'ladder_quotation') {
                    if (record.get('ladder_inquiry_flag') == 'N') {
                        return '-'
                    } else {
                        return '<a href="javascript:pur5220_rfxLadderQuotationViewFunction(' + record.get('feedback_line_id') + ')">阶梯报价</a>';
                    }
                }
            }
            
            function pur5220_rfxLadderQuotationViewFunction(feedback_line_id) {
                new Aurora.Window({
                    url: $('pur5220_rfxLadderQuotationView_link').getUrl() + '?feedback_line_id=' + feedback_line_id,
                    title: '阶梯报价',
                    id: 'pur5220_rfxLadderQuotationView_window',
                    width: 500,
                    height: 300
                });
            }
            
            // function pur52402_rfx_check_price_vendor_load(ds) {
            // var dataSet = $('pur52402_rfx_ln_items_ds');
            // var record = dataSet.getCurrentRecord();
            // lineQueryFlag.push(record.get('rfx_line_item_id'));
            // // rfxVendorDetailLoad(ds);
            // var list_ds = $('pur52402_rfx_vendors_detail_selected_ds');
            // var records = ds.getAll();
            // for (i = 0;i < records.length;i++) {
            // var feedback_line_id = records[i].get('feedback_line_id');
            // var result_record = list_ds.find('feedback_line_id', feedback_line_id);
            // if (Aurora.isEmpty(result_record)) {
            // $('pur52402_rfx_vendors_detail_selected_ds').create(records[i].data);
            // }
            // }
            
            
            
            // }
            
            function pur5240_item_attach_download(value, record, name) {
                var rfx_line_item_id = record.get('rfx_line_item_id');
                var atm_counts_item = record.get('atm_counts_item');
                var atm_counts_feedback = record.get('atm_counts_feedback');
                if (name == "item_attachment") {
                    if (rfx_line_item_id) {
                        return '<a href="javascript:pur5240_download_file(' + rfx_line_item_id + ')">${l:FND_ATM_LINES.ATM_DOWNLOAD}</a>';
                    }
            
                }
            
                if (name == "atm_flag_item") {
                    if (atm_counts_item > 0) {
                        return '<div style="margin-top:3px;margin-left:auto;margin-right:auto;vertical-align:middle;height:20px;line-height:20px;"><img src="${/request/@context_path}/images/paperclip.png"/></div>';
            
                    } else {
                        return '';
                    }
                }
            
                if (name == "atm_flag_feedback") {
                    if (atm_counts_feedback > 0) {
                        return '<div style="margin-top:3px;margin-left:auto;margin-right:auto;vertical-align:middle;height:20px;line-height:20px;"><img src="${/request/@context_path}/images/paperclip.png"/></div>';
            
                    } else {
                        return '';
                    }
                }
            }
            
            function pur5240_download_file(rfx_line_item_id) {
                var url = "${/request/@context_path}/check_uploadFile.screen?table_name=PUR_RFX_LN_ITEMS&header_id=" + rfx_line_item_id;
                new Aurora.Window({
                    url: url,
                    title: '${l:HAP_DOWNLOAD}',
                    id: 'pur5240_download_window',
                    width: 500,
                    height: 500
                });
            }
            
            function pur5240_vendor_attach_Download(value, record, name) {
                var atm_counts_feedback = record.get('atm_counts_feedback');
                var source_from = record.get('source_from');
                var feedback_line_id = record.get('feedback_line_id');
                if (name == "attachment_download" && source_from == '供应商报价') {
                    return '<a href="javascript:pur5240_attachment_Download(' + record.get('feedback_line_id') + ')">${l:FND_ATM_LINES.ATM_DOWNLOAD}</a>';
                }
            
                if (name == "attachment_download" && source_from == '手工录入' && feedback_line_id) {
                    return '<a href="javascript:sacpur5270_upload_file(' + feedback_line_id + ')">${l:PROMPT.UPLOAD_DOWNLOAD}</a>';
                }
            
                if (name == "atm_flag_feedback") {
                    if (atm_counts_feedback > 0) {
                        return '<div style="margin-top:3px;margin-left:auto;margin-right:auto;vertical-align:middle;height:20px;line-height:20px;"><img src="${/request/@context_path}/images/paperclip.png"/></div>';
            
                    } else {
                        return '';
                    }
                }
            }
            
            function sacpur5270_upload_file(id) {
                var url = "${/request/@context_path}/attachment_file_upload.screen?table_name=PUR_RFX_FEEDBACK_LINES&pkvalue=" + id;
                new Aurora.Window({
                    url: url,
                    title: '${l:HAP_UPLOAD_TITLE}',
                    id: 'sacpur5210_upload_window',
                    width: 500,
                    height: 500
                });
            }
            
            
            function pur5240_attachment_Download(feedback_line_id) {
                var url = "${/request/@context_path}/check_uploadFile.screen?table_name=PUR_RFX_FEEDBACK_LINES&header_id=" + feedback_line_id;
                new Aurora.Window({
                    url: url,
                    title: '${l:FND_ATM_LINES.ATM_DOWNLOAD}',
                    id: 'pur5240_firstTrialDownload_window',
                    width: 610,
                    height: 500
                });
            }
            
            function pur52402_rfx_headers_ds_update(ds, record, name, value, oldvalue) {
                var record = ds.getCurrentRecord();
                if (name == 'total_costs') {
            
                    if (Aurora.isEmpty(value) || value == 0) {
                        var total_costs = 0;
                    } else {
                        var total_costs = value * 1;
                    }
                    var account_total_costs = record.get('account_total_costs') * 1;
                    var exceed_money = record.get('exceed_money') * 1;
            
                    //超成本
                    if (account_total_costs > total_costs) {
            
                        record.set('exceed_cost_flag', 'Y');
                        record.set('exceed_cost_flag_desc', '是');
                        record.set('exceed_money', (account_total_costs - total_costs).toFixed(2));
            
                        if (total_costs == 0) {
                            record.set('exceed_percent', '-');
                        } else {
                            //计算超成本百分比 = 超成本金额/总成本金额  * 100
                            var exceed_percent = ((account_total_costs - total_costs).toFixed(2) / total_costs * 100).toFixed(2);
                            record.set('exceed_percent', exceed_percent);
                        }
            
                        //未超成本
                    } else {
                        record.set('exceed_cost_flag', 'N');
                        record.set('exceed_cost_flag_desc', '否');
                        record.set('exceed_money', 0);
                        record.set('exceed_percent', 0);
                    }
                }
            }
            
            
            function pur52402_rfxLnItemsGridRenderer(value, record, name) {
                if (name == "item_note") {
                    if (!Aurora.isEmpty(value) && value.length > 20) {
                        return '<a href="javascript:pur52402_rfxLnItemsView()">' + value + '</a>';
                    } else if (!Aurora.isEmpty(value) && value.length <= 20) {
                        return '<div>' + value + '</div>';
                    } else {
                        return '';
                    }
                }
            }
            
            function pur52402_rfxLnItemsView() {
                new Aurora.Window({
                    url: $('pur52402_rfx_item_note_view_link').getUrl(),
                    title: '查看物品说明',
                    id: 'pur52402_rfx_item_note_view_link_window',
                    width: 500,
                    height: 400
                });
            }
            
            function lowest_flag_desc_change(e, value, oldvalue) {
                var ds = $('pur52402_rfx_feedback_all_ds');
                var records = ds.getAll();
                if (value == '最低价策略') {
                    for (a = 0;a < records.length;a++) {
                        if (records[a].get('lowest_flag') == 'Y') {
                            records[a].set('suggested_flag', 'Y');
                        } else {
                            records[a].set('suggested_flag', 'N');
                        }
                    }
            
            
                } else if (value == '全部选用') {
            
                    for (b = 0;b < records.length;b++) {
                        records[b].set('suggested_flag', 'Y');
                    }
            
                } else {
                    for (c = 0;c < records.length;c++) {
                        records[c].set('suggested_flag', 'N');
                    }
                }
            
            
            }
            
            function feedback_all_update(ds, record, name, value, oldvalue) {
            
                record.dirty = true;
                var quantity = record.get('quantity');
                var price_batch_quantity = record.get('price_batch_quantity');
            
                var feedback_line_id = record.get('feedback_line_id');
            
                if (name == 'suggested_operation' && value != oldvalue) {
                    var records = ds.getAll();
                    var rfx_line_item_id = record.get('rfx_line_item_id');
                    var suggested_operation_desc = record.get('suggested_operation_desc');
                    for (i = 0;i < records.length;i++) {
                        if (records[i].get('rfx_line_item_id') == rfx_line_item_id) {
                            records[i].set('suggested_operation_desc', suggested_operation_desc);
                            records[i].set('suggested_operation', value);
                        }
                    }
            
                    if (value != 'SELECTED') {
                        if (record.get('suggested_flag') != 'N') {
                            record.set('suggested_flag', 'N');
                        }
                        record.set('suggested_feedback_line_id', '');
                    }
            
                }
                if (name == 'cost_price' && value != oldvalue) {
                    var records = ds.getAll();
                    var rfx_line_item_id = record.get('rfx_line_item_id');
                    for (i = 0;i < records.length;i++) {
                        if (records[i].get('rfx_line_item_id') == rfx_line_item_id) {
                            records[i].set('cost_price', value);
                        }
                    }
            
                }
                if (name == 'cost_total_price' && value != oldvalue) {
                    var records = ds.getAll();
                    var rfx_line_item_id = record.get('rfx_line_item_id');
                    for (i = 0;i < records.length;i++) {
                        if (records[i].get('rfx_line_item_id') == rfx_line_item_id) {
                            records[i].set('cost_total_price', value);
                        }
                    }
            
            
                }
            
                if (name == 'need_by_date' && value != oldvalue) {
                    var records = ds.getAll();
                    var rfx_line_item_id = record.get('rfx_line_item_id');
                    for (i = 0;i < records.length;i++) {
                        if (records[i].get('rfx_line_item_id') == rfx_line_item_id) {
                            records[i].set('need_by_date', value);
                        }
                    }
            
            
                }
                if (name == 'suggested_flag') {
            
            
                    if (value == 'Y') {
                        var feedback_line_id = record.get('feedback_line_id');
                        record.getMeta().getField('allotted_quantity').setRequired(true);
                        record.set('allotted_quantity', quantity);
                        record.set('price_batch_quantity', price_batch_quantity);
                        var suggested_operation = record.get('suggested_operation');
                        if (suggested_operation != 'SELECTED') {
                            record.set('suggested_operation_desc', '推荐供应商');
                            record.set('suggested_operation', 'SELECTED');
            
                        }
            
                    } else {
                        record.getMeta().getField('allotted_quantity').setRequired(false);
                        record.set('allotted_quantity', null);
                        record.set('price_batch_quantity', null);
            
                    }
            
                }
            
                if (name == 'suggested_note') {
            
            
            
                   }
            
                if (name == 'price_batch_quantity') {
            
                   }
            
                if (name == 'need_by_date') {
            
                   }
            
            
            
                if (name == "allotted_quantity") {
            
                    if (!Aurora.isEmpty(value) && value != 0) {
            
                        if (value > quantity) {
                            Aurora.showMessage('${l:PROMPT}', '请注意,分配数量大于需求数量');
            
                        }
            
                        //计算分配比例
                        var allotted_percentage = pur5240_accMul(pur5240_accDiv(value, quantity).toFixed(4), 100);
            
                        //赋值分配比例
                        record.set('allotted_percentage', allotted_percentage);
            
                    } else {
                        record.set('allotted_percentage', null);
                    }
                }
                if (name == 'vendor_code') {
            
                    if (value) {
                        record.getField('erp_vendor_code').setReadOnly(true);
                        record.getField('vendor_desc').setReadOnly(true);
                    } else {
                        record.getField('erp_vendor_code').setReadOnly(false);
                        record.getField('vendor_desc').setReadOnly(false);
                    }
            
                    // if (!Aurora.isEmpty(select_record)) {
                    // select_record.set('vendor_code', value);
                    // }
            
                }
            
                if (name == 'erp_vendor_code') {
            
                    if (value) {
                        record.getField('vendor_code').setReadOnly(true);
                        record.getField('vendor_desc').setReadOnly(true);
                    } else {
                        record.getField('vendor_code').setReadOnly(false);
                        record.getField('vendor_desc').setReadOnly(false);
                    }
            
                    // if (!Aurora.isEmpty(select_record)) {
                    // select_record.set('erp_vendor_code', value);
                    // }
            
                }
            
            
                if (name == 'line_num') {
            
            
                   }
            
                if (name == 'vendor_desc') {
            
                   }
            
            
            }
            
            function feedback_all_submitsuccess() {
                $('pur52402_rfx_ln_items_ds').query();
                $('pur52402_rfx_feedback_all_ds').query();
            }
            
            function feedback_all_beforesubmit(ds) {
                var records = ds.getAll();
                var line_num_total;
                var save_flag = 'Y';
                for (var i = 0;i < records.length;i++) {
            
                    var vendor_price_count = records[i].get('vendor_price_count');
                    var suggested_operation2 = records[i].get('suggested_operation');
                    var line_num = records[i].get('line_num');
                    //分配数量之和
                    var sum_allotted_quantity = 0;
                    var select_vendor_count = 0;
                    var quantity = records[i].get('quantity');
                    if (suggested_operation2 == "SELECTED") {
                        var quantity = records[i].get('quantity');
                        var rfx_line_item_id = records[i].get('rfx_line_item_id');
                        for (j = 0;j < records.length;j++) {
                            if (records[j].get('rfx_line_item_id') == rfx_line_item_id && records[j].get('suggested_flag') == 'Y') {
                                select_vendor_count++;
                                if (records[j].get('allotted_quantity') <= 0) {
                                    Aurora.showMessage('${l:PROMPT}', '已选用供应商分配数量应该大于0');
                                    return false;
                                } else {
                                    sum_allotted_quantity = pur5240_accAdd(sum_allotted_quantity, records[j].get('allotted_quantity'));
                                }
                            }
                        }
                        //取2位精度
                        sum_allotted_quantity = sum_allotted_quantity.toFixed(2);
            
                        //校验是否有选用供应商
                        if (select_vendor_count == 0) {
                            Aurora.showMessage('${l:PROMPT}', '没有选用供应商!');
                            return false;
                        }
            
                    }
                    if (suggested_operation2 == "BACK" && vendor_price_count > 0) {
                        save_flag = 'N';
                        if (line_num_total == undefined) {
                            line_num_total = line_num;
                        } else {
                            line_num_total = line_num_total + ',' + line_num;
                        }
            
                    }
                }
                if (save_flag == 'N') {
                    Aurora.showMessage('${l:PROMPT}', '行号' + line_num_total + ':  有报价，不能选择释放物品行!');
                    return false;
                }
            
            }
            
            function last_valid_fb_retail_price_render(value, record, name) {
                if (value) {
                    return '<a href="javascript:pur5240_rfxItem_history_price_openViewFun(' + record.get('rfx_line_item_id') + ')">' + value + '</a>';
            
                }
            
            }
            
            function pur5240_rfxItem_history_price_openViewFun(rfx_line_item_id) {
                new Aurora.Window({
                    url: $('pur5220_rfx_item_history_price_link').getUrl() + '?rfx_line_item_id=' + rfx_line_item_id,
                    title: '历史报价',
                    id: 'pur_public_rfx_item_history_price_view_window',
                    width: 850,
                    height: 400
                });
            }
            
            function pur52202_formatNumber_render(value, record, name) {
                return formatNumber2(value, 8);
            }
            
            
            
            
            
            
            
            
            function pur52402_rfx_feedback_all_saveFun() {
                var ds = $('pur52402_rfx_feedback_all_ds');
                var records = ds.getAll();
                var datas = [];
                for (var i = 0;i < records.length;i++) {
            
                    if (records[i].dirty) {
                        datas.push(records[i].data);
                    }
            
                }
                Aurora.Masker.mask($('pur5270_rfx_input_window').wrap, '${l:LOADING}');
                Aurora.request({
                    url: $('pur5240_pur_rfx_feedback_all_save_link').getUrl(),
                    para: datas,
                    success: function(result) {
                        Aurora.Masker.unmask($('pur5270_rfx_input_window').wrap);
                        $('pur52402_rfx_feedback_all_ds').query();
                    },
                    failure: function() {
                        Aurora.Masker.unmask($('pur5270_rfx_input_window').wrap);
                        return;
                    },
                    error: function() {
                        Aurora.Masker.unmask($('pur5270_rfx_input_window').wrap);
                        return;
                    }
                });
            
            }
            
            function pur5270_rfxDetailAttachment_renderFun(value, record, name) {
                return '<a href="javascript:pur5270_rfxDetailAttachment_openFun(' + record.get('atm_line_id') + ')">${l:PROMPT.VIEW_ATTACHMENT}</a>';
            }
            
            function pur5270_rfxDetailAttachment_openFun(atm_line_id) {
                var url = "${/request/@context_path}/check_uploadFile.screen?table_name=PUR_RFX_HEADERS&header_id=" + atm_line_id;
                new Aurora.Window({
                    url: url,
                    title: '${l:PROMPT.VIEW_ATTACHMENT}',
                    id: 'pur5130_rfxDetailAttachment_window',
                    width: 610,
                    height: 500
                });
            }
            
            /* 批量新增物品行 */
            function pur52402_rfx_batch_add_items() {
                var rfx_header_id=${/parameter/@rfx_header_id};
            
                new Aurora.Window({
                    url: '${/request/@context_path}/modules/pur/PUR5270/pur_rfx_batch_add_items.screen?rfx_header_id='+rfx_header_id,
                    title: '批量新增物品行信息',
                    id: 'pur52402_rfx_batch_add_items_win',
                    width: 570,
                    height: 500
                });
                $('pur52402_rfx_batch_add_items_win').on('close', function() {
                });
            }
        ]]></script>
        <a:dataSets>
            <a:dataSet id="pur52402_rfx_feedback_suggested_operation_ds" lookupCode="PUR_RFX_SUGGESTED_OPERATION"/>
            <a:dataSet id="pur52402_rfx_yes_or_not" lookupCode="YES_OR_NO"/>
            <a:dataSet id="pur52402_rfx_lowest_options_ds" lookupCode="PUR_RFX_CHECK_STRATEGY"/>
            <a:dataSet id="pur52402_rfx_headers_ds" autoQuery="true" model="pur.PUR5270.pur_rfx_check_price_query" queryUrl="${/request/@context_path}/autocrud/pur.PUR5270.pur_rfx_check_price_query/query?rfx_header_id=${/parameter/@rfx_header_id}">
                <a:fields>
                    <a:field name="tax_included_flag" readOnly="true"/>
                    <a:field name="sealed_bid_flag" readOnly="true"/>
                    <a:field name="department_approve_flag" readOnly="true"/>
                    <a:field name="exceed_cost_flag_desc" displayField="code_value_name" options="pur52402_rfx_yes_or_not" returnField="exceed_cost_flag" valueField="code_value"/>
                    <a:field name="firsttrail_comments" readOnly="true"/>
                </a:fields>
                <a:events>
                    <a:event name="update" handler="pur52402_rfx_headers_ds_update"/>
                </a:events>
            </a:dataSet>
            <a:dataSet id="pur71101_rfx_ln_attachments" autoQuery="true" fetchAll="true" model="public.fnd_atm_lines" queryUrl="${/request/@context_path}/autocrud/public.fnd_atm_lines/query?source_table_name=PUR_RFX_HEADERS&amp;source_pk_value=${/parameter/@rfx_header_id}">
                <a:fields>
                    <a:field name="atm_line_id"/>
                </a:fields>
            </a:dataSet>
            <a:dataSet id="pur5240_rfx_lowest_ds">
                <a:fields>
                    <a:field name="lowest_flag_desc" displayField="code_value_name" options="pur52402_rfx_lowest_options_ds" returnField="lowest_flag" valueField="code_value"/>
                </a:fields>
            </a:dataSet>
            <a:dataSet id="pur52402_rfx_feedback_all_ds" autoCount="true" autoPageSize="true" autoQuery="true" fetchAll="true" model="pur.PUR5270.pur_rfx_feedback_all" queryDataSet="pur5240_rfx_lowest_ds" queryUrl="${/request/@context_path}/autocrud/pur.PUR5270.pur_rfx_feedback_all/query?rfx_header_id=${/parameter/@rfx_header_id}" selectable="true">
                <a:fields>
                    <a:field name="source_from" defaultValue="手工录入"/>
                    <a:field name="line_num" lovGridHeight="300" lovHeight="450" lovLabelWidth="100" lovService="pur.PUR5270.pur_rfx_line_item_lov?rfx_header_id=${/parameter/@rfx_header_id}" lovWidth="600" required="true" title="NHLPUR7010.LINE_NUM">
                        <a:mapping>
                            <a:map from="line_num" to="line_num"/>
                            <a:map from="item_id" to="item_id"/>
                            <a:map from="item_code" to="item_code"/>
                            <a:map from="item_desc" to="item_desc"/>
                            <a:map from="item_note" to="item_note"/>
                            <a:map from="uom_code" to="uom_code"/>
                            <a:map from="uom_desc" to="uom_desc"/>
                            <a:map from="quantity" to="quantity"/>
                            <a:map from="item_category_id" to="item_category_id"/>
                            <a:map from="item_category_desc" to="item_category_desc"/>
                            <a:map from="rfx_line_item_id" to="rfx_line_item_id"/>
                            <a:map from="tax_type_rate" to="tax_type_rate"/>
                            <a:map from="suggested_operation" to="suggested_operation"/>
                            <a:map from="cost_price" to="cost_price"/>
                            <a:map from="cost_total_price" to="cost_total_price"/>
                            <a:map from="feedback_range" to="feedback_range"/>
                            <a:map from="item_parameter_config" to="item_parameter_config"/>
                            <a:map from="inv_organization_desc" to="inv_organization_desc"/>
                            <a:map from="req_number" to="req_number"/>
                            <a:map from="req_line_num" to="req_line_num"/>
                            <a:map from="work_num" to="work_num"/>
                            <a:map from="bom_num" to="bom_num"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="allotted_quantity" requiredMessage="分配数量不能为空"/>
                    <a:field name="suggested_flag" checkedValue="Y" defaultValue="N" uncheckedValue="N"/>
                    <a:field name="suggested_operation_desc" displayField="code_value_name" options="pur52402_rfx_feedback_suggested_operation_ds" required="true" returnField="suggested_operation" valueField="code_value"/>
                    <a:field name="erp_vendor_code" autoComplete="true" autoCompleteField="code_name" lovGridHeight="320" lovHeight="450" lovService="public.pur_vendors_lov" lovWidth="500" title="PUR5120.VENDOR">
                        <a:mapping>
                            <a:map from="vendor_id" to="vendor_id"/>
                            <a:map from="vendor_code" to="erp_vendor_code"/>
                            <a:map from="vendor_name" to="vendor_desc"/>
                            <a:map from="coop_business_group" to="coop_business_group"/>
                            <a:map from="coop_company_id" to="coop_company_id"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="vendor_code" autoComplete="true" autoCompleteField="vendor_code_desc" autoCompleteSize="2" lovGridHeight="320" lovHeight="480" lovService="pur.PUR5120.pur_rfx_vendor_lov" lovWidth="500" title="PUR_VENDORS.VENDOR">
                        <a:mapping>
                            <a:map from="coop_company_id" to="coop_company_id"/>
                            <a:map from="vendor_code" to="vendor_code"/>
                            <a:map from="vendor_desc" to="vendor_desc"/>
                            <a:map from="coop_business_group" to="coop_business_group"/>
                            <a:map from="contact_id" to="vendor_contact_id"/>
                            <a:map from="contact_person" to="contact_person"/>
                            <a:map from="contact_mobile" to="contact_mobile"/>
                            <a:map from="contact_mail" to="e_mail"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="valid_fb_retail_price" required="true"/>
                    <a:field name="vendor_desc" required="true"/>
                    <a:field name="feedback_expiry_date_from" required="true"/>
                    <a:field name="feedback_expiry_date_to" required="true"/>
                </a:fields>
                <a:events>
                    <!-- <a:event  name="load" handler="feedback_all_load"  /> -->
                    <a:event name="update" handler="feedback_all_update"/>
                    <a:event name="submitsuccess" handler="feedback_all_submitsuccess"/>
                    <a:event name="beforesubmit" handler="feedback_all_beforesubmit"/>
                    <!--  <a:event name="select" handler="pur5240_feedback_all_select"/>
                    <a:event name="unselect" handler="pur5240_feedback_all_unselect"/> -->
                </a:events>
            </a:dataSet>
            <!--  <a:dataSet id="pur5240_rfx_feedback_all_selected_list_ds"/>
            <a:dataSet id="pur52402_rfx_ln_items_selected_ds"/>
            <a:dataSet id="pur52402_rfx_vendors_detail_selected_ds"/> -->
        </a:dataSets>
        <a:screenBody>
            <a:screenTopToolbar>
                <a:toolbarButton click="pur52402_rfx_feedback_submit" text="HAP_SUBMIT" width="100"/>
                <a:toolbarButton click="pur52402_rfx_operation_record_fun" text="PROMPT.OPERATION_RECORD" width="100"/>
                <a:toolbarButton click="pur52402_rfx_feedback_return" text="HAP_BACK" width="100"/>
                <a:toolbarButton click="pur52402_rfx_assistance_v2" text="比价助手" width="100"/>
                <a:switch test="/parameter/@atm_counts">
                    <a:case value="1">
                        <div style="float:right;margin-top:10px;margin-left:auto;margin-right:20px;vertical-align:middle;">
                            <img src="${/request/@context_path}/images/paperclip.png"/>
                        </div>
                    </a:case>
                </a:switch>
            </a:screenTopToolbar>
            <a:vBox labelWidth="120" padding="0">
                <a:hBox labelWidth="120">
                    <a:textField name="rfx_number" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.RFX_NUMBER" readOnly="true"/>
                    <a:textField name="title" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.TITLE" readOnly="true"/>
                    <a:textField name="round" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.ROUND" readOnly="true"/>
                </a:hBox>
                <a:hBox labelWidth="120">
                    <a:textField name="comments" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.COMMENTS" readOnly="true" width="707"/>
                </a:hBox>
                <a:hBox labelWidth="120">
                    <a:textField name="firsttrail_comments" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.FIRSTTRAIL_COMMENTS" width="707"/>
                </a:hBox>
                <a:hBox>
                    <a:accordionPanel height="300" showIcon="true" singleMode="false" width="900">
                        <a:accordions>
                            <a:accordion prompt="PROMPT.OTHER_INFO" selected="false">
                                <a:vBox>
                                    <a:hBox labelWidth="120">
                                        <a:lov name="pur_organization_name" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_ORGANIZATIONS.PUR_ORG_NAME" readOnly="true"/>
                                        <a:lov name="business_unit_name" bindTarget="pur52402_rfx_headers_ds" prompt="FND_BUSINESS_UNITS.BUSINESS_UNIT" readOnly="true"/>
                                        <a:comboBox name="rfx_type_desc" bindTarget="pur52402_rfx_headers_ds" prompt="询价单类型" readOnly="true"/>
                                    </a:hBox>
                                    <a:hBox labelWidth="120">
                                        <a:comboBox name="rfx_method_desc" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.RFX_METHOD" readOnly="true"/>
                                        <a:comboBox name="payment_method_desc" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.PAYMENT_METHOD_ID" readOnly="true"/>
                                        <a:comboBox name="currency_desc" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.CURRENCY_CODE" readOnly="true"/>
                                    </a:hBox>
                                    <a:hBox labelWidth="120">
                                        <a:numberField name="exchange_rate" allowDecimals="true" allowFormat="true" allowNegative="false" bindTarget="pur52402_rfx_headers_ds" decimalPrecision="8" prompt="PUR_RFX_HEADERS.EXCHANGE_RATE" readOnly="true"/>
                                        <a:textField name="status_desc" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.STATUS" readOnly="true"/>
                                        <a:dateTimePicker name="feedback_end_time" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.FEEDBACK_END_TIME" readOnly="true"/>
                                    </a:hBox>
                                    <a:hBox labelWidth="120">
                                        <a:comboBox name="auction_direction_desc" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.AUCTION_DIRECTION" readOnly="true"/>
                                        <a:checkBox name="tax_included_flag" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.TAX_INCLUDED_FLAG" readOnly="true" width="152"/>
                                        <a:lov name="tax_type_desc" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.TAX_CODE" readOnly="true"/>
                                    </a:hBox>
                                    <a:hBox labelWidth="120">
                                        <a:textField name="tax_type_rate" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.TAX_RATE" readOnly="true"/>
                                        <a:checkBox name="sealed_bid_flag" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.SEALED_BID_FLAG" readOnly="true" width="152"/>
                                        <a:comboBox name="open_rule_desc" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.OPEN_RULE" readOnly="true"/>
                                    </a:hBox>
                                    <a:hBox labelWidth="120">
                                        <a:comboBox name="auction_ranking_desc" bindTarget="pur52402_rfx_headers_ds" prompt="竞价排名" readOnly="true"/>
                                        <a:dateTimePicker name="creation_date_desc" bindTarget="pur52402_rfx_headers_ds" prompt="创建时间" readOnly="true"/>
                                        <a:textField name="place_of_delivery" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.PLACE_OF_DELIVERY" readOnly="true"/>
                                    </a:hBox>
                                    <a:hBox labelWidth="120">
                                        <a:comboBox name="source_type_desc" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.SOURCE_TYPE" readOnly="true"/>
                                        <a:comboBox name="price_category_desc" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.PRICE_CATEGORY" readOnly="true"/>
                                        <a:checkBox name="department_approve_flag" bindTarget="pur52402_rfx_headers_ds" prompt="部门间审批" readOnly="true" width="152"/>
                                    </a:hBox>
                                </a:vBox>
                            </a:accordion>
                        </a:accordions>
                    </a:accordionPanel>
                </a:hBox>
                <a:hBox>
                    <a:accordionPanel id="pur5120_accordion_dim_cost" height="240" showIcon="true" singleMode="false" width="900">
                        <a:accordions>
                            <a:accordion prompt="PUR_RFX_HEADERS.COST_INFO" selected="false">
                                <a:vBox>
                                    <a:hBox labelWidth="120">
                                        <a:numberField name="total_costs" allowDecimals="true" allowFormat="false" allowNegative="false" bindTarget="pur52402_rfx_headers_ds" decimalPrecision="2" prompt="PUR_RFX_HEADERS.TOTAL_COSTS" width="152"/>
                                        <a:numberField name="account_total_costs" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.ACCOUNT_TOTAL_COSTS" readOnly="true"/>
                                    </a:hBox>
                                    <a:hBox labelWidth="120">
                                        <a:comboBox name="exceed_cost_flag_desc" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.EXCEED_COST_FLAG" readOnly="true" width="152"/>
                                        <a:numberField name="exceed_money" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.EXCEED_MONEY" readOnly="true"/>
                                        <a:textField name="exceed_percent" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.EXCEED_PERCENT" readOnly="true"/>
                                    </a:hBox>
                                    <a:hBox labelWidth="120">
                                        <a:textField name="cost_comments" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.COST_COMMENTS" width="707"/>
                                    </a:hBox>
                                    <a:hBox labelWidth="120" style="margin-left:60px;" width="500">
                                        <a:upload fileType="*.*" pkvalue="${/parameter/@rfx_header_id}" sourcetype="PUR_RFX_COST_ATTACHMENT" text="附件上传"/>
                                    </a:hBox>
                                </a:vBox>
                            </a:accordion>
                        </a:accordions>
                    </a:accordionPanel>
                </a:hBox>
            </a:vBox>
            <a:tabPanel height="570" marginWidth="130">
                <a:tabs>
                    <a:tab prompt="全部报价明细" width="120">
                        <a:grid id="pur52402_rfx_feedback_all" autoAppend="false" bindTarget="pur52402_rfx_feedback_all_ds" height="500" marginWidth="160" navBar="true">
                            <a:toolBar>
                                <a:button type="add"/>
                                <a:button type="delete"/>
                                <a:button click="pur52402_rfx_feedback_all_saveFun" text="PROMPT.SAVE"><![CDATA[
                                ]]></a:button>
                                <a:button click="pur52402_rfx_batch_add_items" icon="${/request/@context_path}/images/info.gif" style="margin-left:10px" text="批量新增"/>
                                <font style="margin-top:5px;"><![CDATA[选择策略：]]></font>
                                <a:comboBox name="lowest_flag_desc" bindTarget="pur5240_rfx_lowest_ds" style="margin-top:5px;" width="100">
                                    <a:events>
                                        <a:event name="change" handler="lowest_flag_desc_change"/>
                                    </a:events>
                                </a:comboBox>
                            </a:toolBar>
                            <a:columns>
                                <a:column name="source_from" align="center" prompt="信息来源" width="60"/>
                                <a:column name="line_num" align="center" editorFunction="pur52402_rfxCheckPriceVendorsDetailGridEditorFunction2" prompt="行号" width="30"/>
                                <a:column name="item_category_desc" align="left" prompt="PUR_RFX_LN_ITEMS.ITEM_CATEGORY_ID" width="60"/>
                                <a:column name="item_code" align="left" prompt="PUR_RFX_LN_ITEMS.ITEM_CODE" width="100"/>
                                <a:column name="item_desc" align="left" prompt="PUR_RFX_LN_ITEMS.ITEM_DESC" width="80"/>
                                <a:column name="uom_desc" align="left" prompt="PUR_RFX_LN_ITEMS.UOM_CODE" width="40"/>
                                <a:column name="suggested_operation_desc" align="left" editor="pur52402_suggested_operation_desc_cmb2" prompt="PUR_RFX_LN_ITEMS.SUGGESTED_OPERATION" width="50"/>
                                <a:column name="vendor_code" align="left" editorFunction="pur52402_rfxCheckPriceVendorsDetailGridEditorFunction2" prompt="PUR_RFX_FEEDBACK_HEADERS.VENDOR_CODE" width="70"/>
                                <a:column name="erp_vendor_code" align="left" editorFunction="pur52402_rfxCheckPriceVendorsDetailGridEditorFunction2" prompt="ERP供应商编码" width="70"/>
                                <a:column name="vendor_desc" align="left" editorFunction="pur52402_rfxCheckPriceVendorsDetailGridEditorFunction2" prompt="PUR_RFX_FEEDBACK_HEADERS.VENDOR_DESC" width="100"/>
                                <a:column name="valid_fb_retail_price" align="right" editorFunction="pur52402_rfxCheckPriceVendorsDetailGridEditorFunction2" prompt="PUR_RFX_FEEDBACK_LINES.VALID_FB_RETAIL_PRICE" renderer="pur52402_formatNumber_render" width="40"/>
                                <a:column name="tax_type_rate" align="center" prompt="税率" width="40"/>
                                <a:column name="suggested_flag" align="center" editor="pur52402_vendors_suggested_flag_ck2" prompt="PUR_RFX_FEEDBACK_LINES.SUGGESTED_FLAG" width="40"/>
                                <a:column name="ladder_quotation" align="center" prompt="阶梯报价" renderer="pur52202_rfxLadderQuotationRenderViewFun" width="50"/>
                                <a:column name="vendor_quote" align="center" prompt="PUR_RFX_QUOTE_TITLE" renderer="pur5240_rfxFeedbackVendorQuote_renderFun" width="50"/>
                                <a:column name="last_valid_fb_retail_price" align="right" prompt="PUR_RFX_FEEDBACK_LINES.LAST_QUOTE" renderer="last_valid_fb_retail_price_render" width="40"/>
                                <a:column name="floating_percentage" align="center" prompt="PUR_RFX_FEEDBACK_LINES.FLOAT_PRICE" width="40"/>
                                <a:column name="cost_price" align="left" editor="pur52402_suggested_operation_desc_nb2" prompt="PUR_RFX_LN_ITEMS.COST_PRICE" width="40"/>
                                <a:column name="cost_total_price" align="left" editor="pur52402_suggested_operation_desc_nb2" prompt="PUR_RFX_LN_ITEMS.COST_TOTAL_PRICE" width="40"/>
                                <a:column name="super_cost" align="center" prompt="PUR_RFX_FEEDBACK_LINES.SUPER_COST" width="40"/>
                                <a:column name="suggested_note" align="left" editor="pur52402_vendors_suggested_note_tf2" prompt="PUR_RFX_FEEDBACK_LINES.SUGGESTED_NOTE" width="70"/>
                                <a:column name="price_batch_quantity" align="right" editorFunction="pur52402_rfxCheckPriceVendorsDetailGridEditorFunction2" prompt="价格批量" width="40"/>
                                <a:column name="feedback_expiry_date_from" align="center" editorFunction="pur52402_rfxCheckPriceVendorsDetailGridEditorFunction2" prompt="PUR_RFX_FEEDBACK_LINES.FEEDBACK_EXPIRY_DATE_FROM" renderer="Aurora.formatDate" sortable="true" width="60"/>
                                <a:column name="feedback_expiry_date_to" align="center" editorFunction="pur52402_rfxCheckPriceVendorsDetailGridEditorFunction2" prompt="PUR_RFX_FEEDBACK_LINES.FEEDBACK_EXPIRY_DATE_TO" renderer="Aurora.formatDate" sortable="true" width="60"/>
                                <a:column name="allotted_quantity" align="right" editorFunction="pur52402_rfxCheckPriceVendorsDetailGridEditorFunction2" prompt="分配数量" width="40"/>
                                <a:column name="allotted_percentage" align="center" prompt="分配比例(%)" width="50"/>
                                <a:column name="need_by_date" align="left" editor="pur52402_datePicker" prompt="PUR_RFX_LN_ITEMS.NEED_BY_DATE" renderer="Aurora.formatDate" width="60"/>
                                <a:column name="promised_date" align="left" editorFunction="pur52402_rfxCheckPriceVendorsDetailGridEditorFunction2" prompt="PUR_RFX_FEEDBACK_LINES.PROMISED_DATE" renderer="Aurora.formatDate" width="60"/>
                                <a:column name="delivery_cycle" align="left" editorFunction="pur52402_rfxCheckPriceVendorsDetailGridEditorFunction2" prompt="PUR_RFX_LN_ITEMS.DELIVERY_CYCLE" width="60"/>
                                <a:column name="valid_fb_reason" align="left" editorFunction="pur52402_rfxCheckPriceVendorsDetailGridEditorFunction2" prompt="PUR_RFX_FEEDBACK_LINES.VALID_FB_REASON" width="100"/>
                                <a:column name="valid_fb_wholesale_price" align="right" editorFunction="pur52402_rfxCheckPriceVendorsDetailGridEditorFunction2" prompt="PUR_RFX_FEEDBACK_LINES.VALID_FB_WHOLESALE_PRICE" renderer="pur52202_formatNumber_render" width="60"/>
                                <a:column name="min_purchase" align="right" editorFunction="pur52402_rfxCheckPriceVendorsDetailGridEditorFunction2" prompt="最小采购量" width="50"/>
                                <a:column name="min_package" align="right" editorFunction="pur52402_rfxCheckPriceVendorsDetailGridEditorFunction2" prompt="最小包装量" width="50"/>
                                <a:column name="feedback_time" align="left" prompt="PUR_RFX_FEEDBACK_LINES.FEEDBACK_TIME" width="100"/>
                                <a:column name="feedback_range" align="left" prompt="PUR_RFX_LN_ITEMS.FEEDBACK_RANGE" width="40"/>
                                <a:column name="item_note" align="left" prompt="PUR_RFX_LN_ITEMS.ITEM_NOTE" renderer="pur52402_rfxLnItemsGridRenderer" width="80"/>
                                <a:column name="item_parameter_config" align="left" prompt="PUR_RFX_LN_ITEMS.ITEM_PARAMETER_CONFIG" width="60"/>
                                <a:column name="quantity" align="left" prompt="PUR_RFX_LN_ITEMS.QUANTITY" width="40"/>
                                <a:column name="inv_organization_desc" align="left" prompt="PUR_RFX_LN_ITEMS.INV_ORGANIZATION_ID" width="70"/>
                                <a:column name="req_number" prompt="PUR_RFX_LN_ITEMS.REQ_NUMBER" width="70"/>
                                <a:column name="req_line_num" prompt="PUR_RFX_LN_ITEMS.REQ_LINE_NUMBER" width="60"/>
                                <a:column name="work_num" prompt="PUR_RFX_LN_ITEMS.WORK_NUMBER" width="70"/>
                                <a:column name="bom_num" prompt="PUR_RFX_LN_ITEMS.BOM_NUMBER" width="70"/>
                                <a:column name="item_attachment" align="center" prompt="PUR_RFX_LN_ITEMS.REQ_ATTACHMENT" renderer="pur5240_item_attach_download" width="50"/>
                                <a:column name="attachment_download" align="center" prompt="PUR_RFX_LINE_VENDOR.ATTACHMENT" renderer="pur5240_vendor_attach_Download" width="50"/>
                            </a:columns>
                            <a:editors>
                                <a:lov id="pur5270_lov"/>
                                <a:datePicker id="pur52402_datePicker"/>
                                <a:comboBox id="pur52402_suggested_operation_desc_cmb2"/>
                                <a:numberField id="pur52402_suggested_operation_desc_nb2"/>
                                <a:numberField id="pur52402_valid_fb_retail_price_nb" allowDecimals="true" allowNegative="false" decimalPrecision="6"/>
                                <a:checkBox id="pur52402_vendors_suggested_flag_ck2" checkedValue="Y" uncheckedValue="N"/>
                                <a:textField id="pur52402_vendors_suggested_note_tf2"/>
                                <a:numberField id="pur52402_valid_fb_delivery_cycle_nb2" allowDecimals="false" allowNegative="false"/>
                                <a:numberField id="pur52402_vendors_suggested_note_nf2" allowDecimals="true" allowFormat="false" allowNegative="false" decimalPrecision="2"/>
                            </a:editors>
                            <a:events>
                                <!-- <a:event name="render" handler="pur52402_rfx_feedback_all_grid_render"/> --><![CDATA[
                                
                                
                                
                                
                                
                                
                                
                                
                            ]]></a:events>
                        </a:grid>
                    </a:tab>
                    <a:tab prompt="PUR5120.ATM_FILE_LIST" width="120">
                        <a:grid id="pur71101_atm_grid" bindTarget="pur71101_rfx_ln_attachments" height="350" marginWidth="40" navBar="true" showRowNumber="true">
                            <a:columns>
                                <a:column name="atm_desc" align="center" prompt="FND_ATM_LINES.ATM_DESC" width="100"/>
                                <a:column name="upload_user_name" align="center" prompt="FND_ATM_LINES.UPLOAD_USER_NAME" width="100"/>
                                <a:column align="center" prompt="FND_ATM_LINES.ATM_DOWNLOAD" renderer="pur5270_rfxDetailAttachment_renderFun" width="100"/>
                            </a:columns>
                        </a:grid>
                    </a:tab>
                </a:tabs>
            </a:tabPanel>
        </a:screenBody>
        <script><![CDATA[
            //初始化
            Aurora.onReady(function() {
            });
        ]]></script>
    </a:view>
</a:screen>
