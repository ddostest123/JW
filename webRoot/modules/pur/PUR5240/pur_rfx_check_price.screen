<?xml version="1.0" encoding="UTF-8"?>
<!--
    $Author: IsaacF  
    $Date: 2013-7-3 下午2:29:43  
    $Revision: 1.0  
    $Purpose: 
-->
<a:screen xmlns:a="http://www.aurora-framework.org/application" xmlns:s="aurora.plugin.script">
    <a:init-procedure>
        <s:server-script import="fnd_flex_dynamic_tools.js"/>
        <s:server-script import="fnd_flex_dynamic_page_main.js"/>
        <!-- he 2019-12-03 因一直在加载等待 所以去掉 
         <s:server-script import="fnd_flex_dynamic_grid_expanded.js"/>
         -->
        <a:model-query defaultWhereClause="cbi.config_classify_code = &apos;RFX&apos; AND cbi.config_item_code = &apos;RFX_14&apos;" fetchAll="true" model="public.get_fnd_config_center_bg_item_value" rootPath="bg_item_rfx_14"/>
    </a:init-procedure>
    <a:view>
        <script language="JavaScript" src="${/request/@context_path}/component/handMove.js"/>
        <a:link id="pur52402_rfx_check_price_submit_link" model="pur.PUR5240.pur_rfx_check_price_submit" modelaction="execute"/>
        <a:link id="pur52402_rfx_check_price_submit_new_link" url="pur_rfx_submit_to_oa.svc"/>
        <a:link id="pur52402_rfx_cux_inv_item_link" url="inv_item_to_ebs.svc"/>
        <a:link id="pur52402_rfx_check_price_cancel_new_link" model="pur.PUR5240.pur_rfx_check_price_submit" modelaction="delete"/>
        <a:link id="pur52402_rfx_feedback_records_detail_link" url="${/request/@context_path}/modules/pur/PUR5220/pur_rfx_feedback_records.screen"/>
        <a:link id="pur5240_rfx_feedback_vendor_quote_view_link" url="${/request/@context_path}/modules/pur/public/pur_rfx_feedback_vendor_quote_view.screen"/>
        <!-- <a:link id="pur52402_returnToFirstTrial_link" model="pur.PUR5240.pur_rfx_check_price_submit" modelaction="update"/> -->
        <a:link id="bid6020_bidding_score_link" url="${/request/@context_path}/modules/bid/BID6020/bid_bidding_score.screen"/>
        <a:link id="pur5220_rfxLadderQuotationView_link" url="${/request/@context_path}/modules/pur/SACPUR5210/pur_rfx_ladder_quotation_view.screen"/>
        <a:link id="pur5220_rfx_assistance_v2_link" url="${/request/@context_path}/modules/pur/PUR5220/pur_rfx_assistance_v2.screen"/>
        <a:link id="pur52402_rfx_cost_price_update_link" model="pur.PUR5130.pur_rfx_line_cost_price" modelaction="update"/>
        <a:link id="pur52402_rfx_ln_items_save_link" url="${/request/@context_path}/modules/pur/PUR5240/pur_rfx_check_price_save.svc"/>
        <a:link id="pur52402_rfx_item_note_view_link" url="${/request/@context_path}/modules/pur/PUR5240/pur_rfx_item_note_view.screen"/>
        <a:link id="pur_rfx_approval_config_confirm_link" url="${/request/@context_path}/modules/pur/PUR5240/pur_rfx_approval_config_confirm.screen"/>
        <a:link id="pur5220_rfx_item_history_price_link" url="${/request/@context_path}/modules/pur/public/pur_rfx_item_history_price.screen"/>
        <a:link id="pur5240_pur_rfx_feedback_all_save_link" url="${/request/@context_path}/modules/pur/PUR5240/pur_rfx_feedback_all_save.svc"/>
        <a:link id="pur52402_pur_rfx_returntotrial_link" url="${/request/@context_path}/modules/pur/PUR5240/pur_rfx_returntotrial.screen"/>
        <a:link id="pur52202_rfx_lastBid_vender_link" url="${/request/@context_path}/modules/pur/PUR5220/pur_rfx_feedback_lastbid_vender.screen"/>
        <a:link id="zhy_pur52402_allocation_ratio_link" url="${/request/@context_path}/modules/cux/ZHY/ZHYPUR1050/zhypur1050_amount_reference.screen"/>
        <a:link id="zhy_pur1050_allocation_ratio_link" model="cux.ZHY.ZHYPUR1050.zhypur1050_amount_reference" modelaction="batch_update"/>
        <a:link id="template_link" url="${/request/@context_path}/modules/cux/KINWONG/rfx/rfx5020/rfx5020_template_print.screen"/>
        <a:link id="pur5220_expressFrame_maintain_link" url="${/request/@context_path}/modules/pur/PUR5220/pur_express_frame_readonly.screen"/>
        <a:link id="pur5220_logisticsFrame_maintain_link" url="${/request/@context_path}/modules/pur/PUR5220/pur_domestic_logistics_frame_readonly.screen"/>
        <a:link id="pur5220_vehicleFrame_maintain_link" url="${/request/@context_path}/modules/pur/PUR5220/pur_vehicle_logistics_frame_readonly.screen"/>
        <a:link id="pur51302_rfx_first_trial_link" url="${/request/@context_path}/modules/pur/PUR5130/pur_rfx_first_trial.svc"/>
        <a:link id="pur5130_rfx_first_trail_maintain_link" url="${/request/@context_path}/modules/pur/PUR5130/pur_rfx_first_trial_maintain.screen"/>
        <style><![CDATA[
             #pur5240_rfx_item_price_contain{
                position:fixed;
                z-index:9;
                /* left: 1400px; */
                top: 0;
                width: 500px;
                height: 0px;
                background:#F7F7F7;
                overflow:auto;
                box-shadow: 0px 0px 10px 4px #ddd;
            }
        ]]></style>
        <script><![CDATA[
            var lineQueryFlag = [];
            
            var confirm_flag = 'N';
            var items_dirty;
            var items_quoat_dirty;
            function diaplayTab(id) {
                var ui = document.getElementById(id);
                ui.style.display = "none";
            }
          
          	function showTab(id) {
                var ui = document.getElementById(id);
                ui.style.display = "";
            }
            function pur5240_init() {
                initItemRfxWindow();
            }
            //初始化数量分配参考按钮
            
            
            function init_button() {
                var record = $('zhypur1050_bg_judge_ds').getCurrentRecord();
                var bg_zhy = record.get('bg_zhy');
                var bg_session = record.get('bg_session');
                if (bg_zhy != bg_session) {
                    document.getElementById('zhy_pur52402_ratio_but').style.display = 'none';
                }
            }
            //浮点数加法
            
            function pur5240_accAdd(arg1, arg2) {
                var r1, r2, m, c;
                try {
                    r1 = arg1.toString().split(".")[1].length;
                } catch (e) {
                    r1 = 0;
                }
                try {
                    r2 = arg2.toString().split(".")[1].length;
                } catch (e) {
                    r2 = 0;
                }
                c = Math.abs(r1 - r2);
                m = Math.pow(10, Math.max(r1, r2));
                if (c > 0) {
                    var cm = Math.pow(10, c);
                    if (r1 > r2) {
                        arg1 = Number(arg1.toString().replace(".", ""));
                        arg2 = Number(arg2.toString().replace(".", "")) * cm;
                    } else {
                        arg1 = Number(arg1.toString().replace(".", "")) * cm;
                        arg2 = Number(arg2.toString().replace(".", ""));
                    }
                } else {
                    arg1 = Number(arg1.toString().replace(".", ""));
                    arg2 = Number(arg2.toString().replace(".", ""));
                }
                return (arg1 + arg2) / m;
            }
            
            //浮点数除法 。
            
            function pur5240_accDiv(arg1, arg2) {
                var t1 = 0,
                    t2 = 0,
                    r1, r2;
                try {
                    t1 = arg1.toString().split(".")[1].length;
                } catch (e) {}
                try {
                    t2 = arg2.toString().split(".")[1].length;
                } catch (e) {}
                r1 = Number(arg1.toString().replace(".", ""));
                r2 = Number(arg2.toString().replace(".", ""));
                return (r1 / r2) * Math.pow(10, t2 - t1);
            }
            
            //浮点数乘法
            
            function pur5240_accMul(arg1, arg2) {
                var m = 0,
                    s1 = arg1.toString(),
                    s2 = arg2.toString();
                try {
                    m += s1.split(".")[1].length;
                } catch (e) {}
                try {
                    m += s2.split(".")[1].length;
                } catch (e) {}
                return Number(s1.replace(".", "")) * Number(s2.replace(".", "")) / Math.pow(10, m);
            }
            
            function pur52402_rfx_feedback_records_detail(feedback_line_id) {
                new Aurora.Window({
                    url: $('pur52402_rfx_feedback_records_detail_link').getUrl() + '?feedback_line_id=' + feedback_line_id,
                    title: '${l:PROMPT.OPERATION_RECORD}',
                    id: 'pur52203_rfx_feedback_records_window',
                    fullScreen: true
                });
            }
            
            function pur52402_rfx_feedback_records_render(value, rec, name) {
                var feedback_line_id = rec.get('feedback_line_id');
                return '<a href="javascript:pur52402_rfx_feedback_records_detail(' + feedback_line_id + ')">${l:PUR_RFX_FEEDBACK_LINES.FEEDBACK_HISTORY}</a>';
            
            }
            
        /**
         * 提交 按钮事件
         */
            function pur52402_rfx_feedback_submit() {
                var ds = $('pur52402_rfx_check_price_vendors_detail_ds');
                var hd_ds = $('pur52402_rfx_headers_ds');
                var vendor_all_ds = $('pur52402_rfx_ln_vendors_ds');
                var vendor_ds = $('pur52402_rfx_feedback_all_ds');
                var  suggested_flag = 'N';      
                var record = hd_ds.getCurrentRecord();
                var item_ds = $('pur52402_rfx_ln_items_ds');
                if (!ds.validate() || (!vendor_all_ds.validate())) {
                    return;
                }
                var records = ds.getAll();
                for (var i = 0;i < records.length;i++) {
                   if (records[i].get('suggested_flag') == 'Y'){
                       suggested_flag = 'Y';
                    }
                     
                }
                if (suggested_flag == 'N') {
                    Aurora.showMessage('${l:PROMPT}', '请至少备用选用供应商到oa审批');
                    return;
                }
                
                // add he 2019-12-03  RFQ2019070500004
               // Aurora.showMessage('提示!!2233', record.get('owner_business_unit_id'));
               // return;
                //
                //debugger;
                //console.log(vendor_all_ds);
                if (items_quoat_dirty=='Y' || items_dirty=='Y' || vendor_all_ds.isModified()) {
                    Aurora.showMessage('${l:PROMPT}', '${l:PUR5240.UNSAVED_FOR_SUBMIT}');
                    return;
                }
                // 检查物料编码是否为空
                if (item_ds.data.length > 0) {
                    var rowNumbersNoItemCode = [];
                    item_ds.data.forEach(function (item, index) {
                        if (item.data && (!item.data.item_code || item.data.item_code === '-')) {
                            rowNumbersNoItemCode.push(index);
                        }
                    });
                    if (rowNumbersNoItemCode.length > 0) {
                        var rowNumbers = '';
                        rowNumbersNoItemCode.forEach(function (rowNumber) {
                            rowNumbers += (rowNumber + 1) + '、';
                        })
                        rowNumbers = rowNumbers.substring(0, rowNumbers.length - 1);
                        Aurora.showMessage('${l:PROMPT}', '第' + rowNumbers + '行不存在物料编码');
                        return;
                    }
                }
                datas = {};
                datas['cost_comments'] = record.get('cost_comments');
                datas['total_costs'] = record.get('total_costs');
                datas['rfx_header_id'] = record.get('rfx_header_id');
                var type_po_item = record.get('type_po_item');
                //add begin he 2019-12-03  RFQ2019070500004
                datas['owner_business_unit_id'] = record.get('owner_business_unit_id');
                 //add end he 2019-12-03  RFQ2019070500004
                
                if(type_po_item =='TEST_STRUCTS'){
                    Aurora.Masker.mask($('pur52402_rfx_check_price_window').wrap, '${l:LOADING}');
                    Aurora.request({
                            url: $('pur52402_rfx_cux_inv_item_link').getUrl(),
                            para: datas,
                            success: function() {
                            Aurora.Masker.unmask($('pur52402_rfx_check_price_window').wrap);
                            Aurora.showMessage('${l:PROMPT}', '${l:PUR5220.SUBMIT_SUCCESSFULLY}');
                            window.setTimeout("pur52402_rfx_feedback_return()", 1000);
                    },
                    failure: function() {
                        Aurora.Masker.unmask($('pur52402_rfx_check_price_window').wrap);
                        return;
                    },
                    error: function() {
                        Aurora.Masker.unmask($('pur52402_rfx_check_price_window').wrap);
                        return;
                    } 
                });
                }
                else{
                Aurora.Masker.mask($('pur52402_rfx_check_price_window').wrap, '${l:LOADING}');
                Aurora.request({
                    url: $('pur52402_rfx_check_price_submit_new_link').getUrl(),
                    para: datas,
                    success: function() {
                    Aurora.Masker.unmask($('pur52402_rfx_check_price_window').wrap);
                   Aurora.showMessage('${l:PROMPT}', '${l:PUR5220.SUBMIT_SUCCESSFULLY}');
                   window.setTimeout("pur52402_rfx_feedback_return()", 1000); 
                   },
                    failure: function() {
                        Aurora.Masker.unmask($('pur52402_rfx_check_price_window').wrap);
                        return;
                    },
                    error: function() {
                        Aurora.Masker.unmask($('pur52402_rfx_check_price_window').wrap);
                        return;
                    }
                });
                }
             
                // if (approval_config_enable != 0) {
                // Aurora.Masker.mask($('pur52402_rfx_check_price_window').wrap, '${l:LOADING}');
                // new Aurora.Window({
                // id: 'pur_rfx_approval_config_confirm',
                // title: '${l:PUR5240.APPROVAL_CONFIGURATION_ENTRY}',
                // url: $('pur_rfx_approval_config_confirm_link').getUrl() + '?rfx_header_id=' + rfx_header_id,
                // width: 450,
                // height: 350
                // }).on('beforeclose', function() {
                // Aurora.Masker.unmask($('pur52402_rfx_check_price_window').wrap);
                // if (confirm_flag == 'Y') {
                // // Aurora.showConfirm('${l:PROMPT}', '${l:PUR5240.PRICE_CHECKED_SUBMIT_CONFIRM}', function() {
                // Aurora.Masker.mask($('pur52402_rfx_check_price_window').wrap, '${l:LOADING}');
                // Aurora.request({
                // url: $('pur52402_rfx_check_price_submit_link').getUrl(),
                // para: data,
                // // para: {
                // // rfx_header_id: ${/parameter/@rfx_header_id},
                // // total_costs: ${@total_costs},
                // // cost_comments: ${@cost_comments}
                // // },
                // success: function(result) {
                // Aurora.Masker.unmask($('pur52402_rfx_check_price_window').wrap);
                // Aurora.showMessage('${l:PROMPT}', '${l:PUR5220.SUBMIT_SUCCESSFULLY}');
                // window.setTimeout("pur52402_rfx_feedback_return()", 1000);
                // },
                // failure: function() {
                // Aurora.Masker.unmask($('pur52402_rfx_check_price_window').wrap);
                // return;
                // },
                // error: function() {
                // Aurora.Masker.unmask($('pur52402_rfx_check_price_window').wrap);
                // return;
                // }
                // });
            
                // // });
                // }
                // });
            
            
                // } else {
                // Aurora.showConfirm('${l:PROMPT}', '${l:PUR5240.PRICE_CHECKED_SUBMIT_CONFIRM}', function() {
                // Aurora.Masker.mask($('pur52402_rfx_check_price_window').wrap, '${l:LOADING}');
                // Aurora.request({
                // url: $('pur52402_rfx_check_price_submit_link').getUrl(),
                // para: data,
                // // para: {
                // // rfx_header_id: ${/parameter/@rfx_header_id},
                // // total_costs: ${@total_costs},
                // // cost_comments: ${@cost_comments}
                // // },
                // success: function(result) {
                // Aurora.Masker.unmask($('pur52402_rfx_check_price_window').wrap);
                // Aurora.showMessage('${l:PROMPT}', '${l:PUR5220.SUBMIT_SUCCESSFULLY}');
                // window.setTimeout("pur52402_rfx_feedback_return()", 1000);
                // },
                // failure: function() {
                // Aurora.Masker.unmask($('pur52402_rfx_check_price_window').wrap);
                // return;
                // },
                // error: function() {
                // Aurora.Masker.unmask($('pur52402_rfx_check_price_window').wrap);
                // return;
                // }
                // });
            
                // });
                // }
            }
            
            function pur52402_pur_rfx_returntotrial() {
                // var rfx_header_id = ${/parameter/@rfx_header_id}
                new Aurora.Window({
                    url: $('pur52402_pur_rfx_returntotrial_link').getUrl() + '?rfx_header_id=' + '${/parameter/@rfx_header_id}',
                    title: '退回至初审',
                    id: 'pur_rfx_returntotrial_window',
                    width: 500,
                    height: 100
                });
            }
            
            function pur52402_rfx_feedback_return() {
                $('pur52402_rfx_check_price_window').close();
            }
            
            function pur52402_rfx_check_price_vendors_detail_ds_submitsuccess(ds, res) {
                pur52402_window_reload();
            }
            
            function pur52402_rfx_check_price_items_detail_ds_submitsuccess(ds, res) {
                pur52402_window_reload();
            }
            
            function pur52402_window_reload() {
                $('pur52402_rfx_check_price_items_detail_ds').query();
                $('pur52402_rfx_check_price_vendors_detail_ds').query();
            }
            
            function pur52402_seggusted_flag_reset(feedback_line_id) {
                var ds = $('pur52402_rfx_check_price_vendors_detail_ds');
                var records = ds.getAll();
                for (var i = 0;i < records.length;i++) {
                    if (records[i].get('feedback_line_id') == feedback_line_id) {
                        //records[i].set('suggested_flag', 'Y');
                    } else {
                        records[i].set('suggested_flag', 'N');
                    }
                }
            }
            
            function pur52402_seggusted_flag_resetAll() {
                var ds = $('pur52402_rfx_check_price_vendors_detail_ds');
                var records = ds.getAll();
                for (var i = 0;i < records.length;i++) {
                    if (records[i].get('suggested_flag') != 'N') {
                        records[i].set('suggested_flag', 'N');
                    }
                }
            }
            
            
            function pur52402_item_suggested_operation_selected(rfx_line_item_id, feedback_line_id) {
                var records = $('pur52402_rfx_ln_items_ds').getAll();
                for (var i = 0;i < records.length;i++) {
                    if (records[i].get('rfx_line_item_id') == rfx_line_item_id) {
                        var suggested_operation = records[i].get('suggested_operation');
                        if (suggested_operation != 'SELECTED') {
                            records[i].set('suggested_operation', 'SELECTED');
                            records[i].set('suggested_operation_desc', '${l:PUR5240.RECOMMENDED_VENDOR}');
                            // records[i].set('suggested_operation_desc','${l:PUR5240.SUGGEST_VENDORS}');
                        }
                        records[i].set('suggested_feedback_line_id', feedback_line_id);
                    }
                }
            }
            
            function pur52402_item_suggested_operation_unselected(rfx_line_item_id, feedback_line_id) {
                var records = $('pur52402_rfx_ln_items_ds').getAll();
                for (var i = 0;i < records.length;i++) {
                    if (records[i].get('rfx_line_item_id') == rfx_line_item_id) {
                        if (records[i].get('suggested_feedback_line_id') == feedback_line_id) {
                            var vendor_records = $('pur52402_rfx_check_price_vendors_detail_ds').getAll();
                            var valid_fb_retail_price = 9999999999;
                            for (j = 0;j < vendor_records.length;j++) {
                                if (vendor_records[j].get('suggested_flag') == 'Y' && vendor_records[j].get('valid_fb_retail_price') < valid_fb_retail_price) {
                                    valid_fb_retail_price = vendor_records[j].get('valid_fb_retail_price');
                                    pur52402_item_suggested_operation_selected(vendor_records[j].get('rfx_line_item_id'), vendor_records[j].get('feedback_line_id'));
                                }
                            }
            
                        } else {
                            return;
                        }
                    }
                }
            }
            
            //物料行
			function pur52402_rfx_ln_items_ds_load(ds){
			    items_dirty = 'N';
			}
            function pur52402_rfx_ln_items_ds_update(ds, record, name, value, oldvalue) {
                ds.select(record);
                record.dirty = false;
                items_dirty = 'Y';
                var dataset = $('pur52402_rfx_check_price_vendors_detail_ds');
                var rfx_line_item_id = record.get('rfx_line_item_id');
                var list_ds = $('pur52402_rfx_ln_items_selected_ds');
                var select_record = list_ds.find('rfx_line_item_id', rfx_line_item_id);
            
            
                if (name == "suggested_operation") {
            
                    if (value != 'SELECTED') {
                        var check_price_vendors_detail_ds = $('pur52402_rfx_check_price_vendors_detail_ds');
                        pur52402_seggusted_flag_resetAll();
                        record.set('suggested_feedback_line_id', '');
                    }
            
                    if (!Aurora.isEmpty(select_record)) {
                        select_record.set('suggested_operation', value);
                    }
                }
            
                if (name == "suggested_operation_desc") {
            
                    var suggested_operation_desc = record.get('suggested_operation_desc');
                    if (!Aurora.isEmpty(select_record)) {
                        select_record.set('suggested_operation_desc', suggested_operation_desc);
                    }
                }
            
                if (name == 'cost_price') {
                    var rfx_ln_item_id = record.get('rfx_line_item_id');
                    Aurora.request({
                        url: $('pur52402_rfx_cost_price_update_link').getUrl(),
                        para: {
                            'rfx_ln_item_id': rfx_ln_item_id,
                            'cost_price': value
                        },
                        success: function() {},
                        failure: function() {},
                        error: function() {},
                        scope: this
                    });
            
                    if (!Aurora.isEmpty(select_record)) {
                        select_record.set('cost_price', value);
                    }
                }
            
                if (name == 'cost_total_price') {
                    if (!Aurora.isEmpty(select_record)) {
                        select_record.set('cost_total_price', value);
                    }
                }
                if (name == 'suggested_feedback_line_id') {
                    if (!Aurora.isEmpty(select_record)) {
                        select_record.set('suggested_feedback_line_id', value);
                    }
                }
            
            }
            
            //供应商明细
            
            function pur52402_rfx_check_price_vendors_detail_ds_update(ds, record, name, value, oldvalue) {
                var item_ds = $('pur52402_rfx_ln_items_ds');
                var item_current_rec = item_ds.getCurrentRecord();
                item_ds.select(item_current_rec);
                record.dirty = false;
                items_quoat_dirty = 'Y';
                //获取物品行上的需求数量
                //  var CurrentRecord = $('pur52402_rfx_ln_items_ds').getCurrentRecord();
                var quantity = record.get('quantity');
                var quote_quantity = record.get('quote_quantity'); //报价数量
                //勾选允许供应商修改报价数量
                var is_quot_quantity_flag = $('pur52402_rfx_headers_ds').getAt(0).get('is_quot_quantity_flag');
                var price_batch_quantity = record.get('price_batch_quantity');
                var valid_fb_retail_price = record.get('valid_fb_retail_price');
                var feedback_line_id = record.get('feedback_line_id');
            
                var list_ds = $('pur52402_rfx_vendors_detail_selected_ds');
                var select_record = list_ds.find('feedback_line_id', feedback_line_id);
            
                if (name == "suggested_flag") {
                    var vendor_record = $('pur52402_rfx_ln_vendors_ds').getAll();
                    var records = ds.getAll();
                    //增加逻辑，如果勾选供应商控制信息必输项
                    for (i = 0;i < records.length;i++) {
                        if(records[i].get('suggested_flag') == 'Y'){
	            			for (var i = 0;i < vendor_record.length;i++) {
	                            if (record.get('feedback_header_id') == vendor_record[i].get('feedback_header_id')) {
	                                vendor_record[i].getField('is_cen_pur_desc').setRequired(true);
	                                vendor_record[i].getField('source_type_desc').setRequired(true);
	                                vendor_record[i].getField('vendor_site_code').setRequired(true);
	                            }
	                        }
	                        break;
                        }else{
                            for (var i = 0;i < vendor_record.length;i++) {
	                            if (record.get('feedback_header_id') == vendor_record[i].get('feedback_header_id')) {
	                                vendor_record[i].getField('is_cen_pur_desc').setRequired(false);
	                                vendor_record[i].getField('source_type_desc').setRequired(false);
	                                vendor_record[i].getField('vendor_site_code').setRequired(false);
	                            }
	                        }
                        }
                    }
                    if (value == 'Y') {
                        pur52402_item_suggested_operation_selected(record.get('rfx_line_item_id'), feedback_line_id);
                        for (i = 0;i < records.length;i++) {
                            if (records[i].get('suggested_flag') == 'Y' && records[i].get('feedback_line_id') != feedback_line_id && records[i].get('valid_fb_retail_price') < valid_fb_retail_price) {
                                pur52402_item_suggested_operation_selected(records[i].get('rfx_line_item_id'), records[i].get('feedback_line_id'));
                            }
                        }
            			
                        record.getMeta().getField('allotted_quantity').setRequired(true);
                        if (Aurora.isEmpty(record.get('allotted_quantity'))) {
                            if (is_quot_quantity_flag == 'Y') {
                                record.set('allotted_quantity', quote_quantity);
                            } else {
                                record.set('allotted_quantity', quantity);
                            }
            
            
                            record.set('price_batch_quantity', price_batch_quantity);
                        }
            
                    } else {
                        record.getMeta().getField('allotted_quantity').setRequired(false);
                        record.set('allotted_quantity', null);
                        record.set('price_batch_quantity', null);
                        pur52402_item_suggested_operation_unselected(record.get('rfx_line_item_id'), feedback_line_id);
                    }
            
                    if (!Aurora.isEmpty(select_record)) {
                        select_record.set('suggested_flag', value);
                    }
                }
            
                if (name == 'suggested_note') {
                    if (!Aurora.isEmpty(select_record)) {
                        select_record.set('suggested_note', value);
                    }
                }
                if (name == 'price_batch_quantity') {
                    if (!Aurora.isEmpty(select_record)) {
                        select_record.set('price_batch_quantity', value);
                    }
                }
            
                if (name == "allotted_quantity") {
            
                    if (!Aurora.isEmpty(value) && value != 0) {
                        if (is_quot_quantity_flag == 'Y') {
                            if (value > quote_quantity) {
                                Aurora.showMessage('${l:PROMPT}', '${l:PUR5240.ATTENTION_ASSIGNED_QUANTITY_IS_GREATER_THAN_QUOTA_QUANTITY}');
                            }
                        } else {
                            if (value > quantity) {
                                Aurora.showMessage('${l:PROMPT}', '${l:PUR5240.ATTENTION_ASSIGNED_QUANTITY_IS_GREATER_THAN_DEMAND_QUANTITY}');
                            }
                        }
            
                        var allotted_percentage;
                        if (is_quot_quantity_flag == 'Y') {
                            //计算分配比例
                            allotted_percentage = pur5240_accMul(pur5240_accDiv(value, quote_quantity).toFixed(4), 100);
                        } else {
                            //计算分配比例
                            allotted_percentage = pur5240_accMul(pur5240_accDiv(value, quantity).toFixed(4), 100);
                        }
            
            
                        //赋值分配比例
                        record.set('allotted_percentage', allotted_percentage);
            
                    } else {
                        record.set('allotted_percentage', null);
                    }
            
                    if (!Aurora.isEmpty(select_record)) {
                        select_record.set('allotted_quantity', value);
                    }
                }
            
                if (name == 'allotted_percentage') {
                    //debugger;
                    if (!Aurora.isEmpty(value) && value != 0) {
                        var allotted_quantity;
                        if (is_quot_quantity_flag == 'Y') {
                            //计算分配数量
                            allotted_quantity = pur5240_accMul(pur5240_accDiv(value, 100), quote_quantity).toFixed(2);
                        } else {
                            //计算分配数量
                            allotted_quantity = pur5240_accMul(pur5240_accDiv(value, 100), quantity).toFixed(2);
                        }
            
            
                        //赋值分配数量
                        record.set('allotted_quantity', allotted_quantity);
                    } else {
                        record.set('allotted_quantity', null);
                    }
            
                    if (!Aurora.isEmpty(select_record)) {
                        select_record.set('allotted_percentage', value);
                    }
            
                }
            }
            
            function pur52402_rfx_ln_vendors_ds_update(ds, record, name, value, oldvalue) {
                if (name == 'proposed_flag') {
                    if (value == 'Y') {
                        var feedback_header_id = record.get('feedback_header_id');
                        var records = ds.getAll();
                        for (var i = 0;i < records.length;i++) {
                            if (records[i].get('feedback_header_id') != feedback_header_id) {
                                records[i].set('proposed_flag', 'N');
                                records[i].set('suggested_note', '');
                            }
            
                        }
                        return true;
                    }
                }
            }
            
            function pur52402_rfx_ln_vendors_ds_load(ds) {
                var records = ds.getAll();
                for (var i = 0;i < records.length;i++) {
                    if (records[i].get('feedback_status') == 'NEW') {
                        records[i].getField('proposed_flag').setReadOnly(true);
                    }
                    records[i].getField('vendor_site_code').setLovPara('vendor_id', records[i].get('coop_company_id'));
                    records[i].getField('vendor_site_code').setLovPara('ou_id', records[i].get('owner_business_unit_id'));
                }
            
            }
            
            function pur52402_items_current_bargain_price_ef(record, name) {
                var status = record.get('status');
                if (status == 'SUBMITTED') {
                    return 'pur52402_items_current_bargain_price_nf';
                }
                return;
            }
            
            function pur52402_items_current_bargain_reason_ef(record, name) {
                var status = record.get('status');
                if (status == 'SUBMITTED') {
                    return 'pur52402_items_current_bargain_reason_tf';
                }
                return;
            }
            
            function pur52402_vendors_current_bargain_price_ef(record, name) {
                var status = record.get('status');
                if (status == 'SUBMITTED') {
                    return 'pur52402_vendors_current_bargain_price_nf';
                }
                return;
            }
            
            function pur52402_vendors_current_bargain_reason_ef(record, name) {
                var status = record.get('status');
                if (status == 'SUBMITTED') {
                    return 'pur52402_vendors_current_bargain_reason_tf';
                }
                return;
            }
            
            function pur52402_rfx_ln_items_ds_submitsuccess(ds, res) {
                $('pur52402_rfx_ln_vendors_ds').query();
                $('pur52402_rfx_ln_items_ds').query();
                $('pur52402_rfx_headers_ds').query();
                $('pur52402_rfx_feedback_all_ds').query();
            }
            
            function pur52402_rfx_ln_items_ds_submitsuccess2(ds, res) {
                $('pur52402_rfx_feedback_all_ds').query();
            }
            
            function formatNumber2(value, decimalprecision) {
                if (Ext.isEmpty(value)) {
                    return '';
                }
            
                value = String(value).replace(/,/g, '');
                if (isNaN(value)) {
                    return '';
                }
                if (decimalprecision || decimalprecision === 0)
            
            
                var point_value = value.split('.');
                var in_length = (point_value.length == 2) ? '.' + point_value[1] : '';
            
            
                if (in_length.length - 1 < decimalprecision) {
            
                    decimalprecision = in_length.length - 1
                };
                if (in_length.length == 0) {
                    decimalprecision = 0;
                }
            
                value = Number(value).toFixed(decimalprecision);
            
                var ps = value.split('.');
                var sub = (ps.length == 2) ? '.' + ps[1] : '';
            
            
                var whole = ps[0];
                var r = /(\d+)(\d{3})/;
                while (r.test(whole)) {
                    whole = whole.replace(r, '$1' + ',' + '$2');
                }
            
                Math.round()
                v = whole + sub;
                return v;
            }
            
            function pur52402_formatNumber_render(value, record, name) {
                var lowest_flag = record.get('lowest_flag');
                if (lowest_flag == 'Y') {
            
                    return '<font color="red">' + formatNumber2(value, 8) + '</font>';
                } else {
                    return formatNumber2(value, 8);
                }
            
            
            }
            
            function pur52402_rfx_operation_record_fun() {
                new Aurora.Window({
                    url: '${/request/@context_path}/modules/pur/public/pur_rfx_operation_records.screen?rfx_header_id=${/parameter/@rfx_header_id}',
                    title: '${l:PROMPT.OPERATION_RECORD}',
                    id: 'pur_publicRfxOperationRecord_window',
                    width: 500,
                    height: 350
                });
            }
            
            function pur5240_rfxFeedbackVendorQuote_renderFun(value, record, name) {
                var quote_header_id = record.get('quote_header_id');
                var abandoned_flag = record.get('abandoned_flag');
            
                if (abandoned_flag == 'N' && !Ext.isEmpty(quote_header_id)) {
                    return '<a href="javascript:pur5240_rfxFeedbackVendorQuote_openViewFun(' + record.get('feedback_line_id') + ')">${l:PUR_RFX_QUOTE_TITLE}</a>';
                }
                return ''
            }
            
            function pur5240_rfxFeedbackVendorQuote_openViewFun(feedback_line_id) {
                new Aurora.Window({
                    url: $('pur5240_rfx_feedback_vendor_quote_view_link').getUrl() + '?feedback_line_id=' + feedback_line_id,
                    title: '${l:PUR_RFX_QUOTE_TITLE}',
                    id: 'pur_public_rfx_feedback_vendor_quote_view_window',
                    width: 900,
                    height: 450
                });
            }
            
            function pur52402_rfxCheckPriceVendorsDetailGridEditorFunction(record, name) {
                if (name == "allotted_quantity" || name == "allotted_percentage") {
                    if (record.get('suggested_flag') == "Y") {
                        record.getMeta().getField('allotted_quantity').setRequired(false);
                        record.getMeta().getField('allotted_percentage').setRequired(false);
                        return 'pur52402_vendors_suggested_note_nf';
            
                    } else if (record.get('suggested_flag') == "N") {
                        record.getMeta().getField('allotted_quantity').setRequired(false);
                        record.getMeta().getField('allotted_percentage').setRequired(false);
                        return '';
                    }
                }
                if (name == "price_batch_quantity") {
                    if (record.get('suggested_flag') == "Y") {
                        return 'pur52402_vendors_suggested_note_nf';
            
                    } else if (record.get('suggested_flag') == "N") {
                        return '';
                    }
                }
            }
            
            
            function pur52402_rfxCheckPriceVendorsDetailGridEditorFunction2(record, name) {
                if (name == "allotted_quantity" || name == "allotted_percentage") {
                    if (record.get('suggested_flag') == "Y") {
                        record.getMeta().getField('allotted_quantity').setRequired(true);
                        record.getMeta().getField('allotted_percentage').setRequired(true);
                        return 'pur52402_vendors_suggested_note_nf2';
            
                    } else if (record.get('suggested_flag') == "N") {
                        record.getMeta().getField('allotted_quantity').setRequired(false);
                        record.getMeta().getField('allotted_percentage').setRequired(false);
                        return '';
                    }
                }
                if (name == "price_batch_quantity") {
                    if (record.get('suggested_flag') == "Y") {
                        return 'pur52402_vendors_suggested_note_nf2';
            
                    } else if (record.get('suggested_flag') == "N") {
                        return '';
                    }
                }
            }
            
            function pur52402_rfx_ln_items_ds_beforeSubmit(dataset) {
                //获取此物品行的需求数量
                var quantity = dataset.getCurrentRecord().get('quantity');
                var suggested_operation = dataset.getCurrentRecord().get('suggested_operation');
            
                //物品行选择策略是“推荐供应商”
                if (suggested_operation == "SELECTED") {
            
                    //分配数量之和
                    var sum_allotted_quantity = 0;
            
                    //选用供应商数量
                    var select_vendor_count = 0;
            
                    //校验物品行的分配数量不能为空
                    if (!$('pur52402_rfx_check_price_vendors_detail_ds').validate()) {
                        return false;
                    }
            
                    //循环计算此物品行对应的供应商行，已选用供应商的分配数量之和
                    var records = $('pur52402_rfx_check_price_vendors_detail_ds').getAll();
                    for (var i = 0;i < records.length;i++) {
                        var allotted_quantity = 0;
                        if (records[i].get('suggested_flag') == "Y") {
                            select_vendor_count++;
                            if (!Aurora.isEmpty(records[i].get('allotted_quantity'))) {
                                if (records[i].get('allotted_quantity') <= 0) {
                                    Aurora.showMessage('${l:PROMPT}', '${l:PUR5240.QUANTITY_OF_SELECTED_VENDORS_SHOULD_BE_GREATER_THAN_ZERO}');
                                    return false;
                                } else {
                                    allotted_quantity = records[i].get('allotted_quantity');
                                }
                            }
                            sum_allotted_quantity = pur5240_accAdd(sum_allotted_quantity, allotted_quantity);
                        }
                    }
            
                    //校验是否有选用供应商
                    if (select_vendor_count == 0) {
                        Aurora.showMessage('${l:PROMPT}', '${l:PUR5240.DID_NOT_SELECT_VENDORS}');
                        return false;
                    }
            
                    //取2位精度
                    sum_allotted_quantity = sum_allotted_quantity.toFixed(2);
            
                    //判断分配数量之和与物品的需求数量
                    if (sum_allotted_quantity != quantity) {
                        Aurora.showMessage('${l:PROMPT}', '${l:PUR5240.ASSIGNED_QUANTITY_NEED_SAME_AS_MATERIAL_QUANTITY}');
                        return false;
                    } else {
                        return true;
                    }
                }
            }
            
            function initItemRfxWindow() {
                var div = jDawn.getElementById('pur5240_rfx_item_price_contain');
                var win = jDawn.getElementById('pur52402_rfx_check_price_window');
                var h = win.offsetHeight;
                var w = win.offsetWidth;
                div.style.height = h + 'px';
                div.style.left = w + 0 + 'px';
                jDawn.bindEvent(document, 'mousedown', function(e) {
                    e = e || window.event;
                    var target = e.srcElement || e.target;
                    while (target != document.body) {
                        if (target.id == 'pur5240_rfx_item_price_contain' || target.tagName == 'A') {
                            return;
                        } else {
                            target = target.parentNode;
                        }
                    }
                    if (target.tagName != 'A') {
                        pur5240_closeItemRfxDetail();
                    }
                });
            }
            
            function pur5240_item_renderer(value, record, name) {
                //console.log(record.get('rfx_line_item_id'));
                if (name == 'item_code') {
                    debugger;
                    if (value == '-') {
                        return '<a href="javascript:pur5240_openItemRfxDetail_Id(' + '\'' + record.get('rfx_line_item_id') + '\'' + ')">' + value + '</a>';
                    } else {
                        return '<a href="javascript:pur5240_openItemRfxDetail_Code(' + '\'' + value + '\'' + ')">' + value + '</a>';
                    }
                }
            }
            
            function pur5240_openItemRfxDetail_Id(rfx_line_item_id) {
                var div = jDawn.getElementById('pur5240_rfx_item_price_contain');
                var win = jDawn.getElementById('pur52402_rfx_check_price_window');
                var w = win.offsetWidth;
                handMove.initRun(div, null, {
                    x: w - div.offsetWidth
                }, 0.2, {
                    tween: 'Expo',
                    ease: 'easeOut'
                });
                var ds = $('pur5240_item_resutl_ds');
                if (code == '-') {
                    code = '';
                }
                //ds.setQueryParameter('item_code', code);
                ds.setQueryParameter('rfx_line_item_id', rfx_line_item_id);
                ds.setQueryParameter('rfx_header_id', '${/parameter/@rfx_header_id}');
                ds.query();
                //兼容ie下的样式表
                pur5240IeCssStyleCompatible('hidden');
            }
            
            function pur5240_openItemRfxDetail_Code(code) {
                debugger;
                var div = jDawn.getElementById('pur5240_rfx_item_price_contain');
                var win = jDawn.getElementById('pur52402_rfx_check_price_window');
                var w = win.offsetWidth;
                handMove.initRun(div, null, {
                    x: w - div.offsetWidth
                }, 0.2, {
                    tween: 'Expo',
                    ease: 'easeOut'
                });
                var ds = $('pur5240_item_resutl_ds');
                if (code == '-') {
                    code = '';
                }
                ds.setQueryParameter('item_code', code);
                ds.setQueryParameter('rfx_header_id', '${/parameter/@rfx_header_id}');
                ds.query();
                //兼容ie下的样式表
                pur5240IeCssStyleCompatible('hidden');
            }
            
            function pur5240_closeItemRfxDetail() {
                var div = jDawn.getElementById('pur5240_rfx_item_price_contain');
                var win = jDawn.getElementById('pur52402_rfx_check_price_window');
                var w = win.offsetWidth;
                handMove.initRun(div, null, {
                    x: w
                }, 0.2, {
                    tween: 'Expo',
                    ease: 'easeOut'
                });
                pur5240IeCssStyleCompatible('auto')
            }
            
            function pur5240IeCssStyleCompatible(style) {
                var ua = navigator.userAgent;
                for (var i = 0;i < document.styleSheets.length;i++) {
                    var rules;
                    if (document.styleSheets[i].cssRules) {
                        rules = document.styleSheets[i].cssRules;
                    } else {
                        rules = document.styleSheets[i].rules;
                    }
                    for (var j = 0;j < rules.length;j++) {
                        if (rules[j].selectorText == '.grid-ub') {
                            rules[j].style.overflow = style;
                        }
                    }
                }
            }
            
            function pur52402_rfx_assistance_v2() {
                //校验数据
                var i_records = $('pur52402_rfx_ln_items_ds').getAll();
                var v_records = $('pur52402_rfx_ln_vendors_ds').getAll();
                if (i_records.length == 0 || v_records.length == 0) {
                    Aurora.showMessage('${l:PROMPT}', '${l:PUR5240.MATERIAL_OR_VENDOR_IS_EMPTY}');
                    return;
                }
                //打开窗口
                new Aurora.Window({
                    url: $('pur5220_rfx_assistance_v2_link').getUrl() + '?rfx_header_id=' + '${/parameter/@rfx_header_id}',
                    id: 'pur5220_rfx_assistance_window',
                    width: 850,
                    height: 480
                });
            }
            
            function bid6020BiddingDocmDetailRender(value, record, name) {
                if ('${/parameter/@status}' != 'SCORED') {
                    return '-';
                }
                return '<a href="javascript:bid6020BiddingScoreDetail(' + record.get('rfx_header_id') + "," + record.get('feedback_header_id') + ');">' + value + '</a>';
            }
            
            function bid6020BiddingScoreDetail(entrustment_header_id, bid_header_id) {
                // alert(entrustment_header_id);
                // alert(bid_header_id);
                // alert(bidding_score);
                // alert('${/parameter/@round}');
                // alert('${/parameter/@version}');
                new Aurora.Window({
                    id: 'bid6020_bidding_score_window',
                    title: '${l:PUR_RFX_HEADERS.EXPERT_SCORE_FLAG}',
                    url: $('bid6020_bidding_score_link').getUrl() + '?entrustment_header_id=-' + entrustment_header_id + '&bid_header_id=-' + bid_header_id + '&round=${/parameter/@round}&version=${/parameter/@version}',
                    width: '800',
                    height: '400'
                });
            }
            
            function pur52202_rfxLadderQuotationRenderViewFun(value, record, name) {
                if (name == 'ladder_quotation') {
                    if (record.get('ladder_inquiry_flag') == 'N') {
                        return '-'
                    } else {
                        return '<a href="javascript:pur5220_rfxLadderQuotationViewFunction(' + record.get('feedback_line_id') + ')">${l:SACPUR5210.LADDER_QUOTES}</a>';
                    }
                }
            }
            
            function pur5220_rfxLadderQuotationViewFunction(feedback_line_id) {
                new Aurora.Window({
                    url: $('pur5220_rfxLadderQuotationView_link').getUrl() + '?feedback_line_id=' + feedback_line_id,
                    title: '${l:SACPUR5210.LADDER_QUOTES}',
                    id: 'pur5220_rfxLadderQuotationView_window',
                    width: 500,
                    height: 300
                });
            }
            
            function pur52402_rfx_check_price_vendor_load(ds) {
                var dataSet = $('pur52402_rfx_ln_items_ds');
                var record = dataSet.getCurrentRecord();
                items_quoat_dirty = 'N';
                lineQueryFlag.push(record.get('rfx_line_item_id'));
                // rfxVendorDetailLoad(ds);
                var list_ds = $('pur52402_rfx_vendors_detail_selected_ds');
                var records = ds.getAll();
                for (i = 0;i < records.length;i++) {
                    var feedback_line_id = records[i].get('feedback_line_id');
                    var result_record = list_ds.find('feedback_line_id', feedback_line_id);
                    if (Aurora.isEmpty(result_record)) {
                        $('pur52402_rfx_vendors_detail_selected_ds').create(records[i].data);
                    }
                }
                    //增加逻辑，如果勾选供应商控制信息必输项
                for (var j = 0;j < records.length;j++) {
                    var vendor_record = $('pur52402_rfx_ln_vendors_ds').getAll();
                    if(records[j].get('suggested_flag') == 'Y'){
            			for (var i = 0;i < vendor_record.length;i++) {
                            if (records[j].get('feedback_header_id') == vendor_record[i].get('feedback_header_id')) {
                                vendor_record[i].getField('is_cen_pur_desc').setRequired(true);
                                vendor_record[i].getField('source_type_desc').setRequired(true);
                                vendor_record[i].getField('vendor_site_code').setRequired(true);
                            }
                        }
                        break;
                    }else{
                        for (var i = 0;i < vendor_record.length;i++) {
                            if (records[j].get('feedback_header_id') == vendor_record[i].get('feedback_header_id')) {
                                vendor_record[i].getField('is_cen_pur_desc').setRequired(false);
                                vendor_record[i].getField('source_type_desc').setRequired(false);
                                vendor_record[i].getField('vendor_site_code').setRequired(false);
                            }
                        }
                    }
                }
                //开启配置项则显示税前净价、税前金额、税额、总额字段
                var item_value = '${/model/bg_item_rfx_14/record/@bg_config_item_value}';
                if (!Aurora.isEmpty(item_value) && item_value == "N") {
                    $('pur52402_rfx_check_price_vendors_detail_grid').hideColumn('net_price');
                    $('pur52402_rfx_check_price_vendors_detail_grid').hideColumn('net_amount');
                    $('pur52402_rfx_check_price_vendors_detail_grid').hideColumn('tax_amount');
                    $('pur52402_rfx_check_price_vendors_detail_grid').hideColumn('total_amounts');
                } else if (Aurora.isEmpty(item_value)) {
                    $('pur52402_rfx_check_price_vendors_detail_grid').hideColumn('net_price');
                    $('pur52402_rfx_check_price_vendors_detail_grid').hideColumn('net_amount');
                    $('pur52402_rfx_check_price_vendors_detail_grid').hideColumn('tax_amount');
                    $('pur52402_rfx_check_price_vendors_detail_grid').hideColumn('total_amounts');
                }
            }
            
            function pur5130_rfxDetailAttachment_renderFun(value, record, name) {
                return '<a href="javascript:pur5130_rfxDetailAttachment_openFun(' + record.get('atm_line_id') + ')">${l:PROMPT.VIEW_ATTACHMENT}</a>';
            }
            
            function pur5130_rfxDetailAttachment_openFun(atm_line_id) {
                var url = "${/request/@context_path}/check_uploadFile.screen?table_name=PUR_RFX_HEADERS&header_id=" + atm_line_id;
                new Aurora.Window({
                    url: url,
                    title: '${l:PROMPT.VIEW_ATTACHMENT}',
                    id: 'pur5130_rfxDetailAttachment_window',
                    width: 610,
                    height: 500
                });
            }
            
            function pur5240_item_attach_download(value, record, name) {
                var rfx_line_item_id = record.get('rfx_line_item_id');
                var atm_counts_item = record.get('atm_counts_item');
                var atm_counts1 = record.get('atm_counts1');
                var atm_counts_feedback = record.get('atm_counts_feedback');
                if (name == "item_attachment") {
                    if (!record.isNew && rfx_line_item_id) {
                        if (atm_counts1 == 0) {
                            return '<a href="javascript:pur5240_download_file(' + rfx_line_item_id + ')">${l:FND_ATM_LINES.ATM_DOWNLOAD}</a>';
                        } else {
                            return '<a href="javascript:pur5240_download_file(' + rfx_line_item_id + ')">${l:FND_ATM_LINES.ATM_DOWNLOAD}</a>' + '<img src="${/request/@context_path}/images/paperclip.png"/>';
                        }
                    }
                }
            
                if (name == "atm_flag_item") {
                    if (atm_counts_item > 0) {
                        return '<div style="margin-top:3px;margin-left:auto;margin-right:auto;vertical-align:middle;height:20px;line-height:20px;"><img src="${/request/@context_path}/images/paperclip.png"/></div>';
            
                    } else {
                        return '';
                    }
                }
            
                if (name == "atm_flag_feedback") {
                    if (atm_counts_feedback > 0) {
                        return '<div style="margin-top:3px;margin-left:auto;margin-right:auto;vertical-align:middle;height:20px;line-height:20px;"><img src="${/request/@context_path}/images/paperclip.png"/></div>';
            
                    } else {
                        return '';
                    }
                }
            }
            
            function pur5240_item_attach_download1(value, record, name) {
                var rfx_line_item_id = record.get('rfx_line_item_id');
                var atm_counts = record.get('atm_counts');
                if (name == "item_attachment") {
                    if (!record.isNew && rfx_line_item_id) {
                        if (atm_counts == 0) {
                            return '<a href="javascript:pur5240_download_file(' + rfx_line_item_id + ')">${l:FND_ATM_LINES.ATM_DOWNLOAD}</a>';
                        } else {
                            return '<a href="javascript:pur5240_download_file(' + rfx_line_item_id + ')">${l:FND_ATM_LINES.ATM_DOWNLOAD}</a>' + '<img src="${/request/@context_path}/images/paperclip.png"/>';
                        }
                    }
                }
            }
            
            function pur5240_item_attach_download2(value, record, name) {
                var rfx_line_item_id = record.get('rfx_line_item_id');
                var atm_counts_item = record.get('atm_counts_item');
                if (name == "item_attachment") {
                    if (!record.isNew && rfx_line_item_id) {
                        if (atm_counts_item == 0) {
                            return '<a href="javascript:pur5240_download_file(' + rfx_line_item_id + ')">${l:FND_ATM_LINES.ATM_DOWNLOAD}</a>';
                        } else {
                            return '<a href="javascript:pur5240_download_file(' + rfx_line_item_id + ')">${l:FND_ATM_LINES.ATM_DOWNLOAD}</a>' + '<img src="${/request/@context_path}/images/paperclip.png"/>';
                        }
                    }
                }
            }
            
            function pur5240_download_file(rfx_line_item_id) {
                var url = "${/request/@context_path}/check_uploadFile.screen?table_name=PUR_RFX_LN_ITEMS&header_id=" + rfx_line_item_id;
                new Aurora.Window({
                    url: url,
                    title: '${l:HAP_DOWNLOAD}',
                    id: 'pur5240_download_window',
                    width: 500,
                    height: 500
                });
            }
            
            function pur5240_vendor_attach_Download(value, record, name) {
                var atm_counts_feedback = record.get('atm_counts_feedback');
                var atm_counts = record.get('atm_counts');
                if (name == "attachment_download") {
                    if (atm_counts == 0) {
                        return '<a href="javascript:pur5240_attachment_Download(' + record.get('feedback_line_id') + ')">${l:FND_ATM_LINES.ATM_DOWNLOAD}</a>';
                    } else {
                        return '<a href="javascript:pur5240_attachment_Download(' + record.get('feedback_line_id') + ')">${l:FND_ATM_LINES.ATM_DOWNLOAD}</a>' + '<img src="${/request/@context_path}/images/paperclip.png"/>';
                    }
                }
            
                if (name == "atm_flag_feedback") {
                    if (atm_counts_feedback > 0) {
                        return '<div style="margin-top:3px;margin-left:auto;margin-right:auto;vertical-align:middle;height:20px;line-height:20px;"><img src="${/request/@context_path}/images/paperclip.png"/></div>';
            
                    } else {
                        return '';
                    }
                }
            }
            
            function pur5240_vendor_attach_Download1(value, record, name) {
                var atm_counts_feedback = record.get('atm_counts_feedback');
                if (name == "attachment_download") {
                    if (atm_counts_feedback == 0) {
                        return '<a href="javascript:pur5240_attachment_Download(' + record.get('feedback_line_id') + ')">${l:FND_ATM_LINES.ATM_DOWNLOAD}</a>';
                    } else {
                        return '<a href="javascript:pur5240_attachment_Download(' + record.get('feedback_line_id') + ')">${l:FND_ATM_LINES.ATM_DOWNLOAD}</a>' + '<img src="${/request/@context_path}/images/paperclip.png"/>';
                    }
                }
            }
            
            function pur5240_attachment_Download(feedback_line_id) {
                var url = "${/request/@context_path}/check_uploadFile.screen?table_name=PUR_RFX_FEEDBACK_LINES&header_id=" + feedback_line_id;
                new Aurora.Window({
                    url: url,
                    title: '${l:FND_ATM_LINES.ATM_DOWNLOAD}',
                    id: 'pur5240_firstTrialDownload_window',
                    width: 610,
                    height: 500
                });
            }
            
            function pur52402_rfx_headers_ds_load(ds) {
                var record = ds.getCurrentRecord();
                var rfx_category = record.get('rfx_category');
                if (rfx_category == 'RLF') {
                    document.getElementById('logistics_quotation_desc_id').style.display = 'block';
                    document.getElementById('quotation_title_id').style.display = 'none';
                } else {
                    document.getElementById('logistics_quotation_desc_id').style.display = 'none';
                    document.getElementById('quotation_title_id').style.display = 'block';
                }
            }
            
            function pur52402_rfx_headers_ds_update(ds, record, name, value, oldvalue) {
                var record = ds.getCurrentRecord();
                if (name == 'total_costs') {
            
                    if (Aurora.isEmpty(value) || value == 0) {
                        var total_costs = 0;
                    } else {
                        var total_costs = value * 1;
                    }
                    var account_total_costs = record.get('account_total_costs') * 1;
                    var exceed_money = record.get('exceed_money') * 1;
            
                    //超成本
                    if (account_total_costs > total_costs) {
            
                        record.set('exceed_cost_flag', 'Y');
                        record.set('exceed_cost_flag_desc', '${l:SYS_PARAMETER.YES}');
                        record.set('exceed_money', (account_total_costs - total_costs).toFixed(2));
            
                        if (total_costs == 0) {
                            record.set('exceed_percent', '-');
                        } else {
                            //计算超成本百分比 = 超成本金额/总成本金额  * 100
                            var exceed_percent = ((account_total_costs - total_costs).toFixed(2) / total_costs * 100).toFixed(2);
                            record.set('exceed_percent', exceed_percent);
                        }
            
                        //未超成本
                    } else {
                        record.set('exceed_cost_flag', 'N');
                        record.set('exceed_cost_flag_desc', '${l:SYS_PARAMETER.NO}');
                        record.set('exceed_money', 0);
                        record.set('exceed_percent', 0);
                    }
                }
            }
            
            
            function pur52402_rfxLnItems_saveFun() {
            
            
            
                var dataset = $('pur52402_rfx_ln_items_selected_ds');
            
                var records = dataset.getAll();
            
                if (records.length == 0) {
            
                    Aurora.showMessage('${l:PROMPT}', '${l:PUR5240.PLEASE_CHECK_THE_DATA_WHICH_NEED_SAVE}');
                    return;
                }
                var line_num_total;
                var line_num_total_2;
                var quantity_flag = 'N';
                var save_flag = 'Y';
                for (var i = 0;i < records.length;i++) {
            
                    var quantity = records[i].get('quantity');
                    var suggested_operation = records[i].get('suggested_operation');
                    var cost_total_price = records[i].get('cost_total_price');
            
                    var vendor_price_count = records[i].get('vendor_price_count');
                    var suggested_operation2 = records[i].get('suggested_operation');
                    var line_num = records[i].get('line_num');
                    if (suggested_operation2 == "BACK" && vendor_price_count > 0) {
                        save_flag = 'N';
                        if (line_num_total == undefined) {
                            line_num_total = line_num;
                        } else {
                            line_num_total = line_num_total + ',' + line_num;
                        }
            
            
                    }
            
                    //物品行选择策略是“推荐供应商”
                    if (suggested_operation == "SELECTED") {
            
                        //分配数量之和
                        var sum_allotted_quantity = 0;
            
                        //选用供应商数量
                        var select_vendor_count = 0;
            
                        //供应商数量
                        var vendor_count = 0;
                        //校验物品行的分配数量不能为空
                        if (!$('pur52402_rfx_check_price_vendors_detail_ds').validate()) {
                            return;
                        }
            
                        var line_records = $('pur52402_rfx_vendors_detail_selected_ds').getAll();
                        var line_details = [];
                        for (t = 0;t < line_records.length;t++) {
            
                            if (line_records[t].get('rfx_line_item_id') == records[i].get('rfx_line_item_id')) {
                                vendor_count++;
                                var allotted_quantity = 0;
                                if (line_records[t].get('suggested_flag') == "Y") {
                                    select_vendor_count++;
                                    if (!Aurora.isEmpty(line_records[t].get('allotted_quantity'))) {
                                        if (line_records[t].get('allotted_quantity') <= 0) {
                                            Aurora.showMessage('${l:PROMPT}', '${l:PUR5240.QUANTITY_OF_SELECTED_VENDORS_SHOULD_BE_GREATER_THAN_ZERO}');
                                            return;
                                        } else {
                                            allotted_quantity = line_records[t].get('allotted_quantity');
                                            sum_allotted_quantity = pur5240_accAdd(sum_allotted_quantity, allotted_quantity);
                                        }
                                    }
            
                                }
                                line_records[t].set('_status', 'update');
                                line_details.push(line_records[t].data);
                            }
                        }
            
                        records[i].set('line_details', line_details);
                        //校验是否有选用供应商
                        if (select_vendor_count == 0 && vendor_count > 0) {
                            Aurora.showMessage('${l:PROMPT}', '${l:PUR_LINES_SUBJECTS.LINE_NUM}：' + line_num + ' ${l:PUR5240.DID_NOT_SELECT_VENDORS}');
                            return;
                        }
            
                        //取2位精度
                        sum_allotted_quantity = sum_allotted_quantity.toFixed(2);
                        // alert(sum_allotted_quantity + '___' + quantity);
                        //判断分配数量之和与物品的需求数量
                        if (sum_allotted_quantity != quantity && vendor_count > 0) {
                            quantity_flag = 'Y';
                            if (line_num_total_2 == undefined) {
                                line_num_total_2 = line_num;
                            } else {
                                line_num_total_2 = line_num_total_2 + ',' + line_num;
            
                            }
            
                        }
                    } else {
            
                        var line_records = $('pur52402_rfx_vendors_detail_selected_ds').getAll();
                        var line_details = [];
                        for (t = 0;t < line_records.length;t++) {
            
                            if (line_records[t].get('rfx_line_item_id') == records[i].get('rfx_line_item_id')) {
                                line_records[t].set('_status', 'update');
                                line_details.push(line_records[t].data);
                            }
                        }
            
                        records[i].set('line_details', line_details);
                    }
                }
                if (save_flag == 'N') {
                    Aurora.showMessage('${l:PROMPT}', '${l:PUR_LINES_SUBJECTS.LINE_NUM}' + line_num_total + ':  ${l:PUR5240.THERE_IS_A_QUOTE_CAN_NOT_CHOOSE_TO_RELEASE_MATERIAL_LINE}');
                    return;
                }
                // if (quantity_flag == 'Y') {
                // Aurora.showConfirm('${l:PROMPT}', '${l:PUR_LINES_SUBJECTS.LINE_NUM}' + line_num_total_2 + '${l:PUR5240.ASSIGNED_QUANTITY_LESS_THAN_GREATER_QUANTITY}', function() {
                // //执行保存逻辑
                // pur52402_rfxLnItems_saveLogicFun();
                // }, function() {
                // return;
                // });
                // } else {
                pur52402_rfxLnItems_saveLogicFun();
                // }
            
            }
            
            function pur52402_rfxLnItems_saveLogicFun() {
                var data = $('pur52402_rfx_ln_items_selected_ds').getJsonData();
                for (i = 0;i < data.length;i++) {
                    data[i]._status = 'update';
            
                }
                Aurora.Masker.mask($('pur52402_rfx_check_price_window').wrap, '${l:LOADING}');
                //console.log(data);
                Aurora.request({
                    url: $('pur52402_rfx_ln_items_save_link').getUrl(),
                    para: data,
                    success: function(result) {
                        Aurora.Masker.unmask($('pur52402_rfx_check_price_window').wrap);
                        Aurora.showMessage('${l:PROMPT}', '${l:PROMPT.SAVE_SUCCESS}');
                        pur52402_rfx_ln_items_ds_submitsuccess();
                    },
                    failure: function() {
                        Aurora.Masker.unmask($('pur52402_rfx_check_price_window').wrap);
                        return;
                    },
                    error: function() {
                        Aurora.Masker.unmask($('pur52402_rfx_check_price_window').wrap);
                        return;
                    }
                });
            }
            
            function pur52402_vendors_grid_renderer(value, record, name) {
                var atm_counts = record.get('atm_counts');
                if (name == "attachment_download") {
                    var feedback_header_id = record.get('feedback_header_id');
                    if (!record.isNew && feedback_header_id) {
                        if (atm_counts == 0) {
                            return '<a href="javascript:pur52402_vendors_feedback_atm_view(' + feedback_header_id + ')">${l:FND_ATM_LINES.ATM_DOWNLOAD}</a>';
                        } else {
                            return '<a href="javascript:pur52402_vendors_feedback_atm_view(' + feedback_header_id + ')">${l:FND_ATM_LINES.ATM_DOWNLOAD}</a>' + '<img src="${/request/@context_path}/images/paperclip.png"/>';
                        }
                    }
                }
            }
            
            function pur52402_vendors_feedback_atm_view(id) {
                var url;
                var flag = $('pur52402_rfx_headers_ds').getAt(0).get('closed_bidding_flag');
                if (flag == 'N') {
                    url = "${/request/@context_path}/check_uploadFile.screen?table_name=PUR_RFX_FEEDBACK_HEADER&header_id=" + id;
                } else {
                    url = "${/request/@context_path}/modules/pur/SACPUR5410/pur_rfx_attachment_upload_view.screen?header_id=" + id;
                }
                new Aurora.Window({
                    url: url,
                    title: '${l:FND_ATM_LINES.ATM_DOWNLOAD}',
                    id: 'pur52202_rfx_ln_vendors_feedback_atm_view_window',
                    width: 650,
                    height: 500
                });
            }
            
            function pur52402_rfxLnItemsGridRenderer(value, record, name) {
                var rfx_category = record.get('rfx_category');
                if (name == "item_note") {
                    if (!Aurora.isEmpty(value) && value.length > 20) {
                        return '<a href="javascript:pur52402_rfxLnItemsView()">' + value + '</a>';
                    } else if (!Aurora.isEmpty(value) && value.length <= 20) {
                        return '<div>' + value + '</div>';
                    } else {
                        return '';
                    }
                }
                if (name == 'quotation_detail') {
                    if (rfx_category != 'RLF') {
                        return '<a href="javascript:pur_quotation_detail(' + record.get('es_inv_org_id') + ',' + record.get('coop_company_id') + ')">查看报价</a>';
                    } else {
                        return '<a href="javascript:pur_logis_quotation_detail(' + record.get('rfx_line_item_id') + ',' + record.get('coop_company_id') + ')">查看报价</a>';
                    }
                }
            }
            
            function pur_logis_quotation_detail(rfx_line_item_id, vendor_id) {
                var record = $('pur52402_rfx_headers_ds').getCurrentRecord();
                var logistics_quotation_code = record.get('logistics_quotation_code');
                var url;
                var id;
                var title;
                if (logistics_quotation_code == 'EXPRESS_FRAME') {
                    url = $('pur5220_expressFrame_maintain_link').getUrl();
                    id = 'pur5130_expressFrameEdit_window';
                    title = '快递框架模型';
                } else if (logistics_quotation_code == 'DOMESTIC_LOGISTICS_FRAME') {
                    url = $('pur5220_logisticsFrame_maintain_link').getUrl();
                    id = 'pur5130_logisticsFrameEdit_window';
                    title = '国内物流框架模型';
                } else if (logistics_quotation_code == 'VEHICLE_LOGISTICS_FRAME') {
                    url = $('pur5220_vehicleFrame_maintain_link').getUrl();
                    id = 'pur5130_vehicleFrameEdit_window';
                    title = '整车物流框架模型';
                }
            
                new Aurora.Window({
                    url: url + '?rfx_line_item_id=' + rfx_line_item_id + '&vendor_id=' + vendor_id,
                    title: title,
                    id: id,
                    fullScreen: true
                });
            }
            
            function pur_quotation_detail(inv_org_id, vendor_id) {
                var header_rec = $('pur52402_rfx_headers_ds').getCurrentRecord();
                if (Aurora.isEmpty(header_rec.get('quotation_id'))) {
                    return;
                }
                var url = $('template_link').getUrl() + '?quotation_id=' + header_rec.get('quotation_id') + '&vendor_id=' + vendor_id + '&currency_code=' + header_rec.get('currency_code') + '&business_unit_id=' + inv_org_id + '&show_save=E';
                new Aurora.Window({
                    id: 'rfx5010_template_win',
                    title: '模板',
                    url: url,
                    fullScreen: true
                });
            }
            
            function pur52402_rfxLnItemsView() {
                new Aurora.Window({
                    url: $('pur52402_rfx_item_note_view_link').getUrl(),
                    title: '${l:SACPUR5210.VIEW_MATERIAL_DESCRIPTION}',
                    id: 'pur52402_rfx_item_note_view_link_window',
                    width: 500,
                    height: 400
                });
            }
            
            function lowest_flag_desc_change(e, value, oldvalue) {
                var ds = $('pur52402_rfx_feedback_all_ds');
                var records = ds.getAll();
                // $('pur52402_rfx_feedback_all_ds').query();
                if (value == '${l:PUR5240.LOWEST_PRICE_STRATEGY}') {
                    for (a = 0;a < records.length;a++) {
                        if (records[a].get('lowest_flag') == 'Y') {
                            records[a].set('suggested_flag', 'Y');
                        } else {
                            records[a].set('suggested_flag', 'N');
                        }
                    }
            
            
                } else if (value == '${l:PUR5240.ALL_SELECTED}') {
            
                    for (b = 0;b < records.length;b++) {
                        records[b].set('suggested_flag', 'Y');
                    }
            
                } else {
                    for (c = 0;c < records.length;c++) {
                        records[c].set('suggested_flag', 'N');
                    }
                }
            
            
            }
            
            function feedback_all_update(ds, record, name, value, oldvalue) {
            
                ds.select(record);
                record.dirty = false;
                var quantity = record.get('quantity');
                var quote_quantity = record.get('quote_quantity'); //报价数量
                //勾选允许供应商修改报价数量
                var is_quot_quantity_flag = $('pur52402_rfx_headers_ds').getAt(0).get('is_quot_quantity_flag');
                var price_batch_quantity = record.get('price_batch_quantity');
            
                var feedback_line_id = record.get('feedback_line_id');
                var list_ds = $('pur5240_rfx_feedback_all_selected_list_ds');
                var select_record = list_ds.find('feedback_line_id', feedback_line_id);
            
                if (name == 'suggested_operation' && value != oldvalue) {
                    var records = ds.getAll();
                    var rfx_line_item_id = record.get('rfx_line_item_id');
                    var suggested_operation_desc = record.get('suggested_operation_desc');
                    for (i = 0;i < records.length;i++) {
                        if (records[i].get('rfx_line_item_id') == rfx_line_item_id) {
                            records[i].set('suggested_operation_desc', suggested_operation_desc);
                            records[i].set('suggested_operation', value);
                        }
                    }
            
                    if (value != 'SELECTED') {
                        if (record.get('suggested_flag') != 'N') {
                            record.set('suggested_flag', 'N');
                        }
                        record.set('suggested_feedback_line_id', '');
                    }
            
                    if (!Aurora.isEmpty(select_record)) {
                        select_record.set('suggested_operation_desc', suggested_operation_desc);
                        select_record.set('suggested_operation', value);
                    }
            
                }
                if (name == 'cost_price' && value != oldvalue) {
                    var records = ds.getAll();
                    var rfx_line_item_id = record.get('rfx_line_item_id');
                    for (i = 0;i < records.length;i++) {
                        if (records[i].get('rfx_line_item_id') == rfx_line_item_id) {
                            records[i].set('cost_price', value);
                        }
                    }
                    if (!Aurora.isEmpty(select_record)) {
                        select_record.set('cost_price', value);
                    }
            
                }
                if (name == 'cost_total_price' && value != oldvalue) {
                    var records = ds.getAll();
                    var rfx_line_item_id = record.get('rfx_line_item_id');
                    for (i = 0;i < records.length;i++) {
                        if (records[i].get('rfx_line_item_id') == rfx_line_item_id) {
                            records[i].set('cost_total_price', value);
                        }
                    }
            
                    if (!Aurora.isEmpty(select_record)) {
                        select_record.set('cost_total_price', value);
                    }
            
            
                }
                if (name == 'suggested_flag') {
            
            
                    if (value == 'Y') {
                        var feedback_line_id = record.get('feedback_line_id');
                        record.getMeta().getField('allotted_quantity').setRequired(false);
            
                        if (is_quot_quantity_flag == 'Y') {
                            record.set('allotted_quantity', quote_quantity);
                        } else {
                            record.set('allotted_quantity', quantity);
                        }
                        record.set('price_batch_quantity', price_batch_quantity);
                        var suggested_operation = record.get('suggested_operation');
                        if (suggested_operation != 'SELECTED') {
                            record.set('suggested_operation_desc', '${l:PUR5240.RECOMMENDED_VENDOR}');
                            record.set('suggested_operation', 'SELECTED');
            
                        }
            
                    } else {
                        record.getMeta().getField('allotted_quantity').setRequired(false);
                        record.set('allotted_quantity', null);
                        record.set('price_batch_quantity', null);
            
                    }
                    if (!Aurora.isEmpty(select_record)) {
                        select_record.set('suggested_flag', value);
                    }
            
                }
            
                if (name == 'suggested_note') {
            
            
                    if (!Aurora.isEmpty(select_record)) {
                        select_record.set('suggested_note', value);
                    }
            
                }
            
                if (name == 'price_batch_quantity') {
            
                    if (!Aurora.isEmpty(select_record)) {
                        select_record.set('price_batch_quantity', value);
                    }
                }
            
                if (name == 'need_by_date') {
                    if (!Aurora.isEmpty(select_record)) {
                        select_record.set('need_by_date', value);
                    }
            
                }
            
            
            
                if (name == "allotted_quantity") {
            
                    if (!Aurora.isEmpty(value) && value != 0) {
                        if (is_quot_quantity_flag == 'Y') {
                            if (value > quote_quantity) {
                                Aurora.showMessage('${l:PROMPT}', '${l:PUR5240.ATTENTION_ASSIGNED_QUANTITY_IS_GREATER_THAN_QUOTA_QUANTITY}');
                            }
                        } else {
                            if (value > quantity) {
                                Aurora.showMessage('${l:PROMPT}', '${l:PUR5240.ATTENTION_ASSIGNED_QUANTITY_IS_GREATER_THAN_DEMAND_QUANTITY}');
                            }
                        }
            
                        if (is_quot_quantity_flag == 'Y') {
                            //计算分配比例
                            var allotted_percentage = pur5240_accMul(pur5240_accDiv(value, quote_quantity).toFixed(4), 100);
                        } else {
                            //计算分配比例
                            var allotted_percentage = pur5240_accMul(pur5240_accDiv(value, quantity).toFixed(4), 100);
                        }
            
                        //赋值分配比例
                        record.set('allotted_percentage', allotted_percentage);
            
                    } else {
                        record.set('allotted_percentage', null);
                    }
                }
            
                if (name == 'allotted_percentage') {
                    //debugger;
                    if (!Aurora.isEmpty(value) && value != 0) {
                        if (is_quot_quantity_flag == 'Y') {
                            //计算分配数量
                            var allotted_quantity = pur5240_accMul(pur5240_accDiv(value, 100), quote_quantity).toFixed(2);
                        } else {
                            //计算分配数量
                            var allotted_quantity = pur5240_accMul(pur5240_accDiv(value, 100), quantity).toFixed(2);
                        }
            
            
                        //赋值分配数量
                        record.set('allotted_quantity', allotted_quantity);
                    } else {
                        record.set('allotted_quantity', null);
                    }
                }
            
            
            }
            
            function feedback_all_submitsuccess() {
                $('pur52402_rfx_ln_items_ds').query();
                $('pur52402_rfx_feedback_all_ds').query();
            }
            
            function feedback_all_beforesubmit(ds) {
                /*    var dataset = $('pur52402_rfx_ln_items_ds');
                 //获取此物品行的需求数量
                 var quantity = dataset.getCurrentRecord().get('quantity');
                 var suggested_operation = dataset.getCurrentRecord().get('suggested_operation');
                 var cost_total_price = dataset.getCurrentRecord().get('cost_total_price');
                 */
                var records = ds.getAll();
                var line_num_total;
                var save_flag = 'Y';
                for (var i = 0;i < records.length;i++) {
            
                    var vendor_price_count = records[i].get('vendor_price_count');
                    var suggested_operation2 = records[i].get('suggested_operation');
                    var line_num = records[i].get('line_num');
                    //分配数量之和
                    var sum_allotted_quantity = 0;
                    var select_vendor_count = 0;
                    var quantity = records[i].get('quantity');
                    if (suggested_operation2 == "SELECTED") {
                        var quantity = records[i].get('quantity');
                        var rfx_line_item_id = records[i].get('rfx_line_item_id');
                        for (j = 0;j < records.length;j++) {
                            if (records[j].get('rfx_line_item_id') == rfx_line_item_id && records[j].get('suggested_flag') == 'Y') {
                                select_vendor_count++;
                                if (records[j].get('allotted_quantity') <= 0) {
                                    Aurora.showMessage('${l:PROMPT}', '${l:PUR5240.QUANTITY_OF_SELECTED_VENDORS_SHOULD_BE_GREATER_THAN_ZERO}');
                                    return false;
                                } else {
                                    sum_allotted_quantity = pur5240_accAdd(sum_allotted_quantity, records[j].get('allotted_quantity'));
                                }
                            }
                        }
                        //取2位精度
                        sum_allotted_quantity = sum_allotted_quantity.toFixed(2);
            
                        //校验是否有选用供应商
                        if (select_vendor_count == 0) {
                            Aurora.showMessage('${l:PROMPT}', '${l:PUR5240.DID_NOT_SELECT_VENDORS}');
                            return false;
                        }
            
                        // //判断分配数量之和与物品的需求数量
                        // if (sum_allotted_quantity != quantity) {
                        // Aurora.showConfirm('${l:PROMPT}', '已选用供应商的分配数量之和小于/大于需求数量,是否确定?', function() {
                        // //执行保存逻辑
                        // return true;
                        // }, function() {
                        // return false;
                        // });
                        // }
                    }
                    if (suggested_operation2 == "BACK" && vendor_price_count > 0) {
                        save_flag = 'N';
                        if (line_num_total == undefined) {
                            line_num_total = line_num;
                        } else {
                            line_num_total = line_num_total + ',' + line_num;
                        }
            
                    }
                }
                if (save_flag == 'N') {
                    Aurora.showMessage('${l:PROMPT}', '${l:PUR_LINES_SUBJECTS.LINE_NUM}' + line_num_total + ':  ${l:PUR5240.THERE_IS_A_QUOTE_CAN_NOT_CHOOSE_TO_RELEASE_MATERIAL_LINE}');
                    return false;
                }
            
            }
            
            function last_valid_fb_retail_price_render(value, record, name) {
                if (value) {
                    return '<a href="javascript:pur5240_rfxItem_history_price_openViewFun(' + record.get('rfx_line_item_id') + ')">' + value + '</a>';
            
                }
            
            }
            
            function pur5240_rfxItem_history_price_openViewFun(rfx_line_item_id) {
                new Aurora.Window({
                    url: $('pur5220_rfx_item_history_price_link').getUrl() + '?rfx_line_item_id=' + rfx_line_item_id,
                    title: '${l:PUR7110.HISTORICAL_QUOTATION}',
                    id: 'pur_public_rfx_item_history_price_view_window',
                    width: 850,
                    height: 400
                });
            }
            
            function pur52202_formatNumber_render(value, record, name) {
                return formatNumber2(value, 8);
            }
            
            
            
            // 勾选时所做的操作
            
            function pur5240_feedback_all_select(ds, record) {
                var list_ds = $('pur5240_rfx_feedback_all_selected_list_ds');
                var feedback_line_id = record.get('feedback_line_id');
                var result_record = list_ds.find('feedback_line_id', feedback_line_id);
                if (Aurora.isEmpty(result_record)) {
                    $('pur5240_rfx_feedback_all_selected_list_ds').create(record.data);
                }
            }
            
            // 勾选去掉时所做的操作
            
            function pur5240_feedback_all_unselect(ds, record) {
                var list_ds = $('pur5240_rfx_feedback_all_selected_list_ds');
                var feedback_line_id = record.get('feedback_line_id');
                var result_record = list_ds.find('feedback_line_id', feedback_line_id);
                if (!Aurora.isEmpty(result_record)) {
                    list_ds.remove(result_record);
                }
            }
            
            // 页面执行重新查询时所做的操作
            
            function pur52402_rfx_feedback_all_grid_render(grid) {
                var ds = $('pur52402_rfx_feedback_all_ds');
                var records = ds.getAll();
                var list_ds = $('pur5240_rfx_feedback_all_selected_list_ds');
                var list_records = list_ds.getAll();
                for (var i = 0;i < records.length;i++) {
                    var select_record = list_ds.find('feedback_line_id', records[i].get('feedback_line_id'));
                    if (!Aurora.isEmpty(select_record)) {
                        ds.select(records[i]);
                        records[i].set('suggested_operation_desc', select_record.get('suggested_operation_desc'));
                        records[i].set('suggested_operation', select_record.get('suggested_operation'));
                        records[i].set('suggested_flag', select_record.get('suggested_flag'));
                        records[i].set('cost_price', select_record.get('cost_price'));
                        records[i].set('cost_total_price', select_record.get('cost_total_price'));
                        records[i].set('suggested_note', select_record.get('suggested_note'));
                        records[i].set('price_batch_quantity', select_record.get('price_batch_quantity'));
                        records[i].set('need_by_date', select_record.get('need_by_date'));
            
                    }
                }
            }
            
            
            // 勾选时所做的操作
            
            function pur5240_ln_items_select(ds, record) {
                var list_ds = $('pur52402_rfx_vendors_detail_selected_ds');
                var currentPage = ds.currentPage;
                var pagesize = ds.pagesize;
                //ds 指针定位到勾选的行
                ds.locate(ds.indexOf(record) + 1 + (currentPage - 1) * pagesize);
                var list_ds = $('pur52402_rfx_ln_items_selected_ds');
                var rfx_line_item_id = record.get('rfx_line_item_id');
                var result_record = list_ds.find('rfx_line_item_id', rfx_line_item_id);
                if (Aurora.isEmpty(result_record)) {
                    $('pur52402_rfx_ln_items_selected_ds').create(record.data);
                }
            }
            
            // 勾选去掉时所做的操作
            
            function pur5240_ln_items_unselect(ds, record) {
                var currentPage = ds.currentPage;
                var pagesize = ds.pagesize;
                //ds 指针定位到勾选的行
                ds.locate(ds.indexOf(record) + 1 + (currentPage - 1) * pagesize);
                var list_ds = $('pur52402_rfx_ln_items_selected_ds');
                var rfx_line_item_id = record.get('rfx_line_item_id');
                var result_record = list_ds.find('rfx_line_item_id', rfx_line_item_id);
                if (!Aurora.isEmpty(result_record)) {
                    list_ds.remove(result_record);
                }
            }
            
            // 页面执行重新查询时所做的操作
            
            function pur52402_rfx_ln_items_grid_render(grid) {
            
                var ds = $('pur52402_rfx_ln_items_ds');
                var records = ds.getAll();
                var list_ds = $('pur52402_rfx_ln_items_selected_ds');
                var list_records = list_ds.getAll();
                for (var i = 0;i < records.length;i++) {
                    var select_record = list_ds.find('rfx_line_item_id', records[i].get('rfx_line_item_id'));
                    if (!Aurora.isEmpty(select_record)) {
                        ds.select(records[i]);
                        records[i].set('suggested_operation_desc', select_record.get('suggested_operation_desc'));
                        records[i].set('suggested_operation', select_record.get('suggested_operation'));
                        records[i].set('suggested_flag', select_record.get('suggested_flag'));
                        records[i].set('cost_price', select_record.get('cost_price'));
                        records[i].set('cost_total_price', select_record.get('cost_total_price'));
            
                    }
                }
            }
            
            // 页面执行重新查询时所做的操作
            
            function pur52402_check_price_vendors_detail_grid_render(grid) {
                var ds = $('pur52402_rfx_check_price_vendors_detail_ds');
                var records = ds.getAll();
                var list_ds = $('pur52402_rfx_vendors_detail_selected_ds');
                var list_records = list_ds.getAll();
                for (var i = 0;i < records.length;i++) {
                    var select_record = list_ds.find('feedback_line_id', records[i].get('feedback_line_id'));
                    if (!Aurora.isEmpty(select_record)) {
                        records[i].set('allotted_quantity', select_record.get('allotted_quantity'));
                        records[i].set('allotted_percentage', select_record.get('allotted_percentage'));
                        records[i].set('suggested_flag', select_record.get('suggested_flag'));
                        records[i].set('suggested_note', select_record.get('suggested_note'));
                        records[i].set('price_batch_quantity', select_record.get('price_batch_quantity'));
            
                    }
                }
            
            }
            
            
            
            function pur52402_rfx_feedback_all_saveFun() {
                var ds = $('pur5240_rfx_feedback_all_selected_list_ds');
                var records = ds.getAll();
                var datas = [];
                if (records.length == 0) {
                    Aurora.showMessage('${l:PROMPT}', '${l:PUR5240.PLEASE_CHECK_THE_DATA_WHICH_NEED_SAVE}');
                    return;
                }
                for (var i = 0;i < records.length;i++) {
                    datas.push(records[i].data);
                }
                Aurora.Masker.mask($('pur52402_rfx_check_price_window').wrap, '${l:LOADING}');
                Aurora.request({
                    url: $('pur5240_pur_rfx_feedback_all_save_link').getUrl(),
                    para: datas,
                    success: function(result) {
                        Aurora.Masker.unmask($('pur52402_rfx_check_price_window').wrap);
                        $('pur52402_rfx_feedback_all_ds').query();
                    },
                    failure: function() {
                        Aurora.Masker.unmask($('pur52402_rfx_check_price_window').wrap);
                        return;
                    },
                    error: function() {
                        Aurora.Masker.unmask($('pur52402_rfx_check_price_window').wrap);
                        return;
                    }
                });
            
            }
            
            function pur52202_lastBid_vender_view(value, record, name) {
                if (value) {
                    return '<a href="javascript:pur52202_lastBid_vender(' + record.get('rfx_line_item_id') + ',' + record.get('last_bid_price') + ')">' + value + '</a>';
                }
            }
            
            function pur52202_lastBid_vender(rfx_line_item_id, last_bid_price) {
                new Aurora.Window({
                    url: $('pur52202_rfx_lastBid_vender_link').getUrl() + '?rfx_line_item_id=' + rfx_line_item_id + '&last_bid_price=' + last_bid_price,
                    title: '${l:PROMPT.LAST_BID_VENDER}',
                    id: 'pur_rfx_feedback_lastBid_vender_window',
                    width: 850,
                    height: 400
                });
            }
            
            //add by Hunter 2658 at 2018-04-23 in T2320
            //询报价相关模块，加上显示字段
            
            function pur52402_rfxCheckPriceVendorsDetailGridRendererNetPrice(value, record, name) {
                //获取“显示净价”配置项的值
                var item_value = '${/model/bg_item_rfx_14/record/@bg_config_item_value}';
                var valid_fb_retail_price_v = record.get("valid_fb_retail_price");
                if (isNaN(valid_fb_retail_price_v)) {
                    return '***';
                }
                if (name == "net_price") {
                    //开启配置项则显示此字段
                    if (!Aurora.isEmpty(item_value) && item_value == "Y") {
                        var valid_fb_retail_price = record.get("valid_fb_retail_price");
                        var tax_type_rate = record.get("tax_type_rate");
                        if (Aurora.isEmpty(valid_fb_retail_price)) {
                            valid_fb_retail_price = 0;
                        }
                        if (Aurora.isEmpty(tax_type_rate)) {
                            tax_type_rate = 0;
                        }
            
                        //净价=单价/（1+税率%）
                        var net_price = valid_fb_retail_price / (1 + (tax_type_rate / 100));
                        net_price = net_price.toFixed(2);
                        return '<div>' + net_price + '</div>';
                    } else {
                        return '';
                    }
                }
                if (name == "net_amount") {
                    //开启配置项则显示此字段
                    if (!Aurora.isEmpty(item_value) && item_value == "Y") {
                        var valid_fb_retail_price = record.get("valid_fb_retail_price");
                        var tax_type_rate = record.get("tax_type_rate");
                        var quantity = record.get("quantity");
                        if (Aurora.isEmpty(valid_fb_retail_price)) {
                            valid_fb_retail_price = 0;
                        }
                        if (Aurora.isEmpty(tax_type_rate)) {
                            tax_type_rate = 0;
                        }
            
                        //净价=单价/（1+税率%）
                        var net_price = valid_fb_retail_price / (1 + (tax_type_rate / 100));
                        net_price = net_price.toFixed(2);
                        //税前金额=税前净价x数量
                        var net_amount = net_price * quantity;
                        net_amount = net_amount.toFixed(2);
                        return '<div>' + net_amount + '</div>';
                    } else {
                        return '';
                    }
                }
                if (name == "tax_amount") {
                    //开启配置项则显示此字段
                    if (!Aurora.isEmpty(item_value) && item_value == "Y") {
                        var valid_fb_retail_price = record.get("valid_fb_retail_price");
                        var tax_type_rate = record.get("tax_type_rate");
                        var quantity = record.get("quantity");
                        if (Aurora.isEmpty(valid_fb_retail_price)) {
                            valid_fb_retail_price = 0;
                        }
                        if (Aurora.isEmpty(tax_type_rate)) {
                            tax_type_rate = 0;
                        }
            
                        //净价=单价/（1+税率%）
                        var net_price = valid_fb_retail_price / (1 + (tax_type_rate / 100));
                        net_price = net_price.toFixed(2);
                        //税前金额=税前净价x数量
                        var net_amount = net_price * quantity;
                        net_amount = net_amount.toFixed(2);
                        //税额=（单价-税前净价）x数量
                        var tax_amount = (valid_fb_retail_price - net_price) * quantity;
                        tax_amount = tax_amount.toFixed(2);
                        return '<div>' + tax_amount + '</div>';
                    } else {
                        return '';
                    }
                }
                if (name == "total_amounts") {
                    //开启配置项则显示此字段
                    if (!Aurora.isEmpty(item_value) && item_value == "Y") {
                        var valid_fb_retail_price = record.get("valid_fb_retail_price");
                        var tax_type_rate = record.get("tax_type_rate");
                        var quantity = record.get("quantity");
                        if (Aurora.isEmpty(valid_fb_retail_price)) {
                            valid_fb_retail_price = 0;
                        }
                        if (Aurora.isEmpty(tax_type_rate)) {
                            tax_type_rate = 0;
                        }
            
                        //净价=单价/（1+税率%）
                        var net_price = valid_fb_retail_price / (1 + (tax_type_rate / 100));
                        net_price = net_price.toFixed(2);
                        //税前金额=税前净价x数量
                        var net_amount = net_price * quantity;
                        //税额=（单价-税前净价）x数量
                        var tax_amount = (valid_fb_retail_price - net_price) * quantity;
                        //总额=税前金额+税额
                        var total_amounts = net_amount + tax_amount;
                        total_amounts = total_amounts.toFixed(2);
                        return '<div>' + total_amounts + '</div>';
                    } else {
                        return '';
                    }
                }
            }
            
            //add by Hunter 2658 at 2018-04-23 in T2320
            //询报价相关模块，加上显示字段
            
            function pur52402_rfxFeedbackItemsBargainGridRendererNetPrice(value, record, name) {
                //获取“显示净价”配置项的值
                var item_value = '${/model/bg_item_rfx_14/record/@bg_config_item_value}';
                var valid_fb_retail_price_v = record.get("valid_fb_retail_price");
                if (isNaN(valid_fb_retail_price_v)) {
                    return '***';
                }
                if (name == "net_price") {
                    //开启配置项则显示此字段
                    if (!Aurora.isEmpty(item_value) && item_value == "Y") {
                        var valid_fb_retail_price = record.get("valid_fb_retail_price");
                        var tax_type_rate = record.get("tax_type_rate");
                        if (Aurora.isEmpty(valid_fb_retail_price)) {
                            valid_fb_retail_price = 0;
                        }
                        if (Aurora.isEmpty(tax_type_rate)) {
                            tax_type_rate = 0;
                        }
            
                        //净价=单价/（1+税率%）
                        var net_price = valid_fb_retail_price / (1 + (tax_type_rate / 100));
                        net_price = net_price.toFixed(2);
                        return '<div>' + net_price + '</div>';
                    } else {
                        return '';
                    }
                }
                if (name == "net_amount") {
                    //开启配置项则显示此字段
                    if (!Aurora.isEmpty(item_value) && item_value == "Y") {
                        var valid_fb_retail_price = record.get("valid_fb_retail_price");
                        var tax_type_rate = record.get("tax_type_rate");
                        var quantity = record.get("quantity");
                        if (Aurora.isEmpty(valid_fb_retail_price)) {
                            valid_fb_retail_price = 0;
                        }
                        if (Aurora.isEmpty(tax_type_rate)) {
                            tax_type_rate = 0;
                        }
            
                        //净价=单价/（1+税率%）
                        var net_price = valid_fb_retail_price / (1 + (tax_type_rate / 100));
                        net_price = net_price.toFixed(2);
                        //税前金额=税前净价x数量
                        var net_amount = net_price * quantity;
                        net_amount = net_amount.toFixed(2);
                        return '<div>' + net_amount + '</div>';
                    } else {
                        return '';
                    }
                }
                if (name == "tax_amount") {
                    //开启配置项则显示此字段
                    if (!Aurora.isEmpty(item_value) && item_value == "Y") {
                        var valid_fb_retail_price = record.get("valid_fb_retail_price");
                        var tax_type_rate = record.get("tax_type_rate");
                        var quantity = record.get("quantity");
                        if (Aurora.isEmpty(valid_fb_retail_price)) {
                            valid_fb_retail_price = 0;
                        }
                        if (Aurora.isEmpty(tax_type_rate)) {
                            tax_type_rate = 0;
                        }
            
                        //净价=单价/（1+税率%）
                        var net_price = valid_fb_retail_price / (1 + (tax_type_rate / 100));
                        net_price = net_price.toFixed(2);
                        //税前金额=税前净价x数量
                        var net_amount = net_price * quantity;
                        net_amount = net_amount.toFixed(2);
                        //税额=（单价-税前净价）x数量
                        var tax_amount = (valid_fb_retail_price - net_price) * quantity;
                        tax_amount = tax_amount.toFixed(2);
                        return '<div>' + tax_amount + '</div>';
                    } else {
                        return '';
                    }
                }
                if (name == "total_amounts") {
                    //开启配置项则显示此字段
                    if (!Aurora.isEmpty(item_value) && item_value == "Y") {
                        var valid_fb_retail_price = record.get("valid_fb_retail_price");
                        var tax_type_rate = record.get("tax_type_rate");
                        var quantity = record.get("quantity");
                        if (Aurora.isEmpty(valid_fb_retail_price)) {
                            valid_fb_retail_price = 0;
                        }
                        if (Aurora.isEmpty(tax_type_rate)) {
                            tax_type_rate = 0;
                        }
            
                        //净价=单价/（1+税率%）
                        var net_price = valid_fb_retail_price / (1 + (tax_type_rate / 100));
                        net_price = net_price.toFixed(2);
                        //税前金额=税前净价x数量
                        var net_amount = net_price * quantity;
                        //税额=（单价-税前净价）x数量
                        var tax_amount = (valid_fb_retail_price - net_price) * quantity;
                        //总额=税前金额+税额
                        var total_amounts = net_amount + tax_amount;
                        total_amounts = total_amounts.toFixed(2);
                        return '<div>' + total_amounts + '</div>';
                    } else {
                        return '';
                    }
                }
            }
            
            //add by Hunter 2658 at 2018-04-23 in T2320
            //询报价相关模块，加上显示字段
            
            function pur52402_rfxFeedbackAllRendererNetPrice(value, record, name) {
                //获取“显示净价”配置项的值
                var item_value = '${/model/bg_item_rfx_14/record/@bg_config_item_value}';
                var valid_fb_retail_price_v = record.get("valid_fb_retail_price");
                if (isNaN(valid_fb_retail_price_v)) {
                    return '***';
                }
                if (name == "net_price") {
                    //开启配置项则显示此字段
                    if (!Aurora.isEmpty(item_value) && item_value == "Y") {
                        var valid_fb_retail_price = record.get("valid_fb_retail_price");
                        var tax_type_rate = record.get("tax_type_rate");
                        if (Aurora.isEmpty(valid_fb_retail_price)) {
                            valid_fb_retail_price = 0;
                        }
                        if (Aurora.isEmpty(tax_type_rate)) {
                            tax_type_rate = 0;
                        }
            
                        //净价=单价/（1+税率%）
                        var net_price = valid_fb_retail_price / (1 + (tax_type_rate / 100));
                        net_price = net_price.toFixed(2);
                        return '<div>' + net_price + '</div>';
                    } else {
                        return '';
                    }
                }
                if (name == "net_amount") {
                    //开启配置项则显示此字段
                    if (!Aurora.isEmpty(item_value) && item_value == "Y") {
                        var valid_fb_retail_price = record.get("valid_fb_retail_price");
                        var tax_type_rate = record.get("tax_type_rate");
                        var quantity = record.get("quantity");
                        if (Aurora.isEmpty(valid_fb_retail_price)) {
                            valid_fb_retail_price = 0;
                        }
                        if (Aurora.isEmpty(tax_type_rate)) {
                            tax_type_rate = 0;
                        }
            
                        //净价=单价/（1+税率%）
                        var net_price = valid_fb_retail_price / (1 + (tax_type_rate / 100));
                        net_price = net_price.toFixed(2);
                        //税前金额=税前净价x数量
                        var net_amount = net_price * quantity;
                        net_amount = net_amount.toFixed(2);
                        return '<div>' + net_amount + '</div>';
                    } else {
                        return '';
                    }
                }
                if (name == "tax_amount") {
                    //开启配置项则显示此字段
                    if (!Aurora.isEmpty(item_value) && item_value == "Y") {
                        var valid_fb_retail_price = record.get("valid_fb_retail_price");
                        var tax_type_rate = record.get("tax_type_rate");
                        var quantity = record.get("quantity");
                        if (Aurora.isEmpty(valid_fb_retail_price)) {
                            valid_fb_retail_price = 0;
                        }
                        if (Aurora.isEmpty(tax_type_rate)) {
                            tax_type_rate = 0;
                        }
            
                        //净价=单价/（1+税率%）
                        var net_price = valid_fb_retail_price / (1 + (tax_type_rate / 100));
                        net_price = net_price.toFixed(2);
                        //税前金额=税前净价x数量
                        var net_amount = net_price * quantity;
                        net_amount = net_amount.toFixed(2);
                        //税额=（单价-税前净价）x数量
                        var tax_amount = (valid_fb_retail_price - net_price) * quantity;
                        tax_amount = tax_amount.toFixed(2);
                        return '<div>' + tax_amount + '</div>';
                    } else {
                        return '';
                    }
                }
                if (name == "total_amounts") {
                    //开启配置项则显示此字段
                    if (!Aurora.isEmpty(item_value) && item_value == "Y") {
                        var valid_fb_retail_price = record.get("valid_fb_retail_price");
                        var tax_type_rate = record.get("tax_type_rate");
                        var quantity = record.get("quantity");
                        if (Aurora.isEmpty(valid_fb_retail_price)) {
                            valid_fb_retail_price = 0;
                        }
                        if (Aurora.isEmpty(tax_type_rate)) {
                            tax_type_rate = 0;
                        }
            
                        //净价=单价/（1+税率%）
                        var net_price = valid_fb_retail_price / (1 + (tax_type_rate / 100));
                        net_price = net_price.toFixed(2);
                        //税前金额=税前净价x数量
                        var net_amount = net_price * quantity;
                        //税额=（单价-税前净价）x数量
                        var tax_amount = (valid_fb_retail_price - net_price) * quantity;
                        //总额=税前金额+税额
                        var total_amounts = net_amount + tax_amount;
                        total_amounts = total_amounts.toFixed(2);
                        return '<div>' + total_amounts + '</div>';
                    } else {
                        return '';
                    }
                }
            }
            
            function pur52402_rfx_check_price_items_detail_ds_load(ds) {
                //开启配置项则显示税前净价、税前金额、税额、总额字段
                var item_value = '${/model/bg_item_rfx_14/record/@bg_config_item_value}';
                if (!Aurora.isEmpty(item_value) && item_value == "N") {
                    $('pur52402_rfx_feedback_items_bargain_grid').hideColumn('net_price');
                    $('pur52402_rfx_feedback_items_bargain_grid').hideColumn('net_amount');
                    $('pur52402_rfx_feedback_items_bargain_grid').hideColumn('tax_amount');
                    $('pur52402_rfx_feedback_items_bargain_grid').hideColumn('total_amounts');
                } else if (Aurora.isEmpty(item_value)) {
                    $('pur52402_rfx_feedback_items_bargain_grid').hideColumn('net_price');
                    $('pur52402_rfx_feedback_items_bargain_grid').hideColumn('net_amount');
                    $('pur52402_rfx_feedback_items_bargain_grid').hideColumn('tax_amount');
                    $('pur52402_rfx_feedback_items_bargain_grid').hideColumn('total_amounts');
                }
            
            
            }
            
            function pur52402_rfx_feedback_all_ds_load(ds) {
                //开启配置项则显示税前净价、税前金额、税额、总额字段
                var item_value = '${/model/bg_item_rfx_14/record/@bg_config_item_value}';
                if (!Aurora.isEmpty(item_value) && item_value == "N") {
                    $('pur52402_rfx_feedback_all').hideColumn('net_price');
                    $('pur52402_rfx_feedback_all').hideColumn('net_amount');
                    $('pur52402_rfx_feedback_all').hideColumn('tax_amount');
                    $('pur52402_rfx_feedback_all').hideColumn('total_amounts');
                } else if (Aurora.isEmpty(item_value)) {
                    $('pur52402_rfx_feedback_all').hideColumn('net_price');
                    $('pur52402_rfx_feedback_all').hideColumn('net_amount');
                    $('pur52402_rfx_feedback_all').hideColumn('tax_amount');
                    $('pur52402_rfx_feedback_all').hideColumn('total_amounts');
                }
            }
            //add by liumeiqi 16049 at 2018-05-08 in T2390
            //周黑鸭核价分配比例参考
            
            function zhy_pur52402_allocation_ratio_Fun() {
                var allocation_amount_flag = $('pur52402_rfx_headers_ds').getCurrentRecord().get('allocation_amount_flag');
                if (allocation_amount_flag == 'Y') {
                    new Aurora.Window({
                        url: $('zhy_pur52402_allocation_ratio_link').getUrl() + '?rfx_header_id=' + ${/parameter/@rfx_header_id},
                        title: '数量分配参考',
                        id: 'zhy_pur52402_allocation_ratio_window',
                        fullScreen: true
                    });
                } else {
                    var records = $('pur52402_rfx_feedback_all_ds').getAll();
                    var para = [];
                    for (var i = 0;i < records.length;i++) {
                        records[i].set('_status', 'insert');
                        para.push(records[i].data);
                    }
                    Aurora.Masker.mask($('pur52402_rfx_check_price_window').wrap, '正在加载...');
                    Aurora.request({
                        url: $('zhy_pur1050_allocation_ratio_link').getUrl(),
                        para: para,
                        success: function(result) {
                            new Aurora.Window({
                                url: $('zhy_pur52402_allocation_ratio_link').getUrl() + '?rfx_header_id=' + ${/parameter/@rfx_header_id},
                                title: '数量分配参考',
                                id: 'zhy_pur52402_allocation_ratio_window',
                                fullScreen: true
                            });
                            $('pur52402_rfx_headers_ds').query();
                            Aurora.Masker.unmask($('pur52402_rfx_check_price_window').wrap);
                        },
                        failure: function() {
                            Aurora.Masker.unmask($('pur52402_rfx_check_price_window').wrap);
                        },
                        error: function() {
                            Aurora.Masker.unmask($('pur52402_rfx_check_price_window').wrap);
                        },
                        scopo: this,
                        sync: true
                    });
                }
            
            }
            
            function cancel_rfx_feedback_btn() {
                var ds = $('pur52402_rfx_check_price_vendors_detail_ds');
                var hd_ds = $('pur52402_rfx_headers_ds');
                var vendor_all_ds = $('pur52402_rfx_ln_vendors_ds');
                var vendor_ds = $('pur52402_rfx_feedback_all_ds');
                var record = hd_ds.getCurrentRecord();
                var item_ds = $('pur52402_rfx_ln_items_ds');
                if (!ds.validate()) {
                    return;
                }
                debugger;
                if (ds.isModified() || item_ds.isModified()) {
                    Aurora.showMessage('${l:PROMPT}', '${l:PUR5240.UNSAVED_FOR_SUBMIT}');
                    return;
                }
                var records = vendor_ds.getAll();
                for (var i = 0;i < records.length;i++) {
                    if (records[i].get('suggested_flag') == 'Y') {
                        Aurora.showMessage('${l:PROMPT}', '已经选用物料，不能取消！');
                        return;
                    }
                }
            
                datas = {};
                datas['cost_comments'] = record.get('cost_comments');
                datas['total_costs'] = record.get('total_costs');
                datas['rfx_header_id'] = record.get('rfx_header_id');
                Aurora.Masker.mask($('pur52402_rfx_check_price_window').wrap, '${l:LOADING}');
                Aurora.request({
                    url: $('pur52402_rfx_check_price_cancel_new_link').getUrl(),
                    para: datas,
                    success: function() {
                        Aurora.Masker.unmask($('pur52402_rfx_check_price_window').wrap);
                        Aurora.showMessage('${l:PROMPT}', '取消成功!');
                        window.setTimeout("pur52402_rfx_feedback_return()", 1000);
                    },
                    failure: function() {
                        Aurora.Masker.unmask($('pur52402_rfx_check_price_window').wrap);
                        return;
                    },
                    error: function() {
                        Aurora.Masker.unmask($('pur52402_rfx_check_price_window').wrap);
                        return;
                    }
                });
            }
            function pur52402_rfxFirstTrialAllFunction() {
            	var item_records =$('pur52402_rfx_ln_items_ds').getSelected();
            	var message = '即将发布下一轮询价，不可修改，是否确认?';
            	if(item_records.length == 0 ){
            	    message = '您未勾选物料明细发起下一轮询价，即将全部再次询价，不可修改，是否确认?';
            	    item_records = $('pur52402_rfx_ln_items_ds').getAll();
            	}
                
                //定义询价升级的参数
                var datas = {
                    'rfx_header_id': '${/parameter/@rfx_header_id}'
                };
            
                //整理物品行信息
                var data_items = [];
                for (var i = 0;i < item_records.length;i++) {
                    var record = item_records[i];
                    var items = {
                        'rfx_line_item_id': record.get('rfx_line_item_id'),
                        'round_flag': 'Y'
                    };
                    data_items.push(items);
                }
                //整理请求参数
                datas['data_items'] = data_items;
            
                //提交请求
                Aurora.showConfirm('${l:PROMPT}', message, function() {
                    //全部物品行的round_flag都设置成Y
                    for (i = 0;i < item_records.length;i++) {
                        item_records[i].set('round_flag', 'Y');
                    }
            
                    Aurora.Masker.mask($('pur52402_rfx_check_price_window').wrap, '${l:LOADING}');
                    Aurora.request({
                        url: $('pur51302_rfx_first_trial_link').getUrl(),
                        para: datas,
                        success: function() {
                            Aurora.Masker.unmask($('pur52402_rfx_check_price_window').wrap);
                            new Aurora.Window({
                                url: $('pur5130_rfx_first_trail_maintain_link').getUrl() + '?rfx_header_id=${/parameter/@rfx_header_id}',
                                title: '发布多轮',
                                id: 'pur5130_rfx_first_trail_maintain_window',
                                fullScreen: true
                            }).on('beforeclose', pur52402_rfx_feedback_return);
                        },
                        failure: function() {
                            Aurora.Masker.unmask($('pur52402_rfx_check_price_window').wrap);
                            return;
                        },
                        error: function() {
                            Aurora.Masker.unmask($('pur52402_rfx_check_price_window').wrap);
                            return;
                        }
                    });
                });
            }
        ]]></script>
        <a:dataSets>
            <a:dataSet id="pur52402_rfx_feedback_suggested_operation_ds" lookupCode="PUR_RFX_SUGGESTED_OPERATION"/>
            <a:dataSet id="pur52402_rfx_yes_or_not" lookupCode="YES_OR_NO"/>
            <a:dataSet id="pur52402_rfx_lowest_options_ds" lookupCode="PUR_RFX_CHECK_STRATEGY"/>
            <a:dataSet id="pur52402_rfx_headers_ds" autoQuery="true" model="pur.PUR5240.pur_rfx_check_price_query" queryUrl="${/request/@context_path}/autocrud/pur.PUR5240.pur_rfx_check_price_query/query?rfx_header_id=${/parameter/@rfx_header_id}">
                <a:fields>
                    <a:field name="tax_included_flag" readOnly="true"/>
                    <a:field name="sealed_bid_flag" readOnly="true"/>
                    <a:field name="department_approve_flag" readOnly="true"/>
                    <a:field name="exceed_cost_flag_desc" displayField="code_value_name" options="pur52402_rfx_yes_or_not" returnField="exceed_cost_flag" valueField="code_value"/>
                    <a:field name="firsttrail_comments" readOnly="true"/>
                    <a:field name="is_quot_quantity_flag" readOnly="true"/>
                    <a:field name="type_po_item"/>
                    <!--add begin he 2019-12-03-->
                    <a:field name="business_unit_name" autoComplete="true" autoCompleteField="business_unit_code_name" lovHeight="480" lovService="public.fnd_business_unit_lov" lovWidth="500" title="业务实体查询">
                        <a:mapping>
                            <a:map from="business_unit_id" to="owner_business_unit_id"/>
                            <a:map from="business_unit_code" to="business_unit_code"/>
                            <a:map from="business_unit_name" to="business_unit_name"/>
                            <a:map from="company_id" to="company_id"/>
                        </a:mapping>
                    </a:field>
                    <!--add end he 2019-12-03-->
                </a:fields>
                <a:events>
                    <a:event name="load" handler="pur52402_rfx_headers_ds_load"/>
                    <a:event name="update" handler="pur52402_rfx_headers_ds_update"/>
                </a:events>
            </a:dataSet>
            <a:dataSet id="pur52402_rfx_ln_items_ds" autoCount="true" autoQuery="true" model="pur.PUR5240.pur_rfx_ln_items" pageSize="5" queryUrl="${/request/@context_path}/autocrud/pur.PUR5240.pur_rfx_ln_items/query?rfx_header_id=${/parameter/@rfx_header_id}" selectable="true" submitUrl="${/request/@context_path}/modules/pur/PUR5240/pur_rfx_check_price_save.svc">
                <a:fields>
                    <a:field name="rfx_line_item_id"/>
                    <a:field name="suggested_operation"/>
                    <a:field name="suggested_feedback_line_id"/>
                    <a:field name="suggested_operation_desc" displayField="code_value_name" options="pur52402_rfx_feedback_suggested_operation_ds" required="true" returnField="suggested_operation" valueField="code_value"/>
                </a:fields>
                <a:events>
                    <a:event name="update" handler="pur52402_rfx_ln_items_ds_update"/>
                    <a:event name="load" handler="pur52402_rfx_ln_items_ds_load"/>
                    <a:event name="submitsuccess" handler="pur52402_rfx_ln_items_ds_submitsuccess2"/>
                    <a:event name="select" handler="pur5240_ln_items_select"/>
                    <a:event name="unselect" handler="pur5240_ln_items_unselect"/>
                    <!-- <a:event name="submitsuccess" handler="pur52402_rfx_ln_items_ds_submitsuccess1"/>
                   <a:event name="beforesubmit" handler="pur52402_rfx_ln_items_ds_beforeSubmit"/> -->
                </a:events>
            </a:dataSet>
            <a:dataSet id="yes_or_no_ds" lookupCode="YES_OR_NO"/>
            <a:dataSet id="pur5240_source_type_ds" lookupCode="PUR_RFX_SOURCE_TYPE"/>
            <a:dataSet id="pur52402_rfx_ln_vendors_ds" autoQuery="true" fetchAll="true" model="pur.PUR5240.pur_rfx_ln_vendors" queryUrl="${/request/@context_path}/autocrud/pur.PUR5240.pur_rfx_ln_vendors/query?rfx_header_id=${/parameter/@rfx_header_id}" submitUrl="${/request/@context_path}/modules/pur/PUR5240/pur_rfx_check_price_pack_vendor_save.svc">
                <a:fields>
                    <a:field name="source_type_desc" defaultValue="${l:PUR5130.CONVENTIONAL}" displayField="code_value_name" options="pur5240_source_type_ds" required="true" requiredMessage="${l:PUR5130.PLEASE_CHOOSE_SOURCE_TYPE}" returnField="source_type" valueField="code_value"/>
                    <a:field name="source_type" defaultValue="COMMON" required="true"/>
                    <a:field name="is_cen_pur_desc" displayField="code_value_name" options="yes_or_no_ds" required="true" returnField="is_cen_pur" valueField="code_value"/>
                    <a:field name="suggested_note"/>
                    <a:field name="proposed_flag" checkedValue="Y" uncheckedValue="N"/>
                    <a:field name="vendor_site_code" lovGridHeight="320" lovHeight="450" lovService="pur.PUR5240.pur_rfx_check_vendor_site_lov" lovWidth="500" required="true" title="供应商地点">
                        <a:mapping>
                            <a:map from="display_site_code" to="vendor_site_code"/>
                        </a:mapping>
                    </a:field>
                </a:fields>
                <a:events>
                    <a:event name="load" handler="pur52402_rfx_ln_vendors_ds_load"/>
                    <a:event name="update" handler="pur52402_rfx_ln_vendors_ds_update"/>
                    <a:event name="submitsuccess" handler="pur52402_rfx_ln_items_ds_submitsuccess"/>
                </a:events>
            </a:dataSet>
            <a:dataSet id="pur52402_rfx_check_price_vendors_detail_ds" bindName="check_price_vendors_details" bindTarget="pur52402_rfx_ln_items_ds" fetchAll="true" model="pur.PUR5240.pur_rfx_feedback_check_price_details">
                <a:fields>
                    <a:field name="suggested_flag" checkedValue="Y" defaultValue="N" uncheckedValue="N"/>
                    <a:field name="allotted_quantity"/>
                    <a:field name="tax_included_flag" checkedValue="Y" uncheckedValue="N"/>
                    <a:field name="trans_cost_flag" checkedValue="Y" readOnly="true" uncheckedValue="N"/>
                </a:fields>
                <a:events>
                    <a:event name="load" handler="pur52402_rfx_check_price_vendor_load"/>
                    <a:event name="update" handler="pur52402_rfx_check_price_vendors_detail_ds_update"/>
                    <a:event name="submitsuccess" handler="pur52402_rfx_check_price_vendors_detail_ds_submitsuccess"/>
                </a:events>
            </a:dataSet>
            <a:dataSet id="pur52402_rfx_check_price_items_detail_ds" autoPageSize="true" bindName="pur52402_rfx_feedback_bargain_items" bindTarget="pur52402_rfx_ln_vendors_ds" fetchAll="true" model="pur.PUR5240.pur_rfx_feedback_check_price_details">
                <a:fields>
                    <a:field name="suggested_flag" checkedValue="Y" uncheckedValue="N"/>
                    <a:field name="trans_cost_flag" checkedValue="Y" readOnly="true" uncheckedValue="N"/>
                    <a:field name="tax_included_flag" checkedValue="Y" uncheckedValue="N"/>
                </a:fields>
                <a:events>
                    <a:event name="submitsuccess" handler="pur52402_rfx_check_price_items_detail_ds_submitsuccess"/>
                    <a:event name="load" handler="pur52402_rfx_check_price_items_detail_ds_load"/>
                </a:events>
            </a:dataSet>
            <a:dataSet id="pur52402_rfx_ln_attachments"/>
            <a:dataSet id="pur71101_rfx_ln_attachments" autoQuery="true" fetchAll="true" model="public.fnd_atm_lines" queryUrl="${/request/@context_path}/autocrud/public.fnd_atm_lines/query?source_table_name=PUR_RFX_HEADERS&amp;source_pk_value=${/parameter/@rfx_header_id}">
                <a:fields>
                    <a:field name="atm_line_id"/>
                </a:fields>
            </a:dataSet>
            <a:dataSet id="pur5240_rfx_lowest_ds">
                <a:fields>
                    <a:field name="lowest_flag_desc" displayField="code_value_name" options="pur52402_rfx_lowest_options_ds" returnField="lowest_flag" valueField="code_value"/>
                </a:fields>
            </a:dataSet>
            <a:dataSet id="pur52402_rfx_feedback_all_ds" autoCount="true" autoPageSize="true" autoQuery="true" model="pur.PUR5240.pur_rfx_feedback_all" queryDataSet="pur5240_rfx_lowest_ds" queryUrl="${/request/@context_path}/autocrud/pur.PUR5240.pur_rfx_feedback_all/query?rfx_header_id=${/parameter/@rfx_header_id}" selectable="true">
                <a:fields>
                    <a:field name="allotted_quantity"/>
                    <a:field name="trans_cost_flag" checkedValue="Y" readOnly="true" uncheckedValue="N"/>
                    <a:field name="suggested_flag" checkedValue="Y" defaultValue="N" uncheckedValue="N"/>
                    <a:field name="tax_included_flag" checkedValue="Y" uncheckedValue="N"/>
                    <a:field name="suggested_operation_desc" displayField="code_value_name" options="pur52402_rfx_feedback_suggested_operation_ds" returnField="suggested_operation" valueField="code_value"/>
                </a:fields>
                <a:events>
                    <a:event name="load" handler="pur52402_rfx_feedback_all_ds_load"/>
                    <a:event name="update" handler="feedback_all_update"/>
                    <a:event name="submitsuccess" handler="feedback_all_submitsuccess"/>
                    <a:event name="beforesubmit" handler="feedback_all_beforesubmit"/>
                    <a:event name="select" handler="pur5240_feedback_all_select"/>
                    <a:event name="unselect" handler="pur5240_feedback_all_unselect"/>
                </a:events>
            </a:dataSet>
            <a:dataSet id="pur5240_rfx_feedback_all_selected_list_ds"/>
            <a:dataSet id="pur52402_rfx_ln_items_selected_ds"/>
            <a:dataSet id="pur52402_rfx_vendors_detail_selected_ds"/>
            <!-- add by liumeiqi 16049 -->
            <a:dataSet id="zhypur1050_bg_judge_ds" loadData="true" model="cux.ZHY.ZHYPUR1050.zhypur1050_bg_judge"/>
        </a:dataSets>
        <a:screenBody>
            <a:screenTopToolbar>
                <a:toolbarButton click="pur52402_rfx_feedback_submit" text="HAP_SUBMIT" width="100"/>
                <a:toolbarButton click="cancel_rfx_feedback_btn" text="取消询价" width="100"/>
                <a:toolbarButton click="pur52402_rfxFirstTrialAllFunction" text="再次询价" width="100"/>
                <!-- <a:toolbarButton click="pur52402_pur_rfx_returntotrial" text="PUR5240.RETURNED_TO_THE_FIRST_EXAMINATION" width="100"/> -->
                <a:toolbarButton click="pur52402_rfx_operation_record_fun" text="PROMPT.OPERATION_RECORD" width="100"/>
                <a:toolbarButton click="pur52402_rfx_feedback_return" text="HAP_BACK" width="100"/>
                <a:toolbarButton click="pur52402_rfx_assistance_v2" text="PUR5240.PRICE_COMPARISON_ASSISTANT" width="100"/>
                <a:switch test="/parameter/@atm_counts">
                    <a:case value="1">
                        <div style="float:right;margin-top:10px;margin-left:auto;margin-right:20px;vertical-align:middle;">
                            <img src="${/request/@context_path}/images/paperclip.png"/>
                        </div>
                    </a:case>
                </a:switch>
            </a:screenTopToolbar>
            <a:vBox labelWidth="120" padding="0">
                <a:hBox labelWidth="120">
                    <a:textField name="rfx_number" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.RFX_NUMBER" readOnly="true"/>
                    <a:textField name="title" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.TITLE" readOnly="true"/>
                    <a:textField name="round" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.ROUND" readOnly="true"/>
                </a:hBox>
                <a:hBox labelWidth="120">
                    <!-- <a:textField name="comments" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.COMMENTS" readOnly="true" width="707"/> -->
                    <!-- 修改备注字段显示框 by zoulonghui 2018/01/22 -->
                    <a:textArea name="comments" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.COMMENTS" readOnly="true" width="707"/>
                </a:hBox>
                <a:hBox labelWidth="120">
                    <a:textField name="firsttrail_comments" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.FIRSTTRAIL_COMMENTS" width="707"/>
                </a:hBox>
                <a:hBox>
                    <a:accordionPanel height="250" showIcon="true" singleMode="false" width="900">
                        <a:accordions>
                            <a:accordion prompt="PROMPT.OTHER_INFO" selected="false">
                                <a:vBox>
                                    <a:hBox labelWidth="120">
                                        <!-- <a:lov name="pur_organization_name" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_ORGANIZATIONS.PUR_ORG_NAME" readOnly="true"/> -->
                                        <!--2019-12-03 <a:lov name="business_unit_name" bindTarget="pur52402_rfx_headers_ds" prompt="FND_BUSINESS_UNITS.BUSINESS_UNIT" readOnly="true"/>-->
                                        <a:lov name="business_unit_name" bindTarget="pur52402_rfx_headers_ds" prompt="FND_BUSINESS_UNITS.BUSINESS_UNIT"/>
                                        <a:comboBox name="rfx_type_desc" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.RFX_TYPE_ID" readOnly="true"/>
                                        <a:comboBox name="rfx_method_desc" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.RFX_METHOD" readOnly="true"/>
                                    </a:hBox>
                                    <a:hBox labelWidth="120">
                                        <!-- <a:comboBox name="payment_method_desc" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.PAYMENT_METHOD_ID" readOnly="true"/> -->
                                        <!-- <a:comboBox name="currency_desc" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.CURRENCY_CODE" readOnly="true"/> -->
                                        <a:textField name="status_desc" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.STATUS" readOnly="true"/>
                                        <a:dateTimePicker name="feedback_end_time" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.FEEDBACK_END_TIME" readOnly="true"/>
                                        <a:comboBox name="auction_direction_desc" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.AUCTION_DIRECTION" readOnly="true"/>
                                    </a:hBox>
                                    <a:hBox labelWidth="120">
                                        <a:checkBox name="tax_included_flag" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.TAX_INCLUDED_FLAG" readOnly="true" width="152"/>
                                        <!-- <a:lov name="tax_type_desc" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.TAX_CODE" readOnly="true"/> -->
                                        <a:checkBox name="sealed_bid_flag" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.SEALED_BID_FLAG" readOnly="true" width="152"/>
                                        <a:comboBox name="open_rule_desc" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.OPEN_RULE" readOnly="true"/>
                                    </a:hBox>
                                    <a:hBox labelWidth="120">
                                        <a:comboBox name="auction_ranking_desc" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.AUCTION_RANKING" readOnly="true"/>
                                        <a:dateTimePicker name="creation_date_desc" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.CREATION_DATE" readOnly="true"/>
                                        <!-- <a:textField name="place_of_delivery" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.PLACE_OF_DELIVERY" readOnly="true"/> -->
                                        <!-- <a:comboBox name="source_type_desc" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.SOURCE_TYPE" readOnly="true"/> -->
                                    </a:hBox>
                                    <a:hBox labelWidth="120">
                                        <a:comboBox name="price_category_desc" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.PRICE_CATEGORY" readOnly="true"/>
                                        <!-- <a:checkBox name="department_approve_flag" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.DEPARTMENT_APPROVE_FLAG" readOnly="true" width="152"/> -->
                                        <div id="quotation_title_id">
                                            <a:hBox labelWidth="118">
                                                <a:lov name="quotation_title" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_QUOTATION_TITLE" readOnly="true"/>
                                            </a:hBox>
                                        </div>
                                        <div id="logistics_quotation_desc_id">
                                            <a:hBox labelWidth="112">
                                                <a:comboBox name="logistics_quotation_desc" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_QUOTATION_TITLE" readOnly="true"/>
                                            </a:hBox>
                                        </div>
                                    </a:hBox>
                                </a:vBox>
                            </a:accordion>
                        </a:accordions>
                    </a:accordionPanel>
                </a:hBox>
                <a:hBox>
                    <a:accordionPanel id="pur5120_accordion_dim_cost" height="240" showIcon="true" singleMode="false" width="900">
                        <a:accordions>
                            <a:accordion prompt="PUR_RFX_HEADERS.COST_INFO" selected="false">
                                <a:vBox>
                                    <a:hBox labelWidth="120">
                                        <a:numberField name="total_costs" allowDecimals="true" allowFormat="false" allowNegative="false" bindTarget="pur52402_rfx_headers_ds" decimalPrecision="2" prompt="PUR_RFX_HEADERS.TOTAL_COSTS" width="152"/>
                                        <a:numberField name="account_total_costs" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.ACCOUNT_TOTAL_COSTS" readOnly="true"/>
                                    </a:hBox>
                                    <a:hBox labelWidth="120">
                                        <a:comboBox name="exceed_cost_flag_desc" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.EXCEED_COST_FLAG" readOnly="true" width="152"/>
                                        <a:numberField name="exceed_money" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.EXCEED_MONEY" readOnly="true"/>
                                        <a:textField name="exceed_percent" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.EXCEED_PERCENT" readOnly="true"/>
                                    </a:hBox>
                                    <a:hBox labelWidth="120">
                                        <a:textField name="cost_comments" bindTarget="pur52402_rfx_headers_ds" prompt="PUR_RFX_HEADERS.COST_COMMENTS" width="707"/>
                                    </a:hBox>
                                    <a:hBox labelWidth="120" style="margin-left:60px;" width="500">
                                        <a:upload fileType="*.*" pkvalue="${/parameter/@rfx_header_id}" sourcetype="PUR_RFX_COST_ATTACHMENT" text="ATM.UPLOAD_ATTACHMENT"/>
                                    </a:hBox>
                                </a:vBox>
                            </a:accordion>
                        </a:accordions>
                    </a:accordionPanel>
                </a:hBox>
            </a:vBox>
            <a:tabPanel height="570" marginWidth="130">
                <a:tabs>
                    <a:tab prompt="PUR5120.ITEM_DETIAL" width="120">
                        <a:grid id="pur52402_rfx_ln_items_grid" bindTarget="pur52402_rfx_ln_items_ds" height="250" marginWidth="160" navBar="true">
                            <a:toolBar>
                                <!-- <a:button type="save"/> -->
                                <!--  <a:button click="pur52402_rfxLnItems_saveFun" text="PROMPT.SAVE">
                                    <i class="icon-footer-grid-save"/>
                                </a:button> -->
                                <a:button click="pur52402_rfxLnItems_saveFun" text="PROMPT.SAVE">
                                    <i class="icon-footer-grid-save"/>
                                </a:button>
                                <a:button type="excel"/>
                            </a:toolBar>
                            <a:columns>
                                <a:column name="line_num" align="center" prompt="PUR_RFX_LN_ITEMS.LINE_NUM" width="30"/>
                                <a:column name="suggested_operation_desc" align="left" editor="pur52402_suggested_operation_desc_cmb" prompt="PUR_RFX_LN_ITEMS.SUGGESTED_OPERATION" width="50"/>
                                <a:column name="inv_organization_desc" align="left" prompt="PUR_RFX_LN_ITEMS.INV_ORGANIZATION_ID" width="60"/>
                                <a:column name="item_code" align="left" prompt="PUR_RFX_LN_ITEMS.ITEM_CODE" renderer="pur5240_item_renderer" width="70"/>
                                <a:column name="item_desc" align="left" prompt="PUR_RFX_LN_ITEMS.ITEM_DESC" width="290"/>
                                <a:column name="item_category_desc" align="left" prompt="PUR_RFX_LN_ITEMS.ITEM_CATEGORY_ID" width="60"/>
                                <a:column name="quantity" align="left" prompt="PUR_RFX_LN_ITEMS.QUANTITY" width="40"/>
                                <a:column name="kw_customer" align="center" prompt="PUR_RFX_KW_CUSTOMER" width="50"/>
                                <a:column name="pur_uom_desc" align="left" prompt="PUR_RFX.PUR_UOM_DESC" width="40"/>
                                <a:column name="uom_desc" align="left" prompt="PUR_RFX_LN_ITEMS.UOM_CODE" width="40"/>
                                <a:column name="need_by_date" align="left" prompt="PUR_RFX_LN_ITEMS.NEED_BY_DATE" width="60"/>
                                <a:column name="cost_price" align="left" editor="pur52402_suggested_operation_desc_nb" prompt="PUR_RFX_LN_ITEMS.COST_PRICE" width="40"/>
                                <a:column name="cost_total_price" align="left" editor="pur52402_suggested_operation_desc_nb" prompt="PUR_RFX_LN_ITEMS.COST_TOTAL_PRICE" width="40"/>
                                <a:column name="feedback_range" align="left" prompt="PUR_RFX_LN_ITEMS.FEEDBACK_RANGE" width="40"/>
                                <!-- <a:column name="item_note" align="left" prompt="PUR_RFX_LN_ITEMS.ITEM_NOTE" renderer="pur52402_rfxLnItemsGridRenderer" width="80"/>
                                <a:column name="item_parameter_config" align="left" prompt="PUR_RFX_LN_ITEMS.ITEM_PARAMETER_CONFIG" width="60"/> -->
                                <a:column name="req_number" prompt="PUR_RFX_LN_ITEMS.REQ_NUMBER" width="70"/>
                                <a:column name="req_line_num" prompt="PUR_RFX_LN_ITEMS.REQ_LINE_NUMBER" width="60"/>
                                <!-- <a:column name="work_num" prompt="PUR_RFX_LN_ITEMS.WORK_NUMBER" width="70"/>
                                <a:column name="bom_num" prompt="PUR_RFX_LN_ITEMS.BOM_NUMBER" width="70"/> -->
                                <!-- <a:column name="atm_flag_item" align="center" renderer="pur5240_item_attach_download" width="12"/> -->
                                <a:column name="item_attachment" align="left" prompt="PUR_RFX_LN_ITEMS.REQ_ATTACHMENT" renderer="pur5240_item_attach_download1" width="50"/>
                                <!-- <a:column name="pur_req_num" align="left" prompt="PUR_RFX_LN_ITEMS.PUR_REQ_NUM" width="60"/> -->
                            </a:columns>
                            <a:editors>
                                <a:comboBox id="pur52402_suggested_operation_desc_cmb"/>
                                <a:numberField id="pur52402_suggested_operation_desc_nb"/>
                            </a:editors>
                            <a:events>
                                <a:event name="render" handler="pur52402_rfx_ln_items_grid_render"/>
                            </a:events>
                        </a:grid>
                        <a:grid id="pur52402_rfx_check_price_vendors_detail_grid" autoAppend="false" bindTarget="pur52402_rfx_check_price_vendors_detail_ds" height="250" marginWidth="160">
                            <a:toolBar>
                                <a:button type="excel"/>
                            </a:toolBar>
                            <a:columns>
                                <a:column name="suggested_flag" align="center" editor="pur52402_vendors_suggested_flag_ck" prompt="PUR_RFX_FEEDBACK_LINES.SUGGESTED_FLAG" width="40"/>
                                <a:column name="last_valid_fb_retail_price" align="right" prompt="PUR_RFX_FEEDBACK_LINES.LAST_QUOTE" renderer="last_valid_fb_retail_price_render" width="40"/>
                                <a:column name="floating_percentage" align="center" prompt="PUR_RFX_FEEDBACK_LINES.FLOAT_PRICE" width="40"/>
                                <a:column name="super_cost" align="center" prompt="PUR_RFX_FEEDBACK_LINES.SUPER_COST" width="40"/>
                                <a:column name="suggested_note" align="left" editor="pur52402_vendors_suggested_note_tf" prompt="PUR_RFX_FEEDBACK_LINES.SUGGESTED_NOTE" width="70"/>
                                <a:column name="vendor_code" align="left" prompt="PUR_RFX_FEEDBACK_HEADERS.VENDOR_CODE" width="70"/>
                                <a:column name="vendor_desc" align="left" prompt="PUR_RFX_FEEDBACK_HEADERS.VENDOR_DESC" width="100"/>
                                <a:column name="last_bid_price" align="right" prompt="PUR_RFX_FEEDBACK_LINES.LAST_BID_PRICE" renderer="pur52202_lastBid_vender_view" width="60"/>
                                <a:column name="valid_fb_retail_price" align="right" prompt="PUR_RFX_FEEDBACK_LINES.VALID_FB_RETAIL_PRICE" renderer="pur52402_formatNumber_render" width="40"/>
                                <a:column name="blank_range" align="right" prompt="变化幅度" width="40"/>
                                <a:column name="min_tax_amount" align="right" prompt="历史价格" width="40"/>
                                <a:column name="blank_site_name" align="right" prompt="历史供应商" width="40"/>
                                <a:column name="vendor_range" align="right" prompt="同供应商对比" width="40"/>
                                <a:column name="attribute1" align="right" prompt="英寸报价" renderer="pur52402_formatNumber_render" width="40"/>
                                <a:column name="net_price" align="right" prompt="ACP_BILL.NET_PRICE" renderer="pur52402_rfxCheckPriceVendorsDetailGridRendererNetPrice" width="50"/>
                                <a:column name="net_amount" align="right" prompt="ERP_AP_PAYMENT_CHECKS.BASE_AMOUNT" renderer="pur52402_rfxCheckPriceVendorsDetailGridRendererNetPrice" width="50"/>
                                <a:column name="tax_amount" align="right" prompt="CON_CONTRACT_HEADERS.TAX_AMOUNT" renderer="pur52402_rfxCheckPriceVendorsDetailGridRendererNetPrice" width="50"/>
                                <a:column name="total_amounts" align="right" prompt="BID_ENTRUSTMENT_LN_ITEMS.AMOUNT" renderer="pur52402_rfxCheckPriceVendorsDetailGridRendererNetPrice" width="50"/>
                                <a:column name="ladder_quotation" align="center" prompt="SACPUR5210.LADDER_QUOTES" renderer="pur52202_rfxLadderQuotationRenderViewFun" width="50"/>
                                <a:column name="feedback_expiry_date_from" align="center" prompt="PUR_RFX_FEEDBACK_LINES.FEEDBACK_EXPIRY_DATE_FROM" sortable="true" width="60"/>
                                <a:column name="feedback_expiry_date_to" align="center" prompt="PUR_RFX_FEEDBACK_LINES.FEEDBACK_EXPIRY_DATE_TO" sortable="true" width="60"/>
                                <a:column name="price_batch_quantity" align="right" editorFunction="pur52402_rfxCheckPriceVendorsDetailGridEditorFunction" prompt="PUR_RFX_FEEDBACK_LINES.PRICE_BATCH_QUANTITY" width="40"/>
                                <a:column name="quote_quantity" align="right" prompt="PUR_RFX_FEEDBACK_LINES.QUOTE_QUANTITY" width="50"/>
                                <!-- <a:column name="vendor_quote" align="center" prompt="PUR_RFX_QUOTE_TITLE" renderer="pur5240_rfxFeedbackVendorQuote_renderFun" width="50"/> -->
                                <a:column name="allotted_quantity" align="right" editorFunction="pur52402_rfxCheckPriceVendorsDetailGridEditorFunction" prompt="PUR_RFX_FEEDBACK_LINES.ALLOTTED_QUANTITY" width="40"/>
                                <a:column name="allotted_percentage" align="center" editorFunction="pur52402_rfxCheckPriceVendorsDetailGridEditorFunction" prompt="PUR_RFX_FEEDBACK_LINES.ALLOCATION_RATIO" width="50"/>
                                <a:column name="valid_fb_total_price" align="right" prompt="PUR_RFX_FEEDBACK_LINES.VALID_FB_TOTAL_PRICE" renderer="pur52402_formatNumber_render" width="40"/>
                                <a:column name="tax_included_flag" prompt="PUR_RFX_LN_ITEMS.TAX_INCLUDED_FLAG" width="40"/>
                                <a:column name="tax_type_rate" align="right" prompt="PUR_RFX_LN_ITEMS.TAX_RATE" width="40"/>
                                <a:column name="promised_date" align="left" prompt="PUR_RFX_FEEDBACK_LINES.PROMISED_DATE" width="60"/>
                                <a:column name="delivery_cycle" align="left" prompt="PUR_RFX_LN_ITEMS.DELIVERY_CYCLE" sortable="true" width="60"/>
                                <a:column name="valid_fb_reason" align="left" prompt="PUR_RFX_FEEDBACK_LINES.VALID_FB_REASON" sortable="true" width="100"/>
                                <a:column name="untax_price" align="right" prompt="ACP_INVOICE_LINES.NET_AMOUNT" width="40"/>
                                <a:column name="brand" align="center" prompt="MTL_SYSTEM_ITEMS.BRAND" width="60"/>
                                <a:column name="place_of_product" align="center" prompt="RFX.PLACE_OF_PRODUCT"/>
                                <a:column name="spec" align="center" prompt="RFX.SPEC"/>
                                <a:column name="pur_cycle" align="center" prompt="RFX.PUR_CYCLE"/>
                                <a:column name="warranty_period" align="center" prompt="RFX.PLACE_OF_PRODUCT"/>
                                <a:column name="place_of_delivery" align="center" prompt="PUR_RFX_HEADERS.PLACE_OF_DELIVERY"/>
                                <!-- <a:column name="valid_fb_wholesale_price" align="right" prompt="PUR_RFX_FEEDBACK_LINES.VALID_FB_WHOLESALE_PRICE" renderer="pur52402_formatNumber_render" width="50"/> -->
                                <!-- <a:column name="min_package" align="right" prompt="PUR_RFX_FEEDBACK_LINES.MIN_PACKAGE" width="50"/>
                                <a:column name="trans_cost_flag" align="center" prompt="SACPUR5210.WHETHER_SHIPPING_IS_INCLUDED" width="50"/>
                                <a:column name="trans_cost" align="right" prompt="PUR_RFX_FEEDBACK_LINES.TRANS_COST" width="50"/> -->
                                <a:column name="feedback_time" align="left" prompt="PUR_RFX_FEEDBACK_LINES.FEEDBACK_TIME" width="100"/>
                                <!-- <a:column name="atm_flag_feedback" align="center" renderer="pur5240_vendor_attach_Download" width="12"/> -->
                                <a:column name="attachment_download" align="left" prompt="PUR_RFX_LINE_VENDOR.ATTACHMENT" renderer="pur5240_vendor_attach_Download1" width="50"/>
                                <a:column name="feedback_history" align="center" prompt="PUR_RFX_FEEDBACK_LINES.FEEDBACK_HISTORY" renderer="pur52402_rfx_feedback_records_render" width="50"/>
                            </a:columns>
                            <a:editors>
                                <a:checkBox id="pur52402_vendors_suggested_flag_ck" checkedValue="Y" uncheckedValue="N"/>
                                <a:textField id="pur52402_vendors_suggested_note_tf"/>
                                <a:numberField id="pur52402_vendors_suggested_note_nf" allowDecimals="true" allowFormat="false" allowNegative="false" decimalPrecision="2"/>
                            </a:editors>
                            <a:events>
                                <a:event name="render" handler="pur52402_check_price_vendors_detail_grid_render"/>
                            </a:events>
                        </a:grid>
                    </a:tab>
                    <a:tab prompt="PUR_VENDORS.VENDOR" width="120">
                        <a:grid id="pur52402_vendors_grid" bindTarget="pur52402_rfx_ln_vendors_ds" height="250" marginWidth="160" navBar="true">
                            <a:toolBar>
                                <a:button type="save"/>
                            </a:toolBar>
                            <a:columns>
                                <a:column name="proposed_flag" align="center" editor="pur52402_rfx_ln_vendors_proposed_flag_cb" prompt="PUR_RFX_LN_VENDORS.PROPOSED_FLAG" width="50"/>
                                <a:column name="suggested_note" align="left" editor="pur52402_rfx_ln_vendors_suggested_note_tf" prompt="PUR_RFX_FEEDBACK_LINES.SUGGESTED_NOTE" width="100"/>
                                <a:column name="vendor_code" align="left" prompt="PUR_RFX_LN_VENDORS.VENDOR_CODE" width="70"/>
                                <a:column name="vendor_desc" align="left" prompt="PUR_RFX_LN_VENDORS.VENDOR_DESC" width="100"/>
                                <a:column name="bidding_score" align="right" prompt="BID_ENTRUSTMENT_HEADERS.BID_SCORE_SUM" renderer="bid6020BiddingDocmDetailRender" width="40"/>
                                <a:column name="feedback_counts" align="right" prompt="PUR_RFX_FEEDBACK_HEADERS.FEEDBACK_COUNTS" width="50"/>
                                <a:column name="total_amount" align="right" prompt="PUR_RFX_FEEDBACK_HEADERS.TOTAL_AMOUNT" renderer="Aurora.formatMoney" width="50"/>
                                <a:column name="suggested_total_amount" align="right" prompt="PUR_RFX_LINE_VENDOR.SUGGESTED_TOTAL_AMOUNT" renderer="Aurora.formatMoney" width="50"/>
                                <a:column name="contact_person" align="left" prompt="PUR_RFX_LN_VENDORS.CONTACT_PERSON" width="50"/>
                                <a:column name="contact_mobile" align="left" prompt="PUR_RFX_LN_VENDORS.CONTACT_MOBILE" width="60"/>
                                <a:column name="e_mail" align="left" prompt="PUR_RFX_LN_VENDORS.E_MAIL" width="80"/>
                                <a:column name="attachment_download" align="left" prompt="FND_ATM_LINES.ATM_DOWNLOAD" renderer="pur52402_vendors_grid_renderer" width="60"/>
                                <a:column name="is_cen_pur_desc" align="left" editor="pur51302_vendor_is_cen_cbx" prompt="是否集采" width="100"/>
                                <a:column name="source_type_desc" align="left" editor="pur51302_vendor_is_cen_cbx" prompt="PUR_RFX_HEADERS.SOURCE_TYPE" width="100"/>
                                <a:column name="vendor_site_code" align="center" editor="pur51302_vendor_site_lov" prompt="供应商地地点" width="100"/>
                            </a:columns>
                            <a:editors>
                                <a:checkBox id="pur52402_rfx_ln_vendors_proposed_flag_cb" checkedValue="Y" uncheckedValue="N"/>
                                <a:textField id="pur52402_rfx_ln_vendors_suggested_note_tf"/>
                                <a:comboBox id="pur51302_vendor_is_cen_cbx"/>
                                <a:lov id="pur51302_vendor_site_lov"/>
                            </a:editors>
                        </a:grid>
                        <a:grid id="pur52402_rfx_feedback_items_bargain_grid" bindTarget="pur52402_rfx_check_price_items_detail_ds" height="250" marginWidth="160" navBar="true">
                            <a:toolBar>
                                <a:button type="save"/>
                            </a:toolBar>
                            <a:columns>
                                <a:column name="line_num" align="center" prompt="PUR_RFX_LN_ITEMS.LINE_NUM" width="30"/>
                                <a:column name="suggested_flag" align="center" prompt="PUR_RFX_FEEDBACK_LINES.SUGGESTED_FLAG" width="40"/>
                                <a:column name="item_code" align="left" prompt="PUR_RFX_FEEDBACK_LINES.ITEM_CODE" width="60"/>
                                <a:column name="item_desc" align="left" prompt="PUR_RFX_FEEDBACK_LINES.ITEM_DESC" width="290"/>
                                <a:column name="price_batch_quantity" align="right" editor="pur52402_rfx_check_price_items_detail_editor" prompt="PUR_RFX_FEEDBACK_LINES.PRICE_BATCH_QUANTITY" width="40"/>
                                <a:column name="valid_fb_retail_price" align="right" prompt="PUR_RFX_FEEDBACK_LINES.VALID_FB_RETAIL_PRICE" renderer="pur52402_formatNumber_render" width="40"/>
                                <a:column name="net_price" align="right" prompt="ACP_BILL.NET_PRICE" renderer="pur52402_rfxFeedbackItemsBargainGridRendererNetPrice" width="50"/>
                                <a:column name="net_amount" align="right" prompt="ERP_AP_PAYMENT_CHECKS.BASE_AMOUNT" renderer="pur52402_rfxFeedbackItemsBargainGridRendererNetPrice" width="50"/>
                                <a:column name="tax_amount" align="right" prompt="CON_CONTRACT_HEADERS.TAX_AMOUNT" renderer="pur52402_rfxFeedbackItemsBargainGridRendererNetPrice" width="50"/>
                                <a:column name="total_amounts" align="right" prompt="BID_ENTRUSTMENT_LN_ITEMS.AMOUNT" renderer="pur52402_rfxFeedbackItemsBargainGridRendererNetPrice" width="50"/>
                                <a:column name="quantity" align="right" prompt="PUR_RFX_LN_ITEMS.QUANTITY" width="40"/>
                                <a:column name="allotted_quantity" align="right" prompt="PUR_RFX_FEEDBACK_LINES.ALLOTTED_QUANTITY" width="40"/>
                                <a:column name="valid_fb_total_price" align="right" prompt="PUR_RFX_FEEDBACK_LINES.VALID_FB_TOTAL_PRICE" width="40"/>
                                <a:column name="tax_included_flag" prompt="PUR_RFX_LN_ITEMS.TAX_INCLUDED_FLAG" width="40"/>
                                <a:column name="tax_type_rate" align="right" prompt="PUR_RFX_LN_ITEMS.TAX_RATE" width="40"/>
                                <a:column name="ladder_quotation" align="center" prompt="SACPUR5210.LADDER_QUOTES" renderer="pur52202_rfxLadderQuotationRenderViewFun" width="50"/>
                                <a:column name="feedback_expiry_date_from" align="center" prompt="PUR_RFX_FEEDBACK_LINES.FEEDBACK_EXPIRY_DATE_FROM" sortable="true" width="60"/>
                                <a:column name="feedback_expiry_date_to" align="center" prompt="PUR_RFX_FEEDBACK_LINES.FEEDBACK_EXPIRY_DATE_TO" sortable="true" width="60"/>
                                <a:column name="quote_quantity" align="right" prompt="PUR_RFX_FEEDBACK_LINES.QUOTE_QUANTITY" width="50"/>
                                <a:column name="vendor_quote" align="center" prompt="PUR_RFX_QUOTE_TITLE" renderer="pur5240_rfxFeedbackVendorQuote_renderFun" width="50"/>
                                <a:column name="uom_desc" align="left" prompt="PUR_RFX_FEEDBACK_LINES.UOM_CODE" width="40"/>
                                <a:column name="untax_price" align="right" prompt="ACP_INVOICE_LINES.NET_AMOUNT" width="40"/>
                                <a:column name="brand" align="center" prompt="MTL_SYSTEM_ITEMS.BRAND" width="60"/>
                                <a:column name="place_of_product" align="center" prompt="RFX.PLACE_OF_PRODUCT"/>
                                <a:column name="spec" align="center" prompt="RFX.SPEC"/>
                                <a:column name="pur_cycle" align="center" prompt="RFX.PUR_CYCLE"/>
                                <a:column name="warranty_period" align="center" prompt="RFX.PLACE_OF_PRODUCT"/>
                                <a:column name="place_of_delivery" align="center" prompt="PUR_RFX_HEADERS.PLACE_OF_DELIVERY"/>
                                <a:column name="current_fb_reason" align="left" prompt="PUR_RFX_FEEDBACK_LINES.CURRENT_FB_REASON" width="80"/>
                                <a:column name="currency_desc" align="center" prompt="PUR_RFX_HEADERS.CURRENCY_CODE"/>
                                <a:column name="exchange_rate" align="center" prompt="PUR_RFX_HEADERS.EXCHANGE_RATE"/>
                                <!-- <a:column name="promised_date" align="left" prompt="PUR_RFX_FEEDBACK_LINES.PROMISED_DATE" width="60"/> -->
                                <a:column name="delivery_cycle" align="left" prompt="PUR_RFX_LN_ITEMS.DELIVERY_CYCLE" sortable="true" width="50"/>
                                <a:column name="valid_fb_reason" align="left" prompt="PUR_RFX_FEEDBACK_LINES.VALID_FB_REASON" sortable="true" width="80"/>
                                <a:column name="valid_fb_wholesale_price" align="right" prompt="PUR_RFX_FEEDBACK_LINES.VALID_FB_WHOLESALE_PRICE" renderer="pur52402_formatNumber_render" width="50"/>
                                <!-- <a:column name="trans_cost_flag" align="center" prompt="SACPUR5210.WHETHER_SHIPPING_IS_INCLUDED" width="50"/>
                                <a:column name="trans_cost" align="right" prompt="PUR_RFX_FEEDBACK_LINES.TRANS_COST" width="50"/> -->
                                <a:column name="feedback_time" align="left" prompt="PUR_RFX_FEEDBACK_LINES.FEEDBACK_TIME" width="100"/>
                                <!--  <a:column name="atm_flag_feedback" align="center" renderer="pur5240_item_attach_download" width="12"/> -->
                                <a:column name="item_attachment" align="left" prompt="PUR_RFX_LN_ITEMS.REQ_ATTACHMENT" renderer="pur5240_item_attach_download2" width="50"/>
                                <a:column name="feedback_history" align="center" prompt="PUR_RFX_FEEDBACK_LINES.FEEDBACK_HISTORY" renderer="pur52402_rfx_feedback_records_render" width="50"/>
                            </a:columns>
                            <a:editors>
                                <a:textField id="pur52402_rfx_check_price_items_detail_editor"/>
                            </a:editors>
                        </a:grid>
                    </a:tab>
                    <a:tab prompt="PUR7110.ALL_QUOTATION_DETAILS" width="120">
                        <a:grid id="pur52402_rfx_feedback_all" autoAppend="false" bindTarget="pur52402_rfx_feedback_all_ds" height="500" marginWidth="160" navBar="true">
                            <a:toolBar>
                                <!-- <a:button type="save"/> -->
                                <a:button click="pur52402_rfx_feedback_all_saveFun" text="PROMPT.SAVE"><![CDATA[
                                ]]></a:button>
                                <font style="margin-top:5px;"><![CDATA[${l:PUR_RFX_LN_ITEMS.SUGGESTED_OPERATION}：]]></font>
                                <a:comboBox name="lowest_flag_desc" bindTarget="pur5240_rfx_lowest_ds" style="margin-top:5px;" width="100">
                                    <a:events>
                                        <a:event name="change" handler="lowest_flag_desc_change"/>
                                    </a:events>
                                </a:comboBox>
                                <!-- add by liumeiqi 16049 at 2018-05-08 in T2390 周黑鸭二开-->
                                <a:button id="zhy_pur52402_ratio_but" click="zhy_pur52402_allocation_ratio_Fun" text="数量分配参考"/>
                            </a:toolBar>
                            <a:columns>
                                <a:column name="item_category_desc" align="left" prompt="PUR_RFX_LN_ITEMS.ITEM_CATEGORY_ID" width="60"/>
                                <a:column name="item_code" align="left" prompt="PUR_RFX_LN_ITEMS.ITEM_CODE" renderer="pur5240_item_renderer" width="100"/>
                                <a:column name="item_desc" align="left" prompt="PUR_RFX_LN_ITEMS.ITEM_DESC" width="290"/>
                                <a:column name="uom_desc" align="left" prompt="PUR_RFX_LN_ITEMS.UOM_CODE" width="40"/>
                                <a:column name="line_num" align="center" prompt="PUR_RFX_LN_ITEMS.LINE_NUM" width="30"/>
                                <a:column name="suggested_operation_desc" align="left" editor="pur52402_suggested_operation_desc_cmb2" prompt="PUR_RFX_LN_ITEMS.SUGGESTED_OPERATION" width="50"/>
                                <a:column name="vendor_code" align="left" prompt="PUR_RFX_FEEDBACK_HEADERS.VENDOR_CODE" width="70"/>
                                <a:column name="vendor_desc" align="left" prompt="PUR_RFX_FEEDBACK_HEADERS.VENDOR_DESC" width="100"/>
                                <a:column name="last_bid_price" align="right" prompt="PUR_RFX_FEEDBACK_LINES.LAST_BID_PRICE" renderer="pur52202_lastBid_vender_view" width="60"/>
                                <a:column name="valid_fb_retail_price" align="right" prompt="PUR_RFX_FEEDBACK_LINES.VALID_FB_RETAIL_PRICE" renderer="pur52402_formatNumber_render" width="40"/>
                                <a:column name="net_price" align="right" prompt="ACP_BILL.NET_PRICE" renderer="pur52402_rfxFeedbackAllRendererNetPrice" width="50"/>
                                <a:column name="net_amount" align="right" prompt="ERP_AP_PAYMENT_CHECKS.BASE_AMOUNT" renderer="pur52402_rfxFeedbackAllRendererNetPrice" width="50"/>
                                <a:column name="tax_amount" align="right" prompt="CON_CONTRACT_HEADERS.TAX_AMOUNT" renderer="pur52402_rfxFeedbackAllRendererNetPrice" width="50"/>
                                <a:column name="total_amounts" align="right" prompt="BID_ENTRUSTMENT_LN_ITEMS.AMOUNT" renderer="pur52402_rfxFeedbackAllRendererNetPrice" width="50"/>
                                <a:column name="suggested_flag" align="center" editor="pur52402_vendors_suggested_flag_ck2" prompt="PUR_RFX_FEEDBACK_LINES.SUGGESTED_FLAG" width="40"/>
                                <a:column name="tax_included_flag" prompt="PUR_RFX_LN_ITEMS.TAX_INCLUDED_FLAG" width="40"/>
                                <a:column name="tax_type_code" align="left" prompt="PUR5620.THE_TAX_CODE" width="40"/>
                                <a:column name="tax_type_rate" align="right" prompt="PUR_RFX_LN_ITEMS.TAX_RATE" width="40"/>
                                <a:column name="quotation_detail" align="center" prompt="PUR_RFX_QUOTATION_TITLE" renderer="pur52402_rfxLnItemsGridRenderer" width="50"/>
                                <a:column name="ladder_inquiry_desc" align="right" prompt="PUR_RFX_LADDER_INQUIRY_TYPE" width="40"/>
                                <a:column name="ladder_quotation" align="center" prompt="SACPUR5210.LADDER_QUOTES" renderer="pur52202_rfxLadderQuotationRenderViewFun" width="50"/>
                                <a:column name="quote_quantity" align="right" prompt="PUR_RFX_FEEDBACK_LINES.QUOTE_QUANTITY" width="50"/>
                                <a:column name="vendor_quote" align="center" prompt="PUR_RFX_QUOTE_TITLE" renderer="pur5240_rfxFeedbackVendorQuote_renderFun" width="50"/>
                                <a:column name="last_valid_fb_retail_price" align="right" prompt="PUR_RFX_FEEDBACK_LINES.LAST_QUOTE" renderer="last_valid_fb_retail_price_render" width="40"/>
                                <a:column name="floating_percentage" align="center" prompt="PUR_RFX_FEEDBACK_LINES.FLOAT_PRICE" width="40"/>
                                <a:column name="cost_price" align="left" editor="pur52402_suggested_operation_desc_nb2" prompt="PUR_RFX_LN_ITEMS.COST_PRICE" width="40"/>
                                <a:column name="cost_total_price" align="left" editor="pur52402_suggested_operation_desc_nb2" prompt="PUR_RFX_LN_ITEMS.COST_TOTAL_PRICE" width="40"/>
                                <a:column name="super_cost" align="center" prompt="PUR_RFX_FEEDBACK_LINES.SUPER_COST" width="40"/>
                                <a:column name="suggested_note" align="left" editor="pur52402_vendors_suggested_note_tf2" prompt="PUR_RFX_FEEDBACK_LINES.SUGGESTED_NOTE" width="70"/>
                                <a:column name="price_batch_quantity" align="right" editorFunction="pur52402_rfxCheckPriceVendorsDetailGridEditorFunction2" prompt="PUR_RFX_FEEDBACK_LINES.PRICE_BATCH_QUANTITY" width="40"/>
                                <a:column name="feedback_expiry_date_from" align="center" prompt="PUR_RFX_FEEDBACK_LINES.FEEDBACK_EXPIRY_DATE_FROM" sortable="true" width="60"/>
                                <a:column name="feedback_expiry_date_to" align="center" prompt="PUR_RFX_FEEDBACK_LINES.FEEDBACK_EXPIRY_DATE_TO" sortable="true" width="60"/>
                                <a:column name="allotted_quantity" align="right" editorFunction="pur52402_rfxCheckPriceVendorsDetailGridEditorFunction2" prompt="PUR_RFX_FEEDBACK_LINES.ALLOTTED_QUANTITY" width="40"/>
                                <a:column name="allotted_percentage" align="center" editorFunction="pur52402_rfxCheckPriceVendorsDetailGridEditorFunction2" prompt="PUR_RFX_FEEDBACK_LINES.ALLOCATION_RATIO" width="50"/>
                                <a:column name="need_by_date" align="left" editor="pur52402_datePicker" prompt="PUR_RFX_LN_ITEMS.NEED_BY_DATE" renderer="Aurora.formatDate" width="60"/>
                                <a:column name="promised_date" align="left" prompt="PUR_RFX_FEEDBACK_LINES.PROMISED_DATE" width="60"/>
                                <a:column name="delivery_cycle" align="left" prompt="PUR_RFX_LN_ITEMS.DELIVERY_CYCLE" width="60"/>
                                <a:column name="valid_fb_reason" align="left" prompt="PUR_RFX_FEEDBACK_LINES.VALID_FB_REASON" width="100"/>
                                <!-- <a:column name="valid_fb_wholesale_price" align="right" prompt="PUR_RFX_FEEDBACK_LINES.VALID_FB_WHOLESALE_PRICE" renderer="pur52202_formatNumber_render" width="60"/>
                                <a:column name="min_purchase" align="right" prompt="PUR_RFX_FEEDBACK_LINES.MIN_PURCHASE" width="50"/>
                                <a:column name="min_package" align="right" prompt="PUR_RFX_FEEDBACK_LINES.MIN_PACKAGE" width="50"/> -->
                                <!-- <a:column name="trans_cost_flag" align="center" prompt="SACPUR5210.WHETHER_SHIPPING_IS_INCLUDED" width="50"/>
                                <a:column name="trans_cost" align="right" prompt="PUR_RFX_FEEDBACK_LINES.TRANS_COST" width="50"/> -->
                                <a:column name="feedback_time" align="left" prompt="PUR_RFX_FEEDBACK_LINES.FEEDBACK_TIME" width="100"/>
                                <!-- <a:column name="feedback_range" align="left" prompt="PUR_RFX_LN_ITEMS.FEEDBACK_RANGE" width="40"/>
                                <a:column name="item_note" align="left" prompt="PUR_RFX_LN_ITEMS.ITEM_NOTE" renderer="pur52402_rfxLnItemsGridRenderer" width="80"/>
                                <a:column name="item_parameter_config" align="left" prompt="PUR_RFX_LN_ITEMS.ITEM_PARAMETER_CONFIG" width="60"/> -->
                                <a:column name="quantity" align="left" prompt="PUR_RFX_LN_ITEMS.QUANTITY" width="40"/>
                                <a:column name="inv_organization_desc" align="left" prompt="PUR_RFX_LN_ITEMS.INV_ORGANIZATION_ID" width="70"/>
                                <a:column name="req_number" prompt="PUR_RFX_LN_ITEMS.REQ_NUMBER" width="70"/>
                                <a:column name="req_line_num" prompt="PUR_RFX_LN_ITEMS.REQ_LINE_NUMBER" width="60"/>
                                <!-- <a:column name="work_num" prompt="PUR_RFX_LN_ITEMS.WORK_NUMBER" width="70"/>
                                <a:column name="bom_num" prompt="PUR_RFX_LN_ITEMS.BOM_NUMBER" width="70"/> -->
                                <a:column name="item_attachment" align="left" prompt="PUR_RFX_LN_ITEMS.REQ_ATTACHMENT" renderer="pur5240_item_attach_download" width="60"/>
                                <a:column name="attachment_download" align="left" prompt="PUR_RFX_LINE_VENDOR.ATTACHMENT" renderer="pur5240_vendor_attach_Download" width="60"/>
                            </a:columns>
                            <a:editors>
                                <a:datePicker id="pur52402_datePicker"/>
                                <a:comboBox id="pur52402_suggested_operation_desc_cmb2"/>
                                <a:numberField id="pur52402_suggested_operation_desc_nb2"/>
                                <a:checkBox id="pur52402_vendors_suggested_flag_ck2" checkedValue="Y" uncheckedValue="N"/>
                                <a:textField id="pur52402_vendors_suggested_note_tf2"/>
                                <a:numberField id="pur52402_vendors_suggested_note_nf2" allowDecimals="true" allowFormat="false" allowNegative="false" decimalPrecision="2"/>
                            </a:editors>
                            <a:events>
                                <a:event name="render" handler="pur52402_rfx_feedback_all_grid_render"/>
                            </a:events>
                        </a:grid>
                    </a:tab>
                    <a:tab prompt="PUR5120.ATM_FILE_LIST" width="120">
                        <a:grid id="pur71101_atm_grid" bindTarget="pur71101_rfx_ln_attachments" height="350" marginWidth="40" navBar="true" showRowNumber="true">
                            <a:columns>
                                <a:column name="atm_desc" align="center" prompt="FND_ATM_LINES.ATM_DESC" width="100"/>
                                <a:column name="upload_user_name" align="center" prompt="FND_ATM_LINES.UPLOAD_USER_NAME" width="100"/>
                                <a:column align="center" prompt="FND_ATM_LINES.ATM_DOWNLOAD" renderer="pur5130_rfxDetailAttachment_renderFun" width="100"/>
                            </a:columns>
                        </a:grid>
                    </a:tab>
                    <a:tab id="test_structure_tab_id" prompt="测试架" width="120">
                        <a:grid bindTarget="pur52402_rfx_feedback_all_ds" height="350" marginWidth="140">
                            <a:columns>
                                <a:column name="line_num" align="right" prompt="行号" width="30"/>
                                <a:column name="item_category_desc" align="left" prompt="物品分类" width="100"/>
                                <a:column name="item_code" align="left" prompt="物料编码" width="70"/>
                                <a:column name="item_desc" align="left" prompt="物料描述" width="90"/>
                                <a:column name="test_type" align="left" prompt="测试架类型" width="40"/>
                                <a:column name="test_point_two_five" align="left" prompt="探针0.25mm" width="50"/>
                                <a:column name="test_point_two" align="left" prompt="探针0.2mm" width="50"/>
                                <a:column name="test_point_fifteen" align="left" prompt="探针0.15mm" width="50"/>
                                <a:column name="test_point_twelve" align="left" prompt="探针0.12mm" width="50"/>
                                <a:column name="test_point_one" align="left" prompt="探针0.1mm" width="50"/>
                                <a:column name="test_point_zero_nine" align="left" prompt="探针0.09mm" width="50"/>
                                <a:column name="test_needle_double_zero" align="left" prompt="00针" width="50"/>
                                <a:column name="test_needle_zero_pound" align="left" prompt="0#针" width="50"/>
                                <a:column name="test_needle_one_pound" align="left" prompt="1#针" width="50"/>
                                <a:column name="test_needle_two_pound" align="left" prompt="2#针" width="50"/>
                                <a:column name="test_cylinder" align="left" prompt="气缸" width="50"/>
                                <a:column name="test_float" align="left" prompt="点数" width="50"/>
                                <a:column name="test_pcs" align="left" prompt="pcs数" width="50"/>
                                <a:column name="mini_pound_desc" align="left" prompt="最小探针" width="50"/>
                                <a:column name="test_shelf_length" align="left" prompt="测试架长" width="50"/>
                                <a:column name="test_shelf_width" align="left" prompt="测试架宽" width="50"/>
                                <a:column name="horn_plate_pcs" align="left" prompt="牛角板PCS数" width="50"/>
                                <a:column name="counter_pcs" align="left" prompt="计数器PCS数" width="50"/>
                                <a:column name="test_ccd" align="left" prompt="CCD对位" width="50"/>
                            </a:columns>
                        </a:grid>
                    </a:tab>
                </a:tabs>
            </a:tabPanel>
        </a:screenBody>
        <div id="pur5240_rfx_item_price_contain">
            <a:screen-include screen="modules/pur/PUR5240/pur_rfx_check_item_detail.screen"/>
        </div>
        <flex-segment dataset="pur52402_rfx_ln_items_ds" grid="pur52402_rfx_ln_items_grid" headerIdPath="/parameter/@rfx_header_id" headerTableName="PUR_RFX_HEADERS" pageType="query" templateFieldName="template_id" type="grid_expanded"/>
        <flex-segment dataset="pur52402_rfx_check_price_vendors_detail_ds" grid="pur52402_rfx_check_price_vendors_detail_grid" headerIdPath="/parameter/@rfx_header_id" headerTableName="PUR_RFX_HEADERS" pageType="query" templateFieldName="template_id" type="grid_expanded"/>
        <flex-segment dataset="pur52402_rfx_check_price_items_detail_ds" grid="pur52402_rfx_feedback_items_bargain_grid" headerIdPath="/parameter/@rfx_header_id" headerTableName="PUR_RFX_HEADERS" pageType="query" templateFieldName="template_id" type="grid_expanded"/>
        <script><![CDATA[
          function init() {
                  var type_po_item  = '${/parameter/@type_po_item}' ;
                  console.log('type_po_item == ' +type_po_item);
                 if (type_po_item == 'undefined'|| type_po_item == '' || type_po_item == 'NO_SELECT'){
                  diaplayTab("test_structure_tab_id");
                 } }
        
            //初始化
            Aurora.onReady(function() {
                pur5240_init();
                init_button();
                init();
            });
        ]]></script>
    </a:view>
</a:screen>
