<?xml version="1.0" encoding="UTF-8"?>
<!--
    $Author: wanghaitao2658  
    $Date: 2014-7-31 下午14:37:10  
    $Revision: 1.0  
    $Purpose: 登录后首页，默认页面
-->
<a:screen xmlns:a="http://www.aurora-framework.org/application" trace="true">
    <a:init-procedure>
        <a:model-query model="sys.sys_user_login_info" rootPath="wfl1001_user_info_rs"/>
        <a:model-query defaultWhereClause="(message_type=&apos;PLATFORM&apos; or message_type=&apos;SYSTEM&apos;)" model="sys.sys_user_messages_count" rootPath="wfl1001_user_message_count"/>
        <a:model-query defaultWhereClause="message_type=&apos;BUSINESS&apos;" model="sys.sys_user_messages_count" rootPath="wfl1001_user_message_count_business"/>
        <a:model-query model="sys.sys_schedule_types" rootPath="wfl1001_user_schedule_types"/>
        <a:model-query model="sys.sys_schedule_messages" rootPath="wfl1001_user_schedule_messages"/>
    </a:init-procedure>
    <a:view>
        <a:link id="wfl1001_create_bulletin_browsing_history_link" model="blt.BLT1010.create_bulletin_browsing_history" modelaction="execute"/>
        <a:link id="wfl1001_blt_bulletin_detail_link" url="${/request/@context_path}/modules/blt/BLT1010/blt_bulletin_details_no_login.screen"/>
        <a:link id="wfl1001_sys_user_message_read_link" model="sys.sys_user_messages" modelaction="update"/>
        <a:link id="wfl1001_sys_user_message_delete_link" model="sys.sys_user_messages" modelaction="execute"/>
        <a:link id="wfl1001_sys_schedule_message_insert_link" model="sys.sys_schedule_messages" modelaction="insert"/>
        <a:link id="wfl1001_sys_schedule_message_delete_link" model="sys.sys_schedule_messages" modelaction="delete"/>
        <a:link id="wfl1001_sys_schedule_message_detail_link" url="${/request/@context_path}/modules/wfl/WFL1001/sys_schedule_message_detail.screen"/>
        <a:link id="wfl1001_fnd_user_todo_list_insert_link" model="fnd.fnd_user_todo_list" modelaction="insert"/>
        <a:link id="wfl1001_fnd_user_todo_list_update_link" model="fnd.fnd_user_todo_list" modelaction="update"/>
        <a:link id="wfl1001_fnd_user_todo_list_delete_link" model="fnd.fnd_user_todo_list" modelaction="delete"/>
        <style><![CDATA[
            html,body {
                padding:0px;
                margin:0px;
                color: #000000; 
                font-family: Microsoft YaHei;
                font-size:12px;
                padding: 0px !important;
                margin: 0px !important;
                line-height: 1.5;
                font-style: normal; 
                font-weight: normal;
            }      
            
            .showmore {
                height:35px;
                cursor:pointer;
                tetx-align:center;
            }  
            .showmore .handle{
                display: block;
                height: 35px;
                text-align: center;
                color: #909090;
                font-size: 14px;
                text-decoration: none;
                line-height: 35px;
                margin: 0px 10px 0px 10px;
                background-color: #f9f9f9;
            }  
            .showmore .handle:hover{text-decoration:none;background:#e6e6e6;}  
            
            .checkbox input[type=checkbox]:checked + label::after  {
                font-family: 'FontAwesome';
                content: <i class="fa fa-check"/>;
            }
        ]]></style>
        <script><![CDATA[
            /*
             * 全局参数定义
             */
            var g_userMessagesList_pageNo = 1;
            var g_userMessagesList_pageNoSystem = 1;
            var g_userMessagesList_pageNoBusiness = 1;
            var g_userMessagesList_pageSize = '${/model/wfl1001_user_message_count/record/@user_message_page_size}'; //默认显示消息数量
            var g_userMessagesListUserMessagePage = '${/model/wfl1001_user_message_count/record/@user_message_page}'; //用户消息的页面数量 = 全部消息/默认显示消息数量
            var g_userMessagesListUserMessagePageSystem = '${/model/wfl1001_user_message_count_system/record/@user_message_page}'; //用户消息的页面数量 = 全部消息/默认显示消息数量
            var g_userMessagesListUserMessagePageBusiness = '${/model/wfl1001_user_message_count_business/record/@user_message_page}'; //用户消息的页面数量 = 全部消息/默认显示消息数量
            /*
             * END
             */
             
            //全局参数初始化
            function wfl1001_globalParameterInit(){
                g_userMessagesList_pageNo = 1;
                g_userMessagesList_pageNoSystem = 1;
                g_userMessagesList_pageNoBusiness = 1;
                g_userMessagesList_pageSize = '${/model/wfl1001_user_message_count/record/@user_message_page_size}'; //默认显示消息数量
                g_userMessagesListUserMessagePage = '${/model/wfl1001_user_message_count/record/@user_message_page}'; //用户消息的页面数量 = 全部消息/默认显示消息数量
                g_userMessagesListUserMessagePageSystem = '${/model/wfl1001_user_message_count_system/record/@user_message_page}'; //用户消息的页面数量 = 全部消息/默认显示消息数量
                g_userMessagesListUserMessagePageBusiness = '${/model/wfl1001_user_message_count_business/record/@user_message_page}'; //用户消息的页面数量 = 全部消息/默认显示消息数量
            }
            
            function wfl1001_sidebarOnclick(screen, prompt, flag) {
                $('mainTab').openTab(screen, prompt);
            }
            
            //用户消息列表初始化
            function wfl1001_userMessagesListViewInit(pageNum) {
                if (g_userMessagesListUserMessagePage == pageNum || g_userMessagesListUserMessagePage == 0 ) {
                    document.getElementById("wfl1001_userMessagesListShowMoreDiv").style.display = "none";
                }else{
                    document.getElementById("wfl1001_userMessagesListShowMoreDiv").style.display = "block";
                }
            }
            
            //用户消息列表初始化
            function wfl1001_userMessagesListViewInitBusiness(pageNum) {
                if (g_userMessagesListUserMessagePageBusiness == pageNum || g_userMessagesListUserMessagePageBusiness == 0 ) {
                    document.getElementById("wfl1001_userMessagesListShowMoreDivBusiness").style.display = "none";
                }else{
                    document.getElementById("wfl1001_userMessagesListShowMoreDivBusiness").style.display = "block";
                }
            }
            
            //用户消息列表DIV渲染方法
            function wfl1001_userMessagesListDivView(dataset) {
                var records = dataset.getAll();
                var nextpagehtml = '';
                for (i = 0;i < records.length;i++) {
                    var record = records[i];
                    var count = i + (g_userMessagesList_pageSize * g_userMessagesList_pageNo); //顺序号
                    nextpagehtml += '<div id="user_msg_info_div_' + count + '" class="notification-messages info">';
                    nextpagehtml += '<div class="msg-close">';
                    nextpagehtml += '<a class="remove fa fa-times" onclick="javascript:wfl1001_deleteUserMessage(this,' + count + ',' + record.get('message_id') + ',\'' + record.get('source_table') + '\');"></a>';
                    nextpagehtml += '</div>';
                    nextpagehtml += '<div class="message-wrapper" onclick="javascript:wfl1001_showUserMessageListDetail(' + count + ',' + record.get('message_id') + ',' + record.get('source_id') + ',\'' + record.get('source_table') + '\',\'' + record.get('url') + '\',\'' + record.get('read_flag') + '\');">';
                    if (record.get('read_flag') == 'N') {
                        nextpagehtml += '<div id="user_msg_head_div_' + count + '" class="heading" style="font-weight:bold;"> ● ' + record.get('message_title') + '</div>';
                        nextpagehtml += '<div id="user_msg_desc_div_' + count + '" class="description" style="font-weight:bold;">' + record.get('message_content') + '</div>';
                    } else {
                        nextpagehtml += '<div id="user_msg_head_div_' + count + '" class="heading" style="font-weight:normal;">' + record.get('message_title') + '</div>';
                        nextpagehtml += '<div id="user_msg_desc_div_' + count + '" class="description" style="font-weight:normal;">' + record.get('message_content') + '</div>';
                    }
                    nextpagehtml += '</div>';
                    nextpagehtml += '<div class="date">' + record.get('message_time_desc') + '</div>';
                    nextpagehtml += '</div>';
                }
                document.getElementById("user_messages_list_div_view").innerHTML += nextpagehtml;
            }
            
            //用户消息列表DIV渲染方法
            function wfl1001_userMessagesListDivViewBusiness(dataset) {
                var records = dataset.getAll();
                var nextpagehtml = '';
                for (i = 0;i < records.length;i++) {
                    var record = records[i];
                    var count = i + (g_userMessagesList_pageSize * g_userMessagesList_pageNoBusiness); //顺序号
                    nextpagehtml += '<div id="user_msg_info_div_' + count + '" class="notification-messages info">';
                    nextpagehtml += '<div class="msg-close">';
                    nextpagehtml += '<a class="remove fa fa-times" onclick="javascript:wfl1001_deleteUserMessage(this,' + count + ',' + record.get('message_id') + ',\'' + record.get('source_table') + '\');"></a>';
                    nextpagehtml += '</div>';
                    nextpagehtml += '<div class="message-wrapper" onclick="javascript:wfl1001_showUserMessageListDetail(' + count + ',' + record.get('message_id') + ',' + record.get('source_id') + ',\'' + record.get('source_table') + '\',\'' + record.get('url') + '\',\'' + record.get('read_flag') + '\');">';
                    if (record.get('read_flag') == 'N') {
                        nextpagehtml += '<div id="user_msg_head_div_' + count + '" class="heading" style="font-weight:bold;"> ● ' + record.get('message_title') + '</div>';
                        nextpagehtml += '<div id="user_msg_desc_div_' + count + '" class="description" style="font-weight:bold;">' + record.get('message_content') + '</div>';
                    } else {
                        nextpagehtml += '<div id="user_msg_head_div_' + count + '" class="heading" style="font-weight:normal;">' + record.get('message_title') + '</div>';
                        nextpagehtml += '<div id="user_msg_desc_div_' + count + '" class="description" style="font-weight:normal;">' + record.get('message_content') + '</div>';
                    }
                    nextpagehtml += '</div>';
                    nextpagehtml += '<div class="date">' + record.get('message_time_desc') + '</div>';
                    nextpagehtml += '</div>';
                }
                document.getElementById("user_messages_list_div_viewBusiness").innerHTML += nextpagehtml;
            }
            
            function wfl1001_userMessagesListDsLoad(dataset) {
                wfl1001_userMessagesListDivView(dataset);
            }
            
            function wfl1001_userMessagesListDsLoadBusiness(dataset) {
                wfl1001_userMessagesListDivViewBusiness(dataset);
            }
            
            function wfl1001_userMessageListRefresh() {
                document.getElementById("user_messages_list_div_view").innerHTML = '';
                wfl1001_globalParameterInit();
                wfl1001_userMessagesListViewInit(1);
                $('wfl1001_user_messages_list_ds').query();
            }
            
            function wfl1001_userMessageListRefreshBusiness() {
                document.getElementById("user_messages_list_div_viewBusiness").innerHTML = '';
                wfl1001_globalParameterInit();
                wfl1001_userMessagesListViewInitBusiness(1);
                $('wfl1001_user_messages_list_ds_business').query();
            }
            
            function wfl1001_showMoreUserMessagesList() {
                ++g_userMessagesList_pageNo;
                $('wfl1001_user_messages_list_show_more_ds').setQueryParameter('page_size', g_userMessagesList_pageSize);
                $('wfl1001_user_messages_list_show_more_ds').setQueryParameter('page_num', g_userMessagesList_pageNo);
                $('wfl1001_user_messages_list_show_more_ds').setQueryParameter('_fetchall', false);
                $('wfl1001_user_messages_list_show_more_ds').query();
                wfl1001_userMessagesListViewInit(g_userMessagesList_pageNo);
            }
            
            function wfl1001_showMoreUserMessagesListBusiness() {
                ++g_userMessagesList_pageNoBusiness;
                $('wfl1001_user_messages_list_show_more_ds_business').setQueryParameter('pagesize', g_userMessagesList_pageSize);
                $('wfl1001_user_messages_list_show_more_ds_business').setQueryParameter('page_num', g_userMessagesList_pageNoBusiness);
                $('wfl1001_user_messages_list_show_more_ds_business').setQueryParameter('_fetchall', false);
                $('wfl1001_user_messages_list_show_more_ds_business').query();
                wfl1001_userMessagesListViewInitBusiness(g_userMessagesList_pageNoBusiness);
            }
            
            function wfl1001_userMessagesListShowMoreDsLoad() {
                var dataset = $('wfl1001_user_messages_list_show_more_ds');
                var records = dataset.getAll();
                if (records.length == 0) {
                    document.getElementById("wfl1001_userMessagesListShowMoreDiv").style.display = "none";
                }
                var pageOffset = (g_userMessagesList_pageNo - 1) * g_userMessagesList_pageSize + 1;
                wfl1001_userMessagesListDivView(dataset);
            }
            
            
            function wfl1001_userMessagesListShowMoreDsLoadBusiness() {
                var dataset = $('wfl1001_user_messages_list_show_more_ds_business');
                var records = dataset.getAll();
                if (records.length == 0) {
                    document.getElementById("wfl1001_userMessagesListShowMoreDivBusiness").style.display = "none";
                }
                var pageOffset = (g_userMessagesList_pageNoBusiness - 1) * g_userMessagesList_pageSize + 1;
                wfl1001_userMessagesListDivViewBusiness(dataset);
            }
            
            function wfl1001_showBltBulletinDetail(id, url) {
                Aurora.request({
                    url: $('wfl1001_create_bulletin_browsing_history_link').getUrl(),
                    para: {
                        'bulletin_id': id
                    },
                    success: function() {
                        var new_url = $('wfl1001_blt_bulletin_detail_link').getUrl() + '?bulletin_id=' + id;
                        window.open(new_url, 'WFL_USER_MESSAGE_SHOW_WINDOWS', "left=" + 0 + ",top=" + 0 + ",width=" + (window.screen.availWidth - 10) + ",height=" + (window.screen.availHeight - 50) + ",status=0,toolbar=0,menubar=0,location=0,scrollbars=" + 1 + ",resizable=" + 1, false);
                    },
                    scope: this
                });
            }
            
            function wfl1001_showUserMessageDetail(id, url) {
                var new_url = url + id;
                window.open(new_url, 'WFL_USER_MESSAGE_SHOW_WINDOWS', "left=" + 0 + ",top=" + 0 + ",width=" + (window.screen.availWidth - 10) + ",height=" + (window.screen.availHeight - 50) + ",status=0,toolbar=0,menubar=0,location=0,scrollbars=" + 1 + ",resizable=" + 1, false);
            }
            
            function wfl1001_showUserMessageListDetail(count, message_id, source_id, source_table, url, read_flag) {
                Aurora.request({
                    url: $('wfl1001_sys_user_message_read_link').getUrl(),
                    para: {
                        'message_id': message_id
                    },
                    success: function() {
                        //点击“未读”的用户消息后，修改用户消息的样式，去掉标题和内容的加粗样式
                        if(read_flag == 'N'){
                            var head = document.getElementById('user_msg_head_div_' + count);
                            var head_innerText = head.innerText;
                            head.setAttribute("style", "font-weight:normal;");
                            if(head_innerText.indexOf('●') != -1){
                                head.innerText = head_innerText.substr(1, head_innerText.length);
                            }
                            var desc = document.getElementById('user_msg_desc_div_' + count);
                            desc.setAttribute("style", "font-weight:normal;");
                        }
                        
                        //打开用户消息
                        if (url != 'URL_NULL') {
                            if (source_table == 'BLT_BULLETIN') {
                                wfl1001_showBltBulletinDetail(source_id, url);
                            } else {
                                wfl1001_showUserMessageDetail(source_id, url);
                            }
                        }
                    },
                    scope: this
                });
            }
            
            function wfl1001_deleteUserMessage(thisDiv, count, message_id, source_table) {
                Aurora.request({
                    url: $('wfl1001_sys_user_message_delete_link').getUrl(),
                    para: {
                        'message_id': message_id,
                        'source_table': source_table
                    },
                    success: function() {
                        //thisDiv.parentNode.parentNode.removeChild(thisDiv.parentNode);
                        document.getElementById('user_msg_info_div_' + count).style.display = "none";
                    },
                    scope: this
                });
            }
            
            // function wfl1001_createUserToDoList() {
                // var todo_content = document.getElementById("todo_content").value;
                // if (todo_content && !Ext.isEmpty(todo_content)) {
                    // Aurora.request({
                        // url: $('wfl1001_fnd_user_todo_list_insert_link').getUrl(),
                        // para: {
                            // 'content': todo_content
                        // },
                        // success: function() {
                            // document.getElementById("todo_content").value = '';
                            // document.getElementById("todo_content").focus();
                            // wfl1001_userTodoListRefresh();
                        // },
                        // scope: this
                    // });
                // }
            // }
            
            // function wfl1001_deleteUserToDoList(thisDiv, count, todo_list_id) {
                // if (todo_content && !Ext.isEmpty(todo_content)) {
                    // Aurora.request({
                        // url: $('wfl1001_fnd_user_todo_list_delete_link').getUrl(),
                        // para: {
                            // 'todo_list_id': todo_list_id
                        // },
                        // success: function() {
                            // document.getElementById('user_todo_list_' + count).style.display = "none";
                        // },
                        // scope: this
                    // });
                // }
            // }
            
            // function wfl1001_doneUserToDoList(todo_list_rownum, todo_list_id) {
                // var chk_todo = document.getElementById('chk_todo_' + todo_list_rownum);
                // var label = chk_todo.labels[0];
                // var done_flag;
                // if (chk_todo.checked) {
                    // label.className = "done";
                    // done_flag = 'Y';
                // } else {
                    // label.className = "";
                    // done_flag = 'N';
                // }
                // Aurora.request({
                    // url: $('wfl1001_fnd_user_todo_list_update_link').getUrl(),
                    // para: {
                        // 'todo_list_id': todo_list_id,
                        // 'done_flag': done_flag
                    // },
                    // success: function() {
                        
                    // },
                    // scope: this
                // });
            // }
            
            // function wfl1001_userTodoListDivView(ds) {
                // var records = ds.getAll();
                // var todolist_html = '';
                // for (var i = 0;i < records.length;i++) {
                    // var record = records[i];
                    // var count = i; //顺序号
                    // todolist_html += '<div id="user_todo_list_' + count + '" class="row-fluid">';
                    // todolist_html += '<div class="checkbox check-success">';
                    // if (record.get('done_flag') == 'Y') {
                        // todolist_html += '<input id="chk_todo_' + record.get('todo_list_rownum') + '" checked="checked" class="todo-list" type="checkbox" onclick="javascript:wfl1001_doneUserToDoList(' + record.get('todo_list_rownum') + ',' + record.get('todo_list_id') + ');"/>';
                        // todolist_html += '<label class="done" for="chk_todo_' + record.get('todo_list_rownum') + '">' + record.get('content') + '</label>';
                    // } else {
                        // todolist_html += '<input id="chk_todo_' + record.get('todo_list_rownum') + '" class="todo-list" type="checkbox" onclick="javascript:wfl1001_doneUserToDoList(' + record.get('todo_list_rownum') + ',' + record.get('todo_list_id') + ');"/>';
                        // todolist_html += '<label for="chk_todo_' + record.get('todo_list_rownum') + '">' + record.get('content') + '</label>';
                    // }
                    // todolist_html += '<a class="remove fa fa-times" onclick="javascript:wfl1001_deleteUserToDoList(this,' + count + ',' + record.get('todo_list_id') + ');"></a>';
                    // todolist_html += '</div>';
                    // todolist_html += '</div>';
                // }
                // document.getElementById("user_todo_list_div_view").innerHTML += todolist_html;
            // }
            
            // function wfl1001_userTodoListDsLoad(dataset) {
                // wfl1001_userTodoListDivView(dataset);
            // }
            
            // function wfl1001_userTodoListRefresh() {
                // document.getElementById("user_todo_list_div_view").innerHTML = '';
                // $('wfl1001_user_todo_list_ds').query();
            // }
            
            
        ]]></script>
        <a:dataSets>
            <a:dataSet id="wfl1001_user_messages_list_ds" autoQuery="true" model="sys.sys_user_messages_default" queryUrl="${/request/@context_path}/autocrud/sys.sys_user_messages_default/query?message_type=PLATFORM">
                <a:events>
                    <a:event name="load" handler="wfl1001_userMessagesListDsLoad"/>
                </a:events>
            </a:dataSet>
            <a:dataSet id="wfl1001_user_messages_list_ds_business" autoQuery="true" model="sys.sys_user_messages_default" queryUrl="${/request/@context_path}/autocrud/sys.sys_user_messages_default/query?message_type=BUSINESS">
                <a:events>
                    <a:event name="load" handler="wfl1001_userMessagesListDsLoadBusiness"/>
                </a:events>
            </a:dataSet>
            <a:dataSet id="wfl1001_user_messages_list_show_more_ds" model="sys.sys_user_messages" queryUrl="${/request/@context_path}/autocrud/sys.sys_user_messages/query?message_type=PLATFORM">
                <a:events>
                    <a:event name="load" handler="wfl1001_userMessagesListShowMoreDsLoad"/>
                </a:events>
            </a:dataSet>
            <a:dataSet id="wfl1001_user_messages_list_show_more_ds_business" model="sys.sys_user_messages" queryUrl="${/request/@context_path}/autocrud/sys.sys_user_messages/query?message_type=BUSINESS">
                <a:events>
                    <a:event name="load" handler="wfl1001_userMessagesListShowMoreDsLoadBusiness"/>
                </a:events>
            </a:dataSet>
            <!-- <a:dataSet id="wfl1001_user_todo_list_ds" autoQuery="true" model="fnd.fnd_user_todo_list">
                <a:events>
                    <a:event name="load" handler="wfl1001_userTodoListDsLoad"/>
                </a:events>
            </a:dataSet> -->
            <a:dataSet id="wfl1001_user_schedule_messages_ds">
                <a:datas dataSource="/model/wfl1001_user_schedule_messages"/>
            </a:dataSet>
        </a:dataSets>
        <div class="page-container row">
            <div id="main-menu" class="page-sidebar">
                <div class="user-info-wrapper hidden-sm hidden-xs margin-10 p-b-10">
                    <div class="p-r-10" style="float: left;">
                        <img alt="" class="img-thumbnail img-circle" height="60" src="${/request/@context_path}/images/headIcon.jpg" width="60"/>
                    </div>
                    <div class="user-info p-t-10">
                        <div class="username"><![CDATA[${/model/wfl1001_user_info_rs/record/@user_name}]]></div>
                        <div>
                            <a style="font-size: 17px;"><![CDATA[账户信息 >]]></a>
                        </div>
                    </div>
                </div>
                <div class="user-info-friend">
                    <div class="user-info-friend-item">
                        <center>
                            <p>
                                <h3 class="text-info"><![CDATA[0]]></h3>
                            </p>
                            <p style="font-size: 14px;"><![CDATA[关注]]></p>
                        </center>
                    </div>
                    <div class="user-info-friend-item">
                        <center>
                            <p>
                                <h3 class="text-info"><![CDATA[0]]></h3>
                            </p>
                            <p style="font-size: 14px;"><![CDATA[粉丝]]></p>
                        </center>
                    </div>
                    <div class="user-info-friend-item">
                        <center>
                            <p>
                                <h3 class="text-info"><![CDATA[0]]></h3>
                            </p>
                            <p style="font-size: 14px;"><![CDATA[动态]]></p>
                        </center>
                    </div>
                </div>
                <div class="sidebar-title">
                    <span><![CDATA[常用功能]]></span>
                </div>
                <ul>
                    <li class="">
                        <a href="javascript:wfl1001_sidebarOnclick(&apos;modules/fnd/FND7010/fnd_message.screen?function_code=FND7010&apos;,&apos;站内信&apos;);">
                            <i class="fa fa-envelope"/>
                            <span class="title"><![CDATA[站内信]]></span>
                        </a>
                    </li>
                    <li class="">
                        <a href="javascript:wfl1001_sidebarOnclick(&apos;update_self_password.screen&apos;,&apos;密码修改&apos;);">
                            <i class="fa fa-lock"/>
                            <span class="title"><![CDATA[密码修改]]></span>
                        </a>
                    </li>
                </ul>
            </div>
            <div class="page-content">
                <div class="content">
                    <div id="container">
                        <div>
                            <div>
                                <div class="row p-t-20">
                                    <div class="col-md-6">
                                        <div class="tiles-header"><![CDATA[
                                    	系统消息
                                    	]]></div>
                                        <div class="scroller" data-always-visible="1" data-height="450px" style="background-color: #fff">
                                            <div class="tiles white">
                                                <div class="tiles-body">
                                                    <div class="controller">
                                                        <a class="reload" href="javascript:wfl1001_userMessageListRefresh();"/>
                                                    </div>
                                                    <div id="user_messages_list_div_view" style="padding-top: 20px"/>
                                                </div>
                                                <div id="wfl1001_userMessagesListShowMoreDiv" class="showmore">
                                                    <a class="handle" href="javascript:wfl1001_showMoreUserMessagesList()"><![CDATA[点击显示更多]]></a>
                                                </div>
                                                <div class="row spacing-bottom"/>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="tiles-header"><![CDATA[
                                    	行业资讯
                                    	]]></div>
                                                <div class="scroller" data-always-visible="1" data-height="450px" style="background-color: #fff">
                                                    <div class="tiles white">
                                                        <div class="tiles-body">
                                                            <div class="controller">
                                                                <a class="reload" href="javascript:wfl1001_userMessageListRefreshBusiness();"/>
                                                            </div>
                                                            <div id="user_messages_list_div_viewBusiness" style="padding-top: 20px"/>
                                                        </div>
                                                        <div id="wfl1001_userMessagesListShowMoreDivBusiness" class="showmore">
                                                            <a class="handle" href="javascript:wfl1001_showMoreUserMessagesListBusiness()"><![CDATA[点击显示更多]]></a>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- <div class="col-md-12">
                                                <div class="scroller" data-always-visible="1" data-height="175px">
                                                    <div class="tiles white">
                                                        <div class="tiles-body">
                                                            <div class="controller">
                                                                <a class="reload" href="javascript:wfl1001_userMessageListRefreshBusiness();"/>
                                                            </div>
                                                            <div id="user_messages_list_div_viewSystem"/>
                                                        </div>
                                                        <div id="wfl1001_userMessagesListShowMoreDivBusiness" class="showmore">
                                                            <a class="handle" href="javascript:wfl1001_showMoreUserMessagesListBusiness()"><![CDATA[点击显示更多]]></a>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div> -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row p-t-20">
                            <div class="col-md-12">
                                <div class="row">
                                    <div class="col-md-9">
                                        <div class="panel">
                                            <div class="panel-body">
                                                <div id="calendar"/>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="panel panel-default">
                                            <div class="panel-heading">
                                                <h4 class="panel-title"><![CDATA[日程类型]]></h4>
                                            </div>
                                            <!-- 默认日程类型 -->
                                            <div class="external-events-trash">
                                                <div class="panel-body">
                                                    <div class="external-events">
                                                        <a:freeMarker><![CDATA[
                                                        <#if model.getObject("/model/wfl1001_user_schedule_types").getChilds()??>
                                                            <#list model.getObject("/model/wfl1001_user_schedule_types").getChilds() as user_schedule_types>
                                                                <div class="${user_schedule_types.getString('schedule_color')}" event-db-id="${user_schedule_types.getString('schedule_type_id')}">${user_schedule_types.getString('schedule_type_name')}
                                                                </div>
                                                            </#list>         
                                                        </#if>
                                                        ]]></a:freeMarker>
                                                        <!-- <div class="bg-green"><![CDATA[处理单据]]></div>
                                                        <div class="bg-danger"><![CDATA[会议]]></div>
                                                        <div class="bg-info"><![CDATA[会议]]></div>
                                                        <div class="bg-warning"><![CDATA[会议]]></div>
                                                        <div class="bg-inverse"><![CDATA[会议]]></div> -->
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="panel panel-default">
                                            <div class="panel-heading">
                                                <h3 class="panel-title"><![CDATA[添加类型]]></h3>
                                            </div>
                                            <div class="panel-body">
                                                <div class="input-group mb">
                                                    <input class="form-control external-event-name" placeholder="类型名称" type="text"/>
                                                    <div class="input-group-btn">
                                                        <button class="btn btn-default external-event-add-btn" type="button"><![CDATA[添加]]></button>
                                                    </div>
                                                </div>
                                                <p class="text-muted">
                                                    <small><![CDATA[选择颜色]]></small>
                                                </p>
                                                <ul class="list-inline external-event-color-selector">
                                                    <li class="p0">
                                                        <a class="point point-danger point-xl selected" href="#"/>
                                                    </li>
                                                    <li class="p0">
                                                        <a class="point point-primary point-xl" href="#"/>
                                                    </li>
                                                    <li class="p0">
                                                        <a class="point point-info point-xl" href="#"/>
                                                    </li>
                                                    <li class="p0">
                                                        <a class="point point-success point-xl" href="#"/>
                                                    </li>
                                                    <li class="p0">
                                                        <a class="point point-warning point-xl" href="#"/>
                                                    </li>
                                                    <li class="p0">
                                                        <a class="point point-green point-xl" href="#"/>
                                                    </li>
                                                    <li class="p0">
                                                        <a class="point point-pink point-xl" href="#"/>
                                                    </li>
                                                    <li class="p0">
                                                        <a class="point point-inverse point-xl" href="#"/>
                                                    </li>
                                                    <li class="p0">
                                                        <a class="point point-purple point-xl" href="#"/>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script><![CDATA[
            // wfl1001_userMessagesListViewInit(1);
            // wfl1001_userMessagesListViewInitSystem(1);
            // wfl1001_userMessagesListViewInitBusiness(1);
            var userScheduleMessages = $('wfl1001_user_schedule_messages_ds').getAll();
            
            function colorPicker(s) {
                var r;
                switch (s) {
                case 'PRIMARY':
                    r = '#3c8dbc';
                    break;
                case 'RED':
                    r = '#f56954';
                    break;
                }
                return r;
            }
            
            function userEventInsert(o) {
            
                if (!Aurora.isEmpty(o.id)) {
                    Aurora.request({
                        url: $('wfl1001_sys_schedule_message_insert_link').getUrl(),
                        para: {
                            'schedule_type_id': o.id,
                            'message_title': o.title,
                            'all_day': true,
                            'start_year': o.start.format('YYYY'),
                            'start_month': o.start.format('MM') - 1,
                            'start_day': o.start.format('DD'),
                            'start_hour': o.start.format('hh'),
                            'start_minute': o.start.format('mm')
                        },
                        success: function() {},
                        scope: this
                    });
                }
            }
            
            function userEventDelete(id) {
                if (!Aurora.isEmpty(id)) {
                    Aurora.request({
                        url: $('wfl1001_sys_schedule_message_delete_link').getUrl(),
                        para: {
                            'schedule_message_id': id
                        },
                        success: function() {},
                        scope: this
                    });
                }
            }
            
            jQuery('.scroller').each(function() {
                jQuery(this).slimScroll({
                    size: '7px',
                    color: '#a1b2bd',
                    height: jQuery(this).attr("data-height"),
                    alwaysVisible: (jQuery(this).attr("data-always-visible") == "1" ? true : false),
                    railVisible: (jQuery(this).attr("data-rail-visible") == "1" ? true : false),
                    disableFadeOut: true
                });
            });
            
            (function($, window, document) {
            
                if (!$.fn.fullCalendar) {
                    return;
                }
            
                var ExternalEvent = function(elements) {
            
                        if (!elements) {
                            return;
                        }
            
                        elements.each(function() {
                            var $this = jQuery(this);
                            var calendarEventObject = {
                                id: $this.attr("event-db-id"),
                                title: $.trim($this.text())
                            };
            
                            $this.data('calendarEventObject', calendarEventObject);
            
                            $this.draggable({
                                zIndex: 1070,
                                revert: true,
                                revertDuration: 0
                            });
            
                        });
                    };
            
                function initCalendar(calElement, events) {
            
                    var removeAfterDrop = jQuery('#remove-after-drop');
            
                    calElement.fullCalendar({
                        header: {
                            left: 'prev,next today',
                            center: 'title',
                            right: 'month,agendaWeek,agendaDay'
                        },
                        monthNames: ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"],
                        monthNamesShort: ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"],
                        dayNames: ["周日", "周一", "周二", "周三", "周四", "周五", "周六"],
                        dayNamesShort: ["周日", "周一", "周二", "周三", "周四", "周五", "周六"],
                        today: ["今天"],
                        firstDay: 1,
                        buttonText: {
                            today: '本月',
                            month: '月',
                            week: '周',
                            day: '日',
                            prev: '上一月',
                            next: '下一月'
                        },
                        buttonIcons: {
                            prev: ' fa fa-caret-left',
                            next: ' fa fa-caret-right'
                        },
                        editable: true,
                        droppable: true,
                        eventLimit: true,
                        drop: function(date, allDay) {
                            var $this = jQuery(this),
                                originalEventObject = $this.data('calendarEventObject');
            
                            if (!originalEventObject) {
                                return;
                            }
            
                            var clonedEventObject = $.extend({}, originalEventObject);
            
                            clonedEventObject.start = date;
                            clonedEventObject.allDay = allDay;
                            clonedEventObject.backgroundColor = $this.css("background-color");
                            clonedEventObject.borderColor = $this.css("border-color");
            
                            calElement.fullCalendar('renderEvent', clonedEventObject, true);
            
                            if (removeAfterDrop.is(':checked')) {
                                $this.remove();
                            }
            
                            //将日程插入数据库
                            userEventInsert(clonedEventObject);
                        },
            
                        //点击日程，弹出明细窗口
                        eventClick: function(calEvent, jsEvent, view) {
                            var url = "${/request/@context_path}/modules/wfl/WFL1001/sys_schedule_message_detail.screen?schedule_message_id=" + calEvent.id;
                            new Aurora.Window({
                                id: 'wfl1001_sys_schedule_message_detail_window',
                                title: '日程明细',
                                url: url,
                                height: 200,
                                width: 300
                            });
                        },
                        eventDragStart: function(event, js, ui) {
                            draggingEvent = event;
                        },
                        events: events
                    });
                }
            
                function initExternalEvents(calElement) {
                    var externalEvents = jQuery('.external-events');
            
                    new ExternalEvent(externalEvents.children('div'));
            
                    var currColor = '#f6504d';
                    var eventAddBtn = jQuery('.external-event-add-btn');
                    var eventNameInput = jQuery('.external-event-name');
                    var eventColorSelector = jQuery('.external-event-color-selector .point');
            
                    jQuery('.external-events-trash').droppable({
                        accept: '.fc-event',
                        activeClass: 'active',
                        hoverClass: 'hovered',
                        tolerance: 'touch',
                        drop: function(event, ui) {
                            if (draggingEvent) {
                                //将日程从数据库删除
                                userEventDelete(draggingEvent.id);
            
                                var eid = draggingEvent.id || draggingEvent._id;
                                calElement.fullCalendar('removeEvents', eid);
                                ui.draggable.remove();
                                draggingEvent = null;
                            }
                        }
                    });
            
                    eventColorSelector.click(function(e) {
                        e.preventDefault();
                        var $this = jQuery(this);
            
                        currColor = $this.css('background-color');
                        eventColorSelector.removeClass('selected');
                        $this.addClass('selected');
                    });
            
                    eventAddBtn.click(function(e) {
                        e.preventDefault();
            
                        var val = eventNameInput.val();
                        if ($.trim(val) === '') {
                            return;
                        }
            
                        var newEvent = jQuery('<div/>').css({
                            'background-color': currColor,
                            'border-color': currColor,
                            'color': '#fff'
                        }).html(val);
            
                        externalEvents.prepend(newEvent);
                        new ExternalEvent(newEvent);
                        eventNameInput.val('');
                    });
                }
            
                function loadUserEvents() {
                    var date = new Date();
                    var d = date.getDate(),
                        m = date.getMonth(),
                        y = date.getFullYear();
            
                    var userEvents = [];
            
                    var startYear;
                    var startMonth;
                    var startDay;
                    var startHour;
                    var startMinute;
                    var endYear;
                    var endMonth;
                    var endDay;
                    var endHour;
                    var endMinute;
            
                    for (var i = 0;i < userScheduleMessages.length;i++) {
                        startYear = userScheduleMessages[i].get('start_year');
                        startMonth = userScheduleMessages[i].get('start_month');
                        startDay = userScheduleMessages[i].get('start_day');
                        startHour = userScheduleMessages[i].get('start_hour');
                        startMinute = userScheduleMessages[i].get('start_minute');
            
                        endYear = userScheduleMessages[i].get('end_year');
                        endMonth = userScheduleMessages[i].get('end_month');
                        endDay = userScheduleMessages[i].get('end_day');
                        endHour = userScheduleMessages[i].get('end_hour');
                        endMinute = userScheduleMessages[i].get('end_minute');
            
                        userEvents[i] = {
                            id: userScheduleMessages[i].get('schedule_message_id'),
                            title: userScheduleMessages[i].get('message_title'),
                            start: new Date(startYear, startMonth, startDay, startHour, startMinute)
                        };
            
                        userEvents[i].backgroundColor = colorPicker(userScheduleMessages[i].get('schedule_color'));
                        userEvents[i].borderColor = colorPicker(userScheduleMessages[i].get('schedule_color'));
            
                        if (!Aurora.isEmpty(endYear) && !Aurora.isEmpty(endMonth) && !Aurora.isEmpty(endMonth) && !Aurora.isEmpty(endHour) && !Aurora.isEmpty(endHour)) {
                            userEvents[i].end = new Date(endYear, endMonth, endDay, endHour, endMinute);
                        }
                    }
            
                    return userEvents;
            
                    // return [{
                    // title: 'All Day Event',
                    // start: new Date(y, m, 1),
                    // backgroundColor: "#f56954",
                    // //red
                    // borderColor: "#f56954" //red
                    // }, {
                    // title: 'Long Event',
                    // start: new Date(y, m, d - 5),
                    // end: new Date(y, m, d - 2),
                    // backgroundColor: "#f39c12",
                    // //yellow
                    // borderColor: "#f39c12" //yellow
                    // }, {
                    // title: 'Meeting',
                    // start: new Date(y, m, d, 10, 30),
                    // allDay: false,
                    // backgroundColor: "#0073b7",
                    // //Blue
                    // borderColor: "#0073b7" //Blue
                    // }, {
                    // title: 'Lunch',
                    // start: new Date(y, m, d, 12, 0),
                    // end: new Date(y, m, d, 14, 0),
                    // allDay: false,
                    // backgroundColor: "#00c0ef",
                    // //Info (aqua)
                    // borderColor: "#00c0ef" //Info
                    // }, {
                    // title: 'Birthday Party',
                    // start: new Date(y, m, d + 1, 19, 0),
                    // end: new Date(y, m, d + 1, 22, 30),
                    // allDay: false,
                    // backgroundColor: "#00a65a",
                    // //Success (green)
                    // borderColor: "#00a65a" //Success
                    // }, {
                    // title: 'Open Google',
                    // start: new Date(y, m, 28),
                    // end: new Date(y, m, 29),
                    // url: 'http://google.com/',
                    // backgroundColor: "#3c8dbc",
                    // //Primary (light-blue)
                    // borderColor: "#3c8dbc" //Primary
                    // }];
                }
            
                jQuery(function() {
                    var draggingEvent = null;
                    var calendar = jQuery('#calendar');
            
                    var userEvents = loadUserEvents();
                    initExternalEvents(calendar);
                    initCalendar(calendar, userEvents);
            
                });
            }(jQuery, window, document));
        ]]></script>
    </a:view>
</a:screen>
