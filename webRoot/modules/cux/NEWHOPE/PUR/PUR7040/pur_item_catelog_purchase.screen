<?xml version="1.0" encoding="UTF-8"?>
<!--
    $Author: Lin.Chen
    $Date: 2017-04-17
    $Revision: 1.0  
    $Purpose: 商品目录化选买界面
-->
<a:screen xmlns:a="http://www.aurora-framework.org/application">
    <a:init-procedure>
        <a:model-query model="cux.NEWHOPE.PUR.PUR7040.pur_init_company" rootPath="company_info"/>
    </a:init-procedure>
    <a:view>
        <a:link id="pur_catlog_item_detail_link" url="${/request/@context_path}/modules/cux/NEWHOPE/PUR/PUR7040/pur_catlog_item_preview.screen"/>
        <a:link id="pur_shopping_cart_delete_link_f" model="cux.NEWHOPE.PUR.PUR7040.pur_item_catelog_application" modelaction="delete"/>
        <link href="${/request/@context_path}/css/font-awesome-4.7.0/css/font-awesome.min.css?v=1.1" rel="stylesheet" type="text/css"/>
        <link href="${/request/@context_path}/css/pur/pur_catelog_item_purchase.css?v=3.7" rel="stylesheet"/>
        <script src="${/request/@context_path}/javascripts/jquery-3.1.0.min.js"/>
        <script><![CDATA[
            var catalog_company_id, catalog_company_name;
            var jQuery = $.noConflict();
            var btp = 1;
            var page_num = 1;
            var total_page;
            
            function get_project_name() {
                //获取当前地址
                var curWwwPath = window.document.location.href;
                //获取主机地址之后的目录如：/dev/login.screen
                var pathName = window.document.location.pathname;
                var pos = curWwwPath.indexOf(pathName);
                //获取主机地址，如：//localhost:8080
                var localhostPaht = curWwwPath.substring(0, pos);
                //获取带"/"的项目名，如：dev
                var projectName = pathName.substring(1, pathName.substr(1).indexOf('/') + 1);
            
                return projectName;
            }
            
            function init1() {
                document.getElementById('current_page_id').value = 1;
                $('pur7040_pur_item_catelog_purchase_main_ds').setQueryParameter('page_num', btp);
                $('pur7040_pur_item_catelog_purchase_main_ds').query();
                $('pur7040_count_ds').query();
            }
            //加载
            
            function getItemImg(ds) {
                var records = ds.getAll();
                var count = 0;
                var div;
            
                var div1 = document.getElementById("product-div1");
                var childs = div1.childNodes;
                for (var i = childs.length - 1;i >= 0;i--) {
                    div1.removeChild(childs[i]);
                }
                var div2 = document.getElementById("product-div2");
                var childs = div2.childNodes;
                for (var i = childs.length - 1;i >= 0;i--) {
                    div2.removeChild(childs[i]);
                }
                var div3 = document.getElementById("product-div3");
                var childs = div3.childNodes;
                for (var i = childs.length - 1;i >= 0;i--) {
                    div3.removeChild(childs[i]);
                }
                var div4 = document.getElementById("product-div4");
                var childs = div4.childNodes;
                for (var i = childs.length - 1;i >= 0;i--) {
                    div4.removeChild(childs[i]);
                }
            
                for (var i = 0;i < records.length;i++) {
                    count = records[0].get('rn');
                    // 数据插入函数
                    if (i < 5) {
                        div = document.getElementById('product-div1');
                    } else if (i >= 5 && i < 10) {
                        div = document.getElementById('product-div2');
                    } else if (i >= 10 && i < 15) {
                        div = document.getElementById('product-div3');
                    } else if (i > 15) {
                        div = document.getElementById('product-div4');
                    }
                    contentGoodsLoad(records[i], div, i);
                }
            
                document.getElementById('current_page_id').value = Math.ceil(count / 20);
            }
            
            function contentGoodsLoad(record, div, index) {
                var div_p, div_img, div_item_detail, data_source_div, item_category_div, item_name, vendor_name, price_div;
                var imgSrc = record.get('image_url');
                var projectName = get_project_name();
                if (!Aurora.isEmpty(projectName)) {
                    imgSrc = projectName + '/' + imgSrc;
                }
                var data_source = record.get('data_source');
                var item_id = record.get('item_id');
                var item_category_id = record.get('item_category_id');
                div_p = window.document.createElement('div');
                div_p.classList.add('product-div-menu');
                div_img = window.document.createElement('div');
                div_img.classList.add('product-img');
                if (data_source == 'SRM') {
                    div_img.innerHTML = '<img onerror="javascript:nofind();" onclick="javascript:ItemDescDetail(this);" id="item_picture_' + index + '" src="/' + imgSrc + '" width="180" height="200"/>';
                } else {
                    div_img.innerHTML = '<img onerror="javascript:nofind();" onclick="javascript:ItemDescDetail(this);" id="item_picture_' + index + '" src="' + imgSrc + '" width="180" height="200"/>';
                }
            
                div_item_detail = window.document.createElement('div');
                div_item_detail.id = 'item_detail_' + index;
                div_item_detail.style.display = 'none';
                div_item_detail.innerHTML = item_id;
            
                data_source_div = window.document.createElement('div');
                data_source_div.id = 'data_source_' + index;
                data_source_div.style.display = 'none';
                data_source_div.innerHTML = data_source;
            
                item_category_div = window.document.createElement('div');
                item_category_div.id = 'item_category_' + index;
                item_category_div.style.display = 'none';
                item_category_div.innerHTML = item_category_id;
            
                var item_names = record.data.item_name;
                item_name = window.document.createElement('span');
                item_name.id = 'item_name_' + index;
                item_name.setAttribute('onclick', 'javascript:ItemDescDetail(this);');
                item_name.classList.add('product-name');
                item_name.innerHTML = item_names;
                item_name.setAttribute('title', item_names);
            
                vendor_name = window.document.createElement('div');
                vendor_name.id = 'vendor_name_' + index;
                vendor_name.classList.add('product-vendor-name');
                vendor_name.innerHTML = record.data.vendor_name; //item_desc;
            
                var price = record.data.price;
                price_div = window.document.createElement('div');
                price_div.classList.add('product-price');
                if (price) {
                    price_div.innerHTML = '￥' + price;
                } else {
                    price_div.innerHTML = '${l:CUX_NEWHOME.NO_PRICE}';
                }
            
                div_p.appendChild(div_img);
                div_p.appendChild(div_item_detail);
                div_p.appendChild(data_source_div);
                div_p.appendChild(item_name);
                div_p.appendChild(item_category_div);
                div_p.appendChild(vendor_name);
                div_p.appendChild(price_div);
                div.appendChild(div_p);
            }
            //目录查询
            
            function ItemCatelogNameRender(value, record, name) {
                var catelog_udf_id = record.get('catelog_udf_id');
                return '<a href="javascript:ItemCatelogQuery(' + catelog_udf_id + ')">' + value + '</a>';
            }
            
            function ItemCatelogQuery(catelog_udf_id) {
                var ds = $('pur7040_pur_item_catelog_purchase_main_ds');
                ds.setQueryParameter('catelog_udf_id', catelog_udf_id);
                ds.query();
            }
            
            function nofind() {
                var img = event.srcElement; // 声明对象
                img.src = "/images/NoPictrue.jpg"; // 默认图片地址
                img.onerror = null; //控制不要一直跳动
            }
            
            //上一页
            
            function ItemPreviousPage() {
                btp--;
                if (btp < 1) {
                    btp = 1;
                } else {
                    search(btp);
                }
            }
            
            //下一页
            
            function ItemNextPage() {
                if (btp < total_page) {
                    btp++;
                    search(btp);
                }
            }
            
            //商品详情
            
            function ItemDescDetail(obj) {
                for (var i = 0;i < 20;i++) {
                    if ((obj.id == 'item_name_' + i) || (obj.id == 'item_picture_' + i)) {
                        var item_id = document.getElementById('item_detail_' + i).innerText;
                        var data_source = document.getElementById('data_source_' + i).innerText;
                        var item_category_id = document.getElementById('item_category_' + i).innerText;
            
                        ItemDescDetailRender(item_id, data_source, item_category_id);
                    }
                }
            }
            
            function ItemDescDetailRender(item_id, data_source, item_category_id) {
                new Aurora.Window({
                    id: 'pur_catlog_item_detail_window',
                    url: $('pur_catlog_item_detail_link').getUrl() + '?item_id=' + item_id + '&data_source=' + data_source + '&item_category_id=' + item_category_id + '&company_id=' + catalog_company_id,
                    title: '${l:CUX_NEWHOME.CATAGORY_DETAILS}',
                    fullScreen: true
                }).on('beforeclose', function() {
                    $('pur_item_catelog_shopping_cart_ds').query();
                });
            }
            
            function on_pur7040_catelog_name_ds_load(ds) {
                var records = ds.getAll();
                var length = records.length;
                var catelog_level = [];
                for (var i = 0;i < length;i++) {
                    catelog_level[i] = records[i].data.catelog_level;
                    if (catelog_level[i] === 0) {
            
                       } else if (catelog_level[i] === 1) {
                        loadCatalogLevelOne(records[i]);
                    } else if (catelog_level[i] === 2) {
                        loadCatalogLevelTwo(records[i]);
                    } else if (catelog_level[i] === 3) {
                        loadCatalogLevelThree(records[i]);
                    }
                }
                NavLiHover();
            }
            
            function on_pur7040_company_query_ds_add(dataSet, record, index) {
                if (Aurora.getCookie('catalog_company_name') != '' && Aurora.getCookie('catalog_company_name') != null && Aurora.getCookie('catalog_company_name') != 'undefined') {
                    record.set('company_full_name', Aurora.getCookie('catalog_company_name'));
                } else {
                    record.set('company_full_name', '${/model/company_info/record/@company_full_name}');
                    Aurora.setCookie('catalog_company_name', '${/model/company_info/record/@company_full_name}')
                    Aurora.setCookie('catalog_company_id', '${/model/company_info/record/@company_id}');
                }
            }
            
            function on_pur7040_company_query_ds_update( dataSet , record, name, value, oldvalue) {
                if (name == 'company_id') {
                    var ul = document.getElementById('catalog-submenu-ul');
                    ul.innerHTML = '';
                    if (record.get('company_id')) {
            
                        catalog_company_id = record.get('company_id');
                        Aurora.setCookie('catalog_company_id', catalog_company_id);
            
                        $("pur7040_catelog_name_ds").setQueryParameter('company_id', catalog_company_id);
                        $("pur7040_catelog_name_ds").query();
            
                        $("pur7040_pur_item_catelog_purchase_main_ds").setQueryParameter('company_id', catalog_company_id);
                        $("pur7040_pur_item_catelog_purchase_main_ds").query();
            
                        $("pur7040_count_ds").setQueryParameter('company_id', catalog_company_id);
                        $("pur7040_count_ds").query();
                    } else {
                        $("pur7040_pur_item_catelog_purchase_main_ds").setQueryParameter('company_id', '');
                        $("pur7040_pur_item_catelog_purchase_main_ds").query();
            
                        $("pur7040_count_ds").setQueryParameter('company_id', '');
                        $("pur7040_count_ds").query();
                    }
                } else if (name == 'company_full_name') {
                    Aurora.setCookie('catalog_company_name', value);
                }
            }
            
            // 1级分类
            
            function loadCatalogLevelOne(record) {
                var name = record.data.catelog_name;
                var catid = record.data.catelog_udf_id;
                var TagLi, TagI, TagH5, div;
                div = window.document.createElement('div');
                div.className = 'menu-item';
                div.id = 'menu-item-' + catid;
                document.getElementById('menu-content').appendChild(div);
            
                TagLi = window.document.createElement('li');
                TagLi.className = 'nav-li';
                TagLi.id = catid;
                TagH5 = window.document.createElement('h5');
                TagH5.className = 'nav-li-h5';
                TagH5.innerHTML = name;
                TagI = window.document.createElement('i');
                TagI.className = 'fa fa-angle-right';
                TagLi.appendChild(TagH5);
                TagLi.appendChild(TagI);
            
                document.getElementById('catalog-submenu-ul').appendChild(TagLi);
            
            }
            // 2级分类
            
            function loadCatalogLevelTwo(record) {
                var parent = record.data.parent_catelog_udf_id;
                var catId = record.data.catelog_udf_id;
                var keyword_2 = record.data.catelog_name;
                var dl = window.document.createElement('dl');
                var div = document.getElementById('menu-item-' + parent);
                dl.className = 'shopping-item-dl';
                var dt = window.document.createElement('dt');
                dt.className = 'shopping-item-dt';
                dt.setAttribute('title', keyword_2);
                dt.id = catId;
                var dd = window.document.createElement('dd');
                dd.className = 'shopping-item-dd';
                dd.id = catId + '-dd';
                var da = window.document.createElement('a');
                da.className = 'shopping-item-dt-a';
                da.innerHTML = keyword_2;
                da.setAttribute('href', 'javascript:search(1,' + '"' + catId + '"' + ',' + '"' + keyword_2 + '"' + ')');
                var TagI = window.document.createElement('i');
                TagI.className = 'fa fa-angle-right';
                dt.appendChild(da);
                dt.appendChild(TagI);
                dl.appendChild(dt);
                dl.appendChild(dd);
                div.appendChild(dl);
            }
            // 3级分类
            
            function loadCatalogLevelThree(record) {
                var parent = record.data.parent_catelog_udf_id;
                var cat_id3 = record.data.catelog_udf_id;
                var dd_1 = document.getElementById(parent + '-dd');
            
                var keyword_3 = record.data.catelog_name;
            
                var TagAS = window.document.createElement('a');
                TagAS.className = 'shopping-item-a';
                TagAS.setAttribute('title', keyword_3);
                TagAS.innerHTML = keyword_3;
                TagAS.setAttribute('href', 'javascript:search(1,' + '"' + cat_id3 + '"' + ',' + '"' + keyword_3 + '"' + ')');
            
                // dd.appendChild(TagAS);
                if (dd_1) {
                    dd_1.appendChild(TagAS);
                }
            }
            
            function NavLiHover() {
                jQuery('.catalog-title').hover(function() {
                    jQuery('.catalog-submenu').css('display', 'block');
                }, function() {
                    jQuery('.catalog-submenu').css('display', 'none');
                });
                jQuery('.nav-li').hover(function() {
                    var index = jQuery(this).index();
                    jQuery(jQuery(this).children()[2]).removeClass('fa fa-angle-right');
                    show(index);
                }, function() {
                    hide();
                    jQuery(jQuery(this).children()[2]).addClass('fa fa-angle-right');
                });
            
                jQuery('.menu').hover(function() {
                    jQuery('.sub-menu').css('display', 'block');
                    //jQuery('.menu .fa-angle-up').css('transform', 'scale(1) rotate(180deg)');
                }, function() {
                    jQuery('.sub-menu').css('display', 'none');
                    //jQuery('.menu .fa-angle-up').css('transform', 'none');
                });
            
                jQuery('.sub-menu').hover(function() {
                    jQuery('.sub-menu').css('display', 'block');
                    //jQuery('.menu .fa-angle-up').css('transform', 'scale(1) rotate(180deg)');
                }, function() {
                    jQuery('.sub-menu').css('display', 'none');
                    //jQuery('.menu .fa-angle-up').css('transform', 'none');
                });
            
                jQuery('.menu-item').hover(function() {
                    jQuery('.menu-content').css('display', 'block');
                    jQuery('.sub-menu').css('display', 'block');
                    jQuery(this).css('display', 'block');
                    //jQuery('.menu .fa-angle-up').css('transform', 'scale(1) rotate(180deg)');
                }, function() {
                    jQuery('.menu-content').css('display', 'none');
                    jQuery('.sub-menu').css('display', 'none');
                    jQuery(this).css('display', 'none');
                    //jQuery('.menu .fa-angle-up').css('transform', 'none');
                });
            
                jQuery('.menu-content').hover(function() {
                    jQuery('.catalog-submenu').css('display', 'block');
                }, function() {
                    jQuery('.catalog-submenu').css('display', 'none');
                });
            }
            
            function show(index) {
                jQuery('.catalog-submenu').css('display', 'block');
                jQuery('.menu-item').css('display', 'none');
                jQuery('.menu-content').css('display', 'block');
                jQuery('.menu-item')[index].style.display = 'block';
            
            }
            
            function hide() {
                jQuery('.catalog-submenu').css('display', 'none');
                jQuery('.menu-item').css('display', 'none');
                jQuery('.menu-content').css('display', 'none');
            }
            
            function search2() {
                var search_text = document.getElementById('search-in-result').value;
                jQuery('#product-div1').html('');
                jQuery('#product-div2').html('');
                jQuery('#product-div3').html('');
                jQuery('#product-div4').html('');
                $('pur7040_pur_item_catelog_purchase_main_ds').setQueryParameter('item_detail2', search_text);
                $('pur7040_count_ds').setQueryParameter('item_detail2', search_text);
                $('pur7040_pur_item_catelog_purchase_main_ds').query();
                $('pur7040_count_ds').query();
            }
            
            function search3() {
                var search_text = document.getElementById('search-in-result-vendor').value;
                jQuery('#product-div1').html('');
                jQuery('#product-div2').html('');
                jQuery('#product-div3').html('');
                jQuery('#product-div4').html('');
                $('pur7040_pur_item_catelog_purchase_main_ds').setQueryParameter('vendor_name', search_text);
                $('pur7040_count_ds').setQueryParameter('vendor_name', search_text);
                $('pur7040_pur_item_catelog_purchase_main_ds').query();
                $('pur7040_count_ds').query();
            }
            
            function search(pageNum, id, keyword) {
                var price_from = document.getElementById('price-from').value;
                var price_to = document.getElementById('price-to').value;
                var search_text = document.getElementById('search-text').value;
                if (price_from !== '' && isNaN(price_from)) {
                    price_from = '';
                    document.getElementById('price-from').value = price_from;
                } else if (price_to !== '' && isNaN(price_to)) {
                    price_to = '';
                    document.getElementById('price-to').value = price_to;
                } else {
                    jQuery('#product-div1').html('');
                    jQuery('#product-div2').html('');
                    jQuery('#product-div3').html('');
                    jQuery('#product-div4').html('');
                    if (pageNum) {
                        $('pur7040_pur_item_catelog_purchase_main_ds').setQueryParameter('page_num', parseFloat(pageNum));
                        $('pur7040_count_ds').setQueryParameter('page_num', parseFloat(pageNum));
                    } else {
                        $('pur7040_pur_item_catelog_purchase_main_ds').setQueryParameter('page_num', 1);
                        $('pur7040_count_ds').setQueryParameter('page_num', 1);
                    }
                    $('pur7040_pur_item_catelog_purchase_main_ds').setQueryParameter('item_detail', search_text);
                    $('pur7040_count_ds').setQueryParameter('item_detail', search_text);
                    $('pur7040_pur_item_catelog_purchase_main_ds').setQueryParameter('price_from', parseFloat(price_from));
                    $('pur7040_count_ds').setQueryParameter('price_from', parseFloat(price_from));
                    $('pur7040_pur_item_catelog_purchase_main_ds').setQueryParameter('price_to', parseFloat(price_to));
                    $('pur7040_count_ds').setQueryParameter('price_to', parseFloat(price_to));
                    if (id) {
                        $('pur7040_pur_item_catelog_purchase_main_ds').setQueryParameter('catelog_udf_id', id);
                        $('pur7040_count_ds').setQueryParameter('catelog_udf_id', id);
                        // document.getElementById('search-text').setAttribute('placeholder', keyword);
                        // document.getElementById('search-text').setAttribute('placeholder', keyword);
                    }
                    $('pur7040_pur_item_catelog_purchase_main_ds').query();
                    $('pur7040_count_ds').query();
                }
                hide();
            }
            
            function jump_to() {
                btp = document.getElementById('current_page_id').value;
            
                if (isNaN(btp)) {
                    btp = 1;
                    document.getElementById('current_page_id').value = 1;
                }
            
                btp = parseFloat(btp);
            
                if (typeof(btp) != 'number') {
                    btp = 1;
                    document.getElementById('current_page_id').value = 1;
                }
            
                if (Aurora.isEmpty(btp) || btp == '' || btp == null || btp == 'undefined') {
                    btp = 1;
                    document.getElementById('current_page_id').value = 1;
                }
                var total_count = $('pur7040_count_ds').getAt(0).get('total_count');
            
                if (btp < 1) {
                    btp = 1;
                    document.getElementById('current_page_id').value = 1;
                } else if (btp > total_page) {
                    btp = total_page;
                    document.getElementById('current_page_id').value = btp;
                }
            
                $('pur7040_pur_item_catelog_purchase_main_ds').setQueryParameter('page_num', btp);
                $('pur7040_pur_item_catelog_purchase_main_ds').query();
            }
            
            function setPage(ds) {
                var total_count = ds.getAt(0).get('total_count');
                total_page = Math.ceil(total_count / 20);
                document.getElementById('total_count_id').innerHTML = '${l:PROMPT_PUBLIC.TOTAL} ' + '<span class="total-count-span">' + total_count + '</span>' + ' 件 | 第 ';
                document.getElementById('total_page_id').innerHTML = ' 页 | 共 ' + '<span class="total-page-span">' + total_page + '</span>' + ' ${l:PROMPT_PUBLIC.PAGE}';
            }
            
            function shopping_cart() {
                window.location.href = '${/request/@context_path}/modules/cux/NEWHOPE/PUR/PUR7040/pur_item_application_list.screen';
            }
            
            function delete_product(_this, shopping_cart_id) {
            
                Aurora.request({
                    url: $('pur_shopping_cart_delete_link_f').getUrl(),
                    para: {
                        'shopping_cart_id': shopping_cart_id,
                    },
                    success: function() {
                        var record = $('pur_shopping_cart_details_ds1').find('shopping_cart_id', shopping_cart_id);
            
                        var quantity = record.get('quantity');
                        var price = record.get('price');
                        var amount = quantity * price;
            
                        var commodity_count = document.getElementById('commodity-count1');
                        var commodity_price = document.getElementById('commodity-price1');
                        var commodity_count_tow = document.getElementById('commodity-count-tow1');
                        var commodity_price_tow = document.getElementById('commodity-price-tow1');
                        var totle_species = commodity_count.innerHTML; //商品种类
                        var total_amount = commodity_price.innerHTML.replace('￥', ''); //商品总金额
                        commodity_count.innerHTML = totle_species - 1;
                        commodity_count_tow.innerHTML = totle_species - 1;
                        commodity_price.innerHTML = '￥' + (total_amount - amount);
                        commodity_price_tow.innerHTML = '￥' + (total_amount - amount);
                        jQuery(_this).parent().remove();
                    },
                    failure: function() {},
                    error: function() {},
                    scope: this
                });
            }
            
            function pur_shopping_cart_details_Load1(record) {
                var product_id = record.data.item_id;
                var quantity = record.data.quantity;
                var price = record.data.price;
                var title = record.data.item_name;
                var image_path = record.data.image_url;
                var shopping_cart_id = parseInt(record.data.shopping_cart_id);
                var ul = document.getElementById('shopping-cart1-content1-ul1');
            
                //数据加载
                var li = document.createElement('li');
                li.className = 'shopping-cart1-content1-li';
                var TagA1, TagA2, TagA3, span, span_1, span_2, span_3, span_4, TagA1_img;
                TagA1 = document.createElement('a');
                TagA1.className = 'shopping-cart1-content1-a';
                TagA1_img = document.createElement('img');
                TagA1_img.setAttribute('onerror', 'javascript:nofind()');
                //TagA1_img.setAttribute('onclick', 'javascript:open_product_details("' + product_id + '")');
                TagA1_img.src = image_path;
                TagA1.appendChild(TagA1_img);
            
                TagA2 = document.createElement('a');
                TagA2.className = 'shopping-cart1-content1-a name';
                //TagA2.setAttribute('onclick', 'javascript:open_product_details("' + product_id + '")');
                TagA2.innerHTML = title;
                TagA2.setAttribute('title', title);
            
                span = document.createElement('span');
                span.className = 'shopping-price';
                span_1 = document.createElement('span');
                span_1.className = 'currence';
                span_1.innerHTML = '￥';
                span_2 = document.createElement('span');
                span_2.className = 'price';
                span_2.id = 'price';
                span_2.innerHTML = price;
                span_3 = document.createElement('span');
                span_3.className = 'symbol';
                span_3.innerHTML = '×';
                span_4 = document.createElement('span');
                span_4.className = 'number';
                span_4.id = 'number';
                span_4.innerHTML = quantity;
                span.appendChild(span_1);
                span.appendChild(span_2);
                span.appendChild(span_3);
                span.appendChild(span_4);
            
                var TagA4 = document.createElement('img');
                TagA4.className = 'delete-icon';
                TagA4.src = '${/request/@context_path}/images/main/icon_close_default.png';
                TagA4.setAttribute('onclick', 'javascript:delete_product(this,' + shopping_cart_id + ')');
            
                li.appendChild(TagA1);
                li.appendChild(TagA2);
                li.appendChild(span);
                li.appendChild(TagA4);
                ul.appendChild(li);
            }
            
            function pur_shopping_cart_details_Loads1(ds) {
                var records = ds.getAll();
                document.getElementById('shopping-cart1-content1-ul1').innerHTML = '';
                for (var i = 0;i < records.length;i++) {
                    pur_shopping_cart_details_Load1(records[i]);
                }
                document.getElementsByClassName('shopping-content-bottom1')[0].style.display = 'block';
            }
            
            function pur_shopping_cart_count_Loads1(ds) {
                var record = ds.getAt(0);
                var totle_species = record.get('totle_species'); //商品种类
                var total_amount = record.get('total_amount'); //商品总金额
                var commodity_count = document.getElementById('commodity-count1');
                var commodity_price = document.getElementById('commodity-price1');
                var commodity_count_tow = document.getElementById('commodity-count-tow1');
                var commodity_price_tow = document.getElementById('commodity-price-tow1');
                commodity_count.innerHTML = totle_species;
                commodity_count_tow.innerHTML = totle_species;
                commodity_price.innerHTML = '￥' + total_amount;
                commodity_price_tow.innerHTML = '￥' + total_amount;
            }
            
            function on_pur_item_catelog_shopping_cart_ds_load(dataSet) {
                var record = dataSet.getAt(0);
            
                document.getElementById('commodity-count1').innerHTML = record.get('totle_species');
                document.getElementById('commodity-count-tow1').innerHTML = record.get('totle_species');
                document.getElementById('commodity-price1').innerHTML = record.get('total_amount');
                document.getElementById('commodity-price-tow1').innerHTML = record.get('total_amount');
            
            }
        ]]></script>
        <a:dataSets>
            <a:dataSet id="pur7040_company_ds" autoQuery="true" model="public.fnd_companies_lov"/>
            <a:dataSet id="pur7040_catelog_name_ds" model="cux.NEWHOPE.PUR.PUR7040.pur_catelog_query">
                <a:fields>
                    <a:field name="catelog_udf_id" readOnly="true"/>
                    <a:field name="catelog_name" readOnly="true"/>
                </a:fields>
                <a:events>
                    <a:event name="load" handler="on_pur7040_catelog_name_ds_load"/>
                </a:events>
            </a:dataSet>
            <a:dataSet id="pur7040_company_query_ds" autoCreate="true">
                <a:fields>
                    <a:field name="company_full_name" displayField="company_full_name" options="pur7040_company_ds" required="true" requiredMessage="${l:CUX_NEWHOME.SELECT_COMPANY_PLS}">
                        <a:mapping>
                            <a:map from="company_id" to="company_id"/>
                            <a:map from="company_full_name" to="company_full_name"/>
                        </a:mapping>
                    </a:field>
                </a:fields>
                <a:events>
                    <a:event name="add" handler="on_pur7040_company_query_ds_add"/>
                    <a:event name="update" handler="on_pur7040_company_query_ds_update"/>
                </a:events>
            </a:dataSet>
            <a:dataSet id="pur_item_catelog_shopping_cart_ds" autoQuery="true" fetchAll="true" model="cux.NEWHOPE.PUR.PUR7040.pur_item_catelog_shopping_cart">
                <a:events>
                    <a:event name="load" handler="on_pur_item_catelog_shopping_cart_ds_load"/>
                </a:events>
            </a:dataSet>
            <a:dataSet id="pur7040_pur_item_catelog_purchase_query_ds"/>
            <a:dataSet id="pur7040_pur_item_catelog_purchase_main_ds" autoQuery="false" fetchAll="false" model="cux.NEWHOPE.PUR.PUR7040.pur_item_catelog_purchase" pageSize="20" queryDataSet="pur7040_pur_item_catelog_purchase_query_ds">
                <a:fields>
                    <a:field name="catelog_udf_id"/>
                    <a:field name="catelog_root_id"/>
                    <a:field name="item_name" readOnly="true"/>
                    <a:field name="vendor_name" readOnly="true"/>
                    <a:field name="price" readOnly="true"/>
                </a:fields>
                <a:events>
                    <a:event name="load" handler="getItemImg"/>
                </a:events>
            </a:dataSet>
            <a:dataSet id="pur7040_count_ds" autoQuery="false" fetchAll="true" model="cux.NEWHOPE.PUR.PUR7040.pur_item_catelog_purchase_count_sql" queryDataSet="pur7040_pur_item_catelog_purchase_query_ds">
                <a:events>
                    <a:event name="load" handler="setPage"/>
                </a:events>
            </a:dataSet>
            <a:dataSet id="pur_shopping_cart_details_ds1" autoQuery="true" model="cux.NEWHOPE.PUR.PUR7040.pur_item_catelog_application">
                <a:events>
                    <a:event name="load" handler="pur_shopping_cart_details_Loads1"/>
                </a:events>
            </a:dataSet>
            <a:dataSet id="pur_shopping_cart_count_ds1" autoQuery="true" model="cux.NEWHOPE.PUR.PUR7040.pur_item_catelog_shopping_cart">
                <a:events>
                    <a:event name="load" handler="pur_shopping_cart_count_Loads1"/>
                </a:events>
            </a:dataSet>
        </a:dataSets>
        <a:screenBody>
            <div class="search-block">
                <div id="catalog-menu" class="fl catalog-menu">
                    <div class="catalog-title" onclick="search(1,-1)" style="float:left;"><![CDATA[${l:CUX_NEWHOME.ALL_CLASS}]]></div>
                    <a:comboBox name="company_full_name" bindTarget="pur7040_company_query_ds" prompt="PROMPT_PUBLIC.PROMPT_COMPANY" style="float:left;margin: 5px 0 0 48px;" width="190"/>
                    <div class="catalog-submenu">
                        <ul id="catalog-submenu-ul" class="catalog-submenu-ul"/>
                    </div>
                </div>
                <div class="fr search-input">
                    <input id="search-text" class="fl search-text" placeholder="${l:CUX_NEWHOME.WRITE_KEYWORD_PLZ}" type="text"/>
                    <div class="fl search-btn" onclick="search()">
                        <i class="search-search"/>
                    </div>
                </div>
                <div id="menu-content" class="menu-content"/>
                <div class="search-input-vendor">
                    <div class="fl search-in-result-block1">
                        <input id="search-in-result-vendor" class="search-in-result" placeholder="${l:CUX_NEWHOME.POINT_VENDOR}" type="text"/>
                        <input class="search-in-result-btn" onclick="search3()" type="button" value="${l:CUX_NEWHOME.TEXT_COMFIRM}"/>
                    </div>
                </div>
                <div class="search-input-result">
                    <div class="fl search-in-result-block1">
                        <input id="search-in-result" class="search-in-result" placeholder="${l:CUX_NEWHOME.SEARCH_IN_RESULT}" type="text"/>
                        <input class="search-in-result-btn" onclick="search2()" type="button" value="${l:CUX_NEWHOME.TEXT_COMFIRM}"/>
                    </div>
                </div>
                <div class="search-in-price-cate">
                    <span class="fl search-in-price-text"><![CDATA[${l:PROMPT_PUBLIC.PRICE_FROM}]]></span>
                    <input id="price-from" class="fl search-in-price-input" placeholder="${l:CUX_NEWHOME.PRICE_REQUIRE}" type="text"/>
                    <span class="fl search-in-price-text"><![CDATA[${l:CUX_NEWHOME.PRICE_TO}]]></span>
                    <input id="price-to" class="fl search-in-price-input" placeholder="${l:CUX_NEWHOME.PRICE_REQUIRE}" type="text"/>
                    <span class="fl search-in-price-btn" onclick="search()"><![CDATA[${l:CUX_NEWHOME.TEXT_COMFIRM}]]></span>
                </div>
                <div id="shopping-carts1" class="shopping-cart1">
                    <i class="fa fa-2x fa-shopping-cart"/>
                    <span id="commodity-count1" class="commodity-count1"/>
                    <span class="commodity-text1"><![CDATA[${l:CUX_NEWHOME.TEXT_TOTAL_LINES}]]></span>
                    <span id="commodity-price1" class="price"/>
                </div>
                <div class="shopping-cart1-content1">
                    <ul id="shopping-cart1-content1-ul1"/>
                    <div class="shopping-content-bottom1">
                        <div class="shopping-cart1-tow1">
                            <div class="altogether">
                                <span class="commodity-text1-tow1"><![CDATA[${l:PROMPT_PUBLIC.TOTAL}]]></span>
                                <span id="commodity-count-tow1" class="commodity-count-tow1"/>
                                <span class="commodity-text1-tow1"><![CDATA[${l:CUX_NEWHOME.TEXT_TOTAL_LINES}]]></span>
                            </div>
                            <div class="tatal">
                                <span class="tatal-price1"><![CDATA[${l:CUX_NEWHOME.PROMPT_TOTAL}]]></span>
                                <span id="commodity-price-tow1" class="price-tow1"/>
                            </div>
                        </div>
                        <a class="shopping-btn" href="javascript:shopping_cart();"><![CDATA[${l:CUX_NEWHOME.GO_TO_SHOPPING_CART}]]></a>
                    </div>
                </div>
            </div>
            <a:hBox>
                <a:form>
                    <div class="container">
                        <div id="product-div1" class="product-div"/>
                        <div id="product-div2" class="product-div"/>
                        <div id="product-div3" class="product-div"/>
                        <div id="product-div4" class="product-div"/>
                        <div class="btn-group">
                            <button id="prev_button" class="button-group prev" onclick="ItemPreviousPage()"><![CDATA[${l:CUX_NEWHOME.LAST_PAGE}]]></button>
                            <span id="total_count_id"/>
                            <input id="current_page_id" class="current-page" onchange="jump_to();" type="text"/>
                            <span id="total_page_id"/>
                            <button id="next_button" class="button-group next" onclick="ItemNextPage()"><![CDATA[${l:CUX_NEWHOME.NEXT_PAGE}]]></button>
                        </div>
                    </div>
                </a:form>
            </a:hBox>
        </a:screenBody>
        <script><![CDATA[
            function init() {
            
                catalog_company_id = '${/model/company_info/record/@company_id}';
                $("pur7040_catelog_name_ds").setQueryParameter('company_id', catalog_company_id);
                $("pur7040_pur_item_catelog_purchase_main_ds").setQueryParameter('company_id', catalog_company_id);
                $("pur7040_count_ds").setQueryParameter('company_id', catalog_company_id);
            
                if (Aurora.getCookie('reload_flag') == 'Y') {
            
                    Aurora.setCookie('reload_flag', 'N');
            
                    catalog_company_id = Aurora.getCookie('catalog_company_id');
                    $("pur7040_catelog_name_ds").setQueryParameter('company_id', catalog_company_id);
                    $("pur7040_pur_item_catelog_purchase_main_ds").setQueryParameter('company_id', catalog_company_id);
                    $("pur7040_count_ds").setQueryParameter('company_id', catalog_company_id);
            
                    if ('${/parameter/@search}' == 'Y') {
                        var item_detail = decodeURIComponent(escape('${/parameter/@item_detail}'));
                        document.getElementById('search-text').value = item_detail;
            
                        $('pur7040_pur_item_catelog_purchase_main_ds').setQueryParameter('catelog_udf_id', '${/parameter/@catelog_udf_id}');
                        $('pur7040_count_ds').setQueryParameter('catelog_udf_id', '${/parameter/@catelog_udf_id}');
                        $('pur7040_pur_item_catelog_purchase_main_ds').setQueryParameter('item_detail', item_detail);
                        $('pur7040_count_ds').setQueryParameter('item_detail', item_detail);
                        $('pur7040_pur_item_catelog_purchase_main_ds').query();
                        $('pur7040_count_ds').query();
                    }
            
                    if ('${/parameter/@open_detail}' == 'Y') {
                        ItemDescDetailRender('${/parameter/@item_id}', '${/parameter/@data_source}', '${/parameter/@item_category_id}');
                    }
                }
            }
            init();
            init1();
            
            //执行查询
            $("pur7040_catelog_name_ds").query();
            $("pur7040_pur_item_catelog_purchase_main_ds").query();
            $("pur7040_count_ds").query();
            
            jQuery("#search-text").focus(function() {
                document.onkeydown = function(event) {
                    var e = event || window.event || arguments.callee.caller.arguments[0];
                    if (e && e.keyCode == 13) { // 按 回车键
                        search();
                    }
                };
            });
            
            jQuery("#price-from").focus(function() {
                document.onkeydown = function(event) {
                    var e = event || window.event || arguments.callee.caller.arguments[0];
                    if (e && e.keyCode == 13) { // 按 回车键
                        search();
                    }
                };
            });
            
            jQuery("#price-to").focus(function() {
                document.onkeydown = function(event) {
                    var e = event || window.event || arguments.callee.caller.arguments[0];
                    if (e && e.keyCode == 13) { // 按 回车键
                        search();
                    }
                };
            });
            
            jQuery(".shopping-cart1").hover(function() {
                $('pur_item_catelog_shopping_cart_ds').query();
                $('pur_shopping_cart_details_ds1').query();
                jQuery('.shopping-cart1-content1').css('display', 'block');
            }, function() {
                jQuery('.shopping-cart1-content1').css('display', 'none');
            });
            jQuery(".shopping-cart1-content1").hover(function() {
                jQuery(this).css('display', 'block');
            }, function() {
                jQuery(this).css('display', 'none');
            });
        ]]></script>
    </a:view>
</a:screen>
