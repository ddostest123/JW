<?xml version="1.0" encoding="UTF-8"?>
<!--
    $Author: hansen  
    $Date: 2015-11-11 上午10:55:39  
    $Revision: 1.0  
    $Purpose: 
-->
<a:screen xmlns:a="http://www.aurora-framework.org/application">
    <a:init-procedure>
        <a:model-query defaultWhereClause="flex_value_set_code = &apos;PUR_VENDOR_RECOMMEND_STATUS&apos; and flex_value in (&apos;NEW&apos;, &apos;REJECTED&apos;)" fetchAll="true" model="public.fnd_flex_value_sets_query" rootPath="PUR5720_status_data"/>
        <a:model-query defaultwhereclause="flex_value_set_code = &apos;PUR_POTENTIAL_VENDOR_STATUS&apos; and flex_value in (&apos;NEW&apos;, &apos;REJECTED&apos;)" fetchall="true" model="public.fnd_flex_value_sets_query" rootpath="qms5740_potential_vendor_status_data"/>
        <a:model-query defaultWhereClause="flex_value_set_code = &apos;PUR_QUALIFIED_VENDOR_STATUS&apos; and flex_value in (&apos;NEW&apos;, &apos;REJECTED&apos;)" fetchAll="true" model="public.fnd_flex_value_sets_query" rootPath="pur5760_qualified_vendor_status_data"/>
        <a:model-query defaultWhereClause="flex_value_set_code = &apos;PUR_DOWNGRADE_TATUS&apos; and flex_value in (&apos;NEW&apos;, &apos;APPROVE_REJECTED&apos;)" fetchAll="true" model="public.fnd_flex_value_v_lov" rootPath="pur5770_downgrade_status_data"/>
        <a:model-query defaultWhereClause="flex_value_set_code = &apos;PUR_VENDOR_ITEM_PRICE_LEVEL&apos;" fetchAll="true" model="public.fnd_flex_value_sets_query" rootPath="PUR5720_price_level_data"/>
        <a:model-query defaultWhereClause="flex_value_set_code = &apos;PUR_MARKET_COMPETITION_CODE&apos;" fetchAll="true" model="public.fnd_flex_value_sets_query" rootPath="pur5720_market_competition_data"/>
        <a:model-query defaultWhereClause="flex_value_set_code = &apos;PUR_RECOMMEND_PRICE_LEVEL&apos;" fetchAll="true" model="public.fnd_flex_value_sets_query" rootPath="pur5720_price_level_data"/>
        <a:model-query defaultWhereClause="flex_value_set_code = &apos;PUR_VENDOR_LIFE_CYCLE&apos;" fetchAll="true" model="public.fnd_flex_value_v_lov" rootPath="pur5770_vendor_life_cycle_maintain_data"/>
        <a:model-query defaultWhereClause="flex_value_set_code = &apos;PUR_DOWNGRADE_PROCESS_TYPE&apos;" fetchAll="true" model="public.fnd_flex_value_v_lov" rootPath="pur5770_downgrade_process_type_data"/>
        <a:model-query defaultWhereClause="flex_value_set_code = &apos;PUR_VENDOR_LIFE_CYCLE&apos; and flex_value not in (&apos;ELIMINATED&apos;,&apos;QUALIFIED&apos;)" fetchAll="true" model="public.fnd_flex_value_v_lov" rootPath="pur5770_vendor_life_cycle_data"/>
        <a:model-query model="pur.PUR5800.pur5800_ven_stage_role" rootPath="pur5800_ven_stage_role"/>
    </a:init-procedure>
    <a:view>
        <a:link id="wzpur5800_supplier_stage_change_req_modify_link" url="${/request/@context_path}/modules/cux/WZ/PUR/WZPUR5800/wz_supplier_stage_change_req_modify.screen"/>
        <a:link id="wz_pur5800_com_supplier_detail_link" url="${/request/@context_path}/modules/pur/PUR5660/pur_com_supplier_detail.screen"/>
        <a:link id="wz_pur5800_register_vendor_query_link" url="${/request/@context_path}/modules/pur/PUR5800/pur5800_vendor_survey_release_query.screen"/>
        <a:link id="wz_pur5800_recommend_vendor_query_link" url="${/request/@context_path}/modules/pur/PUR5800/pur5800_vendor_recommend_query.screen"/>
        <a:link id="wz_pur5800_potential_vendor_query_link" url="${/request/@context_path}/modules/pur/PUR5800/pur5800_potential_vendor_query.screen"/>
        <a:link id="wz_pur5800_qualified_vendor_query_link" url="${/request/@context_path}/modules/pur/PUR7250/pur7250_qualified_vendor_query.screen"/>
        <a:link id="wz_pur5800_downgrade_vendor_query_link" url="${/request/@context_path}/modules/pur/PUR5800/pur5800_downgrade_vendor_query.screen"/>
        <!-- 申请 -->
        <a:link id="wz_pur5800_register_vendor_modify_link" url="${/request/@context_path}/modules/pur/PUR5710/pur5710_vendor_survey_create.screen"/>
        <a:link id="wz_pur5800_recommend_vendor_modify_link" url="${/request/@context_path}/modules/pur/PUR5720/pur_vendor_recommend_modify.screen"/>
        <a:link id="wz_pur5800_potential_vendor_modify_link" url="${/request/@context_path}/modules/pur/PUR5740/pur5740_potential_vendor_modify.screen"/>
        <a:link id="wz_pur5800_qualified_vendor_modify_link" url="${/request/@context_path}/modules/pur/PUR5760/pur5760_qualified_vendor_modify.screen"/>
        <a:link id="wz_pur5800_downgrade_vendor_modify_link" url="${/request/@context_path}/modules/pur/PUR5770/pur5770_downgrade_vendor_maintain.screen"/>
        <a:link id="wz_pur5800_black_list_link" url="${/request/@context_path}/modules/pur/PUR5800/pur5800_black_list.screen"/>
        <a:link id="wz_pur5800_checkDocumentVendorDocumentCount_queryLink" model="pur.PUR5800.pur5800_check_vendor_document_count" modelaction="query"/>
        <!-- 样式js -->
        <script src="${/request/@context_path}/component/handPagesBreak/handPagesBreak.js?v=2"/>
        <link href="${/request/@context_path}/component/handPagesBreak/handPagesBreak.css" rel="stylesheet" type="text/css"/>
        <link href="${/request/@context_path}/css/pur/vendor_life_management.css?v=1.7" rel="stylesheet" type="text/css"/>
        <style><![CDATA[
           .black-circle {
				position: absolute; 
				top: 12px;
				left: 70%;
				width: 30px;
				height: 30px;
				line-height: 30px;
				text-indent: 8px;
				/* text-align: left; */
				/* margin: 0 auto; */
				border-radius: 50%;
				background-color: #E9E5E0;
				font-size: 16px;
				color: #000;
				}
        ]]></style>
        <script language="JavaScript" src="${/request/@context_path}/index/js/jquery-1.8.3.min.js"/>
        <script><![CDATA[jQuery.noConflict();]]></script>
        <script><![CDATA[
            var registered_query_role = '${/model/pur5800_ven_stage_role/record/@registered}';
            var recommended_query_role = '${/model/pur5800_ven_stage_role/record/@recommended}';
            var potential_query_role = '${/model/pur5800_ven_stage_role/record/@potential}';
            var qualified_query_role = '${/model/pur5800_ven_stage_role/record/@qualified}';
            var eliminated_query_role = '${/model/pur5800_ven_stage_role/record/@eliminated}';
            var g_window_index = 0;
            var g_window = [];
            var g_stage_code = ['REGISTER','QUALIFIED','ELIMINATED'];
            var g_stage_name = ['注册供应商', '合格供应商','淘汰供应商'];
            var g_pageSize;
            var g_load_flag = {
                register: false, 
                qualified: false,
                eliminated:false
            };
            
            
            var g_from_index,g_to_index;
            
            function init() {
                height_set();
                init_g_window();
                button_init();
            }
            
            function init_g_window() {
                Aurora.Masker.mask(Ext.getBody());
                g_window_index = 0;
                g_window = [];
                var g_load_flag = {
                    register: false, 
                    qualified: false,
                    eliminated:false
                };
                var move = {
                    dragInter: null,
                    onmoveobj: null,
                    onmoveflag: false,
                    to_column_index: null
                };
            
            }
            
            function getId(id) {
                return document.getElementById(id);
            }
            
            function button_init() {
                var target = document.body;
                if (target.addEventListener) {
                    // 监听IE9，谷歌和火狐
                    target.addEventListener('click', function(e) {
                        e = e || window.event;
                        body_out_onclick(e);
                    }, true);
                } else if (target.attachEvent) {
                    target.attachEvent('onclick', function(e) {
                        e = e || window.event;
                        body_out_onclick(e);
                    });
                } else {
                    target["onclick"] = function(e) {
                        e = e || window.event;
                        body_out_onclick(e);
                    };
                }
            }
            
            function body_out_onclick(e) {
                var tgr = e.target || e.srcElement;
                if ((tgr.tagName != 'LI' || tgr.className != 'up_down') && tgr.tagName != 'I' && tgr.className != 'circle') {
                    //关闭标签
                    close_window();
                }
            }
            
            function height_set() {
                var main_body = getId('vendor_main_body');
                var query = getId('wz_pur5800_queryForm');
                var mask = getId('vendor_mask');
                var height = window.document.documentElement.clientHeight;
                var width = window.document.documentElement.clientWidth;
                var marginTop = 10;
                var marginBottom = 10;
                main_body.parentNode.style.marginTop = marginTop + 'px';
                main_body.style.height = height - query.offsetHeight - marginTop + 'px';
                main_body.children[0].style.width = main_body.offsetWidth * 0.95 + 'px';
                main_body.children[0].style.height = main_body.offsetHeight - 15 - marginBottom + 'px';
                mask.style.width = width + 'px';
                mask.style.height = height + 'px';
                mask.style.top = '-15px';
                mask.style.left = -0.5 * (width - main_body.children[0].offsetWidth) + 'px';
                var columns = main_body.children[0].children;
                 
                for (var i = 0;i < columns.length - 2;i++) {
                    columns[i].children[1].style.height = columns[i].offsetHeight - 50 - 32 + 'px';
                }
                
                var _q = getId('vendor_query_form');
                _q.style.width = _q.parentNode.offsetWidth - 250 + 'px';
            }
            
            function PUR5800_query(value, ds) {
                init_g_window();
                var query = $('wz_PUR5800_query_ds').getAt(0);
                query.set('vendor_desc', value);
                $('wz_PUR5800_register_ds').query();
                $('wz_PUR5800_qualified_ds').query();
                $('wz_PUR5800_eliminated_ds').query();
            }
            
            function wz_pur5800_vendor_query(code) {
                var query_str;
                var title;
                var url;
                if (code == 'REGISTER') {
                    query_str = '?stage_code=' + code;
                    title = '查看注册供应商申请';
                    url = $('wz_pur5800_register_vendor_query_link').getUrl() + query_str;
                } else if (code == 'RECOMMEND') {
                    query_str = '?stage_code=' + code;
                    title = '查看推荐供应商申请';
                    url = $('wz_pur5800_recommend_vendor_query_link').getUrl() + query_str;
                } else if (code == 'POTENTIAL') {
                    query_str = '?stage_code=' + code;
                    title = '查看潜在供应商申请';
                    url = $('wz_pur5800_potential_vendor_query_link').getUrl() + query_str;
                } else if (code == 'QUALIFIED') {
                    query_str = '?stage_code=' + code;
                    title = '查看合格供应商申请';
                    url = $('wz_pur5800_qualified_vendor_query_link').getUrl() + query_str;
                } else if (code == 'ELIMINATED') {
                    query_str = '?stage_code=' + code;
                    title = '查看淘汰供应商申请';
                    url = $('wz_pur5800_downgrade_vendor_query_link').getUrl() + query_str;
                }
                new Aurora.Window({
                    url: url,
                    title: title,
                    id: 'wz_pur5800_vendor_query_window',
                    fullScreen: true
                });
            }
            
            function get_vendor_html(body, records, column_index) {
                var html = '';
                for (var i = 0;i < records.length;i++) {
                    var data = records[i].data;
                    if (Aurora.isEmpty(data)) {
                        return;
                    }
                    html += '<li><div index="' + g_window_index + '" column_index="' + column_index + '" id="vendor_block_' + g_window_index + '" class="block">';
                    //内容
                    html += '<div class="left vendor">';
                    html += '<div class="vendor-code" id="' + data.cooper_company_id + '"><a onclick="open_vendor_detail(this)">' + data.display_vendor_code + '</a></div>';
                    if (!Aurora.isEmpty(data.document_type)) {
                        var type, className;
                        var index = g_stage_code.indexOf(data.stage_code);
                        var to_index = g_stage_code.indexOf(data.stage_to);
                        if (data.document_type == 'DOWNGRADE') {
                            type = '降级中';
                            className = 'on-grade-blue';
                        } else if (data.document_type == 'ELIMINATE') {
                            type = '降级中';
                            className = 'on-grade-blue';
                            to_index = -1;
                        } else {
                            type = '升级中';
                            className = 'on-grade-red';
                        }
                        html += '<div class="' + className + '" type="' + data.document_type + '" vendor_id="' + data.vendor_id + '" from_index="' + index + '" to_index="' + to_index + '" document_id="' + data.document_header_id + '" onclick="processQuickLink(this)">' + type + '</div>';
                    }
                    html += '<div class="vendor-name">' + data.full_name + '</div>';
                    html += '</div>';
                    //操作标签
                    if(data.stage_code == 'ELIMINATED'){
                    html += '<div class="circle" stage_code="' + data.stage_code + '" onclick="label_click(this)"><i class="icon-reorder"></i></div>';
                    }
                    html += set_window_html(data, column_index);
                    //特准供应商标志
                    if (data.authorize_flag == 'Y') {
                        html += '<div class="authorize-vendor">特</div>';
                    }
                    if(data.black_list_flag == 'Y'){
                        html += '<div class="black-circle">黑</div>';
                    }
                    html += '</div></li>';
                    g_window_index++;
                }
                body.innerHTML = html;
            }
            
            function processQuickLink(_this) {
                var type = _this.getAttribute('type');
                /* if (type == 'DOWNGRADE' || type == 'ELIMINATE') {
                    downStage(_this);
                } else {
                    upStage(_this);
                } */
            }
            
            function set_window_html(data, column_index) {
                var html = '',
                    className;
                var grade = {
                    up: null,
                    down: [],
                    onway: false,
                    column: column_index,
                    index: g_window_index
                };
                var index = g_stage_code.indexOf(data.stage_code);
                if (Aurora.isEmpty(data.document_type)) {
                    className = 'up_down';
                    grade.onway = false;
                } else {
                    className = 'up_down not';
                    grade.onway = true;
                }
                html = '<div id="window_' + g_window_index + '" class="window"><ul>';
                //升级
                if (data.stage_code != 'ELIMINATED') {
                    html += '<li id="window_upgrade_' + g_window_index + '"><span>升级至</span>';
                    if (data.authorize_flag == 'Y' || (data.introduction_request == 'COMMON' && data.stage_code == 'RECOMMEND')) {
                        //特准供应商直接升级到合格供应商
                        if ((data.document_type == 'UPGRADE' && data.stage_to == g_stage_code[3]) || Aurora.isEmpty(data.document_type)) {
                            html += '<ul><li class="up_down" vendor_id="' + data.vendor_id + '" to_index="3" from_index="' + index + '" document_id="' + ((Aurora.isEmpty(data.document_header_id)) ? '' : data.document_header_id) + '" onclick="upStage(this)">' + g_stage_name[3] + '</li></ul>';
                            grade.up = 3;
                        } else {
                            html += '<ul><li class="' + className + '">' + g_stage_name[3] + '</li></ul>';
                            grade.up = null;
                        }
                    } else {
                        if ((data.document_type == 'UPGRADE' && data.stage_to == g_stage_code[index + 1]) || Aurora.isEmpty(data.document_type)) {
                            html += '<ul><li class="up_down" vendor_id="' + data.vendor_id + '" to_index="' + (index + 1) + '" from_index="' + index + '" document_id="' + ((Aurora.isEmpty(data.document_header_id)) ? '' : data.document_header_id) + '" onclick="upStage(this)">' + g_stage_name[index + 1] + '</li></ul>';
                            grade.up = index + 1;
                        } else {
                            html += '<ul><li class="' + className + '">' + g_stage_name[index + 1] + '</li></ul>';
                            grade.up = null;
                        }
                    }
                    html += '</li>';
                }
                //降级
                html += '<li id="window_downgrade_' + g_window_index + '"><span onmouseover="">升级至</span><ul>';
                 
                 //if(data.stage_code == 'ELIMINATED'){
                    
                 
                for (var i = 0;i < index;i++) {
                    if (((data.introduction_request == 'STRICT' || g_stage_code[i] != 'POTENTIAL') && (data.authorize_flag == 'N')) || (data.authorize_flag == 'Y' && g_stage_code[i] == 'REGISTER')) {
                        if ((data.document_type == 'DOWNGRADE' && data.stage_to == g_stage_code[i]) || Aurora.isEmpty(data.document_type)) {
                            html += '<li class="up_down" vendor_id="' + data.vendor_id + '" from_index="' + index + '" to_index="' + i + '" onclick="downStage(this)">' + g_stage_name[i] + '</li>';
                            grade.down.push(i);
                        } else {
                            html += '<li class="' + className + '">' + g_stage_name[i] + '</li>';
                        }
                    }
                }
                 
                if ((data.document_type == 'ELIMINATE' && data.stage_to == 'ELIMINATED') || Aurora.isEmpty(data.document_type)) {
                    //html += '<li class="up_down" vendor_id="' + data.vendor_id + '" from_index="' + index + '" to_index="-1" onclick="downStage(this)">淘汰供应商</li>';
                    grade.down.push(-1);
                } else {
                    html += '<li class="' + className + '">淘汰供应商</li>';
                }
                
                html += '</ul></li>';
                 //}
                if(data.stage_code=='ELIMINATED'){
                    html+='<li vendor_id="' + data.vendor_id + '" onclick="blackListFunction(this)">黑名单</li>';
                }
                html+='</ul></div>';
                g_window.push(grade);
                return html;
            }
            
            //升级操作
            
            function upStage(_this) {
                var index = _this.getAttribute('to_index');
                var from_index = _this.getAttribute('from_index');
                  g_to_index = _this.getAttribute('to_index');
                  g_from_index = _this.getAttribute('from_index');
                 
                var vendor_id = _this.getAttribute('vendor_id');
                var header_id = _this.getAttribute('document_id');
                var stage_role, records, data, i, win_id, title, url;
                //升级 储备>合格  合格>淘汰 
                if(index==1&&from_index==0){
                   win_id = 'wzpur5800_supplier_stage_change_win';
                    title = '合格供应商申请创建';
                    url = $('wzpur5800_supplier_stage_change_req_modify_link').getUrl() + '?vendor_id=' + vendor_id; 
                }else if(index==2&&from_index==1){
                    win_id = 'wzpur5800_supplier_stage_change_win';
                    title = '淘汰供应商申请创建';
                    url = $('wzpur5800_supplier_stage_change_req_modify_link').getUrl() + '?vendor_id=' + vendor_id; 
                }else{
                   Aurora.showMessage('${l:PROMPT}', '无法进行此项调整！');
                   return; 
                }
                
                var win = new Aurora.Window({
                    id: win_id,
                    title: title,
                    url: url,
                    width:800,
                    height:410
                }).on('close', function() {
                    PUR5800_query();
                });
            }
            
            function downStage(_this) {
                var from = _this.getAttribute('from_index');
                var to = _this.getAttribute('to_index');
                g_from_index=from;
                g_to_index=to;
                if((from==2&&to==0)||(from==1&&to==0)){
                    //不能 淘汰》储备
                    Aurora.showMessage('${l:PROMPT}', '无法进行此项调整！');
                    PUR5800_query();
                    return;
                }
                var vendor_id = _this.getAttribute('vendor_id');
                var data, downgrade_id, process_type;
                var stage_role = '${/model/pur5800_ven_stage_role/record/@vendor_relegation}';
                if (stage_role != 'Y') {
                    Aurora.showMessage('${l:PROMPT}', '无法进行此项调整！');
                    return;
                }
                if (from == 0) {
                    data = get_dataSetJsonData($('wz_PUR5800_register_ds'), vendor_id);
                    downgrade_id = data.document_header_id;
                } else if (from == 1) {
                    data = get_dataSetJsonData($('wz_PUR5800_qualified_ds'), vendor_id);
                    downgrade_id = data.document_header_id;
                } else if (from == 2) {
                    data = get_dataSetJsonData($('wz_PUR5800_eliminated_ds'), vendor_id);
                    downgrade_id = data.document_header_id;
                }
                if (to == '-1') {
                    process_type = 'ELIMINATE';
                } else {
                    process_type = 'DOWNGRATE';
                }
            
                var win_id = 'wzpur5800_supplier_stage_change_win';
                var title = '${l:PUR5770.VENDOR_DEMOTION_APPLICATION}';
                var url = $('wzpur5800_supplier_stage_change_req_modify_link').getUrl();
            
                //降级明细页面
                if (Aurora.isEmpty(downgrade_id)) {
                    url = url + '?vendor_id=' + vendor_id + '&process_type=' + process_type + '&downgrade_to=' + getVendorLifeCyle(to);
                } else {
                    url = url + '?vendor_id=' + vendor_id + '&process_type=' + process_type + '&downgrade_to=' + getVendorLifeCyle(to) + '&downgrade_id=' + downgrade_id;
                }
                var win = new Aurora.Window({
                    id: win_id,
                    title: title,
                    url: url,
                    width:800,
                    height:410
                }).on('close', function() {
                    PUR5800_query();
                });
            }
            
            function getVendorLifeCyle(index) {
                var code = '';
                switch (index) {
                case '2':
                    code = 'ELIMINATED';
                    break;
                case '0':
                    code = 'REGISTER';
                    break;
                case '1':
                    code = 'QUALIFIED';
                    break;
                default:
                    code = '';
                    break;
                }
                return code;
            }
            
            function get_dataSetJsonData(dataSet, vendor_id) {
                var records = dataSet.getAll();
                for (var i = 0;i < records.length;i++) {
                    var data = records[i].data;
                    if (data.vendor_id == vendor_id) {
                        return data;
                    }
                }
                return null;
            }
            
            function open_vendor_detail(_this) {
                new Aurora.Window({
                    url: $('wz_pur5800_com_supplier_detail_link').getUrl() + '?coop_company_id=' + _this.parentNode.id,
                    id: 'pur5660_com_supplier_window',
                    fullScreen: true
                });
            }
            
            function label_click(_this, stage_code) {
                var icon = _this.children[0];
                var window = _this.nextSibling;
                var li = _this.parentNode.parentNode;
                if (window.style.display != 'block') {
                    //关闭其他打开的窗口,打开此窗口
                    close_window();
                    window.style.display = 'block';
                    var className = labelClickPositionOptimization(_this);
                    window.className = className;
                    //设置z-index样式
                    li.style.zIndex = '2';
                } else {
                    window.style.display = 'none';
                    //设置z-index样式
                    li.style.zIndex = '1';
                }
            }
            
            function labelClickPositionOptimization(_this) {
                var window = _this.nextSibling;
                var index = _this.parentNode.getAttribute('column_index');
                var column = getId('content_' + index).children[1];
                var bottom = offsetTop_toBody(column) + column.offsetHeight;
                window.className = 'window';
                var window_b = jQuery('#' + window.id).offset().top + window.offsetHeight;
                if (window_b >= bottom) {
                    return 'window top';
                } else {
                    return 'window';
                }
            }
            
            function el_vendor_click(_this) {
                var obj = _this.nextSibling;
                if (obj.style.display != 'block') {
                    obj.style.display = 'block';
                } else {
                    obj.style.display = 'none';
                }
            }
            
            function close_window() {
                for (var i = 0;i < g_window_index;i++) {
                    var window = getId('window_' + i);
                    if (window.style.display == 'block') {
                        label_click(window.previousSibling);
                    }
                }
                close_eliminated_window();
            }
            
            function register_vendor_load(dataset) {
                var records = dataset.getAll();
                var body = getId('register_ul');
                get_vendor_html(body, records, 0);
                //申请查看权限设置
                var btn = getId('register_title');
                btn.innerHTML = '注册供应商(' + records.length + ')';
                if (registered_query_role != 'Y') {
                    btn.nextSibling.style.display = 'none';
                }
                g_load_flag.register = true;
                dataLoadSuccess();
                Aurora.Masker.unmask(Ext.getBody());
            }
            
 
            
            function qualified_vendor_load(dataset) {
                var records = dataset.getAll();
                var body = getId('qualified_ul');
                get_vendor_html(body, records, 1);
                var btn = getId('qualified_title');
                btn.innerHTML = '合格供应商(' + records.length + ')';
                if (qualified_query_role != 'Y') {
                    btn.nextSibling.style.display = 'none';
                }
                g_load_flag.qualified = true;
                dataLoadSuccess();
                Aurora.Masker.unmask(Ext.getBody());
            }
            
            function eliminated_vendor_load(dataset) {
                var records = dataset.getAll();
                var body = getId('eliminated_ul');
                get_vendor_html(body, records, 2);
                var btn = getId('eliminated_title');
                btn.innerHTML = '淘汰供应商(' + records.length + ')';
                if (eliminated_query_role != 'Y') {
                    btn.nextSibling.style.display = 'none';
                }
                g_load_flag.eliminated = true;
                dataLoadSuccess();
                 
            }
            
            function eliminated_vendor_load1(dataset) {
                var records = dataset.getAll();
                var ul = getId('el_vendor_list');
                var html = '';
                for (var i = 0;i < records.length;i++) {
                    var data = records[i].data;
                    if (i == records.length - 1) {
                        html += '<li class="block last-el-li"><div class="left-el">';
                    } else {
                        html += '<li class="block"><div class="left-el">';
                    }
                    html += '<div class="el-code" id="' + data.cooper_company_id + '"><a onclick="open_vendor_detail(this)">' + data.display_vendor_code + '</a></div>';
                    html += '<div class="el-name">' + data.full_name + '</div>';
                    html += '</div><div class="el-vendor-upgrade" onclick="labelClickInEL(this)"><i class="icon-reorder"></i></div>';
                    html += '<div class="window"><ul><li vendor_id="' + data.vendor_id + '" to_index="0" from_index="-1" onclick="upStage(this)">升级</li><li vendor_id="' + data.vendor_id + '" onclick="blackListFunction(this)">黑名单</li></ul></div>';
                    if(data.black_list_flag == 'Y'){
                        html += '<div class="black-circle">黑</div>';
                    }
                    html += '</li>';
                }
                ul.innerHTML = html;
                var btn = getId('el_vendor_name');
                btn.nextSibling.children[1].innerHTML = records.length;
                if (eliminated_query_role != 'Y') {
                    btn.innerHTML = '淘汰供应商';
                    btn.onclick = null;
                } else {
                    btn.innerHTML = '淘汰供应商(查看申请)';
                }
                dataLoadSuccess();
            }
            
            function labelClickInEL(_this) {
                var window = _this.nextSibling;
                if (window.style.display != 'block') {
                    //关闭其他打开的窗口,打开此窗口
                    close_window();
                    window.style.display = 'block';
                } else {
                    window.style.display = 'none';
                }
            }
            
            function close_eliminated_window(){
                var ul = getId('el_vendor_list');
                var children = ul.children;
                var length = children.length;
                for(var i = 0;i < length;i ++){
                    children[i].children[2].style.display = 'none';
                }
            }
            
            function blackListFunction(_this) {
                new Aurora.Window({
                    id: 'pur5800_vendor_black_list_window',
                    title: '黑名单设置',
                    url: $('wz_pur5800_black_list_link').getUrl() + '?coop_company_id=' + _this.getAttribute('vendor_id'),
                    width: '500',
                    height: '250'
                }).on('close', function() {
                    PUR5800_query();
                    //$('wz_PUR5800_eliminated_ds').query();
                });
            }
            
            //移动
            var move = {
                dragInter: null,
                onmoveobj: null,
                movetarget: null,
                onmoveflag: false,
                to_column_index: null,
                x: null,
                y: null
            };
            
            function moveSetInit() {
                move = {
                    dragInter: null,
                    onmoveobj: null,
                    movetarget: null,
                    onmoveflag: false,
                    to_column_index: null,
                    x: null,
                    y: null,
                    name: null
                };
            }
            
            function dataLoadSuccess() {
                if (g_load_flag.register && g_load_flag.qualified && g_load_flag.eliminated) {
                    //加载移动配置
                    var index = 0;
                    //注册供应商
                    for (var i = 0;i < g_window_index;i++) {
                        var div = getId('vendor_block_' + i);
                        ininMoveDown(div);
                        initMoveUp(div);
                    }
                    Aurora.Masker.unmask(Ext.getBody());
                }
            }
            
            function ininMoveDown(obj) {
                obj.onmousedown = function(e) {
                    //move.onmoveflag = true;
                    e = window.event || e;
                    //点击范围判定
                    var tgr = e.target || e.srcElement;
                    var e_which = e.which || e.button;
                    if (e_which != 1 || tgr.tagName == 'A' || tgr.tagName == 'I' || tgr.tagName == 'LI' || tgr.className == 'on-grade-blue' || tgr.className == 'on-grade-red') {
                        return;
                    }
                    //判断是长按还是短按（以800ms为界限）
                    move.onmoveobj = this;
                    move.movetarget = this;
                    move.x = jDawn.getEvent(e || window.event).x;
                    move.y = jDawn.getEvent(e || window.event).y;
                    this.onmouseout = function(e) {
                        clearInterval(move.dragInter);
                        onMouseUpOperation();
                    };
                    move.dragInter = setInterval(function() {
                        clearInterInLongPush();
                        move.onmoveflag = true;
                        move.to_column_index = move.onmoveobj.getAttribute('column_index');
                        move.onmoveobj.onmouseout = null;
                        divMouseDown();
                    }, 0);
                };
            }
            
            function initMoveUp(obj) {
                getId('vendor_main_body').onmouseup = function(e) {
                    clearInterInLongPush();
                    onMouseUpOperation();
                };
            }
            
            function clearInterInLongPush() {
                clearInterval(move.dragInter);
            }
            
            function onMouseUpOperation() {
                if (move.onmoveflag) { 
                    divMouseUp();
                    //移动后的后续操作
                    var column_before = move.movetarget.getAttribute('column_index');
                    var column_after = move.to_column_index;
                    var operation_type;
                    var _obj;
                    var index = move.movetarget.getAttribute('index');
                    var name = move.movetarget.children[0].children[1].innerHTML;
                    move.movetarget.setAttribute('column_index', move.to_column_index);
                    if (column_after > column_before) {
                        operation_type='升级';
                        if(column_after==2){
                            operation_type='降级';
                        }
                        //升级
                        Aurora.showConfirm('提示', '确定要对【' + name + '】进行'+operation_type+'操作?', function() {
                            _obj = getId('window_upgrade_' + index).children[1].children[0];
                            upStage(_obj);
                        }, function() {
                            PUR5800_query();
                        }).on('close', function() {
                            PUR5800_query();
                        });
            
                    } else if (column_after < column_before) {
                        //降级
                        operation_type='降级';
                        if(column_before==2){
                            operation_type='升级';
                        }
                        Aurora.showConfirm('提示', '确定要对【' + name + '】进行'+operation_type+'操作?', function() {
                            _obj = getId('window_downgrade_' + index).children[1].children[column_after];
                            downStage(_obj);
                        }, function() {
                            PUR5800_query();
                        }).on('close', function() {
                            PUR5800_query();
                        });
            
                    }
                    moveSetInit();
                }
            }
            
            function divMouseUp() {
                //虚线框归位
                var o = move.movetarget.parentNode;
                var d = getId('window_dashed');
                o.style.display = 'block';
                d.parentNode.insertBefore(o, d);
                d.parentNode.removeChild(d);
                //样式重置
                var columns = getId('vendor_main_body').children[0].children;
                for (var i = 0;i < columns.length - 2;i++) {
                    columns[i].style.zIndex = '0';
                }
                var mask = getId('vendor_mask');
                mask.style.display = 'none';
                var vendor_move = getId('vendor_move');
                vendor_move.style.display = 'none';
                vendor_move.innerHTML = '';
                getId('vendor_main_body').onmousemove = null;
            }
            
            function divMouseDown(e) {
                var _this = move.onmoveobj;
                var index = _this.getAttribute('index');
                var column_index = _this.getAttribute('column_index');
                var columns = getId('vendor_main_body').children[0].children;
                var column = columns[column_index];
                //判断是否已提交申请
                if (g_window[index].onway) {
                    Aurora.showMessage('提示', '正在申请中！');
                    move.onmoveobj = null;
                    move.onmoveflag = false;
                    move.to_column_index = null;
                    return;
                }
                //设置移动本体和移动方向的column样式
                var mask = getId('vendor_mask');
                mask.style.display = 'block';
                column.style.zIndex = '11';
                setMoveDirectionColumnCss(index, column_index);
                //移动操作，先设置移动本体下方的虚线框
                var x = move.x;
                var y = move.y;
                createDashDiv(column);
                //initMoveUp(move.onmoveobj);
                var left = move.onmoveobj.offsetLeft;
                var top = move.onmoveobj.offsetTop;
                var width = move.onmoveobj.offsetWidth;
                var height = move.onmoveobj.offsetHeight;
                getId('vendor_main_body').onmousemove = function(e) {
                    if (move.onmoveflag) {
                        e = window.event || e;
                        var e_which = e.which || e.button;
                        //移动中判判断鼠标状态
                        if (e_which == 0) {
                            clearInterInLongPush();
                            onMouseUpOperation();
                        }
                        var _this = move.onmoveobj;
                        var eX = jDawn.getEvent(e || window.event).x;
                        var eY = jDawn.getEvent(e || window.event).y;
                        var l = eX - x; //移动后的相对容器的x距离
                        var t = eY - y; //移动后的相对容器的y距离
                        _this.style.left = l + left + 'px';
                        _this.style.top = t + top + 'px';
                        var ml = offsetLeft_toBody(_this) + width / 2;
                        var mt = offsetTop_toBody(_this) + height / 2;
                        //遍历挤压其他容器
                        for (var i = 0;i < 3;i++) {
                            var div = getId('content_' + i);
                            var _l = offsetLeft_toBody(div);
                            var _r = _l + div.offsetWidth;
                            var _t = offsetTop_toBody(div);
                            var _b = _t + div.offsetHeight;
                            if (ml > _l && ml < _r && mt > _t && mt < _b) {
                                var column_index = div.getAttribute('index');
                                if (judgeColumnActive(column_index, move.onmoveobj.children[0].getAttribute('index'))) {
                                    changePosition(div);
                                }
                            }
                        }
                    }
                };
            
            }
            
            function setMoveDirectionColumnCss(index, column_index) {
                for (var n = 0;n < g_window.length;n++) {
                    if (g_window[n].index == index) {
                        var a = g_window[n];
                    }
                }
                var columns = getId('vendor_main_body').children[0].children;
                if (!Aurora.isEmpty(a.up)) {
                    columns[a.up].style.zIndex = '11';
                }
                for (var i = 0;i < a.down.length;i++) {
                    //不包括淘汰的
                    if (a.down[i] != -1) {
                        columns[a.down[i]].style.zIndex = '11';
                    }
                }
            }
            
            function createDashDiv(column) {
                var div = document.createElement('li');
                var ul = column.children[1].children[0];
                var obj = move.onmoveobj.parentNode;
                div.className = 'dashed';
                div.id = 'window_dashed';
                ul.insertBefore(div, obj);
                var vendor_move = getId('vendor_move');
                vendor_move.style.display = 'block';
                vendor_move.innerHTML = obj.innerHTML;
                vendor_move.style.width = obj.offsetWidth + 'px';
                vendor_move.style.height = obj.offsetHeight + 'px';
                jQuery('#vendor_move').offset(jQuery('#window_dashed').offset());
                obj.style.display = 'none';
                move.onmoveobj = vendor_move;
                column.style.zIndex = '12';
            }
            
            function judgeColumnActive(column_index, index) {
                var array = g_window[index];
                if (column_index == move.onmoveobj.children[0].getAttribute('column_index')) {
                    var content = getId('content_' + column_index).children[1].children[0];
                    for (var j = 0;j < content.children.length;j++) {
                        if (content.children[j].className == 'dashed') {
                            return false;
                        }
            
                    }
                    return true;
                }
                if (array.up == column_index) {
                    return true;
                } else {
                    for (var i = 0;i < array.down.length;i++) {
                        if (array.down[i] == column_index) {
                            return true;
                        }
                    }
                }
                return false;
            }
            
            function changePosition(obj) {
                var dashed = getId('window_dashed');
                //交换时禁止移动
                move.onmoveflag = false;
                obj.children[1].children[0].appendChild(dashed);
                //交换结束
                move.onmoveflag = true;
                move.to_column_index = obj.getAttribute('index');
            }
            
            function clone(obj) {
                var li = document.createElement('li');
                li.id = 'window_clone_li';
                li.style.height = '54px';
                obj.parentNode.insertBefore(li, obj);
                return li;
            }
            
            //利用js的offsetWidth算出目标距离最左边的距离
            
            function offsetLeft_toBody(_this) {
                var offset_left = _this.offsetLeft;
                while (_this.offsetParent != null) {
                    offset_left += (_this.offsetParent.offsetLeft != null) ? _this.offsetParent.offsetLeft : 0;
                    _this = _this.offsetParent;
                }
                return offset_left;
            }
            //利用js的offsetTop算出目标距离最上边的距离
            
            function offsetTop_toBody(_this) {
                var offset_top = _this.offsetTop;
                while (_this.offsetParent != null) {
                    offset_top += (_this.offsetParent.offsetTop != null) ? _this.offsetParent.offsetTop : 0;
                    _this = _this.offsetParent;
                }
                return offset_top;
            }
        ]]></script>
        <a:dataSets>
            <a:dataSet id="wz_pur5720_price_level_ds">
                <a:datas dataSource="PUR5720_price_level_data"/>
            </a:dataSet>
            <a:dataSet id="wz_PUR5720_status_ds">
                <a:datas dataSource="PUR5720_status_data"/>
            </a:dataSet>
            <a:dataSet id="wz_pur5720_market_competition_ds">
                <a:datas dataSource="pur5720_market_competition_data"/>
            </a:dataSet>
            <!-- <a:dataSet id="wz_pur5720_price_level_ds">
                <a:datas dataSource="pur5720_price_level_data"/>
            </a:dataSet> -->
            <a:dataSet id="wz_pur5720_vendor_recommend_status_ds">
                <a:datas dataSource="pur5720_vendor_recommend_status_data"/>
            </a:dataSet>
            <a:dataSet id="wz_pur5740_potential_vendor_status_ds">
                <a:datas dataSource="qms5740_potential_vendor_status_data"/>
            </a:dataSet>
            <a:dataSet id="wz_pur5760_qualified_vendor_status_ds">
                <a:datas dataSource="pur5760_qualified_vendor_status_data"/>
            </a:dataSet>
            <a:dataSet id="wz_pur5770_downgrade_status_ds">
                <a:datas dataSource="pur5770_downgrade_status_data"/>
            </a:dataSet>
            <a:dataSet id="wz_pur5770_downgrade_process_type_ds">
                <a:datas dataSource="pur5770_downgrade_process_type_data"/>
            </a:dataSet>
            <a:dataSet id="wz_pur5770_vendor_life_cycle_ds">
                <a:datas dataSource="pur5770_vendor_life_cycle_data"/>
            </a:dataSet>
            <a:dataSet id="wz_pur5770_vendor_life_cycle_maintain_ds">
                <a:datas dataSource="pur5770_vendor_life_cycle_maintain_data"/>
            </a:dataSet>
            <a:dataSet id="wz_PUR5800_query_ds" autoCreate="true">
                <a:fields>
                    <a:field name="vendor_desc"/>
                </a:fields>
            </a:dataSet>
            <a:dataSet id="wz_PUR5800_register_ds" autoCount="true" autoQuery="true" fetchAll="true" model="cux.WZ.PUR.WZPUR5800.wz_pur_vendor_life_cycle" queryDataSet="wz_PUR5800_query_ds" queryUrl="${/request/@context_path}/autocrud/cux.WZ.PUR.WZPUR5800.wz_pur_vendor_life_cycle/query?stage_code=REGISTER">
                <a:events>
                    <a:event name="load" handler="register_vendor_load"/>
                </a:events>
            </a:dataSet>
            <!--  <a:dataSet id="wz_PUR5800_recommend_ds" autoCount="true" autoQuery="true" fetchAll="true" model="cux.WZ.PUR.WZPUR5800.wz_pur_vendor_life_cycle" queryDataSet="wz_PUR5800_query_ds" queryUrl="${/request/@context_path}/autocrud/cux.WZ.PUR.WZPUR5800.wz_pur_vendor_life_cycle/query?stage_code=RECOMMEND">
                <a:events>
                    <a:event name="load" handler="recommend_vendor_load"/>
                </a:events>
            </a:dataSet>
            <a:dataSet id="wz_PUR5800_potential_ds" autoCount="true" autoQuery="true" fetchAll="true" model="cux.WZ.PUR.WZPUR5800.wz_pur_vendor_life_cycle" queryDataSet="wz_PUR5800_query_ds" queryUrl="${/request/@context_path}/autocrud/cux.WZ.PUR.WZPUR5800.wz_pur_vendor_life_cycle/query?stage_code=POTENTIAL">
                <a:events>
                    <a:event name="load" handler="potential_vendor_load"/>
                </a:events>
            </a:dataSet> -->
            <a:dataSet id="wz_PUR5800_qualified_ds" autoCount="true" autoQuery="true" fetchAll="true" model="cux.WZ.PUR.WZPUR5800.wz_pur_vendor_life_cycle" queryDataSet="wz_PUR5800_query_ds" queryUrl="${/request/@context_path}/autocrud/cux.WZ.PUR.WZPUR5800.wz_pur_vendor_life_cycle/query?stage_code=QUALIFIED">
                <a:events>
                    <a:event name="load" handler="qualified_vendor_load"/>
                </a:events>
            </a:dataSet>
            <a:dataSet id="wz_PUR5800_eliminated_ds" autoCount="true" autoQuery="true" fetchAll="true" model="cux.WZ.PUR.WZPUR5800.wz_pur_vendor_life_cycle" queryDataSet="wz_PUR5800_query_ds" queryUrl="${/request/@context_path}/autocrud/cux.WZ.PUR.WZPUR5800.wz_pur_vendor_life_cycle/query?stage_code=ELIMINATED">
                <a:events>
                    <a:event name="load" handler="eliminated_vendor_load"/>
                </a:events>
            </a:dataSet>
            <a:dataSet id="wz_PUR5800_eliminated1_ds" autoCount="true" autoQuery="true" fetchAll="true" model="cux.WZ.PUR.WZPUR5800.wz_pur_vendor_life_cycle" queryDataSet="wz_PUR5800_query_ds" queryUrl="${/request/@context_path}/autocrud/cux.WZ.PUR.WZPUR5800.wz_pur_vendor_life_cycle/query?stage_code=ELIMINATED">
                <a:events>
                    <a:event name="load" handler="eliminated_vendor_load1"/>
                </a:events>
            </a:dataSet>
        </a:dataSets>
        <div class="vendor-query-form">
            <div id="vendor_query_form" class="query">
                <a:queryForm id="wz_pur5800_queryForm" bindTarget="wz_PUR5800_query_ds" defaultQueryField="vendor_desc" defaultQueryHint="供应商编码或描述" queryhook="PUR5800_query" resultTarget="wz_PUR5800_register_ds"/>
            </div>
            <div class="el-vendor" style="display:none;">
                <span id="el_vendor_name" class="vendor-name" onclick="wz_pur5800_vendor_query(&apos;ELIMINATED&apos;)"><![CDATA[淘汰供应商(查看申请)]]></span>
                <span class="icon-btn" onclick="el_vendor_click(this)">
                    <i class="icon-angle-down"/>
                    <span/>
                </span>
                <div class="el-vendor-list">
                    <ul id="el_vendor_list"/>
                </div>
            </div>
            <div style="clear:both"/>
        </div>
        <div id="vendor_main_body" class="v-body">
            <div class="main-v-body">
                <div id="content_0" class="v-column" index="0">
                    <div class="head">
                        <div id="register_title" class="left title"><![CDATA[注册供应商]]></div>
                        <div class="right button" onclick="wz_pur5800_vendor_query(&apos;REGISTER&apos;)"><![CDATA[查看申请]]></div>
                    </div>
                    <div class="content">
                        <ul id="register_ul"/>
                    </div>
                    <div id="page_break_con_register" class="vendor-page-break"/>
                </div>
                <div id="content_1" class="v-column" index="1">
                    <div class="head">
                        <div id="qualified_title" class="left title"><![CDATA[合格供应商]]></div>
                        <div class="right button" onclick="wz_pur5800_vendor_query(&apos;QUALIFIED&apos;)"><![CDATA[查看申请]]></div>
                    </div>
                    <div class="content">
                        <ul id="qualified_ul"/>
                    </div>
                </div>
                <div id="content_2" class="v-column last" index="2">
                    <div class="head">
                        <div id="eliminated_title" class="left title"><![CDATA[淘汰供应商]]></div>
                        <div class="right button" onclick="wz_pur5800_vendor_query(&apos;ELIMINATED&apos;)"><![CDATA[查看申请]]></div>
                    </div>
                    <div class="content">
                        <ul id="eliminated_ul"/>
                    </div>
                </div>
                <div id="vendor_mask" class="mask"/>
                <div id="vendor_move"/>
            </div>
        </div>
        <script><![CDATA[
            Aurora.onReady(function() {
                init();
            });
        ]]></script>
    </a:view>
</a:screen>
