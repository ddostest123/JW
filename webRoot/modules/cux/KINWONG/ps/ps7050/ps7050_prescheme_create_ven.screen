<?xml version="1.0" encoding="UTF-8"?>
<!--
    $Author: 孙超超  
    $Date: 2018-12-3 上午9:49:14  
    $Revision: 1.0  
    $Purpose: 
-->
<a:screen xmlns:a="http://www.aurora-framework.org/application" trace="true">
    <a:view>
        <a:link id="ps7050_edit_prescheme_save_link" url="${/request/@context_path}/modules/cux/KINWONG/ps/ps7050/ps7050_prescheme_save.svc"/>
        <a:link id="ps7050_prescheme_execute_link" model="cux.KINWONG.ps.ps7050.ps7050_prescheme_query" modelaction="execute"/>
        <style><![CDATA[
.contain {
padding:3px;
background:white;
font-size:9pt;
border-width:1px 2px 2px 1px;
border-style:solid;
left:20; 
margin-left:-418px;
margin-top:16px;
position:absolute;
display:none;
z-index:9999;
overflow:auto;
max-width:450px;
max-height:100px;
}
]]></style>
        <script><![CDATA[
            var mix = 0;
            var sum = 0;
            var subtotal = 0;
            var total = 0;
            var sum_quantities_stack = {};
            var sum_subtotal = 0;
            var sum_total = 0;
            var map = {
                'risk_cost': 0,
                'materials_cost': 0,
                'artificial_cost': 0,
                'mechanical_cost': 0,
                'management_cost': 0,
                'profits': 0
            };
            
            
            //加法
            
            function ps7050_accAdd(arg1, arg2) {
                var r1, r2, m, c;
                try {
                    r1 = arg1.toString().split(".")[1].length;
                } catch (e) {
                    r1 = 0;
                }
                try {
                    r2 = arg2.toString().split(".")[1].length;
                } catch (e) {
                    r2 = 0;
                }
                c = Math.abs(r1 - r2);
                m = Math.pow(10, Math.max(r1, r2));
                if (c > 0) {
                    var cm = Math.pow(10, c);
                    if (r1 > r2) {
                        arg1 = Number(arg1.toString().replace(".", ""));
                        arg2 = Number(arg2.toString().replace(".", "")) * cm;
                    } else {
                        arg1 = Number(arg1.toString().replace(".", "")) * cm;
                        arg2 = Number(arg2.toString().replace(".", ""));
                    }
                } else {
                    arg1 = Number(arg1.toString().replace(".", ""));
                    arg2 = Number(arg2.toString().replace(".", ""));
                }
                return (arg1 + arg2) / m;
            
            }
            
            //乘法
            
            function ps7050_accMul(arg1, arg2) {
                var m = 0,
                    s1 = arg1.toString(),
                    s2 = arg2.toString();
                try {
                    m += s1.split(".")[1].length
                } catch (e) {}
                try {
                    m += s2.split(".")[1].length
                } catch (e) {}
                return Number(s1.replace(".", "")) * Number(s2.replace(".", "")) / Math.pow(10, m);
            
            }
            //取精度
            
            function ps7050_js_round(para1, para2) {
                return Math.round(ps7050_accMul(para1, Math.pow(10, para2))) / Math.pow(10, para2);
            }
            
            //除法
            
            
            
            function ps7050_accDiv(arg1, arg2) {
                var t1 = 0,
                    t2 = 0,
                    r1, r2;
                try {
                    t1 = arg1.toString().split(".")[1].length
                } catch (e) {}
                try {
                    t2 = arg2.toString().split(".")[1].length
                } catch (e) {}
                with(Math) {
                    r1 = Number(arg1.toString().replace(".", ""))
                    r2 = Number(arg2.toString().replace(".", ""))
                    return ps7050_js_round((r1 / r2) * pow(10, t2 - t1), 8);
                }
            
            }
            
            
            
            
            function init() {
                debugger;
                var prescheme_id = '${/parameter/@prescheme_id}';
                var line_vendor_id = '${/parameter/@line_vendor_id}';
                var status_code = '${/parameter/@status_code}';
                if (status_code == '10') {
                    $('ps7050_prescheme_head_ds').setQueryParameter('prescheme_id', prescheme_id);
                    $('ps7050_prescheme_head_ds').query();
                    $('ps7050_prescheme_line_roject_ds').setQueryUrl('${/request/@context_path}/autocrud/cux.KINWONG.ps.ps7010.ps7010_prescheme_line_eng/query?line_head_id=' + prescheme_id);
                    $('ps7050_prescheme_line_roject_ds').query();
                    //附件查询
                    $('ps7050_prescheme_files_ds').setQueryParameter('source_table_name', 'PS_PRESCHEME_HEAD.CREATE_FILE');
                    $('ps7050_prescheme_files_ds').setQueryParameter('source_pk_value', prescheme_id);
                    $('ps7050_prescheme_files_ds').query();
                } else {
                    $('ps7050_prescheme_head_ds').setQueryParameter('prescheme_id', prescheme_id);
                    $('ps7050_prescheme_head_ds').query();
                    $('ps7050_prescheme_line_roject_ds').setQueryParameter('prescheme_id', prescheme_id);
                    $('ps7050_prescheme_line_roject_ds').setQueryParameter('line_vendor_id', line_vendor_id);
                    $('ps7050_prescheme_line_roject_ds').query();
                    //附件查询
                    $('ps7050_prescheme_files_ds').setQueryParameter('source_table_name', 'PS_PRESCHEME_HEAD.VEN_FILE');
                    $('ps7050_prescheme_files_ds').setQueryParameter('source_pk_value', line_vendor_id);
                    $('ps7050_prescheme_files_ds').query();
                }
                if (status_code == '30' || status_code == '40') {
                    $('ps7050PreschemeSave_bt').disable();
                    $('ps7050_prescheme_submit_bt').disable();
                }
            
            }
            
            
            function ps7050_back() {
                query_ps7050_prescheme_query_result_ds();
                $('ps_prescheme_detail_window').close();
            }
            //保存
            
            function ps7050PreschemeSave() {
                var ds = $('ps7050_prescheme_head_ds');
            
                var lines_eng_ds = $('ps7050_prescheme_line_roject_ds');
                if (ds.validate() && lines_eng_ds.validate()) {
                    var record = ds.getCurrentRecord();
                    var records = lines_eng_ds.getAll();
                    var para = record.data;
                    para['eng_lines'] = lines_eng_ds.getJsonData(false);
                    var url;
                    url = $('ps7050_edit_prescheme_save_link').getUrl();
                    Aurora.Masker.mask($('ps_prescheme_detail_window').wrap, '正在提交...');
                    Aurora.request({
                        url: url,
                        para: para,
                        success: function(res) {
                            var prescheme_id = res.result.prescheme_id ? res.result.prescheme_id : '${/parameter/@prescheme_id}';
                            var line_vendor_id = res.result.line_vendor_id ? res.result.line_vendor_id : '${/parameter/@line_vendor_id}';
                            Aurora.showMessage('${l:PROMPT}', '${l:PROMPT.SAVE_SUCCESS}', function() {
                                ds.setQueryParameter('prescheme_id', prescheme_id);
                                ds.query();
                                lines_eng_ds.setQueryParameter('line_head_id', prescheme_id);
                                lines_eng_ds.setQueryParameter('line_vendor_id', line_vendor_id);
                                lines_eng_ds.query();
                                Aurora.Masker.unmask($('ps_prescheme_detail_window').wrap);
                            });
                        },
                        error: function() {
                            Aurora.Masker.unmask($('ps_prescheme_detail_window').wrap);
                        },
                        failure: function() {
                            Aurora.Masker.unmask($('ps_prescheme_detail_window').wrap);
                        },
                        scope: this
                    });
                }
            }
            
            function ps7050_prescheme_submit() {
                var record = $('ps7050_prescheme_head_ds').getCurrentRecord();
                var eng_lines = $('ps7050_prescheme_line_roject_ds');
                if (record.get('prescheme_id')) {
                    if (record.dirty) {
                        Aurora.showMessage('${l:PROMPT}', '数据未保存');
                        return;
                    }
                    //判断行数据是否发生更改
                    var records1 = eng_lines.getAll();
                    if (records1.length > 0) {
                        //判断数据是否已经保存
                        for (var i = 0;i < records1.length;i++) {
                            if (records1[i].dirty || !records1[i].get('line_eng_id')) {
                                Aurora.showMessage('${l:PROMPT}', '数据未保存');
                                return;
                            }
                        }
                    }
            
                    Aurora.showConfirm('${l:PROMPT}', '确定反馈？', function() {
                        Aurora.Masker.mask($('ps_prescheme_detail_window').wrap, '正在提交');
                        Aurora.request({
                            url: $('ps7050_prescheme_execute_link').getUrl(),
                            para: record.data,
                            success: function() {
                                Aurora.showMessage('${l:PROMPT}', '反馈成功', function() {
                                    Aurora.Masker.unmask($('ps_prescheme_detail_window').wrap);
                                    ps7050_back();
                                });
                            },
                            error: function() {
                                Aurora.Masker.unmask($('ps_prescheme_detail_window').wrap);
                            },
                            failure: function() {
                                Aurora.Masker.unmask($('ps_prescheme_detail_window').wrap);
                            },
                            scope: this
                        });
                    }, function() {}, 300, 100);
                } else {
                    Aurora.showMessage('${l:PROMPT}', '数据未保存');
                    return;
                }
            }
            
            function ps7050_create_files_ds_beforeCreate(ds, record, index) {
                var prescheme_id = $('ps7050_prescheme_head_ds').getCurrentRecord().get('prescheme_id');
                if (Aurora.isEmpty(prescheme_id)) {
                    Aurora.showMessage('${l:PROMPT}', '请先保存数据,再新附件行！');
                    return false;
                }
            }
            
            function ps7050_create_files_ds_add(ds, record, index) {
                var line_vendor_id = $('ps7050_prescheme_head_ds').getCurrentRecord().get('line_vendor_id');
                record.set('source_pk_value', line_vendor_id);
            }
            
            //附件下载
            
            function ps7050_upload_renderer(value, record, name) {
                var atm_line_id = record.get('atm_line_id');
                if (!record.isNew && atm_line_id) {
                    return '<a href="javascript:ps7050_upload_file(' + atm_line_id + ')">${l:ATM.UPLOAD_ATTACHMENT}</a>';
                }
            }
            
            function ps7050_upload_file(id) {
                var url = "${/request/@context_path}/uploadFile.screen?table_name=PS_PRESCHEME_HEAD.VEN_FILE&header_id=" + id;
                new Aurora.Window({
                    url: url,
                    title: '${l:ATM.UPLOAD_ATTACHMENT}',
                    id: 'ps7050_upload_window',
                    width: 850,
                    height: 500
                }).on('beforeclose', function() {
                    $('ps7050_prescheme_files_ds').query();
                });
            
            }
            
            function ps7050_upload_renderer2(value, record, name) {
                var atm_line_id = record.get('atm_line_id');
                if (!record.isNew && atm_line_id) {
                    return '<a href="javascript:ps7050_upload_file2(' + atm_line_id + ')">${l:ATM.UPLOAD_ATTACHMENT}</a>';
                }
            }
            
            function ps7050_upload_file2(id) {
                var url = "${/request/@context_path}/attachment_file_download.screen?table_name=PS_PRESCHEME_HEAD.CREATE_FILE&pkvalue=" + id;
                new Aurora.Window({
                    url: url,
                    title: '${l:ATM.UPLOAD_ATTACHMENT}',
                    id: 'ps7050_upload_window2',
                    width: 850,
                    height: 500
                }).on('beforeclose', function() {
                    $('ps7050_prescheme_files_readonly_ds').query();
                });
            
            }
            
            function ps7050_line_roject_ds_loadFcn() {
                debugger;
                var status_code = '${/parameter/@status_code}';
                if (status_code != '40') {
                    $('ps7050_prescheme_line_roject_grid').hideColumn('bargain_price');
                    $('ps7050_prescheme_line_roject_grid').hideColumn('bargain_price_reason');
                }
            }
            
            function getParentrecord(parent_data_id, records) {
                for (i = 0;i < records.length;i++) {
                    if (records[i].get('matching_code') + records[i].get('project_code') == parent_data_id) {
                        return records[i];
                    }
                }
                return null;
            }
            function getChildAll(parent_data_id, records) {
                var res = [];
                for (i = 0;i < records.length;i++) {
                    if (records[i].get('matching_code')== parent_data_id) {
                        res.push(records[i]);
                    }
                }
                return res;
            }
            
            
            var calculating = false;
            
            function callback1(record, name, value) {
                if (name == 'management_cost') {
                    var new_management_cost = record.get('management_cost') * (record.get('mechanical_cost') * 0.1 + record.get('artificial_cost'));
                    record.set('management_cost', declim2(new_management_cost));
                } else if (name == 'profits') {
                    var new_profits = (record.get('mechanical_cost') + record.get('artificial_cost') + record.get('main_material_cost') + record.get('management_cost') + record.get('assist_material_cost')) * record.get('profits');
                    record.set('profits', declim2(new_profits));
                }
            }
            
            function callback2(record, name, value) {
                if (name == 'management_cost') {
                    var new_management_cost = record.get('management_cost_temp');
                    record.set('management_cost', declim2(new_management_cost));
                } else if (name == 'profits') {
                    var new_profits = record.get('artificial_cost') * record.get('profits');
            
                    record.set('profits', declim2(new_profits));
                }
            }
            
            function callback3(record, name, value) {
                if (name == 'management_cost') {
                    var new_management_cost = record.get('management_cost') * record.get('artificial_cost');
                    record.set('management_cost', declim2(new_management_cost));
                } else if (name == 'profits') {
                    var new_profits = record.get('artificial_cost') * record.get('profits');
                    record.set('profits', declim2(new_profits));
                }
            
            
            }
            
            function doCallback(fn, args) {
                fn.apply(this, args);
            }
            
            function calculate_fun() {
                var place_list = {
                    '深圳': 'callback1',
                    '广东': 'callback2',
                    '江西': 'callback3'
                };
                var head_record = $('ps7050_prescheme_head_ds').getCurrentRecord();
                var place = head_record.get('area_desc');
                var line_ds = $('ps7050_prescheme_line_roject_ds');
                var records = line_ds.getAll();
                console.log(records);
                for (var i = 0;i < records.length;i++) {
                    if (records[i].get('category_level') == '2') {
                        calculating = true;
                        if (records[i].get('calculate_flag') == 'N') {
                            doCallback(eval(place_list[place]), [records[i], 'management_cost']);
                            records[i].set('calculate_flag', 'Y');
                        }
                        if (records[i].get('calculate_flag_2') == 'N') {
                            doCallback(eval(place_list[place]), [records[i], 'profits']);
                            records[i].set('calculate_flag_2', 'Y');
                        }
                        calculating = false;
            
                    }
                }
            }
            function ps7050_line_roject_ds_up(dataSet, record, name, value, oldvalue) {
				var level = record.get('category_level');
                var records = dataSet.getAll();
                if (level == '2') {
                    if (name == 'management_cost') {
                        if (!calculating) {
                            record.set('calculate_flag', 'N');
                            if (value != oldvalue) {
                                for (var i = 0;i < records.length;i++) {
                                    if (records[i].get('category_level') == '2') {
                                        records[i].set('management_cost', value);
                                    }
                                }
                            }
                        }
                    } else if (name == 'profits') {
                        if (!calculating) {
                            record.set('calculate_flag_2', 'N');
                            if (value != oldvalue) {
                                for (var i = 0;i < records.length;i++) {
                                    if (records[i].get('category_level') == '2') {
                                        records[i].set('profits', value);
                                    }
                                }
                            }
                        }
                    }
                } else if (level == '主材' && name == 'main_material_unit_price') {
                    var parent_record = getParentrecord(record.get('matching_code'), records);
                    var res = getChildAll(record.get('matching_code'), records);
                    var main_material_cost = 0;
                    for (var i = 0 ; i< res.length ; i++){
						var main_material_unit_price = res[i].get('main_material_unit_price');
						var main_material_loss_rate = res[i].get('main_material_loss_rate');
						if(main_material_unit_price && main_material_loss_rate){
						    main_material_cost += main_material_unit_price*main_material_loss_rate;
						}
                    }
                    parent_record.set('main_material_cost', declim2(main_material_cost));
                }               
            }
            
            function declim2(sum) {
                return Math.round(sum * 100) / 100;
            }
            
            function getnumber(name, record) {
                if (typeof(record.get(name)) != 'undefined' && !Ext.isEmpty(record.get(name))) {
                    return record.get(name);
                } else {
                    return 0;
                }
            }
            
            function getSum(val, oldVal, sum_x) {
                if (!oldVal) {
                    sum_x += val;
                } else {
                    sum_x += val - oldVal;
                }
                return sum_x;
            }
            
            function ps7050_line_ven_ds_cellclickFun(grid, row, name, record, value) {
                if (name == 'contact_person') {
                    record.getField('contact_person').setLovPara('vendor_company_id', record.get('vendor_id'));
                }
            }
            
            function ps7050_file_SubmitSuccess(dataset, res) {
                var record = $('ps7050_prescheme_head_ds').getCurrentRecord();
                var line_vendor_id = record.get('line_vendor_id');
                dataset.setQueryParameter('source_table_name', 'PS_PRESCHEME_HEAD.VEN_FILE');
                dataset.setQueryParameter('source_pk_value', line_vendor_id);
                dataset.query();
            }
            
            function ps7050_engineering_load_handler(ds) {
                debugger;
                var ps7050_prescheme_head_ds = $('ps7050_prescheme_head_ds').getCurrentRecord();
                var prescheme_id = ps7050_prescheme_head_ds.get('prescheme_id');
                var engineering_ds = ds.getAll();
                var ps7050_prescheme_line_roject_ds = $('ps7050_prescheme_line_roject_ds');
                for (var t = 0;t < engineering_ds.length;t++) {
                    var flag = 0;
                    var line_ds = ps7050_prescheme_line_roject_ds.getAll();
                    for (var i = 0;i < line_ds.length;i++) {
                        if (engineering_ds[t].get('data_id') == line_ds[i].get('data_id')) {
                            flag = 1;
                            return;
                        }
                    }
                    if (flag == 0) {
                        ps7050_prescheme_line_roject_ds.create({
                            'line_head_id': prescheme_id,
                            'project_code': engineering_ds[t].get('project_code'),
                            'expanded': 'Y',
                            'project_name': engineering_ds[t].get('project_name'),
                            'category_level': engineering_ds[t].get('category_level'),
                            'parent_data_id': engineering_ds[t].get('parent_date_id'),
                            'data_id': engineering_ds[t].get('data_id'),
                            'project_uom_name': engineering_ds[t].get('project_uom_name'),
                            'project_characteristi': engineering_ds[t].get('project_characteristi'),
                            'project_uom_code': engineering_ds[t].get('project_uom_code')
                        });
                    }
                }
                for (var i = 0;i < engineering_ds.length;i++) {
                    ps7050_prescheme_line_roject_ds.pre();
                }
            }
            
            function ps7050_PreschemeTreegridEditorFunction2(record, name) {
                var status_code = '${/parameter/@status_code}';
                if (status_code != '40') {
                    return '';
                } else {
                    if (name == 'bargain_price') {
                        return 'ps7050_edit_line_roject_nf1';
                    }
                    if (name == 'bargain_price_reason') {
                        return 'ps7050_edit_line_roject_nf2';
                    }
                }
            }
            
            function ps7050_PreschemeTreegridEditorFunction(record, name) {
            
                var level = record.get('category_level');
                if (level == 1) {
                    if (name == 'quantities') {
                        return 'ps7050_edit_line_roject_nf4';
            
                    }
                    if (name == 'artificial_cost') {
                        return 'ps7050_edit_line_roject_nf3';
                    }
            
                    if (name == 'materials_cost') {
                        return 'ps7050_edit_line_roject_nf3';
                    }
            
                    if (name == 'mechanical_cost') {
                        return 'ps7050_edit_line_roject_nf3';
                    }
            
                    if (name == 'management_cost') {
                        return 'ps7050_edit_line_roject_nf3';
                    }
            
                    if (name == 'profits') {
                        return 'ps7050_edit_line_roject_nf3';
                    }
                    if (name == 'risk_cost') {
            
                        return 'ps7050_edit_line_roject_nf3';
            
                    }
                    if (name == 'subtotal') {
            
                        return 'ps7050_edit_line_roject_nf3';
            
                    }
                    if (name == 'total') {
                        return 'ps7050_edit_line_roject_nf3';
                    }
                }else if (level == 2) {
                    if (name == 'quantities') {
                        return 'ps7050_edit_line_roject_nf2';
            
                    }
                    if (name == 'artificial_cost') {
                        return 'ps7050_edit_line_roject_nf1';
                    }
            
                    if (name == 'materials_cost') {
                        return 'ps7050_edit_line_roject_nf1';
                    }
            
                    if (name == 'mechanical_cost') {
                        return 'ps7050_edit_line_roject_nf1';
                    }
            
                    if (name == 'management_cost') {
                        return 'ps7050_edit_line_roject_nf1';
                    }
            
                    if (name == 'profits') {
                        return 'ps7050_edit_line_roject_nf1';
                    }
                    if (name == 'risk_cost') {
            
                        return 'ps7050_edit_line_roject_nf1';
            
                    }
                    if (name == 'subtotal') {
            
                        return 'ps7050_edit_line_roject_nf1';
            
                    }
                    if (name == 'total') {
                        return 'ps7050_edit_line_roject_nf1';
                    }
                }else if(level == '主材'){
                    if(name == 'main_material_unit_price'){
                        return 'ps7050_edit_line_roject_nf1';
                    }
                }
            }
            
            
            var data_list = {
                '安全文明施工费': 'total',
                '施工人员保险费': 'N',
                '材料运输费': '',
                '设计费': 'profits',
                '税率': '',
                '税费': 'tax_rate',
                '报价总额': 'N'
            };
            
            function kw_bid_entrument_ln_collect_editFun(rec, name) {
                if (!data_list[rec.get('project_name')]) {
                    return 'ps7050_prescheme_line_collect_nf';
                }
            
                return '';
            }
            
            function test(){
                debugger;
            }
        ]]></script>
        <a:dataSets>
            <a:dataSet id="ps7050_engineering_ds" fetchAll="true" model="bid.BID8010.bid8010_engineering_main">
                <a:events>
                    <a:event name="load" handler="ps7050_engineering_load_handler"/>
                </a:events>
            </a:dataSet>
            <a:dataSet id="ps7050_prescheme_head_ds" autoCount="false" autoQuery="true" fetchAll="true" model="cux.KINWONG.ps.ps7050.ps7050_prescheme_query" selectable="true">
                <a:fields>
                    <a:field name="prescheme_id"/>
                    <a:field name="line_vendor_id"/>
                    <a:field name="prescheme_code" readOnly="true"/>
                    <a:field name="prescheme_title" readOnly="true" required="true"/>
                    <a:field name="prescheme_project_name" readOnly="true"/>
                    <a:field name="prescheme_unit_code"/>
                    <a:field name="prescheme_unit_desc"/>
                    <a:field name="prescheme_comments" readOnly="true"/>
                    <a:field name="prescheme_status_code"/>
                    <a:field name="created_by_name" readOnly="true"/>
                    <a:field name="creation_date" readOnly="true"/>
                    <a:field name="project_type_desc" readOnly="true"/>
                </a:fields>
            </a:dataSet>
            <a:dataSet id="ps7050_prescheme_line_roject_ds" autoCount="true" autoPageSize="true" fetchAll="true" model="cux.KINWONG.ps.ps7050.ps7050_prescheme_line_eng_ven" selectable="true">
                <a:fields>
                    <a:field name="line_eng_id"/>
                    <a:field name="line_head_id" defaultValue="${/parameter/@prescheme_id}"/>
                    <a:field name="line_vendor_id" defaultValue="${/parameter/@line_vendor_id}"/>
                    <a:field name="project_code" lovAutoQuery="true" lovGridHeight="300" lovHeight="450" lovLabelWidth="100" lovService="cux.KINWONG.ps.ps7010.ps7010_prescheme_project_lov" lovWidth="500" required="true" title="项目工程选择">
                        <a:mapping>
                            <a:map from="project_name" to="project_name"/>
                            <a:map from="project_characteristi" to="project_characteristi"/>
                            <a:map from="project_uom_name" to="project_uom_name"/>
                            <a:map from="project_uom_code" to="project_uom_code"/>
                            <a:map from="data_id" to="data_id"/>
                            <a:map from="category_level" to="category_level"/>
                            <a:map from="parent_date_id" to="parent_data_id"/>
                            <a:map from="expanded" to="expanded"/>
                            <a:map from="project_code" to="project_code"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="category_level"/>
                    <a:field name="parent_data_id"/>
                    <a:field name="data_id"/>
                    <a:field name="expanded" checkedValue="Y" uncheckedValue="N"/>
                    <a:field name="project_name"/>
                    <a:field name="project_uom_name"/>
                    <a:field name="project_characteristi"/>
                    <a:field name="brand"/>
                    <a:field name="project_uom_code"/>
                    <a:field name="quantities"/>
                    <a:field name="unit_price"/>
                    <a:field name="rate" lovAutoQuery="true" lovGridHeight="300" lovHeight="450" lovLabelWidth="100" lovService="cux.KINWONG.ps.ps7010.ps7010_rate_lov" lovWidth="500" title="税率选择">
                        <a:mapping>
                            <a:map from="bg_tax_type_rate" to="rate"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="Tax_unit_price" readOnly="true"/>
                    <a:field name="total_price" readOnly="true"/>
                    <a:field name="tax_total_price" readOnly="true"/>
                    <a:field name="comments"/>
                    <a:field name="artificial_cost"/>
                    <a:field name="materials_cost"/>
                    <a:field name="mechanical_cost"/>
                    <a:field name="management_cost"/>
                    <a:field name="profits"/>
                    <a:field name="risk_cost"/>
                    <a:field name="subtotal"/>
                    <a:field name="total"/>
                    <a:field name="calculate_flag"/>
                    <a:field name="calculate_flag_2"/>
                </a:fields>
                <a:events>
                    <a:event name="load" handler="ps7050_line_roject_ds_loadFcn"/>
                    <a:event name="update" handler="ps7050_line_roject_ds_up"/>
                </a:events>
            </a:dataSet>
            <a:dataSet id="ps7050_prescheme_files_ds" autoQuery="true" model="public.fnd_atm_lines" queryUrl="${/request/@context_path}/autocrud/public.fnd_atm_lines/query?source_table_name=PS_PRESCHEME_HEAD.VEN_FILE&amp;source_pk_value=${/parameter/@line_vendor_id}" selectable="true">
                <a:fields>
                    <a:field name="atm_line_id"/>
                    <a:field name="line_number"/>
                    <a:field name="atm_desc" required="true"/>
                    <a:field name="source_table_name" defaultValue="PS_PRESCHEME_HEAD.VEN_FILE"/>
                    <a:field name="source_pk_value" defaultValue="${/parameter/@line_vendor_id}"/>
                </a:fields>
                <a:events>
                    <a:event name="beforecreate" handler="ps7050_create_files_ds_beforeCreate"/>
                    <a:event name="add" handler="ps7050_create_files_ds_add"/>
                    <a:event name="submitsuccess" handler="ps7050_file_SubmitSuccess"/>
                </a:events>
            </a:dataSet>
            <a:dataSet id="ps7050_prescheme_files_readonly_ds" autoQuery="true" model="public.fnd_atm_lines" queryUrl="${/request/@context_path}/autocrud/public.fnd_atm_lines/query?source_table_name=PS_PRESCHEME_HEAD.CREATE_FILE&amp;source_pk_value=${/parameter/@prescheme_id}" selectable="true">
                <a:fields>
                    <a:field name="atm_line_id"/>
                    <a:field name="line_number"/>
                    <a:field name="atm_desc" required="true"/>
                    <a:field name="source_table_name" defaultValue="PS_PRESCHEME_HEAD.CREATE_FILE"/>
                    <a:field name="source_pk_value" defaultValue="${/parameter/@prescheme_id}"/>
                </a:fields>
            </a:dataSet>
            <a:dataSet id="ps7050_prescheme_line_query_ds">
                <a:fields>
                    <a:field name="line_head_id" defaultValue="${/parameter/@prescheme_id}"/>
                    <a:field name="line_vendor_id" defaultValue="${/parameter/@line_vendor_id}"/>
                </a:fields>
            </a:dataSet>
            <a:dataSet id="ps7050_prescheme_line_sum_ds" autoCount="true" autoQuery="true" model="cux.KINWONG.ps.ps7050.kw_ps7050_vendor_sum_query" pageSize="20" queryDataSet="ps7050_prescheme_line_query_ds"/>
        </a:dataSets>
        <a:screenBody>
            <a:screenTopToolbar>
                <!--    <a:toolbarButton id="ps7050PreschemeSave_bt" click="ps7050PreschemeSave" text="PROMPT.SAVE" width="100"/> 
                 <a:toolbarButton id="ps7050_prescheme_submit_bt" click="ps7050_prescheme_submit" text="PROMPT.SUBMIT" width="100"/> -->
                <a:toolbarButton id="ps7050_back_button" click="ps7050_back" text="HAP_BACK" width="100"/>
            </a:screenTopToolbar>
            <a:vBox>
                <a:hBox labelWidth="100">
                    <a:textField name="prescheme_title" bindTarget="ps7050_prescheme_head_ds" prompt="预方案标题" width="410"/>
                </a:hBox>
                <a:hBox labelWidth="100">
                    <a:textField name="prescheme_code" bindTarget="ps7050_prescheme_head_ds" prompt="预方案编号" readOnly="true"/>
                    <a:datePicker name="creation_date" bindTarget="ps7050_prescheme_head_ds" prompt="创建日期" readOnly="true"/>
                </a:hBox>
                <a:hBox labelWidth="100">
                    <a:textField name="created_by_name" bindTarget="ps7050_prescheme_head_ds" prompt="创建人" readOnly="true"/>
                    <a:textField name="prescheme_project_name" bindTarget="ps7050_prescheme_head_ds" prompt="项目名称"/>
                </a:hBox>
                <a:hBox labelWidth="100">
                    <a:textArea name="prescheme_comments" bindTarget="ps7050_prescheme_head_ds" height="40" prompt="备注" width="400"/>
                </a:hBox>
                <a:hBox labelWidth="100">
                    <a:lov name="project_type_desc" bindTarget="ps7050_prescheme_head_ds" prompt="工程类型"/>
                </a:hBox>
                <a:tabPanel id="ps7050_prescheme_line_tab" height="380" marginWidth="70">
                    <a:tabs>
                        <a:tab prompt="方案构成" width="100">
                            <a:treeGrid id="ps7050_prescheme_line_roject_grid" bindTarget="ps7050_prescheme_line_roject_ds" expandField="expanded" idField="son_matching_code" marginHeight="160" marginWidth="80" parentField="matching_code" showCheckBox="false">
                                <!--   <a:toolBar>
                                    <a:button type="add"/>
                                    <a:button type="delete"/>
                                    <a:button type="clear"/>
                                </a:toolBar> -->
                                <a:columns>
                                    <a:column name="project_code" align="center" autoAdjust="true" prompt="项目编码" width="80"/>
                                    <a:column name="matching_code" align="center" prompt="匹配编码" width="80"/>
                                    <a:column name="project_name" align="left" autoAdjust="true" prompt="项目名称" width="50"/>
                                    <a:column name="project_characteristi" align="left" autoAdjust="true" prompt="项目特征" width="50"/>
                                    <a:column name="main_material_name" prompt="主材料名称" width="60"/>
                                    <a:column name="main_material_model" prompt="主材料规格" width="60"/>
                                    <a:column name="project_uom_name" align="center" autoAdjust="true" prompt="计量单位" width="60"/>
                                    <a:column name="quantities" align="center" autoAdjust="true" prompt="工程量" width="50"/>
                                    <!--
                                    <a:column align="center" prompt="综合单价">
                                        <a:column name="artificial_cost" align="center"  prompt="人工费" width="60"/>
                                        <a:column name="main_material_loss_rate" align="center" prompt="耗用量" width="40"/>
                                        <a:column name="main_material_unit_price" align="center"   prompt="主材单价" width="60"/>
                                        <a:column name="main_material_cost" align="center" prompt="主材费" width="60"/>
                                        <a:column name="mechanical_cost" prompt="主材费" align="center"   width="60"/>
                                        <a:column name="management_cost" prompt="管理费" align="center"  width="60"/>
                                        <a:column name="assist_material_cost" align="center" prompt="辅材费" width="60"/>
                                        <a:column name="profits" align="center"  prompt="利润" width="60"/>
                                        <a:column name="subtotal" align="center" editorFunction="ps7050_PreschemeTreegridEditorFunction" prompt="小计" width="60"/>   
                                    
                                    </a:column>
                                    <a:column name="total" align="center" autoAdjust="true"   prompt="合计" width="80"/> -->
                                    <!-- <a:column name="rate" align="center" autoAdjust="true" editor="ps7050_edit_line_roject_lov" prompt="税率" width="80"/> -->
                                    <a:column name="comments" align="left" autoAdjust="true" prompt="备注" width="200"/>
                                    <!--
                                    <a:column name="bargain_price" align="center" autoAdjust="true"   prompt="还价价格" width="80"/>
                                    <a:column name="bargain_price_reason" align="left" autoAdjust="true"  prompt="还价理由" width="200"/> -->
                                    <a:column name="category_level" align="left" prompt="级别" width="40"/>
                                </a:columns>
                                <a:editors>
                                    <a:textField id="ps7050_edit_line_roject_tf"/>
                                    <a:textField id="ps7050_edit_line_roject_tf2"/>
                                    <a:numberField id="ps7050_edit_line_roject_nf1" allowDecimals="true" allowFormat="true" allowNegative="false" decimalPrecision="4"/>
                                    <a:numberField id="ps7050_edit_line_roject_nf2" allowDecimals="true" allowFormat="true" allowNegative="false" decimalPrecision="4"/>
                                    <a:numberField id="ps7050_edit_line_roject_nf3" allowDecimals="true" allowFormat="true" allowNegative="false" decimalPrecision="4" readOnly="true"/>
                                    <a:numberField id="ps7050_edit_line_roject_nf4" allowDecimals="true" allowFormat="true" allowNegative="false" decimalPrecision="4" readOnly="true"/>
                                    <a:lov id="ps7050_edit_line_roject_lov"/>
                                </a:editors>
                            </a:treeGrid>
                        </a:tab>
                        <a:tab prompt="汇总表">
                            <a:grid id="ps7050_prescheme_line_sum_grid" bindTarget="ps7050_prescheme_line_sum_ds" marginHeight="270" marginWidth="80" navBar="true">
                                <a:columns>
                                    <a:column name="line_num" align="center" prompt="行号" width="100"/>
                                    <a:column name="project_name" align="center" prompt="项目名称" width="150"/>
                                    <a:column name="sum_price" align="center" editorFunction="kw_bid_entrument_ln_collect_editFun" prompt="总价" width="150"/>
                                    <a:column name="comments" prompt="备注" width="385"/>
                                </a:columns>
                                <a:editors>
                                    <a:numberField id="ps7050_prescheme_line_collect_nf" allowDecimals="true" allowFormat="true" allowNegative="false" decimalPrecision="8"/>
                                </a:editors>
                            </a:grid>
                        </a:tab>
                        <a:tab prompt="附件信息" width="100">
                            <a:grid id="ps7050_files_grid" bindTarget="ps7050_prescheme_files_ds" marginHeight="160" marginWidth="80" navBar="true">
                                <a:toolBar>
                                    <a:button type="add"/>
                                    <a:button type="save"/>
                                    <a:button type="delete"/>
                                </a:toolBar>
                                <a:columns>
                                    <a:column name="atm_desc" editor="ps7050_files_desc_tf" prompt="FND_ATM_LINES.ATM_DESC"/>
                                    <a:column name="upload_user_desc" prompt="上传人"/>
                                    <a:column name="upload_date" prompt="上传时间"/>
                                    <a:column align="center" prompt="PROMPT.UPLOAD_DOWNLOAD" renderer="ps7050_upload_renderer" width="100"/>
                                </a:columns>
                                <a:editors>
                                    <a:textField id="ps7050_files_desc_tf" maxLength="500"/>
                                </a:editors>
                            </a:grid>
                        </a:tab>
                        <a:tab marginHeight="160" marginWidth="80" prompt="附件信息_采购方">
                            <a:grid id="ps7050_files_readonly_grid" bindTarget="ps7050_prescheme_files_readonly_ds" height="260" marginWidth="150" navBar="true">
                                <a:columns>
                                    <a:column name="atm_desc" editor="ps7050_files_desc_tf" prompt="FND_ATM_LINES.ATM_DESC"/>
                                    <a:column name="upload_user_desc" prompt="上传人"/>
                                    <a:column name="upload_date" prompt="上传时间"/>
                                    <a:column align="center" prompt="PROMPT.UPLOAD_DOWNLOAD" renderer="ps7050_upload_renderer2" width="100"/>
                                </a:columns>
                            </a:grid>
                        </a:tab>
                    </a:tabs>
                </a:tabPanel>
            </a:vBox>
        </a:screenBody>
        <script><![CDATA[
            init();
        ]]></script>
    </a:view>
</a:screen>
