<?xml version="1.0" encoding="UTF-8"?>
<!--
    $Author: 孙超超  
    $Date: 2018-11-30 下午2:17:11  
    $Revision: 1.0  
    $Purpose: 
-->
<a:screen xmlns:a="http://www.aurora-framework.org/application" trace="true">
    <a:view>
        <a:link id="ps7010_template_insert_link" url="${/request/@context_path}/modules/cux/KINWONG/ps/ps8010/ps8010_template_insert.svc"/>
        <a:link id="ps7010_prescheme_detail_link" url="${/request/@context_path}/modules/cux/KINWONG/ps/ps7010/ps7010_prescheme_detail.screen"/>
        <a:link id="ps7010_edit_prescheme_insert_link" url="${/request/@context_path}/modules/cux/KINWONG/ps/ps7010/ps7010_prescheme_save.svc"/>
        <a:link id="ps7010_edit_prescheme_update_link" url="${/request/@context_path}/modules/cux/KINWONG/ps/ps7010/ps7010_prescheme_update_save.svc"/>
        <a:link id="ps7010_prescheme_execute_link" model="cux.KINWONG.ps.ps7010.ps7010_prescheme_query" modelaction="execute"/>
        <a:link id="ps7010_engineering_execute_link" model="cux.KINWONG.ps.ps7010.ps7010_engineering_main" modelaction="execute"/>
        <a:link id="ps7010_prescheme_line_project_import_link" url="${/request/@context_path}/modules/cux/KINWONG/ps/ps7010/ps7010_prescheme_line_project_import.screen"/>
        <style><![CDATA[
.contain {
padding:3px;
background:white;
font-size:9pt;
border-width:1px 2px 2px 1px;
border-style:solid;
left:20; 
margin-left:-418px;
margin-top:16px;
position:absolute;
display:none;
z-index:9999;
overflow:auto;
max-width:450px;
max-height:100px;
}

.tishi{
        color:#f00;
        font-size: 10px;
    }
 .tishi2{
        color:#f00;
        font-size: 10px;
        padding-left:30px;
    }   
            

]]></style>
        <script><![CDATA[
            var data_list = {
                '分部分项合计': '',
                '人工费合计': '',
                '材料费合计': '',
                '机械费合计': '',
                '管理费合计': '',
                '辅材费合计': '',
                '利润合计': '',
                '安全文明施工费': 'total',
                '施工人员保险费': 'N',
                '材料运输费': '',
                '设计费': '',
                '未税合计': 'N',
                '税率': '',
                '税费': 'tax_rate',
                '报价总额': 'N'
            };
            
            var comments_list = {
                '安全文明施工费': '深圳：分部分项合计*费率1.8%,龙川、珠海：分部分项合计*3.8%,江西：人工费总额*费率12%',
                '施工人员保险费': '深圳：分部分项合计*费率0.28%,龙川、珠海：分部分项合计*费率0.3%, 江西：人工费总额*费率11%',
                '设计费': '需有标准的图纸、方案书及工程量清单才可计算，计算费率按分部分项合计：2%',
                '未税合计': '分部分项合计+安全文明施工费+施工人员保险费+材料运输费+设计费',
                '税费': '未税合计*税率',
                '报价总额': '未税合计+税费'
            };
            
            //加法
            
            function ps7010_accAdd(arg1, arg2) {
                var r1, r2, m, c;
                try {
                    r1 = arg1.toString().split(".")[1].length;
                } catch (e) {
                    r1 = 0;
                }
                try {
                    r2 = arg2.toString().split(".")[1].length;
                } catch (e) {
                    r2 = 0;
                }
                c = Math.abs(r1 - r2);
                m = Math.pow(10, Math.max(r1, r2));
                if (c > 0) {
                    var cm = Math.pow(10, c);
                    if (r1 > r2) {
                        arg1 = Number(arg1.toString().replace(".", ""));
                        arg2 = Number(arg2.toString().replace(".", "")) * cm;
                    } else {
                        arg1 = Number(arg1.toString().replace(".", "")) * cm;
                        arg2 = Number(arg2.toString().replace(".", ""));
                    }
                } else {
                    arg1 = Number(arg1.toString().replace(".", ""));
                    arg2 = Number(arg2.toString().replace(".", ""));
                }
                return (arg1 + arg2) / m;
            
            }
            
            //乘法
            
            function ps7010_accMul(arg1, arg2) {
                var m = 0,
                    s1 = arg1.toString(),
                    s2 = arg2.toString();
                try {
                    m += s1.split(".")[1].length;
                } catch (e) {}
                try {
                    m += s2.split(".")[1].length;
                } catch (e) {}
                return Number(s1.replace(".", "")) * Number(s2.replace(".", "")) / Math.pow(10, m);
            
            }
            //取精度
            
            function ps7010_js_round(para1, para2) {
                return Math.round(ps7010_accMul(para1, Math.pow(10, para2))) / Math.pow(10, para2);
            }
            
            //除法
            
            
            function ps7010_accDiv(arg1, arg2) {
                var t1 = 0,
                    t2 = 0,
                    r1, r2;
            
                try {
                    t1 = arg1.toString().split(".")[1].length;
                } catch (e) {}
            
                try {
                    t2 = arg2.toString().split(".")[1].length;
                } catch (e) {}
            
                with(Math) {
            
                    r1 = Number(arg1.toString().replace(".", ""))
            
                    r2 = Number(arg2.toString().replace(".", ""))
            
                    return ps7010_js_round((r1 / r2) * pow(10, t2 - t1), 8);
            
                }
            
            }
            
            
            
            
            function init() {
                var prescheme_id = '${/parameter/@prescheme_id}';
                if (prescheme_id) {
                    $('ps7010_prescheme_head_ds').setQueryParameter('prescheme_id', prescheme_id);
                    $('ps7010_prescheme_head_ds').query();
                    $('ps7010_prescheme_line_roject_ds').setQueryParameter('line_head_id', prescheme_id);
                    $('ps7010_prescheme_line_roject_ds').query();
                    $('ps7010_prescheme_line_vendor_ds').setQueryParameter('line_head_id', prescheme_id);
                    $('ps7010_prescheme_line_vendor_ds').query();
                    //附件查询
                    $('ps7010_prescheme_files_ds').setQueryParameter('source_table_name', 'PS_PRESCHEME_HEAD.CREATE_FILE');
                    $('ps7010_prescheme_files_ds').setQueryParameter('source_pk_value', prescheme_id);
                    $('ps7010_prescheme_files_ds').query();
                } else {
            
                    $('ps7010_generate_template_button').disable();
                    $('ps7010_bulk_import_button').disable();
                }
            
            }
            
            
            function ps7010_back() {
                query_ps7010_prescheme_query_result_ds();
                $('ps7010_prescheme_create_window').close();
            }
            //保存
            
            function ps7010PreschemeSave() {
                var ds = $('ps7010_prescheme_head_ds');
                var lines_ven_ds = $('ps7010_prescheme_line_vendor_ds');
                var lines_eng_ds = $('ps7010_prescheme_line_roject_ds');
                var line_sum_ds = $('ps7010_prescheme_line_sum_ds');
            
                if (ds.validate() && lines_ven_ds.validate() && lines_eng_ds.validate() && line_sum_ds.validate()) {
                    //计算
                    calculate_fun();
                    var record = ds.getCurrentRecord();
                    var records1 = lines_ven_ds.getAll();
                    var records2 = lines_eng_ds.getAll();
                    var para = record.data;
                    para['ven_lines'] = lines_ven_ds.getJsonData(false);
                    para['eng_lines'] = lines_eng_ds.getJsonData(false);
                    para['sum_lines'] = line_sum_ds.getJsonData(false);
                    var url;
            
                    if (record.get('prescheme_id')) {
                        url = $('ps7010_edit_prescheme_update_link').getUrl();
                    } else {
                        //新建
                        url = $('ps7010_edit_prescheme_insert_link').getUrl();
                    }
            
                    Aurora.Masker.mask($('ps7010_prescheme_create_window').wrap, '正在提交...');
                    Aurora.request({
                        url: url,
                        para: para,
                        success: function(res) {
                            var prescheme_id = res.result.prescheme_id ? res.result.prescheme_id : '${/parameter/@prescheme_id}';
                           // alert('prescheme_id === '+prescheme_id);
                            Aurora.showMessage('${l:PROMPT}', '${l:PROMPT.SAVE_SUCCESS}', function() {
                                ds.setQueryParameter('prescheme_id', prescheme_id);
                                ds.query();
                                lines_ven_ds.setQueryParameter('line_head_id', prescheme_id);
                                lines_ven_ds.query();
                                lines_eng_ds.setQueryParameter('line_head_id', prescheme_id);
                                lines_eng_ds.query();
                                line_sum_ds.setQueryParameter('header_id', prescheme_id);
                                line_sum_ds.query();
                                $('ps7010_generate_template_button').enable();
                                $('ps7010_bulk_import_button').enable();
                                Aurora.Masker.unmask($('ps7010_prescheme_create_window').wrap);
                            });
                        },
                        error: function() {
                            Aurora.Masker.unmask($('ps7010_prescheme_create_window').wrap);
                        },
                        failure: function() {
                            Aurora.Masker.unmask($('ps7010_prescheme_create_window').wrap);
                        },
                        scope: this
                    });
                }
            }
            
            function ps7010_prescheme_submit() {
                var record = $('ps7010_prescheme_head_ds').getCurrentRecord();
                var eng_lines = $('ps7010_prescheme_line_roject_ds');
                var ven_lines = $('ps7010_prescheme_line_vendor_ds');
                if (record.get('prescheme_id')) {
                    if (record.dirty) {
                        Aurora.showMessage('${l:PROMPT}', '数据未保存');
                        return;
                    }
                    //判断行数据是否发生更改
                    var records1 = eng_lines.getAll();
                    if (records1.length > 0) {
                        //判断数据是否已经保存
                        for (var i = 0;i < records1.length;i++) {
                            if (records1[i].dirty || !records1[i].get('line_eng_id')) {
                                Aurora.showMessage('${l:PROMPT}', '数据未保存');
                                return;
                            }
                        }
                    }
                    var records2 = ven_lines.getAll();
                    if (records2.length > 0) {
                        //判断数据是否已经保存
                        for (var t = 0;t < records2.length;t++) {
                            if (records2[t].dirty || !records2[t].get('line_vendor_id')) {
                                Aurora.showMessage('${l:PROMPT}', '数据未保存');
                                return;
                            }
                        }
                    }
                    Aurora.showConfirm('${l:PROMPT}', '确定发布？', function() {
                        Aurora.Masker.mask($('ps7010_prescheme_create_window').wrap, '正在提交');
                        Aurora.request({
                            url: $('ps7010_prescheme_execute_link').getUrl(),
                            para: record.data,
                            success: function() {
                                Aurora.showMessage('${l:PROMPT}', '发布成功', function() {
                                    Aurora.Masker.unmask($('ps7010_prescheme_create_window').wrap);
                                    ps7010_back();
                                });
                            },
                            error: function() {
                                Aurora.Masker.unmask($('ps7010_prescheme_create_window').wrap);
                            },
                            failure: function() {
                                Aurora.Masker.unmask($('ps7010_prescheme_create_window').wrap);
                            },
                            scope: this
                        });
                    }, function() {}, 300, 100);
                } else {
                    Aurora.showMessage('${l:PROMPT}', '数据未保存');
                    return;
                }
            }
            
            function ps7010_create_files_ds_beforeCreate(ds, record, index) {
                var prescheme_id = $('ps7010_prescheme_head_ds').getCurrentRecord().get('prescheme_id');
                if (Aurora.isEmpty(prescheme_id)) {
                    Aurora.showMessage('${l:PROMPT}', '请先保存数据,再新附件行！');
                    return false;
                }
            }
            
            function ps7010_create_files_ds_add(ds, record, index) {
                var prescheme_id = $('ps7010_prescheme_head_ds').getCurrentRecord().get('prescheme_id');
                record.set('source_pk_value', prescheme_id);
            }
            
            //附件下载
            
            function ps7010_upload_renderer(value, record, name) {
                var atm_line_id = record.get('atm_line_id');
                if (!record.isNew && atm_line_id) {
                    return '<a href="javascript:ps7010_upload_file(' + atm_line_id + ')">${l:ATM.UPLOAD_ATTACHMENT}</a>';
                }
            }
            
            function ps7010_upload_file(id) {
                var url = "${/request/@context_path}/uploadFile.screen?table_name=PS_PRESCHEME_HEAD.CREATE_FILE&header_id=" + id;
                new Aurora.Window({
                    url: url,
                    title: '${l:ATM.UPLOAD_ATTACHMENT}',
                    id: 'ps7010_upload_window',
                    width: 850,
                    height: 500
                }).on('beforeclose', function() {
                    $('ps7010_prescheme_files_ds').query();
                });
            
            }
            
            
            var calculating = false;
            
            function callback1(record, name, value) {
                if (name == 'management_cost') {
                    var new_management_cost = record.get('management_cost') * (record.get('mechanical_cost') * 0.1 + record.get('artificial_cost'));
                    record.set('management_cost', declim2(new_management_cost));
                } else if (name == 'profits') {
                    var new_profits = (record.get('mechanical_cost') + record.get('artificial_cost') + record.get('main_material_cost') + record.get('management_cost') + record.get('assist_material_cost')) * record.get('profits');
                    record.set('profits', declim2(new_profits));
                }
            }
            
            function callback2(record, name, value) {
                if (name == 'management_cost') {
                    var new_management_cost = record.get('management_cost_temp');
                    record.set('management_cost', declim2(new_management_cost));
                } else if (name == 'profits') {
                    var new_profits = record.get('artificial_cost') * record.get('profits');
            
                    record.set('profits', declim2(new_profits));
                }
            }
            
            function callback3(record, name, value) {
            //    Aurora.showMessage('${l:PROMPT}', 'management_cost == '+ name );
                if (name == 'management_cost') {
                    var new_management_cost = record.get('management_cost') * record.get('artificial_cost');
                    record.set('management_cost', declim2(new_management_cost));
                } else if (name == 'profits') {
                    var new_profits = record.get('artificial_cost') * record.get('profits');
                    record.set('profits', declim2(new_profits));
                }
            
            
            }
            
            function doCallback(fn, args) {
                fn.apply(this, args);
            }
            
            function calculate_fun() {
                var place_list = {
                    '深圳': 'callback1',
                    '广东': 'callback2',
                    '江西': 'callback3'
                };
                var head_record = $('ps7010_prescheme_head_ds').getCurrentRecord();
                var place = head_record.get('area_desc');
                var line_ds = $('ps7010_prescheme_line_roject_ds');
                var records = line_ds.getAll();
                console.log(records);
                
                for (var i = 0;i < records.length;i++) {
                    if (records[i].get('category_level') == '2') {
                        calculating = true;
                        if (records[i].get('calculate_flag') == 'N') {
                            doCallback(eval(place_list[place]), [records[i], 'management_cost']);
                            records[i].set('calculate_flag', 'Y');
                        }
                        if (records[i].get('calculate_flag_2') == 'N') {
                            doCallback(eval(place_list[place]), [records[i], 'profits']);
                            records[i].set('calculate_flag_2', 'Y');
                        }
                        calculating = false;
            
                    }
                }
            }
            
            function ps7010_line_roject_ds_up(dataSet, record, name, value, oldvalue) {
                var level = record.get('category_level');
                var records = dataSet.getAll();
                if (level == '2') {
                    if (name == 'management_cost') {
                        if (!calculating) {
                            record.set('calculate_flag', 'N');
                            if (value != oldvalue) {
                                for (var i = 0;i < records.length;i++) {
                                    if (records[i].get('category_level') == '2') {
                                        records[i].set('management_cost', value);
                                    }
                                }
                            }
                        }
                    } else if (name == 'profits') {
                        if (!calculating) {
                            record.set('calculate_flag_2', 'N');
                            if (value != oldvalue) {
                                for (var i = 0;i < records.length;i++) {
                                    if (records[i].get('category_level') == '2') {
                                        records[i].set('profits', value);
                                    }
                                }
                            }
                        }
                    }
                } else if (level == '主材' && name == 'main_material_unit_price') {
                    var parent_record = getParentrecord(record.get('matching_code'), records);
                    var res = getChildAll(record.get('matching_code'), records);
                    var main_material_cost = 0;
                    for (var i = 0;i < res.length;i++) {
                        var main_material_unit_price = res[i].get('main_material_unit_price');
                        var main_material_loss_rate = res[i].get('main_material_loss_rate');
                        if (main_material_unit_price && main_material_loss_rate) {
                            main_material_cost += main_material_unit_price * main_material_loss_rate;
                        }
                    }
                    parent_record.set('main_material_cost', declim2(main_material_cost));
                } else if (name == 'main_material_loss_rate') {
                    if (value) {
                        record.getField('main_material_unit_price').setReadOnly(false);
                    } else {
                        record.getField('main_material_unit_price').setReadOnly(true);
                    }
                }
            }
            
            
            
            function declim2(sum) {
                return Math.round(sum * 100) / 100;
            }
            
            function getnumber(name, record) {
                if (typeof(record.get(name)) != 'undefined' && !Ext.isEmpty(record.get(name))) {
                    return record.get(name);
                } else {
                    return 0;
                }
            }
            
            function getSum(val, oldVal, sum_x) {
                if (!oldVal) {
                    sum_x += val;
                } else {
                    sum_x += val - oldVal;
                }
                return sum_x;
            }
            
            function getParentrecord(parent_data_id, records) {
                for (i = 0;i < records.length;i++) {
                    if (records[i].get('matching_code') + records[i].get('project_code') == parent_data_id) {
                        return records[i];
                    }
                }
                return null;
            }
            
            function getChildAll(parent_data_id, records) {
                var res = [];
                for (i = 0;i < records.length;i++) {
                    if (records[i].get('matching_code') == parent_data_id) {
                        res.push(records[i]);
                    }
                }
                return res;
            }
            
            
            function ps7010_line_ven_ds_cellclickFun(grid, row, name, record, value) {
                if (name == 'contact_person') {
                    record.getField('contact_person').setLovPara('vendor_company_id', record.get('vendor_id'));
                }
            }
            
            function ps7010_file_SubmitSuccess(dataset, res) {
                var record = $('ps7010_prescheme_head_ds').getCurrentRecord();
                var prescheme_id = record.get('prescheme_id');
                dataset.setQueryParameter('source_table_name', 'PS_PRESCHEME_HEAD.CREATE_FILE');
                dataset.setQueryParameter('source_pk_value', prescheme_id);
                dataset.query();
            }
            
            function ps7010_status_renderer(value, record, name) {
                var staus = record.get('status_code');
                if (staus == '30' || staus == '40') {
                    return '<a href="javascript:ps7010_prescheme_detail_maintain(' + record.get('line_head_id') + ',' + record.get('line_vendor_id') + ',' + record.get('status_code') + ',' + "'" + record.get('business_group') + "'" + ');">' + value + '</a>';
                } else {
                    return value;
                }
            }
            
            
            function ps7010_prescheme_detail_maintain(prescheme_id, line_vendor_id, status_code, business_group) {
                new Aurora.Window({
                    id: 'ps7010_prescheme_detail_ven_window',
                    title: '供应商预方案查看',
                    url: $('ps7010_prescheme_detail_link').getUrl() + '?prescheme_id=' + prescheme_id + '&line_vendor_id=' + line_vendor_id + '&status_code=' + status_code + '&business_group=' + business_group,
                    fullScreen: true
                }).on('beforeclose', function() {
                    $('ps7010_prescheme_query_result_ds').query();
                });
            }
            
            function ps7010_engineering_load_handler(ds) {
                debugger;
                var ps7010_prescheme_head_ds = $('ps7010_prescheme_head_ds').getCurrentRecord();
                var prescheme_id = ps7010_prescheme_head_ds.get('prescheme_id');
                var engineering_ds = ds.getAll();
                var ps7010_prescheme_line_roject_ds = $('ps7010_prescheme_line_roject_ds');
                ps7010_prescheme_line_roject_ds.removeAll();
                for (var t = 0;t < engineering_ds.length;t++) {
                    var line_ds = ps7010_prescheme_line_roject_ds.getAll();
                    console.log(engineering_ds[t]);
                    ps7010_prescheme_line_roject_ds.create({
                        'line_head_id': prescheme_id,
                        'project_code': engineering_ds[t].get('project_code'),
                        'expanded': 'N',
                        'project_name': engineering_ds[t].get('project_name'),
                        'category_level': engineering_ds[t].get('category_level'),
                        'parent_data_id': engineering_ds[t].get('parent_data_id'),
                        'data_id': engineering_ds[t].get('data_id'),
                        'artificial_cost': engineering_ds[t].get('artificial_cost'),
                        'materials_cost': engineering_ds[t].get('materials_cost'),
                        'mechanical_cost': engineering_ds[t].get('mechanical_cost'),
                        'management_cost': engineering_ds[t].get('management_cost'),
                        'profits': engineering_ds[t].get('profits'),
                        'subtotal': engineering_ds[t].get('subtotal'),
                        'quantities': engineering_ds[t].get('quantities'),
                        'main_material_name': engineering_ds[t].get('main_material_name'),
                        'main_material_model': engineering_ds[t].get('main_material_model'),
                        'main_material_model_desc': engineering_ds[t].get('main_material_model_desc'),
                        'main_material_loss_rate': engineering_ds[t].get('main_material_loss_rate'),
                        'main_material_unit_price': engineering_ds[t].get('main_material_unit_price'),
                        'main_material_cost': engineering_ds[t].get('main_material_cost'),
                        'matching_code': engineering_ds[t].get('matching_code'),
                        'son_matching_code': engineering_ds[t].get('son_matching_code'),
                        'project_uom_name': engineering_ds[t].get('project_uom_name'),
                        'project_characteristi': engineering_ds[t].get('project_characteristi'),
                        'project_uom_code': engineering_ds[t].get('project_uom_code')
                    });
                }
                for (var i = 0;i < engineering_ds.length;i++) {
                    ps7010_prescheme_line_roject_ds.pre();
                }
            }
            
            function ps7010_generate_template_ft() {
                record = $('ps7010_prescheme_head_ds').getCurrentRecord();
                var prescheme_id = record.get('prescheme_id');
                var project_type_desc = record.get('project_type_desc');
                var project_type_id = record.get('project_type_id');
                if (!Ext.isEmpty(project_type_desc)) {
                    Aurora.showConfirm('${l:PROMPT}', '确定生成模版？', function() {
                        Aurora.Masker.mask($('ps7010_prescheme_create_window').wrap, '正在提交');
                        Aurora.request({
                            url: $('ps7010_engineering_execute_link').getUrl(),
                            para: {
                                'prescheme_id': prescheme_id,
                                'project_type_desc': project_type_desc,
                                'project_type_id': project_type_id
                            },
                            success: function() {
                                Aurora.showMessage('${l:PROMPT}', '生成成功', function() {
                                    Aurora.Masker.unmask($('ps7010_prescheme_create_window').wrap);
                                    ps7010_back();
                                });
                            },
                            error: function() {
                                Aurora.Masker.unmask($('ps7010_prescheme_create_window').wrap);
                            },
                            failure: function() {
                                Aurora.Masker.unmask($('ps7010_prescheme_create_window').wrap);
                            },
                            scope: this
                        });
                    }, function() {}, 300, 100);
                } else {
                    Aurora.showMessage('${l:PROMPT}', '请先填写工程类型！');
                }
            
            
            }
            
            function ps7010_prescheme_head_ds_up(dataSet, record, name, value, oldvalue) {
                var template_head_id = record.get('template_head_id');
                if (name == 'template_head_id' && !Ext.isEmpty(template_head_id)) {
                    $('ps7010_engineering_ds').setQueryUrl("${/request/@context_path}/autocrud/cux.KINWONG.ps.ps8010.ps8010_engineering_template_line/query?template_head_id=" + template_head_id);
                    $('ps7010_engineering_ds').query();
                }
            
                if (name == 'area') {
                    var ds = $('ps7010_prescheme_line_roject_ds');
                    var records = ds.getAll();
                    for (var i = 0;i < records.length;i++) {
                        debugger;
                        records[i].getField('project_code').setLovPara('area', value);
                    }
                }
            
            }
            
            function ps7010_PreschemeTreegridEditorFunction(record, name) {
                var level = record.get('category_level');
            
                if (level == '1') {
                    if (name == 'project_code') {
                        return 'ps7010_edit_line_roject_lov';
                    }
                    if (name == 'quantities') {
                        return 'ps7010_edit_line_roject_nf';
                    }
                    if (name == 'project_characteristi') {
                        return 'ps7010_edit_line_roject_tf';
                    }
                }
                if (level == '2') {
                    if (name == 'project_code') {
                        return 'ps7010_edit_line_roject_lov';
                    }
                    if (name == 'artificial_cost') {
                        return 'ps7010_edit_line_roject_nf';
                    }
                    if (name == 'profits') {
                        return 'ps7010_edit_line_roject_nf';
                    }
                    if (name == 'quantities') {
                        return 'ps7010_edit_line_roject_nf';
                    }
            
                    if (name == 'artificial_num') {
                        return 'ps7010_edit_line_roject_nf';
                    }
                    if (name == 'artificial_unit_price') {
                        return 'ps7010_edit_line_roject_nf';
                    }
            
                    if (name == 'mechanical_cost') {
                        return 'ps7010_edit_line_roject_nf';
                    }
                    if (name == 'management_cost') {
                        return 'ps7010_edit_line_roject_nf';
                    }
                    if (name == 'assist_material_cost') {
                        return 'ps7010_edit_line_roject_nf';
                    }
            
                }
                if (level == '主材') {
                    if (name == 'main_material_name') {
                        return 'ps7010_edit_line_roject_lov';
                    }
            
                    if (name == 'main_material_model_desc') {
                        return 'ps7010_edit_line_roject_tf';
                    }
            
                    if (name == 'main_material_loss_rate') {
                        return '';
                    }
                    if (name == 'main_material_unit_price') {
                        return 'ps7010_edit_line_roject_nf';
                    }
                }
            }
            
            function ps7010_PreschemeGridRendererFunction(value, record, name) {
                var level = record.get('category_level');
                var project_code = record.get('project_code');
                var matching_code = record.get('matching_code');
                if (!Aurora.isEmpty(project_code)) {
                    if (name == 'add') {
                        if (level == '1') {
                            return '<a href="javascript:add_l2_project(\'' + project_code + '\')">新增</a>';
                        } else if (level == '2') {
                            return '<a href="javascript:add_l3_project(\'' + project_code + '\',\'' + matching_code + '\')">新增</a>';
                        } else {
                            return '';
                        }
                    }
                }
            }
            
            function ps7010_prescheme_line_projectImportFun() {
                var line_head_id = '${/parameter/@prescheme_id}';
                new Aurora.Window({
                    id: 'ps7010_line_project_import_win',
                    title: '预方案构成导入',
                    url: $('ps7010_prescheme_line_project_import_link').getUrl() + '?line_head_id=' + line_head_id,
                    fullScreen: true
                }).on('close', function() {
                    $('ps7010_prescheme_line_roject_ds').query();
                });
            
            }
            
            function add_l1_project() {
                var ds = $('ps7010_prescheme_line_roject_ds');
                var new_rec = ds.create({
                    'category_level': '1'
                });
            }
            
            function add_l2_project(project_code) {
                var ds = $('ps7010_prescheme_line_roject_ds');
                var new_rec = ds.create({
                    'category_level': '2',
                    'matching_code': project_code
                });
            }
            
            function add_l3_project(project_code, matching_code) {
                var ds = $('ps7010_prescheme_line_roject_ds');
                var new_rec = ds.create({
                    'category_level': '主材',
                    'matching_code': matching_code + project_code
                });
            }
            
            function ps7010_line_project_ds_load(ds) {
                var records = $('ps7010_prescheme_line_roject_ds').getAll();
                for (var i = 0;i < records.length;i++) {
                    if (records[i].get('main_material_loss_rate')) {
                        records[i].getField('main_material_unit_price').setReadOnly(false);
                    }
                }
            }
            
            function kw_bid_entrument_ln_collect_editFun(rec, name) {
                if (!data_list[rec.get('project_name')]) {
                    return 'ps7010_prescheme_line_collect_nf';
                }
            
                return '';
            }
            
            function sum_validator(rec, name, val) {
                if (!data_list[rec.get('project_name')]) {
                    if (!val) {
                        if (val != 0) {
                            return rec.get('project_name') + '未填写';
                        }
                    }
                }
                return true;
            }
            
            function kw_ps7010_prescheme_line_collect_load_handler(ds) {
                var records = ds.getAll();
                if (records.length == 0) {
                    var count = 1;
                    for (var i in data_list) {
                        var comments = '';
                        if (comments_list[i]) {
                            comments = comments_list[i];
                        }
                        ds.create({
                            'line_num': count++,
                            'project_name': i,
                            'sum_price': '',
                            'comments': comments,
                            '_status': 'insert'
                        });
                    }
                }
            }
            
            function ps7010_line_project_ds_add(ds, rec, index) {
                rec.getField('project_code').setLovPara('category_level', rec.get('category_level'));
                if (rec.get('category_level') == '2') {
                    rec.getField('project_code').setLovPara('area', $('ps7010_prescheme_head_ds').getCurrentRecord().get('area'));
                }else if(rec.get('category_level') == '主材'){
                    rec.getField('main_material_name').setLovPara('area', $('ps7010_prescheme_head_ds').getCurrentRecord().get('area'));
                }
            }
            
            function sum_all_render(data, name) {
                var all_sum = 0;
                for (var i = 0;i < data.length;i++) {
                    if (data[i].get('category_level') == '1' && data[i].get(name) && data[i].get('quantities')) {
                        if (name == 'total') {
                            all_sum += data[i].get(name);
                        } else {
                            all_sum += data[i].get(name) * data[i].get('quantities');
                        }
                    }
                }
                return declim2(all_sum);
            }
            
            function kw_ps7010_prescheme_line_aftercreate_handler(ds, obj) {
                console.log(obj);
                if (obj['line_num']) {
                    return true;
                }
                return false;
            
            }
        ]]></script>
        <a:dataSets>
            <a:dataSet id="ps7010_engineering_ds">
                <a:events>
                    <a:event name="load" handler="ps7010_engineering_load_handler"/>
                </a:events>
            </a:dataSet>
            <a:dataSet id="per_plan_area_ds" lookupCode="PRE_PLAN_AREA"/>
            <a:dataSet id="ps7010_prescheme_head_ds" autoCount="false" autoCreate="true" fetchAll="true" model="cux.KINWONG.ps.ps7010.ps7010_prescheme_query" selectable="true">
                <a:fields>
                    <a:field name="template_code" lovAutoQuery="true" lovGridHeight="300" lovHeight="450" lovLabelWidth="100" lovService="cux.KINWONG.ps.ps7010.ps7010_template_code_lov" lovWidth="500" title="方案模版选择">
                        <a:mapping>
                            <a:map from="template_code" to="template_code"/>
                            <a:map from="template_head_id" to="template_head_id"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="prescheme_id"/>
                    <a:field name="prescheme_code" readOnly="true"/>
                    <a:field name="prescheme_title" required="true"/>
                    <a:field name="prescheme_project_name"/>
                    <a:field name="prescheme_unit_code"/>
                    <a:field name="prescheme_unit_desc"/>
                    <a:field name="prescheme_comments"/>
                    <a:field name="prescheme_status_code"/>
                    <a:field name="created_by_name" readOnly="true"/>
                    <a:field name="creation_date" readOnly="true"/>
                    <a:field name="project_type_desc" lovAutoQuery="true" lovGridHeight="300" lovHeight="450" lovLabelWidth="100" lovService="cux.KINWONG.ps.ps7010.ps7010_project_type_lov" lovWidth="500" required="true" title="项目工程选择">
                        <a:mapping>
                            <a:map from="entrustment_type_desc" to="project_type_desc"/>
                            <a:map from="entrustment_type_id" to="project_type_id"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="project_type_id"/>
                    <a:field name="template_head_id"/>
                    <a:field name="area_desc" displayField="code_value_name" options="per_plan_area_ds" required="true" returnField="area" valueField="code_value"/>
                </a:fields>
                <a:events>
                    <a:event name="update" handler="ps7010_prescheme_head_ds_up"/>
                </a:events>
            </a:dataSet>
            <a:dataSet id="ps7010_prescheme_line_roject_ds" autoCount="true" autoCreate="true" autoPageSize="true" autoQuery="true" fetchAll="true" model="cux.KINWONG.ps.ps7010.ps7010_prescheme_line_eng" selectable="true">
                <a:fields>
                    <a:field name="main_material_unit_price" readOnly="true"/>
                    <a:field name="matching_code"/>
                    <a:field name="line_eng_id"/>
                    <a:field name="line_head_id" defaultValue="${/parameter/@prescheme_id}"/>
                    <a:field name="project_code" lovAutoQuery="true" lovGridHeight="300" lovHeight="450" lovLabelWidth="100" lovService="cux.KINWONG.ps.ps7010.ps7010_prescheme_project_lov" lovWidth="500" title="项目工程选择">
                        <a:mapping>
                            <a:map from="project_name" to="project_name"/>
                            <a:map from="project_characteristi" to="project_characteristi"/>
                            <a:map from="project_uom_name" to="project_uom_name"/>
                            <a:map from="project_uom_code" to="project_uom"/>
                            <a:map from="project_code" to="project_code"/>
                            <a:map from="assist_material_cost" to="assist_material_cost"/>
                            <a:map from="management_cost" to="management_cost"/>
                            <a:map from="machinery_cost" to="mechanical_cost"/>
                            <a:map from="unit_price" to="artificial_cost"/>
                            <a:map from="margin" to="profits"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="main_material_name" lovService="cux.KINWONG.ps.ps7010.ps7010_main_material_lov" lovWidth="500">
                        <a:mapping>
                            <a:map from="main_material_name" to="main_material_name"/>
                            <a:map from="main_material_model" to="main_material_model"/>
                            <a:map from="main_material_loss_rate" to="main_material_loss_rate"/>
                            <a:map from="project_uom_code" to="project_uom"/>
                            <a:map from="project_uom_desc" to="project_uom_name"/>
                            <a:map from="main_material_unit_cost" to="main_material_unit_price"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="project_name"/>
                    <a:field name="expanded" checkedValue="Y" uncheckedValue="N"/>
                    <a:field name="project_uom_name" lovAutoQuery="true" lovGridHeight="300" lovHeight="450" lovLabelWidth="100" lovService="bid.BID8010.bid8010_uom_code_lov" lovWidth="500" required="true" title="计量单位查询">
                        <a:mapping>
                            <a:map from="uom_code" to="project_uom"/>
                            <a:map from="uom_name" to="project_uom_name"/>
                            <a:map from="class_name" to="project_uom_class_name"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="category_level"/>
                    <a:field name="parent_data_id"/>
                    <a:field name="data_id"/>
                    <a:field name="project_characteristi"/>
                    <a:field name="brand"/>
                    <a:field name="project_uom_code"/>
                    <a:field name="quantities"/>
                    <a:field name="unit_price"/>
                    <a:field name="rate" lovAutoQuery="true" lovGridHeight="300" lovHeight="450" lovLabelWidth="100" lovService="cux.KINWONG.ps.ps7010.ps7010_rate_lov" lovWidth="500" title="税率选择">
                        <a:mapping>
                            <a:map from="bg_tax_type_rate" to="rate"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="Tax_unit_price" readOnly="true"/>
                    <a:field name="total_price" readOnly="true"/>
                    <a:field name="artificial_cost"/>
                    <a:field name="materials_cost"/>
                    <a:field name="mechanical_cost"/>
                    <a:field name="management_cost"/>
                    <a:field name="profits"/>
                    <a:field name="risk_cost"/>
                    <a:field name="subtotal"/>
                    <a:field name="total"/>
                    <a:field name="tax_total_price" readOnly="true"/>
                    <a:field name="comments"/>
                    <a:field name="template_line_id"/>
                    <a:field name="calculate_flag"/>
                    <a:field name="calculate_flag_2"/>
                </a:fields>
                <a:events>
                    <a:event name="update" handler="ps7010_line_roject_ds_up"/>
                    <a:event name="load" handler="ps7010_line_project_ds_load"/>
                    <a:event name="add" handler="ps7010_line_project_ds_add"/>
                </a:events>
            </a:dataSet>
            <a:dataSet id="ps7010_prescheme_line_vendor_ds" autoCount="true" fetchAll="true" model="cux.KINWONG.ps.ps7010.ps7010_prescheme_line_vendor" selectable="true">
                <a:fields>
                    <a:field name="line_vendor_id"/>
                    <a:field name="line_head_id" defaultValue="${/parameter/@prescheme_id}"/>
                    <a:field name="vendor_code" autoComplete="true" autoCompleteField="code_name" lovHeight="480" lovService="bid.public.bid_bidders_lov?entrustment_header_id=${/parameter/@entrustment_header_id}" lovWidth="500" required="true" title="BID_ENTRUSTMENT_HEADERS.BIDDER">
                        <a:mapping>
                            <a:map from="bidder_company_id" to="vendor_id"/>
                            <a:map from="bidder_code" to="vendor_code"/>
                            <a:map from="bidder_desc" to="vendor_name"/>
                            <a:map from="contact_name" to="contact_person"/>
                            <a:map from="mobile_phone" to="contact_mobile"/>
                            <a:map from="email" to="e_mail"/>
                            <a:map from="bidder_business_group" to="business_group"/>
                            <a:map from="coop_company_id" to="vendor_id"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="status_code"/>
                    <a:field name="vendor_id"/>
                    <a:field name="business_group"/>
                    <a:field name="vendor_name"/>
                    <a:field name="e_mail"/>
                    <a:field name="contact_person" autoComplete="false" lovHeight="480" lovUrl="${/request/@context_path}/modules/public/fnd_com_sup_contacts_lov.screen" lovWidth="560" title="BID_ENTRUSTMENT_LN_ITEMS.CONTACT_ID" tooltip="BID_ENTRUSTMENT_MESSAGE.CONTACT_NAME">
                        <a:mapping>
                            <a:map from="contact_name" to="contact_person"/>
                            <a:map from="mobile_phone" to="contact_mobile"/>
                            <a:map from="email" to="e_mail"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="status_desc" readOnly="true"/>
                    <a:field name="status_code"/>
                </a:fields>
            </a:dataSet>
            <a:dataSet id="ps7010_prescheme_files_ds" autoQuery="true" model="public.fnd_atm_lines" queryUrl="${/request/@context_path}/autocrud/public.fnd_atm_lines/query?source_table_name=PS_PRESCHEME_HEAD.CREATE_FILE&amp;source_pk_value=${/parameter/@prescheme_id}" selectable="true">
                <a:fields>
                    <a:field name="atm_line_id"/>
                    <a:field name="line_number"/>
                    <a:field name="atm_desc" required="true"/>
                    <a:field name="source_table_name" defaultValue="PS_PRESCHEME_HEAD.CREATE_FILE"/>
                    <a:field name="source_pk_value" defaultValue="${/parameter/@prescheme_id}"/>
                </a:fields>
                <a:events>
                    <a:event name="beforecreate" handler="ps7010_create_files_ds_beforeCreate"/>
                    <a:event name="add" handler="ps7010_create_files_ds_add"/>
                    <a:event name="submitsuccess" handler="ps7010_file_SubmitSuccess"/>
                </a:events>
            </a:dataSet>
            <a:dataSet id="ps7010_prescheme_line_query_ds">
                <a:fields>
                    <a:field name="header_id" defaultValue="${/parameter/@prescheme_id}"/>
                </a:fields>
            </a:dataSet>
            <a:dataSet id="ps7010_prescheme_line_sum_ds" autoQuery="true" model="cux.KINWONG.ps.ps7010.kw_ps7010_sum_all_query" pageSize="20" queryDataSet="ps7010_prescheme_line_query_ds">
                <a:fields>
                    <a:field name="header_id" defaultValue="${/parameter/@prescheme_id}"/>
                    <a:field name="sum_price" validator="sum_validator"/>
                </a:fields>
                <a:events>
                    <a:event name="load" handler="kw_ps7010_prescheme_line_collect_load_handler"/>
                    <a:event name="beforecreate" handler="kw_ps7010_prescheme_line_aftercreate_handler"/>
                </a:events>
            </a:dataSet>
        </a:dataSets>
        <a:screenBody>
            <a:screenTopToolbar>
                <a:toolbarButton click="ps7010PreschemeSave" text="PROMPT.SAVE" width="100"/>
                <a:toolbarButton id="ps7010_prescheme_submit_bt" click="ps7010_prescheme_submit" text="PROMPT.SUBMIT" width="100"/>
                <a:toolbarButton id="ps7010_back_button" click="ps7010_back" text="HAP_BACK" width="100"/>
                <a:toolbarButton id="ps7010_bulk_import_button" click="ps7010_prescheme_line_projectImportFun" text="批量导入方案构成" width="100"/>
                <a:toolbarButton id="ps7010_generate_template_button" click="ps7010_generate_template_ft" text="生成模版" width="100"/>
            </a:screenTopToolbar>
            <a:vBox>
                <a:hBox labelWidth="100">
                    <a:textField name="prescheme_title" bindTarget="ps7010_prescheme_head_ds" prompt="预方案标题" width="410"/>
                    <a:textField name="prescheme_code" bindTarget="ps7010_prescheme_head_ds" prompt="预方案编号" readOnly="true"/>
                    <a:datePicker name="creation_date" bindTarget="ps7010_prescheme_head_ds" prompt="创建日期" readOnly="true"/>
                </a:hBox>
                <a:hBox labelWidth="100">
                    <a:textField name="created_by_name" bindTarget="ps7010_prescheme_head_ds" prompt="创建人" readOnly="true"/>
                    <a:textField name="prescheme_project_name" bindTarget="ps7010_prescheme_head_ds" prompt="项目名称"/>
                    <a:textArea name="prescheme_comments" bindTarget="ps7010_prescheme_head_ds" height="40" prompt="备注" width="400"/>
                </a:hBox>
                <a:hBox labelWidth="100">
                    <a:lov name="project_type_desc" bindTarget="ps7010_prescheme_head_ds" prompt="工程类型"/>
                    <a:lov name="template_code" bindTarget="ps7010_prescheme_head_ds" prompt="模版编号"/>
                    <a:comboBox name="area_desc" bindTarget="ps7010_prescheme_head_ds" prompt="地区"/>
                </a:hBox>
                <a:tabPanel id="ps7010_prescheme_line_tab" height="400" marginWidth="70">
                    <a:tabs>
                        <a:tab prompt="方案构成" width="100">
                            <a:hBox>
                                <lable class="tishi"><![CDATA[注：1.请在“管理费”栏位填写管理费率，系统会自动计算出管理费。计算公式：江西:管理费=人工费*管理费率 深圳：管理费=（人工费+机械费*0.1）*费率 广东：定额固定值]]></lable>
                            </a:hBox>
                            <a:hBox>
                                <lable class="tishi2"><![CDATA[2.请在“利润”栏位填写利润率，系统会自动计算出利润。计算公式：利润=人工费*利润率 深圳：（分部分项+管理费）*费率 广东：人工费*费率]]></lable>
                            </a:hBox>
                            <a:treeGrid id="ps7010_prescheme_line_roject_grid" bindTarget="ps7010_prescheme_line_roject_ds" expandField="expanded" idField="son_matching_code" marginHeight="270" marginWidth="80" parentField="matching_code">
                                <a:toolBar>
                                    <a:button click="add_l1_project" text="新增一级工程"/>
                                    <a:button type="excel"/>
                                    <a:button type="delete"/>
                                    <a:button type="clear"/>
                                    <a:button click="calculate_fun" text="计算"/>
                                </a:toolBar>
                                <a:columns>
                                    <a:column name="project_code" align="center" editorFunction="ps7010_PreschemeTreegridEditorFunction" prompt="工程项目编码" width="80"/>
                                    <a:column name="matching_code" align="center" prompt="匹配编码" width="80"/>
                                    <a:column name="project_name" align="center" editorFunction="ps7010_PreschemeTreegridEditorFunction" prompt="项目名称" width="80"/>
                                    <a:column name="project_characteristi" editorFunction="ps7010_PreschemeTreegridEditorFunction" prompt="项目特征" width="80"/>
                                    <a:column name="main_material_name" editorFunction="ps7010_PreschemeTreegridEditorFunction" prompt="主材料名称" width="60"/>
                                    <a:column name="main_material_model" editorFunction="ps7010_PreschemeTreegridEditorFunction" prompt="主材料规格" width="60"/>
                                    <!-- <a:column name="main_material_model_desc" editorFunction="ps7010_PreschemeTreegridEditorFunction" prompt="主材料规格描述" width="100"/> -->
                                    <a:column name="add" align="center" prompt="下级项目" renderer="ps7010_PreschemeGridRendererFunction" width="40"/>
                                    <!-- <a:column name="brand" editor="ps7010_edit_line_roject_tf" prompt="品牌" width="80"/> -->
                                    <a:column name="project_uom_name" prompt="计量单位" width="35"/>
                                    <a:column name="quantities" editorFunction="ps7010_PreschemeTreegridEditorFunction" prompt="工程量" width="40"/>
                                    <a:column align="center" prompt="主材单价">
                                        <!-- <a:column name="artificial_num" align="center" editorFunction="ps7010_PreschemeTreegridEditorFunction" prompt="人工数" width="60"/>
                                        <a:column name="artificial_unit_price" align="center" editorFunction="ps7010_PreschemeTreegridEditorFunction" prompt="人工单价" width="80"/> -->
                                        <a:column name="artificial_cost" align="center" editorFunction="ps7010_PreschemeTreegridEditorFunction" footerRenderer="sum_all_render" prompt="人工费" width="60"/>
                                        <a:column name="main_material_loss_rate" align="center" editorFunction="ps7010_PreschemeTreegridEditorFunction" prompt="耗用量" width="30"/>
                                        <a:column name="main_material_unit_price" align="center" editorFunction="ps7010_PreschemeTreegridEditorFunction" prompt="主材单价" width="60"/>
                                        <a:column name="main_material_cost" align="center" editorFunction="ps7010_PreschemeTreegridEditorFunction" footerRenderer="sum_all_render" prompt="主材费" width="60"/>
                                        <a:column name="mechanical_cost" align="center" editorFunction="ps7010_PreschemeTreegridEditorFunction" footerRenderer="sum_all_render" prompt="机械费" width="60"/>
                                        <a:column name="management_cost" align="center" editorFunction="ps7010_PreschemeTreegridEditorFunction" footerRenderer="sum_all_render" prompt="管理费" width="60"/>
                                        <a:column name="assist_material_cost" align="center" editorFunction="ps7010_PreschemeTreegridEditorFunction" footerRenderer="sum_all_render" prompt="辅材费" width="60"/>
                                        <a:column name="profits" align="center" editorFunction="ps7010_PreschemeTreegridEditorFunction" footerRenderer="sum_all_render" prompt="利润" width="60"/>
                                        <a:column name="subtotal" align="center" editorFunction="ps7010_PreschemeTreegridEditorFunction" prompt="小计" width="60"/>
                                    </a:column>
                                    <a:column name="total" align="center" autoAdjust="true" editorFunction="ps7010_PreschemeTreegridEditorFunction" footerRenderer="sum_all_render" prompt="合计" width="70"/>
                                    <!-- <a:column name="rate" align="center" autoAdjust="true" editor="ps7010_edit_line_roject_lov" prompt="税率" width="50"/> -->
                                    <a:column name="comments" align="left" autoAdjust="true" editor="ps7010_edit_line_roject_tf" prompt="备注" width="200"/>
                                    <a:column name="category_level" align="center" prompt="级别" width="40"/>
                                </a:columns>
                                <a:editors>
                                    <a:textField id="ps7010_edit_line_roject_tf"/>
                                    <a:numberField id="ps7010_edit_line_roject_nf" allowDecimals="true" allowFormat="true" allowNegative="false" decimalPrecision="2"/>
                                    <a:lov id="ps7010_edit_line_roject_lov"/>
                                </a:editors>
                            </a:treeGrid>
                        </a:tab>
                        <a:tab prompt="汇总表">
                            <a:grid id="ps7010_prescheme_line_sum_grid" bindTarget="ps7010_prescheme_line_sum_ds" marginHeight="270" marginWidth="80" navBar="true">
                                <a:toolBar>
                                    <a:button type="excel"/>
                                </a:toolBar>
                                <a:columns>
                                    <a:column name="line_num" align="center" prompt="行号" width="100"/>
                                    <a:column name="project_name" align="center" prompt="项目名称" width="150"/>
                                    <a:column name="sum_price" align="center" editorFunction="kw_bid_entrument_ln_collect_editFun" prompt="总价" width="150"/>
                                    <a:column name="comments" prompt="备注" width="385"/>
                                </a:columns>
                                <a:editors>
                                    <a:numberField id="ps7010_prescheme_line_collect_nf" allowDecimals="true" allowFormat="true" allowNegative="false" decimalPrecision="8"/>
                                </a:editors>
                            </a:grid>
                        </a:tab>
                        <a:tab prompt="建议供应商" width="100">
                            <a:grid id="ps7010_prescheme_line_vendor_grid" bindTarget="ps7010_prescheme_line_vendor_ds" marginHeight="270" marginWidth="80" navBar="true">
                                <a:toolBar>
                                    <a:button type="add"/>
                                    <a:button type="delete"/>
                                </a:toolBar>
                                <a:columns>
                                    <a:column name="vendor_code" align="left" editor="ps7010_prescheme_line_vendor_lov" prompt="供应商代码" width="100"/>
                                    <a:column name="vendor_name" align="left" editor="ps7010_prescheme_line_vendor_tf" prompt="供应商名称" width="200"/>
                                    <a:column name="contact_person" align="left" editor="ps7010_prescheme_line_vendor_lov" prompt="联系人" width="100"/>
                                    <a:column name="contact_mobile" align="left" editor="ps7010_prescheme_line_vendor_tf" prompt="联系电话" width="150"/>
                                    <a:column name="e_mail" align="left" editor="ps7010_prescheme_line_vendor_tf" prompt="电子邮件" width="150"/>
                                    <a:column name="status_desc" align="center" prompt="状态" renderer="ps7010_status_renderer" width="80"/>
                                </a:columns>
                                <a:editors>
                                    <a:lov id="ps7010_prescheme_line_vendor_lov"/>
                                    <a:textField id="ps7010_prescheme_line_vendor_tf"/>
                                </a:editors>
                                <a:events>
                                    <a:event name="cellclick" handler="ps7010_line_ven_ds_cellclickFun"/>
                                </a:events>
                            </a:grid>
                        </a:tab>
                        <a:tab prompt="附件信息" width="100">
                            <a:grid id="ps7010_files_grid" bindTarget="ps7010_prescheme_files_ds" marginHeight="270" marginWidth="80" navBar="true">
                                <a:toolBar>
                                    <a:button type="add"/>
                                    <a:button type="save"/>
                                    <a:button type="delete"/>
                                </a:toolBar>
                                <a:columns>
                                    <a:column name="atm_desc" editor="ps7010_files_desc_tf" prompt="FND_ATM_LINES.ATM_DESC"/>
                                    <a:column name="upload_user_desc" prompt="上传人"/>
                                    <a:column name="upload_date" prompt="上传时间"/>
                                    <a:column align="center" prompt="PROMPT.UPLOAD_DOWNLOAD" renderer="ps7010_upload_renderer" width="100"/>
                                </a:columns>
                                <a:editors>
                                    <a:textField id="ps7010_files_desc_tf" maxLength="500"/>
                                </a:editors>
                            </a:grid>
                        </a:tab>
                    </a:tabs>
                </a:tabPanel>
            </a:vBox>
        </a:screenBody>
        <script><![CDATA[
            init();
        ]]></script>
    </a:view>
</a:screen>
