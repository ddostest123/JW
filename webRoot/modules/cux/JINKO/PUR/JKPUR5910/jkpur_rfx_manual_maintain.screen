<?xml version="1.0" encoding="UTF-8"?>
<!--
    $Author: IsaacF  
    $Date: 2013-6-25 下午7:34:51  
    $Revision: 1.0  
    $Purpose: 
-->
<a:screen xmlns:a="http://www.aurora-framework.org/application" xmlns:s="aurora.plugin.script" trace="true">
    <a:init-procedure>
        <a:model-query fetchAll="true" model="public.csh_payment_methods_list" rootPath="pur51302_payment_methods_source"/>
        <a:model-query fetchAll="true" model="public.currency_list" rootPath="pur51302_currency_source"/>
    </a:init-procedure>
    <a:view>
        <a:link id="jkpur5910_copyFromOtherPur_link" url="${/request/@context_path}/modules/cux/JINKO/PUR/JKPUR5910/jkpur_rfx_copy_header_query.screen"/>
        <a:link id="jkpur5910_agreement_confirm_link" url="${/request/@context_path}/modules/cux/JINKO/PUR/JKPUR5910/jkpur_rfx_cnt_agreement_confirm.screen"/>
        <a:link id="pur51302_rfx_maintain_link" url="${/request/@context_path}/modules/pur/PUR5130/pur_rfx_manual_maintain.screen"/>
        <a:link id="pur51302_rfx_save_link" url="${/request/@context_path}/modules/cux/JINKO/PUR/JKPUR5910/jkpur_rfx_save.svc"/>
        <a:link id="pur51302_rfx_submit_link" model="cux.JINKO.PUR.JKPUR5910.jkpur_rfx_submit" modelaction="execute"/>
        <a:link id="pur51302_rfx_cancel_link" model="cux.JINKO.PUR.JKPUR5910.jkpur_rfx_cancel" modelaction="execute"/>
        <a:link id="pur51302_rfx_quote_link" url="${/request/@context_path}/modules/pur/PUR5130/pur_rfx_quote_edit.screen"/>
        <a:link id="pur51302_rfx_quote_create_link" url="${/request/@context_path}/modules/pur/PUR5130/pur_rfx_quote_create.screen"/>
        <a:link id="pur51302_attachment_file_upload_link" url="${/request/@context_path}/attachment_file_upload.screen"/>
        <style><![CDATA[
  .desc-a-part{
    text-indent: 1em;
    font-size:14px;
    color:#444;
}
   .desc-a-part a{
	color:#19a2d5;
}     
        ]]></style>
        <script><![CDATA[
            function pur51302_rfx_headers_ds_update(ds, record, name, value, oldvalue) {
                if (name == 'owner_business_unit_id') {
                    var item_records = $("pur51302_rfx_ln_items_ds").getAll();
                    for (var i = 0;i < item_records.length;i++) {
                        item_records[i].set('owner_business_unit_id', value);
                    }
                } else if (name == 'currency_code' || name == 'functional_currency_code') {
                    var functional_currency_code = record.get('functional_currency_code');
                    var currency_code = record.get('currency_code');
                    if (functional_currency_code != currency_code) {
                        record.set('exchange_rate', '');
                        record.getMeta().getField('exchange_rate').setReadOnly(false);
                    } else {
                        record.set('exchange_rate', 1);
                        record.getMeta().getField('exchange_rate').setRequired(false);
                        record.getMeta().getField('exchange_rate').setReadOnly(true);
                    }
                } else if (name == 'tax_included_flag') {
                    record.set('tax_type_id', '');
                    record.set('tax_type_code', '');
                    record.set('tax_type_desc', '');
                    record.set('tax_type_rate', '');
                    if (value == 'Y') {
                        record.getMeta().getField('tax_type_desc').setRequired(true);
                        record.getMeta().getField('tax_type_desc').setReadOnly(false);
                    } else {
                        record.getMeta().getField('tax_type_desc').setRequired(false);
                        record.getMeta().getField('tax_type_desc').setReadOnly(true);
                    }
                }
                if (record.getField('pur_organization_name').isRequired()) {
                    record.getField('pur_organization_name').setRequired(false);
                    record.getField('pur_organization_name').setRequired(true);
                } else {
                    record.getField('pur_organization_name').setRequired(true);
                    record.getField('pur_organization_name').setRequired(false);
                }
            
                record.getField('business_unit_name').setRequired(false);
                record.getField('business_unit_name').setRequired(true);
            
            }
            
            function check_update() {                          
                if ($('pur51302_rfx_ln_items_ds').isModified()) {
                    return 'Y';
                }                              
                return 'N';
            }
            
            function pur51302_rfx_headers_ds_load(dataSet) {
                var record = dataSet.getCurrentRecord();
            
                var functional_currency_code = record.get('functional_currency_code');
                var currency_code = record.get('currency_code');
                if (functional_currency_code != currency_code) {
                    record.getMeta().getField('exchange_rate').setReadOnly(false);
                } else {
                    record.set('exchange_rate', 1);
                    record.getMeta().getField('exchange_rate').setRequired(false);
                    record.getMeta().getField('exchange_rate').setReadOnly(true);
                }
            
                var tax_included_flag = record.get('tax_included_flag');
                if (tax_included_flag == 'Y') {
                    record.getMeta().getField('tax_type_desc').setRequired(true);
                    record.getMeta().getField('tax_type_desc').setReadOnly(false);
                } else {
                    record.getMeta().getField('tax_type_desc').setRequired(false);
                    record.getMeta().getField('tax_type_desc').setReadOnly(true);
                }
                if (Aurora.isEmpty(record.get("tax_included_flag"))) {
                    record.set("tax_included_flag", 'N');
                }
                var status = record.get('status');
                if (status == 'RESULT_REJECTED') {
                    $('jkpur5910_save_bt').disable();
                    
                }
            }
            
            
            
            /* 批量添加供应商 add by Harry 9952 2016/11/24 */
            
            function pur51302_rfx_batch_add_supplier() {
                var header_record = $('pur51302_rfx_headers_ds').getCurrentRecord();
                var rfx_header_id = header_record.get('rfx_header_id');
                var company_id = header_record.get('company_id');
            
                new Aurora.Window({
                    url: '${/request/@context_path}/modules/cux/JINKO/PUR/JKPUR5910/jkpur_rfx_batch_add_supplier.screen?company_id=' + company_id + '&rfx_header_id=' + rfx_header_id,
                    title: '${l:PUR5130.BATCH_ADD_SUPPLIER}',
                    id: 'pur51302_rfx_batch_add_supplier_win',
                    width: 1000,
                    height: 500
                });
                $('pur51302_rfx_batch_add_supplier_win').on('close', function() {});
            }
            
            function pur51302_rfx_save() {
                var header_ds = $('pur51302_rfx_headers_ds');
                var item_ds = $('pur51302_rfx_ln_items_ds');
                var vendor_ds = $('pur51302_rfx_ln_vendors_ds');
                var attachments_ds = $('pur51302_rfx_ln_attachments');
                var header_record = header_ds.getCurrentRecord();
                header_record.set('source_from', 'MANUAL');               
                if (!header_ds.validate()) {
                    return;
                }
                if (!item_ds.validate()) {
                    return;
                }
                var item_records = item_ds.getAll();
                for (i = 0;i < item_records.length;i++) {
                    if (item_records[i].dirty) {
                        var quote_lines = item_records[i].get('quote_lines');
                        if (quote_lines) {
                            for (m = 0;m < quote_lines.data.length;m++) {
                                quote_lines.data[m].dirty = true;
                            }
            
                        }
                    }
                }
                if (item_records.length > 1){
                    Aurora.showMessage('${l:PROMPT}', '物料行数据应少于两行');
                    return;
                }
                if (!vendor_ds.validate()) {
                    return;
                }
                if (!attachments_ds.validate()) {
                    return;
                }
                var data = header_record.data;
                if (Aurora.isEmpty(header_record.get('rfx_header_id'))) {
                    data._status = 'insert';
                } else {
                    data._status = 'update';
                }
                data['items'] = item_ds.getJsonData();
                data['vendors'] = vendor_ds.getJsonData();
                data['attachments'] = attachments_ds.getJsonData();
                pur51302_mask();
                Aurora.request({
                    url: $('pur51302_rfx_save_link').getUrl(),
                    para: data,
                    success: function(result) {
                        pur51302_unmask();
                        Aurora.showMessage('${l:PROMPT}', '${l:PUR5130.RFX_SAVED_SUCCESSFULLY}', function() {
                            header_ds.query();
                            item_ds.query();
                            vendor_ds.query();
                            attachments_ds.query();
                            $('pur5910_rule_name_header_ds').query();
            
                        });
            
                    },
                    failure: function() {
                        pur51302_unmask();
                        return;
                    },
                    error: function() {
                        pur51302_unmask();
                        return;
                    }
                });
            }
            
            
            function pur51302_rfx_submit() {
               var isModified = check_update();
                    if (isModified == 'Y') {
                        Aurora.showMessage('${l:PROMPT}', '${l:PUR5730.SAVE_DATA_FIRST}', null);
                        return;
                    }
                var header_ds = $('pur51302_rfx_headers_ds');
                var item_ds = $('pur51302_rfx_ln_items_ds');
                var vendor_ds = $('pur51302_rfx_ln_vendors_ds');
                var attachments_ds = $('pur51302_rfx_ln_attachments');
                var header_record = header_ds.getCurrentRecord();
                header_record.set('source_from', 'MANUAL');
                if (!header_ds.validate()) {
                    return;
                }
                if (!item_ds.validate()) {
                    return;
                }
                var item_records = item_ds.getAll();
                for (i = 0;i < item_records.length;i++) {
                    if (item_records[i].dirty) {
                        var quote_lines = item_records[i].get('quote_lines');
                        if (quote_lines) {
                            for (m = 0;m < quote_lines.data.length;m++) {
                                quote_lines.data[m].dirty = true;
                            }
            
                        }
                    }
                }
                if (!vendor_ds.validate()) {
                    return;
                }
                if (!attachments_ds.validate()) {
                    return;
                }
                var data = header_record.data;
                if (Aurora.isEmpty(header_record.get('rfx_header_id'))) {
                    data._status = 'insert';
                } else {
                    data._status = 'update';
                }
                data['items'] = item_ds.getJsonData();
                data['vendors'] = vendor_ds.getJsonData();
                data['attachments'] = attachments_ds.getJsonData();
                pur51302_mask();
                Aurora.request({
                    url: $('pur51302_rfx_save_link').getUrl(),
                    para: data,
                    success: function(result) {
                        pur51302_unmask();
                        header_ds.query();
                        item_ds.query();
                        vendor_ds.query();
                        attachments_ds.query();
                        Aurora.showConfirm('${l:PROMPT}', '${l:PUR5140.RFX_RELEASE_CONFIRM}', function() {
                            pur51302_mask();
                            Aurora.request({
                                url: $('pur51302_rfx_submit_link').getUrl(),
                                para: {
                                    rfx_header_id: header_ds.getAt(0).get('rfx_header_id')
                                },
                                success: function() {
                                    pur51302_unmask();
                                    Aurora.showMessage('${l:PROMPT}', '${l:PUR5130.RFX_RELEASED_SUCCESSFULLY}', function() {
                                        pur51302_reback();
                                    });
                                },
                                failure: function() {
                                    pur51302_unmask();
                                    return;
                                },
                                error: function() {
                                    pur51302_unmask();
                                    return;
                                }
                            });
                        });
            
                    },
                    failure: function() {
                        pur51302_unmask();
                        return;
                    },
                    error: function() {
                        pur51302_unmask();
                        return;
                    }
                });
            
            }
            
            function pur51302_rfx_cancel() {
                var data = {};
                data.rfx_header_id = '${/parameter/@rfx_header_id}';
                Aurora.showConfirm('${l:PROMPT}', '${l:PUR5140.RFX_CANCEL_CONFIRM}', function() {
                    if (Aurora.isEmpty(data.rfx_header_id)) {
                        pur51302_reback();
                        return;
                    }
                    pur51302_mask();
                    Aurora.request({
                        url: $('pur51302_rfx_cancel_link').getUrl(),
                        para: data,
                        success: function() {
                            pur51302_unmask();
                            Aurora.showMessage('${l:PROMPT}', '${l:PUR5140.RFX_CANCEL_SUCCESSFULLY}', function() {
                                pur51302_reback();
                            });
                        },
                        failure: function() {
                            pur51302_unmask();
                            return;
                        },
                        error: function() {
                            pur51302_unmask();
                            return;
                        }
                    });
                });
            }
            
            function pur51302_confirmBeforeBack() {
                pur51302_reback();
            }
            
            function pur51302_reback() {
                jkpur5910_query();
                $('jkpur5910_rfx_manual_maintain_window').close();
            }
            
            function pur51302_rfx_ln_items_ds_load(ds) {
                var records = ds.getAll();
                      
                for (var i = 0;i < records.length;i++) {
                    var owner_business_unit_id = records[i].get('owner_business_unit_id');
                    var inv_organization_id = records[i].get('inv_organization_id');
                    var item_category_id = records[i].get('item_category_id');
                    if (!Aurora.isEmpty(owner_business_unit_id)) {
                        records[i].getField('inv_organization_desc').setLovPara('owner_business_unit_id', owner_business_unit_id);
                    }
                    if (!Aurora.isEmpty(inv_organization_id)) {
                        records[i].getField('item_code').setLovPara('inv_organization_id', inv_organization_id);
                    }
                    if (!Aurora.isEmpty(item_category_id)) {
                        records[i].getField('item_code').setLovPara('item_category_id', item_category_id);
                    }
                }
            }
            
            function pur51302_rfx_ln_items_grid_cellclick(grid, row, name, record) {
                var owner_business_unit_id = record.get('owner_business_unit_id');
            
                if (name == 'item_code') {
                    record.getField('item_code').setLovPara('owner_business_unit_id', owner_business_unit_id);
            
                    if (Aurora.isEmpty(record.get('inv_organization_id'))) {
                        record.getField('item_code').setLovPara('inv_organization_id', -1);
                    } else {
                        record.getField('item_code').setLovPara('inv_organization_id', record.get('inv_organization_id'));
                    }
            
                    var item_category_id = record.get('item_category_id');
                    if (Aurora.isEmpty(item_category_id)) {
                        record.getField('item_code').setLovPara('item_category_id', -1);
                    } else {
                        record.getField('item_code').setLovPara('item_category_id', item_category_id);
                    }
                } else if (name == 'quote_name') {
                    grid.focusRow(row);
                }
            }
            
            function pur51302_rfx_ln_items_ds_update(ds, record, name, value, oldvalue) {
                if (name == 'owner_business_unit_id') {
                    record.set('inv_organization_id', '');
                    record.set('inv_organization_code', '');
                    record.set('inv_organization_desc', '');
                    record.getField('inv_organization_desc').setLovPara('business_unit_id', value);
                } else if (name == 'inv_organization_id') {
                    record.set('item_id', '');
                    record.set('item_code', '');
                    record.set('item_desc', '');
                    record.getField('item_code').setLovPara('inv_organization_id', value);
                } else if (name == 'item_category_desc') {
                    if (Aurora.isEmpty(value)) {
                        record.set('item_category_id', '');
                    }
                } else if (name == 'item_category_id') {
                    //自主品类变更,清除当前record下的对应的报价模板创建ds中数据
                    var quote_lines = record.get('quote_lines');
                    if (quote_lines) {
                        for (var i = quote_lines.data.length - 1;i >= 0;i--) {
                            var quote_line_rec = quote_lines.data[i];
                            $('pur51202_rfx_quote_create_ds').remove(quote_line_rec);
                        }
                    }
            
                    if (!Aurora.isEmpty(value)) {
                        pur51302_mask();
                        $('pur51302_rfx_quote_query_ds').setQueryParameter('item_category_id', value);
                        $('pur51302_rfx_quote_query_ds').setQueryParameter('rfx_line_item_id', record.get('rfx_line_item_id'));
                        $('pur51302_rfx_quote_query_ds').query();
                    }
                } 
            }
            
            function pur51302_rfx_quote_query_ds_loadFun(ds) {
                pur51302_unmask();
                var records = ds.getAll();
                for (var i = 0;i < records.length;i++) {
                    $('pur51202_rfx_quote_create_ds').add(records[i]);
                }
            }
            
            function getMaxLineNum(ds) {
                var records = ds.getAll();
                var max_line_num = 0;
                for (var i = 0;i < records.length;i++) {
                    max_line_num = records[i].get('line_num') > max_line_num ? records[i].get('line_num') : max_line_num;
                }
                max_line_num++;
                return max_line_num;
            }
            
            function pur51302_rfx_ln_items_ds_add(ds, record, index) {
                var owner_business_unit_id = $('pur51302_rfx_headers_ds').getCurrentRecord().get('owner_business_unit_id');
                if (Aurora.isEmpty(owner_business_unit_id)) {
                    Aurora.showMessage('${l:PROMPT}', '${l:PUR5130.CHOOSE_BU_FIRST_THEN_ADD_ITEM}');
                    return false;
                }
            
                record.set('owner_business_unit_id', owner_business_unit_id);
                var line_num = getMaxLineNum(ds);
                var tax_type_id = $('pur51302_rfx_headers_ds').getCurrentRecord().get('tax_type_id');
                var tax_type_code = $('pur51302_rfx_headers_ds').getCurrentRecord().get('tax_type_code');
                var description = $('pur51302_rfx_headers_ds').getCurrentRecord().get('description');
                var tax_type_rate = $('pur51302_rfx_headers_ds').getCurrentRecord().get('tax_type_rate');
                var tax_included_flag = $('pur51302_rfx_headers_ds').getCurrentRecord().get('tax_included_flag');
            
                record.set('line_num', line_num);
                record.set('tax_type_id', tax_type_id);
                record.set('tax_type_code', tax_type_code);
                record.set('description', description);
                record.set('tax_type_rate', tax_type_rate);
                record.set('tax_included_flag', tax_included_flag);
            
                var head_rec = $('pur51302_rfx_headers_ds').getCurrentRecord();
                var item_classify_require_flag = head_rec.get('item_classify_require_flag');
                //配置中心，判断物料分类是否必输
                var item_records = ds.getAll();
                if (item_classify_require_flag == 'Y') {
                    for (i = 0;i < item_records.length;i++) {
                        item_records[i].getField('item_category_desc').setRequired(true);
                    }
                }
            
            }
            
            function pur51302_rfx_ln_items_ef(record, name) {
                if (name == 'item_category_desc') {
                    var item_id = record.get('item_id');
                    if (Aurora.isEmpty(item_id)) {
                        return 'pur51302_item_category_desc_lov';
                    }
                    return 'pur51302_item_category_desc_lov';
                }
            }
            
            function pur51302_rfx_ln_vendors_ds_load(ds) {
                var records = ds.getAll();
                for (var i = 0;i < records.length;i++) {
                    var vendor_company_id = records[i].get('coop_company_id');
                    if (!Aurora.isEmpty(vendor_company_id)) {
                        records[i].getField('contact_person').setLovPara('vendor_company_id', vendor_company_id);
                        records[i].getField('contact_person').setReadOnly(false);
                    }
                }
            }
            
            function pur51302_rfx_ln_vendors_ds_update(ds, record, name, value, oldvalue) {
                if (name == 'coop_company_id') {
            
                    if (Ext.isEmpty(value)) {
                        record.getField('contact_person').setLovPara('vendor_company_id', -1);
                        record.getField('contact_person').setReadOnly(true);
                    } else {
                        record.getField('contact_person').setLovPara('vendor_company_id', value);
                        record.getField('contact_person').setReadOnly(false);
                    }
                }
            }
            
            function pur51302_rfx_ln_vendors_ds_beforecreate(ds, object) {
                var rfx_method = $('pur51302_rfx_headers_ds').getCurrentRecord().get('rfx_method');
                if (rfx_method == 'OPEN') {
                    Aurora.showMessage('${l:PROMPT}', '${l:PUR5120.OPEN_RFX_VENDOR_REMAIN}');
                    return false;
                }
                return true;
            }
            
            function pur51302_mask() {
                Aurora.Masker.mask($('jkpur5910_rfx_manual_maintain_window').wrap, '${l:LOADING}');
            
            }
            
            function pur51302_unmask() {
                Aurora.Masker.unmask($('jkpur5910_rfx_manual_maintain_window').wrap);
            }
            
            //上传附件
            
            function pur51302_atch_num_rd(value, record, name) {
                var ds = $('pur51302_rfx_ln_attachments');
                var line_num = ds.indexOf(record);
            
                return (line_num + 1) * 10;
            
            }
            
            function pur51302_upload_render(value, record, name) {
                var atm_line_id = record.get('atm_line_id');
                var atm_counts = record.get('atm_counts');
                if (name == "attachment") {
                    if (!record.isNew && atm_line_id) {
                        return '<a href="javascript:pur51302_upload_file(' + atm_line_id + ')">${l:PROMPT.UPLOAD_DOWNLOAD}</a>';
                    }
                }
            
                if (name == "atm_flag") {
                    if (atm_counts > 0) {
                        return '<div style="margin-top:3px;margin-left:auto;margin-right:auto;vertical-align:middle;height:20px;line-height:20px;"><img src="${/request/@context_path}/images/paperclip.png"/></div>';
            
                    } else {
                        return '';
                    }
                }
            }
            
            function pur51302_upload_file(id) {
                var url = "${/request/@context_path}/uploadFile.screen?table_name=JK_PUR_RFX_HEADERS&header_id=" + id;
                new Aurora.Window({
                    url: url,
                    title: '${l:ATM.UPLOAD_ATTACHMENT}',
                    id: 'pur51302_upload_window',
                    width: 850,
                    height: 500
                }).on('beforeclose', function() {
                    $('pur51302_rfx_ln_attachments').query();
                });
            }
            
            //比较两个日期的大小
            
            function pur51302_compareDate(start, end) {
            
                if (typeof(start) == 'string') {
                    start = new Date(start.replace(/-/g, '/'));
                }
            
                if (typeof(end) == 'string') {
                    end = new Date(end.replace(/-/g, '/'));
                }
            
                if (start > end) {
                    return false;
                }
                return true;
            }
            
            //发布日期校验
            
            function pur51302_release_dateValidator(record, name, value) {
                if (name == 'feedback_start_time' || name == 'feedback_end_time') {
                    //var start = record.get('feedback_start_time');
                    var end = record.get('feedback_end_time');
            
                    if ( !! end) {
                        var sysdate = new Date();
                        if (!pur51302_compareDate(sysdate, end)) {
                            return '${l:PUR5130.CLOSING_MUST_BE_LATER_THAN_CURRENT}';
                        }
                    }
                    return true;
                }
            }
            
            
            function pur51302_vendors_grid_cellclick(grid, row, name, record) {
                var head_record = $('pur51302_rfx_headers_ds').getCurrentRecord();
                var company_id = head_record.get('company_id');
                if (name == 'vendor_code') {
                    record.getField('vendor_code').setLovPara('company_id', company_id);
                }
            }
            
            function pur51302_rfx_ln_vendors_ds_add(ds, record, index) {
                var owner_business_unit_id = $('pur51302_rfx_headers_ds').getCurrentRecord().get('owner_business_unit_id');
                if (Aurora.isEmpty(owner_business_unit_id)) {
                    Aurora.showMessage('${l:PROMPT}', '${l:PUR5130.CHOOSE_BU_FIRST_THEN_ADD_VENDOR}');
                    return false;
                }
            }
            
            function pur51302_rfx_operation_record_fun() {
                new Aurora.Window({
                    url: '${/request/@context_path}/modules/pur/public/pur_rfx_operation_records.screen?rfx_header_id=${/parameter/@rfx_header_id}',
                    title: '${l:PROMPT.OPERATION_RECORD}',
                    id: 'pur_publicRfxOperationRecord_window',
                    width: 500,
                    height: 350
                });
            }
            
            function pur51302_quoteRendererFun(value, record, name) {
                var rfx_line_item_id = record.get('rfx_line_item_id');
                var item_category_id = record.get('item_category_id');
                var quote_tmpl_flag = record.get('quote_tmpl_flag');
            
                if (!Aurora.isEmpty(item_category_id) && quote_tmpl_flag == 'Y') {
                    return '<a href="javascript:pur51202_quoteCreateFun(' + record.id + "," + item_category_id + ')">${l:PUR_RFX_QUOTE_TITLE}</a>';
                }
                return '';
            
            }
            
            function pur51202_quoteEditFun(rfx_line_item_id) {
                new Aurora.Window({
                    url: $('pur51302_rfx_quote_link').getUrl() + '?rfx_line_item_id=' + rfx_line_item_id,
                    title: '${l:PUR_RFX_QUOTE_TITLE}',
                    id: 'pur51302_rfx_quote_window',
                    width: 500,
                    height: 380
                });
            }
            
            var open_renderer_flag = 'N';
            var item_record_id = -1;
            var item_category_id2 = -1;
            
            function pur51202_quoteCreateFun(id, item_category_id) {
            
                var record = $('pur51302_rfx_ln_items_ds').findById(id);
                $('pur51202_rfx_quote_edit_ds').removeAll();
                var quote_lines = record.get('quote_lines');
                if (quote_lines) {
                    for (var i = quote_lines.data.length - 1;i >= 0;i--) {
                        var quote_line_rec = quote_lines.data[i];
                        if (quote_line_rec.get('template_line_id')) {
                            $('pur51202_rfx_quote_edit_ds').create({
                                'quote_line_id': quote_line_rec.get('quote_line_id'),
                                'quote_header_id': quote_line_rec.get('quote_header_id'),
                                'config_item': quote_line_rec.get('config_item'),
                                'parameter_requirements': quote_line_rec.get('parameter_requirements'),
                                'template_id': quote_line_rec.get('template_id'),
                                'template_line_id': quote_line_rec.get('template_line_id'),
                                'item_category_id': quote_line_rec.get('item_category_id'),
                                'rfx_line_item_id': quote_line_rec.get('rfx_line_item_id'),
                            });
                        }
            
                    }
            
                    new Aurora.Window({
                        url: $('pur51302_rfx_quote_create_link').getUrl() + '?id=' + id + '&item_category_id=' + item_category_id,
                        title: '${l:PUR_RFX_QUOTE_TITLE}',
                        id: 'pur51302_rfx_quote_create_window',
                        width: 520,
                        height: 420
                    });
                    open_renderer_flag = 'N';
                    item_record_id = -1;
                    item_category_id2 = -1;
                } else {
                    open_renderer_flag = 'Y';
                    item_record_id = id;
                    item_category_id2 = item_category_id;
                }
            }
            
            
            function pur51202_rfx_quote_create_loadFun(ds) {
                pur51302_unmask();
                if (open_renderer_flag == 'Y') {
                    setTimeout(function() {
                        pur51202_quoteCreateFun(item_record_id, item_category_id2);
                    }, 500)
            
                }
            }
            
            function pur51302_taxTypeRateEditorFunction(record, name) {
                if (record.get('tax_included_flag') == 'Y') {
                    record.getMeta().getField('tax_type_rate').setRequired(true);
                    return 'pur51302_tax_type_rate_lov';
                } else {
                    record.getMeta().getField('tax_type_rate').setRequired(false);
                    record.set('tax_type_id', '');
                    record.set('tax_type_code', '');
                    record.set('tax_type_desc', '');
                    record.set('tax_type_rate', '');
                    return '';
                }
            }
            
            
            
            
            function pur51302_upload_attachment(value, record, name) {
                var rfx_line_item_id = record.get('rfx_line_item_id');
                var atm_counts = record.get('atm_counts');
                if (name == "item_attachment") {
                    if (Aurora.isEmpty(rfx_line_item_id)) {
                        return '-';
                    } else {
                        return '<a href="javascript:pur51302_attach_upload_function(' + rfx_line_item_id + ')">${l:ATM.UPLOAD_ATTACHMENT}</a>';
                    }
                }
            
                if (name == "atm_flag") {
                    if (atm_counts > 0) {
                        return '<div style="margin-top:3px;margin-left:auto;margin-right:auto;vertical-align:middle;height:20px;line-height:20px;"><img src="${/request/@context_path}/images/paperclip.png"/></div>';
            
                    } else {
                        return '';
                    }
                }
            }
            
            function pur51302_attach_upload_function(rfx_line_item_id) {
                new Aurora.Window({
                    id: 'pur51302_attachment_file_upload_link_window',
                    title: '${l:HAP_UPLOAD_TITLE}',
                    url: $('pur51302_attachment_file_upload_link').getUrl() + '?pkvalue=' + rfx_line_item_id + '&table_name=JK_PUR_RFX_LN_ITEMS',
                    width: 500,
                    height: 500
                });
            }
            //竞标规则                      
            function jkpur5910_config_agreement_open() {
                Aurora.Masker.mask(Ext.getBody(), '正在跳转竞标规则页面...');
                new Aurora.Window({
                    id:'jkpur5910_agreement_confirm_window',
                    url:$('jkpur5910_agreement_confirm_link').getUrl() + '?agreement_type=BCD' + '&owner_business_group=${/session/@business_group}',
                    fullScreen: true
                }).on('close',function(){
                    Aurora.Masker.unmask(Ext.getBody());
                });                
            }
            //复制功能
            function jkpur5910_rfx_copy() {              
                o_rfx_header_id = '';
                new Aurora.Window({
                    id: 'jkpur5910_copyFromOtherPur_window',
                    url: $('jkpur5910_copyFromOtherPur_link').getUrl(),
                    title: '复制其他招竞标单据信息',
                    height: 450,
                    width: 700
                }).on('close', function() {
                    $('jkpur5910_rfx_manual_maintain_window').load($('jkpur5910_rfx_manual_maintain_link2').getUrl() + '?rfx_header_id=' + o_rfx_header_id);
                });
            }
            
            function pur5910_rule_name_header_ds_load(dataSet){
                
                var rule_name_header_records = dataSet.getAll();
                var distribution_rule_name='';
                var header_record = $('pur51302_rfx_headers_ds').getCurrentRecord();
                for (i = 0;i < rule_name_header_records.length;i++) {
                     var distribution_rule_name_a = rule_name_header_records[i].get('distribution_rule_name');
                     distribution_rule_name = distribution_rule_name + distribution_rule_name_a;
                }                             
                
                var distribution_rule_name_line = distribution_rule_name;
                var distribution_rule_name_header =header_record.get('distribution_rule_name')
                if (Aurora.isEmpty(distribution_rule_name_header)){
                    header_record.set('distribution_rule_name', distribution_rule_name_line); 
                    return;
                }
                if (!Aurora.isEmpty(distribution_rule_name_header) && distribution_rule_name_header != distribution_rule_name_line){
                    header_record.set('distribution_rule_name', distribution_rule_name_line);
                    return;
                }
                
            }
        ]]></script>
        <a:dataSets>
            <a:dataSet id="pur51302_bg_rfx_type_ds" autoCreate="true" loadData="true">
                <a:datas dataSource="/model/pur51302_bg_rfx_type"/>
            </a:dataSet>
            <a:dataSet id="pur5910_rfx_price_ds" lookupCode="JK_ZJB_FEEDBACK_PRICE_TYPE"/>
            <a:dataSet id="pur51302_rfx_category_ds" lookupCode="PUR_RFX_CATEGORY"/>
            <a:dataSet id="pur51302_rfx_method_ds" lookupCode="JK_ZJB_METHOD"/>
            <a:dataSet id="pur51302_rfx_auction_direction_ds" lookupCode="PUR_RFX_AUCTION_DIRECTION"/>
            <a:dataSet id="pur51302_rfx_open_rule_ds" lookupCode="PUR_RFX_OPEN_RULE"/>
            <a:dataSet id="jkpur5910_rfx_ranking_rule_ds" lookupCode="PUR_RFX_AUCTION_RANKING"/>
            <a:dataSet id="pur51302_payment_method_ds" autoCreate="true" loadData="true">
                <a:datas dataSource="/model/pur51302_payment_methods_source"/>
            </a:dataSet>
            <a:dataSet id="pur51302_currency_ds" autoCreate="true" loadData="true">
                <a:datas dataSource="/model/pur51302_currency_source"/>
            </a:dataSet>
            <!--寻源类型-->
            <a:dataSet id="pur51302_source_type_ds" lookupCode="JK_ZJB_SOURCE_TYPE"/>
            <a:dataSet id="pur51302_price_category_ds" lookupCode="PUR_RFX_PRICE_CATEGORY"/>
            <a:dataSet id="jkpur5910_rfx_model_ds" lookupCode="JK_ZJB_MODEL"/>
            <a:dataSet id="jkpur5910_rfx_document_type_ds" lookupCode="JK_ZJB_DOCUMENT_TYPE"/>
            <a:dataSet id="pur51302_rfx_headers_ds" autoQuery="true" model="cux.JINKO.PUR.JKPUR5910.jkpur_rfx_headers" queryUrl="${/request/@context_path}/autocrud/cux.JINKO.PUR.JKPUR5910.jkpur_rfx_headers/query?rfx_header_id=${/parameter/@rfx_header_id}">
                <a:fields>
                    <a:field name="extend_date" required="true"/>
                    <a:field name="document_type_desc" defaultValue="招竞标" displayField="code_value_name" options="jkpur5910_rfx_document_type_ds" readOnly="true" required="true" returnField="document_type_code" valueField="code_value"/>
                    <a:field name="rfx_header_id"/>
                    <a:field name="pur_organization_require_flag"/>
                    <a:field name="source_from" defaultValue="MANUAL"/>
                    <a:field name="rfx_number" readOnly="true"/>
                    <a:field name="company_id"/>
                    <a:field name="pur_organization_name" autoComplete="true" autoCompleteField="pur_organization_code_name" lovHeight="480" lovService="public.pur_organization_lov" lovWidth="510" required="true" title="PUR_ORGANIZATIONS.PUR_ORGANIZATION">
                        <a:mapping>
                            <a:map from="pur_organization_id" to="pur_organization_id"/>
                            <a:map from="pur_organization_code" to="pur_organization_code"/>
                            <a:map from="pur_organization_name" to="pur_organization_name"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="business_unit_name" autoComplete="true" autoCompleteField="business_unit_code_name" lovHeight="480" lovService="public.fnd_business_unit_lov" lovWidth="500" readOnly="true" title="FND_BUSINESS_UNITS.BUSINESS_UNIT_QUERY">
                        <a:mapping>
                            <a:map from="owner_business_unit_id" to="owner_business_unit_id"/>
                            <a:map from="business_unit_code" to="business_unit_code"/>
                            <a:map from="business_unit_name" to="business_unit_name"/>
                            <a:map from="company_id" to="company_id"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="rfx_mode_desc" displayField="code_value_name" options="jkpur5910_rfx_model_ds" required="true" returnField="rfx_mode_code" valueField="code_value"/>
                    <a:field name="title" required="true" requiredMessage="${l:PUR5130.PLEASE_FILL_RFX_TITLE}"/>
                    <a:field name="rfx_method"/>
                    <a:field name="rfx_method_desc" displayField="code_value_name" options="pur51302_rfx_method_ds" required="true" requiredMessage="${l:PUR5130.PLEASE_CHOOSE_RFX_MODE}" returnField="rfx_method" valueField="code_value"/>
                    <a:field name="auction_direction"/>
                    <a:field name="auction_direction_desc" displayField="code_value_name" options="pur51302_rfx_auction_direction_ds" required="true" requiredMessage="${l:PUR5130.PLEASE_CHOOSE_BIDDING_DIRECTION}" returnField="auction_direction" valueField="code_value"/>
                    <a:field name="open_rule"/>
                    <a:field name="open_rule_desc" displayField="code_value_name" options="pur51302_rfx_open_rule_ds" required="true" requiredMessage="${l:PUR5130.PLEASE_CHOOSE_OPEN_RULE}" returnField="open_rule" valueField="code_value"/>
                    <a:field name="payment_method_id"/>
                    <a:field name="payment_method_desc" displayField="payment_method_desc" options="pur51302_payment_method_ds" required="true" requiredMessage="${l:PUR5130.PLEASE_CHOOSE_PAYMENT_TERM}" returnField="payment_method_id" valueField="payment_method_id"/>
                    <a:field name="currency_code"/>
                    <a:field name="currency_desc" displayField="currency_name" options="pur51302_currency_ds" required="true" requiredMessage="${l:PUR5130.PLEASE_CHOOSE_CURRENCY}" returnField="currency_code" valueField="currency_code">
                        <a:mapping>
                            <a:map from="currency_name" to="currency_desc"/>
                            <a:map from="currency_code" to="currency_code"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="exchange_rate" readOnly="true" requiredMessage="${l:PUR5130.PLEASE_FILL_EXCHANGE_RATE}"/>
                    <a:field name="tax_included_flag" checkedValue="Y" defaultValue="N" uncheckedValue="N"/>
                    <a:field name="tax_type_id"/>
                    <a:field name="tax_type_desc" autoComplete="true" autoCompleteField="quick_value" lovHeight="480" lovService="public.fnd_tax_type_code_lov?business_group=${/session/@business_group}" lovWidth="500" requiredMessage="${l:PUR5130.PLEASE_CHOOSE_TAX_CODE}" title="PUR_REQ_LINES.TAX_TYPE_RATE">
                        <a:mapping>
                            <a:map from="tax_type_id" to="tax_type_id"/>
                            <a:map from="tax_type_code" to="tax_type_code"/>
                            <a:map from="description" to="tax_type_desc"/>
                            <a:map from="tax_type_rate" to="tax_type_rate"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="tax_type_rate" readOnly="true"/>
                    <a:field name="place_of_delivery" required="true"/>
                    <a:field name="status_desc" readOnly="true"/>
                    <a:field name="created_by"/>
                    <a:field name="created_by_desc" readOnly="true"/>
                    <a:field name="creation_date_desc" readOnly="true"/>
                    <a:field name="issued_date_desc" readOnly="true"/>
                    <a:field name="comments"/>
                    <a:field name="source_type_desc" displayField="code_value_name" options="pur51302_source_type_ds" required="true" requiredMessage="${l:PUR5130.PLEASE_CHOOSE_SOURCE_TYPE}" returnField="source_type" valueField="code_value"/>
                    <a:field name="price_category_desc" displayField="code_value_name" options="pur51302_price_category_ds" required="true" requiredMessage="${l:PUR5130.PLEASE_CHOOSE_PRICE_CATEGORY}" returnField="price_category" valueField="code_value"/>
                    <a:field name="agent_name" autoComplete="true" autoCompleteField="code_name" lovGridHeight="320" lovHeight="480" lovService="public.pur_buyers_lov" lovWidth="500" required="true" requiredMessage="${l:PUR5130.RFX_GROUP_NOT_NULL}" title="PUR_HEADERS_ALL.PUR_BUYER">
                        <a:mapping>
                            <a:map from="buyer_id" to="agent_id"/>
                            <a:map from="buyer_code" to="agent_code"/>
                            <a:map from="description" to="agent_name"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="start_date" required="true"/>
                    <a:field name="end_date" required="true"/>
                    <a:field name="ranking_rule"/>
                    <a:field name="ranking_rule_desc" displayField="code_value_name" options="jkpur5910_rfx_ranking_rule_ds" required="true" requiredMessage="${l:PUR5130.PLEASE_CHOOSE_RANK_RULE}" returnField="ranking_rule" valueField="code_value"/>
                    <a:field name="payment_description" autoComplete="true" autoCompleteField="payment_description_name" lovHeight="480" lovService="cux.JINKO.PUR.JKPUR5910.jkpur_rfx_payment_terms" lovWidth="510" required="true" title="付款条款">
                        <a:mapping>
                            <a:map from="payment_term_id" to="payment_term_id"/>
                            <a:map from="payment_term_code" to="payment_term_code"/>
                            <a:map from="payment_description" to="payment_description"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="distribution_rule_name"/>
                </a:fields>
                <a:events>
                    <a:event name="update" handler="pur51302_rfx_headers_ds_update"/>
                    <a:event name="load" handler="pur51302_rfx_headers_ds_load"/>
                </a:events>
            </a:dataSet>
            <!-- 物品行 -->
            <a:dataSet id="pur51302_rfx_ln_items_ds" bindName="items" bindTarget="pur51302_rfx_headers_ds" fetchAll="true" model="cux.JINKO.PUR.JKPUR5910.jkpur_rfx_ln_items" queryUrl="${/request/@context_path}/autocrud/cux.JINKO.PUR.JKPUR5910.jkpur_rfx_ln_items/query?rfx_header_id=${/parameter/@rfx_header_id}" selectable="true">
                <a:fields>
                    <a:field name="line_num" required="true"/>
                    <a:field name="decimal_digits" defaultValue="2" required="true"/>
                    <a:field name="buffer_range" defaultValue="0" required="true"/>
                    <a:field name="rfx_line_item_id"/>
                    <a:field name="source_from" defaultValue="MANUAL"/>
                    <a:field name="auto_create_distribute" defaultValue="Y"/>
                    <a:field name="line_number"/>
                    <a:field name="company_id"/>
                    <a:field name="allow_same_price_flag_desc" displayField="code_value_name" options="pur5910_rfx_price_ds" required="true" requiredMessage="允许相同报价不能为空" returnField="allow_same_price_flag" valueField="code_value"/>
                    <a:field name="source_from" defaultValue="MANUAL"/>
                    <a:field name="inv_organization_id"/>
                    <a:field name="inv_organization_desc" autoComplete="true" autoCompleteField="organization_code_name" autoCompleteSize="2" lovHeight="505" lovService="public.inv_organizations_lov" lovWidth="780" required="true" requiredMessage="${l:PUR5130.PLEASE_CHOOSE_INV_ORG}" title="PUR_RFX_LN_ITEMS.INV_ORGANIZATION_ID">
                        <a:mapping>
                            <a:map from="inv_organization_id" to="inv_organization_id"/>
                            <a:map from="inv_organization_name" to="inv_organization_desc"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="item_category_id"/>
                    <a:field name="item_category_desc" autoComplete="true" autoCompleteField="category_code_name" lovHeight="480" lovService="pur.PUR5130.mtl_categories_user_defined_vl" lovWidth="510" requiredMessage="${l:PUR5130.PLEASE_CHOOSE_MATL_CATEGORY}" title="PUR_REQUISITION_LNS.ITEM_CATEGORY_ID">
                        <a:mapping>
                            <a:map from="category_name" to="item_category_desc"/>
                            <a:map from="category_udf_id" to="item_category_id"/>
                            <a:map from="category_code" to="item_category_code"/>
                            <a:map from="quote_tmpl_flag" to="quote_tmpl_flag"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="item_id"/>
                    <a:field name="item_code" autoComplete="true" autoCompleteField="code_name" lovAutoQuery="false" lovHeight="480" lovService="public.mtl_system_item_relations_lov" lovWidth="550" title="MTL_SYSTEM_ITEMS.ITEM_CODE">
                        <a:mapping>
                            <a:map from="item_id" to="item_id"/>
                            <a:map from="item_code" to="item_code"/>
                            <a:map from="item_name" to="item_desc"/>
                            <a:map from="item_note" to="item_note"/>
                            <a:map from="primary_uom_code" to="uom_code"/>
                            <a:map from="primary_uom_desc" to="uom_desc"/>
                            <a:map from="item_category_id" to="item_category_id"/>
                            <a:map from="item_category_name" to="item_category_desc"/>
                            <a:map from="item_category_code" to="item_category_code"/>
                            <a:map from="quote_tmpl_flag" to="quote_tmpl_flag"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="item_desc" required="true"/>
                    <a:field name="item_note"/>
                    <a:field name="item_parameter_config"/>
                    <a:field name="quantity" required="true" requiredMessage="${l:PUR5130.PLEASE_FILL_DEMAND_QUANTITY}"/>
                    <a:field name="uom_code"/>
                    <a:field name="uom_desc" autoComplete="true" autoCompleteField="code_name" lovGridHeight="350" lovHeight="500" lovService="public.fnd_uom_codes_lov" lovWidth="500" required="true" requiredMessage="${l:PUR5130.PLEASE_CHOOSE_UNIT}" title="FND_UOM_CODES.UOM">
                        <a:mapping>
                            <a:map from="uom_code" to="uom_code"/>
                            <a:map from="uom_desc" to="uom_desc"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="need_by_date" requiredMessage="${l:PUR5130.PLEASE_CHOOSE_DEMAND_DATE}"/>
                    <a:field name="tax_included_flag" checkedValue="Y" defaultValue="N" uncheckedValue="N"/>
                    <a:field name="samples_requested" checkedValue="Y" defaultValue="N" uncheckedValue="N"/>
                    <a:field name="tax_type_rate" lovHeight="480" lovService="public.fnd_tax_type_code_lov?business_group=${/session/@business_group}" lovWidth="500" requiredMessage="${l:PUR5130.PLEASE_CHOOSE_TAX_CODE}" title="PUR_REQ_LINES.TAX_TYPE_RATE">
                        <a:mapping>
                            <a:map from="tax_type_id" to="tax_type_id"/>
                            <a:map from="tax_type_code" to="tax_type_code"/>
                            <a:map from="description" to="tax_type_desc"/>
                            <a:map from="tax_type_rate" to="tax_type_rate"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="limit_price" required="true"/>
                    <a:field name="feedback_range" required="true"/>
                    <a:field name="rule_name" autoComplete="true" autoCompleteField="rule_code_name" autoCompleteSize="2" lovHeight="480" lovService="cux.JINKO.PUR.JKPUR5910.jkpur_rfx_quato_rule" lovWidth="550" requiredMessage="请选择配额规则" title="配额规则">
                        <a:mapping>
                            <a:map from="rule_id" to="rule_id"/>
                            <a:map from="rule_name" to="rule_name"/>
                            <a:map from="rule_number" to="rule_number"/>
                        </a:mapping>
                    </a:field>
                </a:fields>
                <a:events>
                    <a:event name="update" handler="pur51302_rfx_ln_items_ds_update"/>
                    <a:event name="load" handler="pur51302_rfx_ln_items_ds_load"/>
                    <a:event name="add" handler="pur51302_rfx_ln_items_ds_add"/>
                </a:events>
            </a:dataSet>
            <!-- Quote Ds -->
            <a:dataSet id="pur51202_rfx_quote_create_ds" bindName="quote_lines" bindTarget="pur51302_rfx_ln_items_ds" fetchAll="true" model="cux.JINKO.PUR.JKPUR5910.jkpur_rfx_quotes">
                <a:events>
                    <a:event name="load" handler="pur51202_rfx_quote_create_loadFun"/>
                </a:events>
            </a:dataSet>
            <a:dataSet id="pur51302_rfx_quote_query_ds" autoQuery="true" bindTarget="pur51302_rfx_ln_items_ds" fetchAll="true" model="cux.JINKO.PUR.JKPUR5910.jkpur_rfx_quote_tmpl_line_create_query">
                <a:events>
                    <a:event name="load" handler="pur51302_rfx_quote_query_ds_loadFun"/>
                </a:events>
            </a:dataSet>
            <a:dataSet id="pur51202_rfx_quote_edit_ds" fetchAll="true"/>
            <a:dataSet id="pur51302_rfx_ln_vendors_ds" autoQuery="true" model="cux.JINKO.PUR.JKPUR5910.jkpur_rfx_ln_vendors" queryUrl="${/request/@context_path}/autocrud/cux.JINKO.PUR.JKPUR5910.jkpur_rfx_ln_vendors/query?rfx_header_id=${/parameter/@rfx_header_id}" selectable="true">
                <a:fields>
                    <a:field name="vendor_company_id"/>
                    <a:field name="vendor_code" autoComplete="true" autoCompleteField="vendor_code_desc" autoCompleteSize="2" lovGridHeight="320" lovHeight="480" lovService="cux.JINKO.PUR.JKPUR5910.jkpur_rfx_vendor_lov?rfx_header_id=${/parameter/@rfx_header_id}" lovWidth="500" required="true" requiredMessage="${l:PUR5130.PLEASE_CHOOSE_VENDOR}" title="PUR_VENDORS.VENDOR">
                        <a:mapping>
                            <a:map from="coop_company_id" to="coop_company_id"/>
                            <a:map from="vendor_code" to="vendor_code"/>
                            <a:map from="vendor_desc" to="vendor_desc"/>
                            <a:map from="coop_business_group" to="coop_business_group"/>
                            <a:map from="contact_id" to="vendor_contact_id"/>
                            <a:map from="contact_person" to="contact_person"/>
                            <a:map from="contact_mobile" to="contact_mobile"/>
                            <a:map from="contact_mail" to="e_mail"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="vendor_desc"/>
                    <a:field name="vendor_contact_id"/>
                    <a:field name="contact_person" autoComplete="true" autoCompleteField="contact_name" lovGridHeight="320" lovHeight="450" lovService="public.fnd_com_sup_contacts_lov" lovWidth="800" readOnly="true" title="PUR_RFX_LN_VENDORS.CONTACT_PERSON">
                        <a:mapping>
                            <a:map from="contact_id" to="vendor_contact_id"/>
                            <a:map from="contact_name" to="contact_person"/>
                            <a:map from="mobile_phone" to="contact_mobile"/>
                            <a:map from="email" to="e_mail"/>
                        </a:mapping>
                    </a:field>
                    <a:field name="contact_mobile"/>
                    <a:field name="e_mail"/>
                    <a:field name="sms_schicken_flag" checkedValue="Y" defaultValue="Y" uncheckedValue="N"/>
                </a:fields>
                <a:events>
                    <a:event name="update" handler="pur51302_rfx_ln_vendors_ds_update"/>
                    <a:event name="load" handler="pur51302_rfx_ln_vendors_ds_load"/>
                    <a:event name="beforecreate" handler="pur51302_rfx_ln_vendors_ds_beforecreate"/>
                    <a:event name="add" handler="pur51302_rfx_ln_vendors_ds_add"/>
                </a:events>
            </a:dataSet>
            <a:dataSet id="pur51302_rfx_ln_attachments" autoQuery="true" bindTarget="pur51302_rfx_headers_ds" model="public.fnd_atm_lines" queryUrl="${/request/@context_path}/autocrud/public.fnd_atm_lines/query?source_table_name=JK_PUR_RFX_HEADERS&amp;source_pk_value=${/parameter/@rfx_header_id}" selectable="true">
                <a:fields>
                    <a:field name="atm_line_id"/>
                    <a:field name="line_number"/>
                    <a:field name="atm_desc"/>
                    <a:field name="source_table_name" defaultValue="JK_PUR_RFX_HEADERS"/>
                    <a:field name="source_pk_value" defaultValue="${/parameter/@rfx_header_id}"/>
                </a:fields>
            </a:dataSet>
            <a:dataSet id="pur5910_rule_name_header_ds" autoQuery="true" model="cux.JINKO.PUR.JKPUR5910.jkpur_rfx_quato_rule_header" queryUrl="${/request/@context_path}/autocrud/cux.JINKO.PUR.JKPUR5910.jkpur_rfx_quato_rule_header/query?rfx_header_id=${/parameter/@rfx_header_id}">
                <a:events>
                    <a:event name="load" handler="pur5910_rule_name_header_ds_load"/>
                </a:events>
            </a:dataSet>
        </a:dataSets>
        <a:screenBody>
            <a:screenTopToolbar>
                <a:toolbarButton id="jkpur5910_save_bt" click="pur51302_rfx_save" style="margin-left:20px;" text="HAP_SAVE" width="100"/>
                <a:toolbarButton id="jkpur5910_submit_bt" click="pur51302_rfx_submit" text="PROMPT.SUBMIT" width="100"/>
                <a:toolbarButton id="jkpur5910_cancel_bt" click="pur51302_rfx_cancel" text="HAP_CANCEL" width="100"/>
                <a:toolbarButton id="jkpur5910_copy_bt" click="jkpur5910_rfx_copy" text="PROMPT.COPY" width="100"/>
                <a:toolbarButton id="jkpur5910_operation_record_bt" click="pur51302_rfx_operation_record_fun" text="PROMPT.OPERATION_RECORD" width="100"/>
                <a:toolbarButton id="pur51302_reback_button" click="pur51302_confirmBeforeBack" text="HAP_BACK" width="100"/>
                <a:switch test="/parameter/@atm_counts">
                    <a:case value="1">
                        <div style="float:right;margin-top:10px;margin-left:auto;margin-right:20px;vertical-align:middle;">
                            <img src="${/request/@context_path}/images/paperclip.png"/>
                        </div>
                    </a:case>
                </a:switch>
            </a:screenTopToolbar>
            <a:vBox labelWidth="120" padding="0">
                <a:hBox labelWidth="120">
                    <a:textField name="rfx_number" bindTarget="pur51302_rfx_headers_ds" prompt="竞标书单号" readOnly="true"/>
                    <a:lov name="pur_organization_name" bindTarget="pur51302_rfx_headers_ds" prompt="PUR_ORGANIZATIONS.PUR_ORG_NAME"/>
                    <a:lov name="agent_name" bindTarget="pur51302_rfx_headers_ds" prompt="PUR5130.RFX_GROUP"/>
                    <a:lov name="business_unit_name" bindTarget="pur51302_rfx_headers_ds" prompt="FND_BUSINESS_UNITS.BUSINESS_UNIT"/>
                </a:hBox>
                <a:hBox labelWidth="120">
                    <a:textField name="title" bindTarget="pur51302_rfx_headers_ds" prompt="竞标书标题"/>
                    <a:comboBox name="document_type_desc" bindTarget="pur51302_rfx_headers_ds" prompt="单据类型"/>
                    <a:comboBox name="rfx_method_desc" bindTarget="pur51302_rfx_headers_ds" prompt="招竞标方式"/>
                    <a:comboBox name="auction_direction_desc" bindTarget="pur51302_rfx_headers_ds" prompt="竞标方向"/>
                </a:hBox>
                <a:hBox labelWidth="120">
                    <a:comboBox name="source_type_desc" bindTarget="pur51302_rfx_headers_ds" prompt="竞标类型"/>
                    <a:comboBox name="currency_desc" bindTarget="pur51302_rfx_headers_ds" prompt="PUR_RFX_HEADERS.CURRENCY_CODE"/>
                    <a:comboBox name="payment_method_desc" bindTarget="pur51302_rfx_headers_ds" prompt="PUR_RFX_HEADERS.PAYMENT_METHOD_ID"/>
                    <a:numberField name="exchange_rate" allowDecimals="true" allowFormat="true" allowNegative="false" bindTarget="pur51302_rfx_headers_ds" decimalPrecision="8" prompt="PUR_RFX_HEADERS.EXCHANGE_RATE"/>
                </a:hBox>
                <a:hBox labelWidth="120">
                    <a:lov name="payment_description" bindTarget="pur51302_rfx_headers_ds" prompt="付款条款"/>
                    <a:dateTimePicker name="start_date" bindTarget="pur51302_rfx_headers_ds" prompt="竞标开始时间"/>
                    <a:dateTimePicker name="end_date" bindTarget="pur51302_rfx_headers_ds" prompt="竞标截止时间"/>
                </a:hBox>
                <a:hBox labelWidth="120">
                    <a:textArea name="comments" bindTarget="pur51302_rfx_headers_ds" prompt="邀标条款" width="707"/>
                    <a href="javascript:jkpur5910_config_agreement_open()" style="margin-left: 50px;color: blue;"><![CDATA[竞标规则]]></a>
                </a:hBox>
                <a:hBox labelWidth="120">
                    <a:textField name="distribution_rule_name" bindTarget="pur51302_rfx_headers_ds" prompt="比例分配规则" width="400"/>
                </a:hBox>
                <a:hBox>
                    <a:accordionPanel id="pur5120_accordion_dim" height="220" showIcon="true" singleMode="false" width="1200">
                        <a:accordions>
                            <a:accordion prompt="PUR_RFX_HEADERS.OTHER_INFO" selected="true">
                                <a:vBox labelWidth="120">
                                    <a:hBox labelWidth="120">
                                        <a:checkBox name="tax_included_flag" bindTarget="pur51302_rfx_headers_ds" prompt="PUR_RFX_HEADERS.TAX_INCLUDED_FLAG" width="152"/>
                                        <a:lov name="tax_type_desc" bindTarget="pur51302_rfx_headers_ds" prompt="PUR_RFX_HEADERS.TAX_CODE"/>
                                        <a:textField name="tax_type_rate" bindTarget="pur51302_rfx_headers_ds" prompt="PUR_RFX_HEADERS.TAX_RATE" width="170"/>
                                        <a:dateTimePicker name="creation_date_desc" bindTarget="pur51302_rfx_headers_ds" prompt="PUR_RFX_HEADERS.CREATION_DATE"/>
                                    </a:hBox>
                                    <a:hBox labelWidth="120">
                                        <a:textField name="created_by_desc" bindTarget="pur51302_rfx_headers_ds" prompt="创建人"/>
                                        <a:comboBox name="open_rule_desc" bindTarget="pur51302_rfx_headers_ds" prompt="PUR_RFX_HEADERS.OPEN_RULE"/>
                                        <a:comboBox name="ranking_rule_desc" bindTarget="pur51302_rfx_headers_ds" prompt="竞标排名规则" width="170"/>
                                        <a:textField name="place_of_delivery" bindTarget="pur51302_rfx_headers_ds" prompt="PUR_RFX_HEADERS.PLACE_OF_DELIVERY"/>
                                    </a:hBox>
                                    <a:hBox labelWidth="120">
                                        <a:comboBox name="rfx_mode_desc" bindTarget="pur51302_rfx_headers_ds" prompt="竞标模式"/>
                                        <a:comboBox name="price_category_desc" bindTarget="pur51302_rfx_headers_ds" prompt="标准/样件"/>
                                        <a:numberField name="extend_date" allowNegative="false" bindTarget="pur51302_rfx_headers_ds" decimalPrecision="2" prompt="延长截标时间（m）" width="170"/>
                                    </a:hBox>
                                </a:vBox>
                            </a:accordion>
                        </a:accordions>
                    </a:accordionPanel>
                </a:hBox>
            </a:vBox>
            <a:tabPanel height="400" marginWidth="130">
                <a:tabs>
                    <a:tab prompt="PUR5120.ITEM_DETIAL" width="120">
                        <a:grid id="pur51302_rfx_ln_items_grid" bindTarget="pur51302_rfx_ln_items_ds" height="350" marginWidth="140" navBar="true">
                            <a:toolBar>
                                <a:button type="add"/>
                                <a:button type="delete"/>
                            </a:toolBar>
                            <a:columns>
                                <a:column name="line_num" align="right" editor="pur51302_item_line_num_nf" prompt="PUR_RFX_LN_ITEMS.LINE_NUM" width="30"/>
                                <a:column name="inv_organization_desc" align="left" editor="pur51302_inv_organization_desc_lov" prompt="工厂" width="80"/>
                                <a:column name="item_code" align="left" editor="pur51302_item_code_lov" prompt="PUR_RFX_LN_ITEMS.ITEM_CODE" width="60"/>
                                <a:column name="item_desc" align="left" editor="pur51302_item_desc_tf" prompt="PUR_RFX_LN_ITEMS.ITEM_DESC" width="100"/>
                                <a:column name="item_category_desc" align="left" editorFunction="pur51302_rfx_ln_items_ef" prompt="PUR_RFX_LN_ITEMS.ITEM_CATEGORY_ID" width="100"/>
                                <a:column name="quantity" align="left" editor="pur51302_item_quantity_nf" prompt="PUR_RFX_LN_ITEMS.QUANTITY" width="40"/>
                                <a:column name="uom_desc" align="left" editor="pur51302_uom_desc_lov" prompt="PUR_RFX_LN_ITEMS.UOM_CODE" width="40"/>
                                <a:column name="limit_price" editor="pur51302_limit_price_nf" prompt="PUR_RFX_LN_ITEMS.LIMIT_PRICE" width="40"/>
                                <a:column name="feedback_range" align="left" editor="pur51302_feedback_range_nf" prompt="PUR_RFX_LN_ITEMS.FEEDBACK_RANGE" width="40"/>
                                <a:column name="allow_same_price_flag_desc" align="center" editor="pur51302_pur_ln_type_desc_cb" prompt="允许相同报价" width="50"/>
                                <a:column name="buffer_range" align="left" editor="pur51302_feedback_range_nf" prompt="报价缓冲范围" width="50"/>
                                <a:column name="decimal_digits" align="left" editor="pur51302_item_line_num_nf" prompt="报价小位数" width="50"/>
                                <a:column name="rule_name" align="left" editor="pur51302_item_code_lov" prompt="配额规则" width="60"/>
                                <a:column name="tax_included_flag" editor="pur51302_tax_included_flag_ckb" prompt="PUR_RFX_LN_ITEMS.TAX_INCLUDED_FLAG" width="40"/>
                                <a:column name="tax_type_rate" editorFunction="pur51302_taxTypeRateEditorFunction" prompt="PUR_RFX_LN_ITEMS.TAX_TYPE_RATE" width="40"/>
                                <!-- <a:column name="need_by_date" align="left" editor="pur51302_item_need_by_date_dp" prompt="PUR_RFX_LN_ITEMS.NEED_BY_DATE" renderer="Aurora.formatDate" width="60"/> -->
                                <a:column name="supply_date_from" align="left" editor="pur51302_item_need_by_date_dp" prompt="供货需求期间从" renderer="Aurora.formatDate" width="60"/>
                                <a:column name="supply_date_to" align="left" editor="pur51302_item_need_by_date_dp" prompt="供货需求期间至" renderer="Aurora.formatDate" width="60"/>
                                <a:column name="req_number" prompt="PUR_RFX_LN_ITEMS.REQ_NUMBER" width="70"/>
                                <a:column name="req_line_num" prompt="PUR_RFX_LN_ITEMS.REQ_LINE_NUMBER" width="70"/>
                                <!-- <a:column name="quote_name" align="center" prompt="PUR_RFX_QUOTE_TITLE" renderer="pur51302_quoteRendererFun" width="50"/> -->
                                <a:column name="comments" align="center" editor="pur51302_item_parameter_config_tf" prompt="备注" width="60"/>
                                <!-- <a:column name="item_attachment" align="center" prompt="PUR_RFX_LN_ITEMS.REQ_ATTACHMENT" renderer="pur51302_upload_attachment" width="60"/> -->
                            </a:columns>
                            <a:editors>
                                <a:numberField id="pur51302_item_line_num_nf" allowDecimals="false" allowNegative="false"/>
                                <a:textField id="pur51302_item_note_tf"/>
                                <a:comboBox id="pur51302_pur_ln_type_desc_cb"/>
                                <a:lov id="pur51302_inv_organization_desc_lov"/>
                                <a:lov id="pur51302_item_category_desc_lov"/>
                                <a:lov id="pur51302_item_code_lov"/>
                                <a:lov id="pur51302_uom_desc_lov"/>
                                <a:textField id="pur51302_item_parameter_config_tf"/>
                                <a:textField id="pur51302_item_desc_tf"/>
                                <a:numberField id="pur51302_item_quantity_nf" allowNegative="false"/>
                                <a:datePicker id="pur51302_item_need_by_date_dp"/>
                                <a:numberField id="pur51302_feedback_range_nf"/>
                                <a:numberField id="pur51302_limit_price_nf"/>
                                <a:numberField id="pur51302_trans_cost_nf"/>
                                <a:checkBox id="pur51302_samples_requested_ckb"/>
                                <a:checkBox id="pur51302_tax_included_flag_ckb"/>
                                <a:lov id="pur51302_tax_type_rate_lov"/>
                            </a:editors>
                            <a:events>
                                <a:event name="cellclick" handler="pur51302_rfx_ln_items_grid_cellclick"/>
                            </a:events>
                        </a:grid>
                    </a:tab>
                    <a:tab prompt="PUR5120.VENDOR_LIST" width="120">
                        <a:grid id="pur51302_vendors_grid" bindTarget="pur51302_rfx_ln_vendors_ds" height="350" marginWidth="140" navBar="true">
                            <a:toolBar>
                                <a:button type="add"/>
                                <a:button type="delete"/>
                                <a:button click="pur51302_rfx_batch_add_supplier" icon="${/request/@context_path}/images/info.gif" style="margin-left:10px" text="PUR5130.BATCH_ADD_SUPPLIER"/>
                            </a:toolBar>
                            <a:columns>
                                <a:column name="vendor_code" align="left" editor="pur51302_vendor_code_lov" prompt="PUR_RFX_LN_VENDORS.VENDOR_CODE" width="100"/>
                                <a:column name="vendor_desc" align="left" prompt="PUR_RFX_LN_VENDORS.VENDOR_DESC" width="150"/>
                                <a:column name="contact_person" align="left" editor="pur51302_contact_person_lov" prompt="PUR_RFX_LN_VENDORS.CONTACT_PERSON" width="100"/>
                                <a:column name="contact_mobile" align="left" prompt="PUR_RFX_LN_VENDORS.CONTACT_MOBILE" width="100"/>
                                <a:column name="e_mail" align="left" prompt="PUR_RFX_LN_VENDORS.E_MAIL" width="100"/>
                                <!-- <a:column name="sms_schicken_flag" align="center" editor="pur51302_sms_schicken_flag_ck" prompt="PUR_RFX_LN_VENDORS.SMS_SCHICKEN_FLAG" width="100"/> -->
                            </a:columns>
                            <a:editors>
                                <a:lov id="pur51302_vendor_code_lov"/>
                                <a:lov id="pur51302_contact_person_lov"/>
                                <a:checkBox id="pur51302_sms_schicken_flag_ck" checkedValue="Y" uncheckedValue="N"/>
                            </a:editors>
                            <a:events>
                                <a:event name="cellclick" handler="pur51302_vendors_grid_cellclick"/>
                            </a:events>
                        </a:grid>
                    </a:tab>
                    <a:tab prompt="PUR5120.ATM_FILE_LIST" width="120">
                        <a:grid id="pur51302_atch_grid" bindTarget="pur51302_rfx_ln_attachments" height="350" marginWidth="140" navBar="true">
                            <a:toolBar>
                                <a:button type="add"/>
                                <a:button type="delete"/>
                            </a:toolBar>
                            <a:columns>
                                <a:column name="atm_desc" align="left" editor="pur51302_atch_desc_tf" prompt="FND_ATM_LINES.ATM_DESC" width="150"/>
                                <a:column name="upload_user_desc" align="center" prompt="FND_ATM_LINES.UPLOAD_USER_NAME" width="100"/>
                                <a:column name="upload_date" align="center" prompt="FND_ATM_LINES.UPLOAD_DATE" width="100"/>
                                <a:column name="atm_flag" align="center" renderer="pur51302_upload_render" width="20"/>
                                <a:column name="attachment" align="center" prompt="PROMPT.UPLOAD_DOWNLOAD" renderer="pur51302_upload_render" width="100"/>
                            </a:columns>
                            <a:editors>
                                <a:textField id="pur51302_atch_desc_tf" maxLength="500"/>
                            </a:editors>
                        </a:grid>
                    </a:tab>
                </a:tabs>
            </a:tabPanel>
        </a:screenBody>
        <script><![CDATA[
              function init() {
              }
             // init();
          ]]></script>
    </a:view>
</a:screen>
