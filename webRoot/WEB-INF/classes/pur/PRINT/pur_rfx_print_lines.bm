<?xml version="1.0" encoding="UTF-8"?>
<bm:model xmlns:bm="http://www.aurora-framework.org/schema/bm">
    <bm:operations>
        <bm:operation name="query">
            <bm:query-sql><![CDATA[
                SELECT
                    v.*,
                    v.quantity * unit_price_1 price_total_1,
                    v.quantity * unit_price_2 price_total_2,
                    v.quantity * unit_price_3 price_total_3,
                    v.quantity * unit_price_4 price_total_4,
                    v.quantity * unit_price_5 price_total_5
                FROM
                    (SELECT
                        fc.company_full_name,
                        ri.item_desc,
                        ri.quantity,
                        ri.uom_code AS uom,
                        NVL(
                        (SELECT
                            vl.uom_desc
                        FROM
                            fnd_uom_codes_vl vl
                        WHERE
                            ri.uom_code       = vl.uom_code AND
                            vl.business_group = rh.owner_business_group
                        ), ri.uom_code) uom_code,
                        ri.tax_type_rate,
                        rh.score_mode,
                        (SELECT
                            fcc.registered_capital
                        FROM
                            fnd_companies fcc
                        WHERE
                            fcc.company_id = fc.company_id
                        ) registered_capital,
                        (SELECT
                            rfl.delivery_cycle
                        FROM
                            pur_rfx_feedback_headers rfh,
                            pur_rfx_feedback_lines rfl
                        WHERE
                            rfh.rfx_header_id      = rh.rfx_header_id AND
                            fc.company_id          = rfh.coop_company_id AND
                            rfl.rfx_line_item_id   = ri.rfx_line_item_id AND
                            rfl.feedback_header_id = rfh.feedback_header_id AND
                            rfh.rfx_round          = rh.round AND
                            rownum                 = 1
                        ) implementation_cycle,
                        (SELECT
                            t.description
                        FROM
                            csh_payment_methods_vl t
                        WHERE
                            t.payment_method_id = NVL(
                            (SELECT
                                rhp.payment_method_id
                            FROM
                                pur_rfx_headers rhp
                            WHERE
                                rhp.rfx_header_id = rh.rfx_header_id AND
                                rhp.round         = rh.round
                            ), rh.payment_method_id)
                        ) payment_methods,
                        (SELECT
                            rfl.current_fb_reason
                        FROM
                            pur_rfx_feedback_headers rfh,
                            pur_rfx_feedback_lines rfl,
                            pur_rfx_headers rh
                        WHERE
                            rfh.feedback_header_id = rfl.feedback_header_id AND
                            rfh.rfx_header_id      = rh.rfx_header_id AND
                            rh.rfx_header_id       = ${@rfx_header_id} AND
                            fc.company_id          = rfh.coop_company_id AND
                            rfh.rfx_round         IN
                            (SELECT
                                fh.rfx_round
                            FROM
                                pur_rfx_feedback_headers fh
                            WHERE
                                fh.feedback_header_id IN
                                (SELECT
                                    MAX(fh.feedback_header_id)
                                FROM
                                    pur_rfx_feedback_headers fh
                                WHERE
                                    fh.rfx_header_id   = ${@rfx_header_id} AND
                                    fh.coop_company_id = ${@coop_company_id}
                                )
                            ) AND
                            rownum = 1
                        ) comments,
                        (SELECT
                            rfl.current_fb_reason
                        FROM
                            pur_rfx_feedback_headers rfh,
                            pur_rfx_feedback_lines rfl
                        WHERE
                            rfh.feedback_header_id = rfl.feedback_header_id AND
                            rfh.rfx_header_id      = ${@rfx_header_id} AND
                            fc.company_id          = rfh.coop_company_id AND
                            rfl.rfx_line_item_id   = ri.rfx_line_item_id and
                            rfh.rfx_round          = 1
                        )comments_1,
                        (SELECT
                            rfl.current_fb_reason
                        FROM
                            pur_rfx_feedback_headers rfh,
                            pur_rfx_feedback_lines rfl
                        WHERE
                            rfh.feedback_header_id = rfl.feedback_header_id AND
                            rfh.rfx_header_id      = ${@rfx_header_id} AND
                            fc.company_id          = rfh.coop_company_id AND
                            rfl.rfx_line_item_id   = ri.rfx_line_item_id and
                            rfh.rfx_round          = 2
                        )comments_2,
                        (SELECT
                            rfl.current_fb_reason
                        FROM
                            pur_rfx_feedback_headers rfh,
                            pur_rfx_feedback_lines rfl
                        WHERE
                            rfh.feedback_header_id = rfl.feedback_header_id AND
                            rfh.rfx_header_id      = ${@rfx_header_id} AND
                            fc.company_id          = rfh.coop_company_id AND
                            rfl.rfx_line_item_id   = ri.rfx_line_item_id and
                            rfh.rfx_round          = 3
                        )comments_3,
                        (SELECT
                            rfl.current_fb_reason
                        FROM
                            pur_rfx_feedback_headers rfh,
                            pur_rfx_feedback_lines rfl
                        WHERE
                            rfh.feedback_header_id = rfl.feedback_header_id AND
                            rfh.rfx_header_id      = ${@rfx_header_id} AND
                            fc.company_id          = rfh.coop_company_id AND
                            rfl.rfx_line_item_id   = ri.rfx_line_item_id and
                            rfh.rfx_round          = 4
                        )comments_4,
                        (SELECT
                            rfl.current_fb_reason
                        FROM
                            pur_rfx_feedback_headers rfh,
                            pur_rfx_feedback_lines rfl
                        WHERE
                            rfh.feedback_header_id = rfl.feedback_header_id AND
                            rfh.rfx_header_id      = ${@rfx_header_id} AND
                            fc.company_id          = rfh.coop_company_id AND
                            rfl.rfx_line_item_id   = ri.rfx_line_item_id and
                            rfh.rfx_round          = 5
                        )comments_5,
                        (SELECT
                            rfl.valid_fb_retail_price
                        FROM
                            pur_rfx_feedback_headers rfh,
                            pur_rfx_feedback_lines rfl
                        WHERE
                            rfh.feedback_header_id = rfl.feedback_header_id AND
                            rfh.rfx_header_id      = rh.rfx_header_id AND
                            fc.company_id          = rfh.coop_company_id AND
                            rfl.rfx_line_item_id   = ri.rfx_line_item_id AND
                            rfh.rfx_round          = 1 AND
                            rfh.status            IN ('FEEDBACKING','FINISHED')
                        ) unit_price_1,
                        (SELECT
                            1
                        FROM
                            pur_rfx_feedback_headers rfh,
                            pur_rfx_feedback_lines rfl
                        WHERE
                            rfh.feedback_header_id = rfl.feedback_header_id AND
                            rfh.rfx_header_id      = rh.rfx_header_id AND
                            fc.company_id          = rfh.coop_company_id AND
                            rfl.rfx_line_item_id   = ri.rfx_line_item_id AND
                            rfh.rfx_round          = 1 AND
                            rfh.status            IN ('FEEDBACKING','FINISHED') AND
                            NOT EXISTS
                            (SELECT
                                1
                            FROM
                                pur_rfx_feedback_lines rfll,
                                pur_rfx_feedback_headers rfhh
                            WHERE
                                rfll.rfx_line_item_id      = ri.rfx_line_item_id AND
                                rfll.feedback_line_id     <> rfl.feedback_line_id AND
                                rfll.valid_fb_retail_price < rfl.valid_fb_retail_price AND
                                rfhh.feedback_header_id    = rfll.feedback_header_id AND
                                rfhh.rfx_round             = 1 AND
                                rfhh.status               IN ('FEEDBACKING','FINISHED') AND
                                rfhh.rfx_header_id         = rfh.rfx_header_id AND
                                rfhh.coop_company_id      IN
                                (SELECT
                                    rlv.coop_company_id
                                FROM
                                    pur_rfx_ln_vendors rlv
                                WHERE
                                    rlv.rfx_header_id = rfh.rfx_header_id
                                )
                            )
                        ) lowest_flag_1,
                        (
                            CASE
                                WHEN
                                    (
                                        rh.round > 1 AND
                                        (SELECT
                                                rhh.score_mode
                                            FROM
                                                pur_rfx_headers_hist rhh
                                            WHERE
                                                rhh.rfx_header_id = rh.rfx_header_id AND
                                                rhh.round         = 1 AND
                                                rownum            = 1
                                        )
                                        = 'NONDISTINCTION'
                                    )
                                    OR
                                    (
                                        rh.round      = 1 AND
                                        rh.score_mode = 'NONDISTINCTION'
                                    )
                                THEN TO_CHAR(bid_score_pkg.get_bidding_score(
                                    (SELECT
                                        rfh.feedback_header_id * -1
                                    FROM
                                        pur_rfx_feedback_headers rfh
                                    WHERE
                                        rfh.rfx_header_id = rh.rfx_header_id AND
                                        fc.company_id     = rfh.coop_company_id AND
                                        rfh.rfx_round     = 1
                                    ), 1))
                                WHEN
                                    (
                                        rh.round > 1 AND
                                        (SELECT
                                                rhh.score_mode
                                            FROM
                                                pur_rfx_headers_hist rhh
                                            WHERE
                                                rhh.rfx_header_id = rh.rfx_header_id AND
                                                rhh.round         = 1 AND
                                                rownum            = 1
                                        )
                                        IS NULL
                                    )
                                    OR
                                    (
                                        rh.round       = 1 AND
                                        rh.score_mode IS NULL
                                    )
                                THEN NULL
                                ELSE '商务组：'
                                    || bid_score_pkg.get_bidding_bus_score(
                                    (SELECT
                                        rfh.feedback_header_id * -1
                                    FROM
                                        pur_rfx_feedback_headers rfh
                                    WHERE
                                        rfh.rfx_header_id = rh.rfx_header_id AND
                                        fc.company_id     = rfh.coop_company_id AND
                                        rfh.rfx_round     = 1
                                    ), 1)
                                    || '<br/>技术组：'
                                    || bid_score_pkg.get_bidding_tech_score(
                                    (SELECT
                                        rfh.feedback_header_id * -1
                                    FROM
                                        pur_rfx_feedback_headers rfh
                                    WHERE
                                        rfh.rfx_header_id = rh.rfx_header_id AND
                                        fc.company_id     = rfh.coop_company_id AND
                                        rfh.rfx_round     = 1
                                    ), 1)
                            END) score_1,
                        (SELECT
                            rfl.valid_fb_retail_price
                        FROM
                            pur_rfx_feedback_headers rfh,
                            pur_rfx_feedback_lines rfl
                        WHERE
                            rfh.feedback_header_id = rfl.feedback_header_id AND
                            rfh.rfx_header_id      = rh.rfx_header_id AND
                            fc.company_id          = rfh.coop_company_id AND
                            rfl.rfx_line_item_id   = ri.rfx_line_item_id AND
                            rfh.rfx_round          = 2 AND
                            rfh.status            IN ('FEEDBACKING','FINISHED')
                        ) unit_price_2,
                        (SELECT
                            1
                        FROM
                            pur_rfx_feedback_headers rfh,
                            pur_rfx_feedback_lines rfl
                        WHERE
                            rfh.feedback_header_id = rfl.feedback_header_id AND
                            rfh.rfx_header_id      = rh.rfx_header_id AND
                            fc.company_id          = rfh.coop_company_id AND
                            rfl.rfx_line_item_id   = ri.rfx_line_item_id AND
                            rfh.rfx_round          = 2 AND
                            rfh.status            IN ('FEEDBACKING','FINISHED') AND
                            NOT EXISTS
                            (SELECT
                                1
                            FROM
                                pur_rfx_feedback_lines rfll,
                                pur_rfx_feedback_headers rfhh
                            WHERE
                                rfll.rfx_line_item_id      = ri.rfx_line_item_id AND
                                rfll.feedback_line_id     <> rfl.feedback_line_id AND
                                rfll.valid_fb_retail_price < rfl.valid_fb_retail_price AND
                                rfhh.feedback_header_id    = rfll.feedback_header_id AND
                                rfhh.rfx_round             = 2 AND
                                rfhh.status               IN ('FEEDBACKING','FINISHED') AND
                                rfhh.rfx_header_id         = rfh.rfx_header_id AND
                                rfhh.coop_company_id      IN
                                (SELECT
                                    rlv.coop_company_id
                                FROM
                                    pur_rfx_ln_vendors rlv
                                WHERE
                                    rlv.rfx_header_id = rfh.rfx_header_id
                                )
                            )
                        ) lowest_flag_2,
                        (
                            CASE
                                WHEN
                                    (
                                        rh.round > 2 AND
                                        (SELECT
                                                rhh.score_mode
                                            FROM
                                                pur_rfx_headers_hist rhh
                                            WHERE
                                                rhh.rfx_header_id = rh.rfx_header_id AND
                                                rhh.round         = 2 AND
                                                rownum            = 1
                                        )
                                        = 'NONDISTINCTION'
                                    )
                                    OR
                                    (
                                        rh.round      = 2 AND
                                        rh.score_mode = 'NONDISTINCTION'
                                    )
                                THEN TO_CHAR(bid_score_pkg.get_bidding_score(
                                    (SELECT
                                        rfh.feedback_header_id * -1
                                    FROM
                                        pur_rfx_feedback_headers rfh
                                    WHERE
                                        rfh.rfx_header_id = rh.rfx_header_id AND
                                        fc.company_id     = rfh.coop_company_id AND
                                        rfh.rfx_round     = 2
                                    ), 1))
                                WHEN
                                    (
                                        rh.round > 2 AND
                                        (SELECT
                                                rhh.score_mode
                                            FROM
                                                pur_rfx_headers_hist rhh
                                            WHERE
                                                rhh.rfx_header_id = rh.rfx_header_id AND
                                                rhh.round         = 2 AND
                                                rownum            = 1
                                        )
                                        IS NULL
                                    )
                                    OR
                                    (
                                        rh.round       = 2 AND
                                        rh.score_mode IS NULL
                                    )
                                THEN NULL
                                ELSE '商务组：'
                                    || bid_score_pkg.get_bidding_bus_score(
                                    (SELECT
                                        rfh.feedback_header_id * -1
                                    FROM
                                        pur_rfx_feedback_headers rfh
                                    WHERE
                                        rfh.rfx_header_id = rh.rfx_header_id AND
                                        fc.company_id     = rfh.coop_company_id AND
                                        rfh.rfx_round     = 2
                                    ), 1)
                                    || '<br/>技术组：'
                                    || bid_score_pkg.get_bidding_tech_score(
                                    (SELECT
                                        rfh.feedback_header_id * -1
                                    FROM
                                        pur_rfx_feedback_headers rfh
                                    WHERE
                                        rfh.rfx_header_id = rh.rfx_header_id AND
                                        fc.company_id     = rfh.coop_company_id AND
                                        rfh.rfx_round     = 2
                                    ), 1)
                            END) score_2,
                        (SELECT
                            rfl.valid_fb_retail_price
                        FROM
                            pur_rfx_feedback_headers rfh,
                            pur_rfx_feedback_lines rfl
                        WHERE
                            rfh.feedback_header_id = rfl.feedback_header_id AND
                            rfh.rfx_header_id      = rh.rfx_header_id AND
                            fc.company_id          = rfh.coop_company_id AND
                            rfl.rfx_line_item_id   = ri.rfx_line_item_id AND
                            rfh.rfx_round          = 3 AND
                            rfh.status            IN ('FEEDBACKING','FINISHED')
                        ) unit_price_3,
                        (SELECT
                            1
                        FROM
                            pur_rfx_feedback_headers rfh,
                            pur_rfx_feedback_lines rfl
                        WHERE
                            rfh.feedback_header_id = rfl.feedback_header_id AND
                            rfh.rfx_header_id      = rh.rfx_header_id AND
                            fc.company_id          = rfh.coop_company_id AND
                            rfl.rfx_line_item_id   = ri.rfx_line_item_id AND
                            rfh.rfx_round          = 3 AND
                            rfh.status            IN ('FEEDBACKING','FINISHED') AND
                            NOT EXISTS
                            (SELECT
                                1
                            FROM
                                pur_rfx_feedback_lines rfll,
                                pur_rfx_feedback_headers rfhh
                            WHERE
                                rfll.rfx_line_item_id      = ri.rfx_line_item_id AND
                                rfll.feedback_line_id     <> rfl.feedback_line_id AND
                                rfll.valid_fb_retail_price < rfl.valid_fb_retail_price AND
                                rfhh.feedback_header_id    = rfll.feedback_header_id AND
                                rfhh.rfx_round             = 3 AND
                                rfhh.status               IN ('FEEDBACKING','FINISHED') AND
                                rfhh.rfx_header_id         = rfh.rfx_header_id AND
                                rfhh.coop_company_id      IN
                                (SELECT
                                    rlv.coop_company_id
                                FROM
                                    pur_rfx_ln_vendors rlv
                                WHERE
                                    rlv.rfx_header_id = rfh.rfx_header_id
                                )
                            )
                        ) lowest_flag_3,
                        (
                            CASE
                                WHEN
                                    (
                                        rh.round > 3 AND
                                        (SELECT
                                                rhh.score_mode
                                            FROM
                                                pur_rfx_headers_hist rhh
                                            WHERE
                                                rhh.rfx_header_id = rh.rfx_header_id AND
                                                rhh.round         = 3 AND
                                                rownum            = 1
                                        )
                                        = 'NONDISTINCTION'
                                    )
                                    OR
                                    (
                                        rh.round      = 3 AND
                                        rh.score_mode = 'NONDISTINCTION'
                                    )
                                THEN TO_CHAR(bid_score_pkg.get_bidding_score(
                                    (SELECT
                                        rfh.feedback_header_id * -1
                                    FROM
                                        pur_rfx_feedback_headers rfh
                                    WHERE
                                        rfh.rfx_header_id = rh.rfx_header_id AND
                                        fc.company_id     = rfh.coop_company_id AND
                                        rfh.rfx_round     = 3
                                    ), 1))
                                WHEN
                                    (
                                        rh.round > 3 AND
                                        (SELECT
                                                rhh.score_mode
                                            FROM
                                                pur_rfx_headers_hist rhh
                                            WHERE
                                                rhh.rfx_header_id = rh.rfx_header_id AND
                                                rhh.round         = 3 AND
                                                rownum            = 1
                                        )
                                        IS NULL
                                    )
                                    OR
                                    (
                                        rh.round       = 3 AND
                                        rh.score_mode IS NULL
                                    )
                                THEN NULL
                                ELSE '商务组：'
                                    || bid_score_pkg.get_bidding_bus_score(
                                    (SELECT
                                        rfh.feedback_header_id * -1
                                    FROM
                                        pur_rfx_feedback_headers rfh
                                    WHERE
                                        rfh.rfx_header_id = rh.rfx_header_id AND
                                        fc.company_id     = rfh.coop_company_id AND
                                        rfh.rfx_round     = 3
                                    ), 1)
                                    || '<br/>技术组：'
                                    || bid_score_pkg.get_bidding_tech_score(
                                    (SELECT
                                        rfh.feedback_header_id * -1
                                    FROM
                                        pur_rfx_feedback_headers rfh
                                    WHERE
                                        rfh.rfx_header_id = rh.rfx_header_id AND
                                        fc.company_id     = rfh.coop_company_id AND
                                        rfh.rfx_round     = 3
                                    ), 1)
                            END) score_3,
                        (SELECT
                            rfl.valid_fb_retail_price
                        FROM
                            pur_rfx_feedback_headers rfh,
                            pur_rfx_feedback_lines rfl
                        WHERE
                            rfh.feedback_header_id = rfl.feedback_header_id AND
                            rfh.rfx_header_id      = rh.rfx_header_id AND
                            fc.company_id          = rfh.coop_company_id AND
                            rfl.rfx_line_item_id   = ri.rfx_line_item_id AND
                            rfh.rfx_round          = 4 AND
                            rfh.status            IN ('FEEDBACKING','FINISHED')
                        ) unit_price_4,
                        (SELECT
                            1
                        FROM
                            pur_rfx_feedback_headers rfh,
                            pur_rfx_feedback_lines rfl
                        WHERE
                            rfh.feedback_header_id = rfl.feedback_header_id AND
                            rfh.rfx_header_id      = rh.rfx_header_id AND
                            fc.company_id          = rfh.coop_company_id AND
                            rfl.rfx_line_item_id   = ri.rfx_line_item_id AND
                            rfh.rfx_round          = 4 AND
                            rfh.status            IN ('FEEDBACKING','FINISHED') AND
                            NOT EXISTS
                            (SELECT
                                1
                            FROM
                                pur_rfx_feedback_lines rfll,
                                pur_rfx_feedback_headers rfhh
                            WHERE
                                rfll.rfx_line_item_id      = ri.rfx_line_item_id AND
                                rfll.feedback_line_id     <> rfl.feedback_line_id AND
                                rfll.valid_fb_retail_price < rfl.valid_fb_retail_price AND
                                rfhh.feedback_header_id    = rfll.feedback_header_id AND
                                rfhh.rfx_round             = 4 AND
                                rfhh.status               IN ('FEEDBACKING','FINISHED') AND
                                rfhh.rfx_header_id         = rfh.rfx_header_id AND
                                rfhh.coop_company_id      IN
                                (SELECT
                                    rlv.coop_company_id
                                FROM
                                    pur_rfx_ln_vendors rlv
                                WHERE
                                    rlv.rfx_header_id = rfh.rfx_header_id
                                )
                            )
                        ) lowest_flag_4,
                        (
                            CASE
                                WHEN
                                    (
                                        rh.round > 4 AND
                                        (SELECT
                                                rhh.score_mode
                                            FROM
                                                pur_rfx_headers_hist rhh
                                            WHERE
                                                rhh.rfx_header_id = rh.rfx_header_id AND
                                                rhh.round         = 4 AND
                                                rownum            = 1
                                        )
                                        = 'NONDISTINCTION'
                                    )
                                    OR
                                    (
                                        rh.round      = 4 AND
                                        rh.score_mode = 'NONDISTINCTION'
                                    )
                                THEN TO_CHAR(bid_score_pkg.get_bidding_score(
                                    (SELECT
                                        rfh.feedback_header_id * -1
                                    FROM
                                        pur_rfx_feedback_headers rfh
                                    WHERE
                                        rfh.rfx_header_id = rh.rfx_header_id AND
                                        fc.company_id     = rfh.coop_company_id AND
                                        rfh.rfx_round     = 4
                                    ), 1))
                                WHEN
                                    (
                                        rh.round > 4 AND
                                        (SELECT
                                                rhh.score_mode
                                            FROM
                                                pur_rfx_headers_hist rhh
                                            WHERE
                                                rhh.rfx_header_id = rh.rfx_header_id AND
                                                rhh.round         = 4 AND
                                                rownum            = 1
                                        )
                                        IS NULL
                                    )
                                    OR
                                    (
                                        rh.round       = 4 AND
                                        rh.score_mode IS NULL
                                    )
                                THEN NULL
                                ELSE '商务组：'
                                    || bid_score_pkg.get_bidding_bus_score(
                                    (SELECT
                                        rfh.feedback_header_id * -1
                                    FROM
                                        pur_rfx_feedback_headers rfh
                                    WHERE
                                        rfh.rfx_header_id = rh.rfx_header_id AND
                                        fc.company_id     = rfh.coop_company_id AND
                                        rfh.rfx_round     = 4
                                    ), 1)
                                    || '<br/>技术组：'
                                    || bid_score_pkg.get_bidding_tech_score(
                                    (SELECT
                                        rfh.feedback_header_id * -1
                                    FROM
                                        pur_rfx_feedback_headers rfh
                                    WHERE
                                        rfh.rfx_header_id = rh.rfx_header_id AND
                                        fc.company_id     = rfh.coop_company_id AND
                                        rfh.rfx_round     = 4
                                    ), 1)
                            END) score_4,
                        (SELECT
                            rfl.valid_fb_retail_price
                        FROM
                            pur_rfx_feedback_headers rfh,
                            pur_rfx_feedback_lines rfl
                        WHERE
                            rfh.feedback_header_id = rfl.feedback_header_id AND
                            rfh.rfx_header_id      = rh.rfx_header_id AND
                            fc.company_id          = rfh.coop_company_id AND
                            rfl.rfx_line_item_id   = ri.rfx_line_item_id AND
                            rfh.rfx_round          = 5 AND
                            rfh.status            IN ('FEEDBACKING','FINISHED')
                        ) unit_price_5,
                        (SELECT
                            1
                        FROM
                            pur_rfx_feedback_headers rfh,
                            pur_rfx_feedback_lines rfl
                        WHERE
                            rfh.feedback_header_id = rfl.feedback_header_id AND
                            rfh.rfx_header_id      = rh.rfx_header_id AND
                            fc.company_id          = rfh.coop_company_id AND
                            rfl.rfx_line_item_id   = ri.rfx_line_item_id AND
                            rfh.rfx_round          = 5 AND
                            rfh.status            IN ('FEEDBACKING','FINISHED') AND
                            NOT EXISTS
                            (SELECT
                                1
                            FROM
                                pur_rfx_feedback_lines rfll,
                                pur_rfx_feedback_headers rfhh
                            WHERE
                                rfll.rfx_line_item_id      = ri.rfx_line_item_id AND
                                rfll.feedback_line_id     <> rfl.feedback_line_id AND
                                rfll.valid_fb_retail_price < rfl.valid_fb_retail_price AND
                                rfhh.feedback_header_id    = rfll.feedback_header_id AND
                                rfhh.rfx_round             = 5 AND
                                rfhh.status               IN ('FEEDBACKING','FINISHED') AND
                                rfhh.rfx_header_id         = rfh.rfx_header_id AND
                                rfhh.coop_company_id      IN
                                (SELECT
                                    rlv.coop_company_id
                                FROM
                                    pur_rfx_ln_vendors rlv
                                WHERE
                                    rlv.rfx_header_id = rfh.rfx_header_id
                                )
                            )
                        ) lowest_flag_5,
                        (
                            CASE
                                WHEN
                                    (
                                        rh.round > 5 AND
                                        (SELECT
                                                rhh.score_mode
                                            FROM
                                                pur_rfx_headers_hist rhh
                                            WHERE
                                                rhh.rfx_header_id = rh.rfx_header_id AND
                                                rhh.round         = 5 AND
                                                rownum            = 1
                                        )
                                        = 'NONDISTINCTION'
                                    )
                                    OR
                                    (
                                        rh.round      = 5 AND
                                        rh.score_mode = 'NONDISTINCTION'
                                    )
                                THEN TO_CHAR(bid_score_pkg.get_bidding_score(
                                    (SELECT
                                        rfh.feedback_header_id * -1
                                    FROM
                                        pur_rfx_feedback_headers rfh
                                    WHERE
                                        rfh.rfx_header_id = rh.rfx_header_id AND
                                        fc.company_id     = rfh.coop_company_id AND
                                        rfh.rfx_round     = 5
                                    ), 1))
                                WHEN
                                    (
                                        rh.round > 5 AND
                                        (SELECT
                                                rhh.score_mode
                                            FROM
                                                pur_rfx_headers_hist rhh
                                            WHERE
                                                rhh.rfx_header_id = rh.rfx_header_id AND
                                                rhh.round         = 5 AND
                                                rownum            = 1
                                        )
                                        IS NULL
                                    )
                                    OR
                                    (
                                        rh.round       = 5 AND
                                        rh.score_mode IS NULL
                                    )
                                THEN NULL
                                ELSE '商务组：'
                                    || bid_score_pkg.get_bidding_bus_score(
                                    (SELECT
                                        rfh.feedback_header_id * -1
                                    FROM
                                        pur_rfx_feedback_headers rfh
                                    WHERE
                                        rfh.rfx_header_id = rh.rfx_header_id AND
                                        fc.company_id     = rfh.coop_company_id AND
                                        rfh.rfx_round     = 5
                                    ), 1)
                                    || '<br/>技术组：'
                                    || bid_score_pkg.get_bidding_tech_score(
                                    (SELECT
                                        rfh.feedback_header_id * -1
                                    FROM
                                        pur_rfx_feedback_headers rfh
                                    WHERE
                                        rfh.rfx_header_id = rh.rfx_header_id AND
                                        fc.company_id     = rfh.coop_company_id AND
                                        rfh.rfx_round     = 5
                                    ), 1)
                            END) score_5,
                            ri.item_note
                    FROM
                        pur_rfx_headers rh,
                        fnd_companies_vl fc,
                        pur_rfx_ln_items ri
                    WHERE
                        rh.rfx_header_id = ${@rfx_header_id} AND
                        fc.company_id    = ${@coop_company_id} AND
                        ri.rfx_header_id = rh.rfx_header_id
                    ) v
            ]]></bm:query-sql>
        </bm:operation>
    </bm:operations>
</bm:model>
